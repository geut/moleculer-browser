!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("kleur"),require("eventemitter2"),require("browser-process-hrtime"),require("timers-browserify"),require("lodash"),require("glob"),require("path"),require("buffer"),require("es6-error"),require("stream"),require("cpus"),require("fs"),require("crypto"),require("lru-cache"),require("util"),require("fastest-validator"),require("fflate"),require("fn-args")):"function"==typeof define&&define.amd?define(["exports","kleur","eventemitter2","browser-process-hrtime","timers-browserify","lodash","glob","path","buffer","es6-error","stream","cpus","fs","crypto","lru-cache","util","fastest-validator","fflate","fn-args"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).Moleculer={},e.kleur,e.EE,e.hrtime,e.timersBrowserify,e._,e.glob,e.path,e.buffer,e.ExtendableError,e.require$$0,e.cpus,e.fs,e.crypto,e.LRU,e.util,e.Validator,e.fflate,e.functionArguments)}(this,(function(e,t,s,r,i,n,o,a,l,c,h,u,d,p,m,E,g,f,_){"use strict";function T(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var v=T(t),S=T(s),b=T(r),O=T(n),y=T(o),I=T(a),R=T(c),C=T(h),L=T(u),A=T(d),N=T(p),P=T(m),M=T(E),k=T(g),U=T(_),D={CIRCUIT_CLOSE:"close",CIRCUIT_HALF_OPEN:"half_open",CIRCUIT_HALF_OPEN_WAIT:"half_open_wait",CIRCUIT_OPEN:"open"},w="undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{};class x extends S.default{constructor(){super(),this.title="browser",this.browser=!0,this.env={},this.argv=[],this.version="",this.versions={http_parser:"0.0",node:"12.18.4",v8:"0.0",uv:"0.0",zlib:"0.0",ares:"0.0",icu:"0.0",modules:"0",openssl:"0.0"},this.hrtime=b.default,this.pid=0,this.exitCode=0,this.connected=!0,this._startTime=Date.now(),this._errorCallback=null}exit(e){throw this.exitCode=e,this.emit("exit",[e]),new Error("process.exit() called.")}setUncaughtExceptionCaptureCallback(e){this._errorCallback&&window.removeEventListener("error",this._errorCallback),this._errorCallback=e,e&&window.addEventListener("error",e)}hasUncaughtExceptionCaptureCallback(){return null!==this._errorCallback}cwd(){return"/"}uptime(){return Math.floor((Date.now()-this._startTime)/1e3)}memoryUsage(){if(!performance&&!performance.memory)return{rss:0,heapTotal:Number.MAX_SAFE_INTEGER,heapUsed:0,external:0};const{memory:e}=performance;return{rss:0,heapTotal:e.totalJSHeapSize,heapUsed:e.usedJSHeapSize,external:0}}nextTick(e,...t){queueMicrotask((()=>e(...t)))}_getActiveHandles(){return[]}_getActiveRequests(){return[]}}const H=new x;if("undefined"!=typeof process)for(const e in H)"function"!=typeof H[e]?process[e]=H[e]:process[e]=H[e].bind(H);w.process=H;var $="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function B(){throw new Error("Dynamic requires are not currently supported by @rollup/plugin-commonjs")}var G={PACKET_UNKNOWN:"???",PACKET_EVENT:"EVENT",PACKET_REQUEST:"REQ",PACKET_RESPONSE:"RES",PACKET_DISCOVER:"DISCOVER",PACKET_INFO:"INFO",PACKET_DISCONNECT:"DISCONNECT",PACKET_HEARTBEAT:"HEARTBEAT",PACKET_PING:"PING",PACKET_PONG:"PONG",PACKET_GOSSIP_REQ:"GOSSIP_REQ",PACKET_GOSSIP_RES:"GOSSIP_RES",PACKET_GOSSIP_HELLO:"GOSSIP_HELLO",DATATYPE_UNDEFINED:0,DATATYPE_NULL:1,DATATYPE_JSON:2,DATATYPE_BUFFER:3,Packet:class{constructor(e,t,s){this.type=e||"???",this.target=t,this.payload=s||{}}}},F=function(e,t,s){return e(s={path:t,exports:{},require:function(e,t){return B(null==t&&s.path)}},s.exports),s.exports}((function(e){class t extends R.default{constructor(e,t,s,r){super(e),this.code=t||500,this.type=s,this.data=r,this.retryable=!1}}class s extends t{constructor(e,t,s,r){super(e),this.code=t||500,this.type=s,this.data=r,this.retryable=!0}}class r extends t{constructor(e,t,s,r){super(e,t||400,s,r)}}e.exports={MoleculerError:t,MoleculerRetryableError:s,MoleculerServerError:class extends s{},MoleculerClientError:r,ServiceNotFoundError:class extends s{constructor(e={}){let t;e.nodeID&&e.action?t=`Service '${e.action}' is not found on '${e.nodeID}' node.`:e.action&&(t=`Service '${e.action}' is not found.`),e.service&&e.version?t=`Service '${e.version}.${e.service}' not found.`:e.service&&(t=`Service '${e.service}' not found.`),super(t,404,"SERVICE_NOT_FOUND",e)}},ServiceNotAvailableError:class extends s{constructor(e){let t;t=e.nodeID?`Service '${e.action}' is not available on '${e.nodeID}' node.`:`Service '${e.action}' is not available.`,super(t,404,"SERVICE_NOT_AVAILABLE",e)}},ValidationError:class extends r{constructor(e,t,s){super(e,422,t||"VALIDATION_ERROR",s)}},RequestTimeoutError:class extends s{constructor(e){super(`Request is timed out when call '${e.action}' action on '${e.nodeID}' node.`,504,"REQUEST_TIMEOUT",e)}},RequestSkippedError:class extends t{constructor(e){super(`Calling '${e.action}' is skipped because timeout reached on '${e.nodeID}' node.`,514,"REQUEST_SKIPPED",e),this.retryable=!1}},RequestRejectedError:class extends s{constructor(e){super(`Request is rejected when call '${e.action}' action on '${e.nodeID}' node.`,503,"REQUEST_REJECTED",e)}},QueueIsFullError:class extends s{constructor(e){super(`Queue is full. Request '${e.action}' action on '${e.nodeID}' node is rejected.`,429,"QUEUE_FULL",e)}},MaxCallLevelError:class extends t{constructor(e){super(`Request level is reached the limit (${e.level}) on '${e.nodeID}' node.`,500,"MAX_CALL_LEVEL",e),this.retryable=!1}},ServiceSchemaError:class extends t{constructor(e,t){super(e,500,"SERVICE_SCHEMA_ERROR",t)}},BrokerOptionsError:class extends t{constructor(e,t){super(e,500,"BROKER_OPTIONS_ERROR",t)}},GracefulStopTimeoutError:class extends t{constructor(e){e&&e.service?super(`Unable to stop '${e.service.name}' service gracefully.`,500,"GRACEFUL_STOP_TIMEOUT",e&&e.service?{name:e.service.name,version:e.service.version}:null):super("Unable to stop ServiceBroker gracefully.",500,"GRACEFUL_STOP_TIMEOUT")}},ProtocolVersionMismatchError:class extends t{constructor(e){super("Protocol version mismatch.",500,"PROTOCOL_VERSION_MISMATCH",e)}},InvalidPacketDataError:class extends t{constructor(e){super("Invalid packet data.",500,"INVALID_PACKET_DATA",e)}},BrokerDisconnectedError:class extends s{constructor(){super("The broker's transporter has disconnected. Please try again when a connection is reestablished.",502,"BAD_GATEWAY"),this.stack=""}},recreateError:function(t){const s=e.exports[t.name];if(s)switch(t.name){case"MoleculerError":case"MoleculerRetryableError":case"MoleculerServerError":case"MoleculerClientError":return new s(t.message,t.code,t.type,t.data);case"ValidationError":return new s(t.message,t.type,t.data);case"ServiceNotFoundError":case"ServiceNotAvailableError":case"RequestTimeoutError":case"RequestSkippedError":case"RequestRejectedError":case"QueueIsFullError":case"MaxCallLevelError":case"GracefulStopTimeoutError":case"ProtocolVersionMismatchError":case"InvalidPacketDataError":return new s(t.data);case"ServiceSchemaError":case"BrokerOptionsError":return new s(t.message,t.data)}}}})),q={TYPE_COUNTER:"counter",TYPE_GAUGE:"gauge",TYPE_HISTOGRAM:"histogram",TYPE_INFO:"info",PROCESS_ARGUMENTS:"process.arguments",PROCESS_PID:"process.pid",PROCESS_PPID:"process.ppid",PROCESS_MEMORY_HEAP_SIZE_TOTAL:"process.memory.heap.size.total",PROCESS_MEMORY_HEAP_SIZE_USED:"process.memory.heap.size.used",PROCESS_MEMORY_RSS:"process.memory.rss",PROCESS_MEMORY_EXTERNAL:"process.memory.external",PROCESS_MEMORY_HEAP_SPACE_SIZE_TOTAL:"process.memory.heap.space.size.total",PROCESS_MEMORY_HEAP_SPACE_SIZE_USED:"process.memory.heap.space.size.used",PROCESS_MEMORY_HEAP_SPACE_SIZE_AVAILABLE:"process.memory.heap.space.size.available",PROCESS_MEMORY_HEAP_SPACE_SIZE_PHYSICAL:"process.memory.heap.space.size.physical",PROCESS_MEMORY_HEAP_STAT_HEAP_SIZE_TOTAL:"process.memory.heap.stat.heap.size.total",PROCESS_MEMORY_HEAP_STAT_EXECUTABLE_SIZE_TOTAL:"process.memory.heap.stat.executable.size.total",PROCESS_MEMORY_HEAP_STAT_PHYSICAL_SIZE_TOTAL:"process.memory.heap.stat.physical.size.total",PROCESS_MEMORY_HEAP_STAT_AVAILABLE_SIZE_TOTAL:"process.memory.heap.stat.available.size.total",PROCESS_MEMORY_HEAP_STAT_USED_HEAP_SIZE:"process.memory.heap.stat.used.heap.size",PROCESS_MEMORY_HEAP_STAT_HEAP_SIZE_LIMIT:"process.memory.heap.stat.heap.size.limit",PROCESS_MEMORY_HEAP_STAT_MALLOCATED_MEMORY:"process.memory.heap.stat.mallocated.memory",PROCESS_MEMORY_HEAP_STAT_PEAK_MALLOCATED_MEMORY:"process.memory.heap.stat.peak.mallocated.memory",PROCESS_MEMORY_HEAP_STAT_ZAP_GARBAGE:"process.memory.heap.stat.zap.garbage",PROCESS_UPTIME:"process.uptime",PROCESS_INTERNAL_ACTIVE_HANDLES:"process.internal.active.handles",PROCESS_INTERNAL_ACTIVE_REQUESTS:"process.internal.active.requests",PROCESS_VERSIONS_NODE:"process.versions.node",PROCESS_EVENTLOOP_LAG_MIN:"process.eventloop.lag.min",PROCESS_EVENTLOOP_LAG_AVG:"process.eventloop.lag.avg",PROCESS_EVENTLOOP_LAG_MAX:"process.eventloop.lag.max",PROCESS_EVENTLOOP_LAG_COUNT:"process.eventloop.lag.count",PROCESS_GC_TIME:"process.gc.time",PROCESS_GC_TOTAL_TIME:"process.gc.total.time",PROCESS_GC_EXECUTED_TOTAL:"process.gc.executed.total",OS_MEMORY_FREE:"os.memory.free",OS_MEMORY_USED:"os.memory.used",OS_MEMORY_TOTAL:"os.memory.total",OS_UPTIME:"os.uptime",OS_TYPE:"os.type",OS_RELEASE:"os.release",OS_HOSTNAME:"os.hostname",OS_ARCH:"os.arch",OS_PLATFORM:"os.platform",OS_USER_UID:"os.user.uid",OS_USER_GID:"os.user.gid",OS_USER_USERNAME:"os.user.username",OS_USER_HOMEDIR:"os.user.homedir",OS_DATETIME_UNIX:"os.datetime.unix",OS_DATETIME_ISO:"os.datetime.iso",OS_DATETIME_UTC:"os.datetime.utc",OS_DATETIME_TZ_OFFSET:"os.datetime.tz.offset",OS_NETWORK_ADDRESS:"os.network.address",OS_NETWORK_MAC:"os.network.mac",OS_CPU_LOAD_1:"os.cpu.load.1",OS_CPU_LOAD_5:"os.cpu.load.5",OS_CPU_LOAD_15:"os.cpu.load.15",OS_CPU_UTILIZATION:"os.cpu.utilization",OS_CPU_USER:"os.cpu.user",OS_CPU_SYSTEM:"os.cpu.system",OS_CPU_TOTAL:"os.cpu.total",OS_CPU_INFO_MODEL:"os.cpu.info.model",OS_CPU_INFO_SPEED:"os.cpu.info.speed",OS_CPU_INFO_TIMES_USER:"os.cpu.info.times.user",OS_CPU_INFO_TIMES_SYS:"os.cpu.info.times.sys",MOLECULER_NODE_TYPE:"moleculer.node.type",MOLECULER_NODE_VERSIONS_MOLECULER:"moleculer.node.versions.moleculer",MOLECULER_NODE_VERSIONS_LANG:"moleculer.node.versions.lang",MOLECULER_NODE_VERSIONS_PROTOCOL:"moleculer.node.versions.protocol",MOLECULER_BROKER_NAMESPACE:"moleculer.broker.namespace",MOLECULER_BROKER_STARTED:"moleculer.broker.started",MOLECULER_BROKER_LOCAL_SERVICES_TOTAL:"moleculer.broker.local.services.total",MOLECULER_BROKER_MIDDLEWARES_TOTAL:"moleculer.broker.middlewares.total",MOLECULER_REGISTRY_NODES_TOTAL:"moleculer.registry.nodes.total",MOLECULER_REGISTRY_NODES_ONLINE_TOTAL:"moleculer.registry.nodes.online.total",MOLECULER_REGISTRY_SERVICES_TOTAL:"moleculer.registry.services.total",MOLECULER_REGISTRY_SERVICE_ENDPOINTS_TOTAL:"moleculer.registry.service.endpoints.total",MOLECULER_REGISTRY_ACTIONS_TOTAL:"moleculer.registry.actions.total",MOLECULER_REGISTRY_ACTION_ENDPOINTS_TOTAL:"moleculer.registry.action.endpoints.total",MOLECULER_REGISTRY_EVENTS_TOTAL:"moleculer.registry.events.total",MOLECULER_REGISTRY_EVENT_ENDPOINTS_TOTAL:"moleculer.registry.event.endpoints.total",MOLECULER_REQUEST_TOTAL:"moleculer.request.total",MOLECULER_REQUEST_ACTIVE:"moleculer.request.active",MOLECULER_REQUEST_ERROR_TOTAL:"moleculer.request.error.total",MOLECULER_REQUEST_TIME:"moleculer.request.time",MOLECULER_REQUEST_LEVELS:"moleculer.request.levels",MOLECULER_EVENT_EMIT_TOTAL:"moleculer.event.emit.total",MOLECULER_EVENT_BROADCAST_TOTAL:"moleculer.event.broadcast.total",MOLECULER_EVENT_BROADCASTLOCAL_TOTAL:"moleculer.event.broadcast-local.total",MOLECULER_EVENT_RECEIVED_TOTAL:"moleculer.event.received.total",MOLECULER_EVENT_RECEIVED_ACTIVE:"moleculer.event.received.active",MOLECULER_EVENT_RECEIVED_ERROR_TOTAL:"moleculer.event.received.error.total",MOLECULER_EVENT_RECEIVED_TIME:"moleculer.event.received.time",MOLECULER_TRANSIT_PUBLISH_TOTAL:"moleculer.transit.publish.total",MOLECULER_TRANSIT_RECEIVE_TOTAL:"moleculer.transit.receive.total",MOLECULER_TRANSIT_REQUESTS_ACTIVE:"moleculer.transit.requests.active",MOLECULER_TRANSIT_STREAMS_SEND_ACTIVE:"moleculer.transit.streams.send.active",MOLECULER_TRANSIT_READY:"moleculer.transit.ready",MOLECULER_TRANSIT_CONNECTED:"moleculer.transit.connected",MOLECULER_TRANSIT_PONG_TIME:"moleculer.transit.pong.time",MOLECULER_TRANSIT_PONG_SYSTIME_DIFF:"moleculer.transit.pong.systime-diff",MOLECULER_TRANSIT_ORPHAN_RESPONSE_TOTAL:"moleculer.transit.orphan.response.total",MOLECULER_TRANSPORTER_PACKETS_SENT_TOTAL:"moleculer.transporter.packets.sent.total",MOLECULER_TRANSPORTER_PACKETS_SENT_BYTES:"moleculer.transporter.packets.sent.bytes",MOLECULER_TRANSPORTER_PACKETS_RECEIVED_TOTAL:"moleculer.transporter.packets.received.total",MOLECULER_TRANSPORTER_PACKETS_RECEIVED_BYTES:"moleculer.transporter.packets.received.bytes",MOLECULER_CIRCUIT_BREAKER_OPENED_ACTIVE:"moleculer.circuit-breaker.opened.active",MOLECULER_CIRCUIT_BREAKER_OPENED_TOTAL:"moleculer.circuit-breaker.opened.total",MOLECULER_CIRCUIT_BREAKER_HALF_OPENED_ACTIVE:"moleculer.circuit-breaker.half-opened.active",MOLECULER_REQUEST_FALLBACK_TOTAL:"moleculer.request.fallback.total",MOLECULER_REQUEST_BULKHEAD_INFLIGHT:"moleculer.request.bulkhead.inflight",MOLECULER_REQUEST_BULKHEAD_QUEUE_SIZE:"moleculer.request.bulkhead.queue.size",MOLECULER_EVENT_BULKHEAD_INFLIGHT:"moleculer.event.bulkhead.inflight",MOLECULER_EVENT_BULKHEAD_QUEUE_SIZE:"moleculer.event.bulkhead.queue.size",MOLECULER_REQUEST_RETRY_ATTEMPTS_TOTAL:"moleculer.request.retry.attempts.total",MOLECULER_REQUEST_TIMEOUT_TOTAL:"moleculer.request.timeout.total",MOLECULER_CACHER_GET_TOTAL:"moleculer.cacher.get.total",MOLECULER_CACHER_GET_TIME:"moleculer.cacher.get.time",MOLECULER_CACHER_FOUND_TOTAL:"moleculer.cacher.found.total",MOLECULER_CACHER_SET_TOTAL:"moleculer.cacher.set.total",MOLECULER_CACHER_SET_TIME:"moleculer.cacher.set.time",MOLECULER_CACHER_DEL_TOTAL:"moleculer.cacher.del.total",MOLECULER_CACHER_DEL_TIME:"moleculer.cacher.del.time",MOLECULER_CACHER_CLEAN_TOTAL:"moleculer.cacher.clean.total",MOLECULER_CACHER_CLEAN_TIME:"moleculer.cacher.clean.time",MOLECULER_CACHER_EXPIRED_TOTAL:"moleculer.cacher.expired.total",MOLECULER_DISCOVERER_REDIS_COLLECT_TOTAL:"moleculer.discoverer.redis.collect.total",MOLECULER_DISCOVERER_REDIS_COLLECT_TIME:"moleculer.discoverer.redis.collect.time",MOLECULER_DISCOVERER_ETCD_COLLECT_TOTAL:"moleculer.discoverer.etcd.collect.total",MOLECULER_DISCOVERER_ETCD_COLLECT_TIME:"moleculer.discoverer.etcd.collect.time",UNIT_BIT:"bit",UNIT_BYTE:"byte",UNIT_KILOBYTES:"kilobyte",UNIT_MEGABYTE:"megabyte",UNIT_GIGABYTE:"gigabyte",UNIT_TERRABYTE:"terrabyte",UNIT_PETABYTE:"petabyte",UNIT_EXOBYTE:"exabyte",UNIT_NANOSECONDS:"nanosecond",UNIT_MICROSECONDS:"microsecond",UNIT_MILLISECONDS:"millisecond",UNIT_SECONDS:"second",UNIT_MINUTE:"minute",UNIT_HOUR:"hour",UNIT_DAY:"day",UNIT_WEEK:"week",UNIT_MONTH:"month",UNIT_YEAR:"year",UNIT_HANDLE:"handle",UNIT_CPU:"cpu",UNIT_GHZ:"GHz",UNIT_REQUEST:"request",UNIT_CONNECTION:"connection",UNIT_PACKET:"packet",UNIT_MESSAGE:"message",UNIT_STREAM:"stream",UNIT_EVENT:"event"};const Y=S.default;class V extends Y{constructor(e){super(),this.options={...V.defaultOptions,...e},this.reset(),this.tick=this.tick.bind(this),this.onVisibilityChange=this.onVisibilityChange.bind(this)}reset(){this.isVisible=!0,this.running=!1,this.prevTime=null,this.startTime=null,this.frameDuration=V.fpsToMs(this.options.fps),this.performance=void 0,this.perfSamples=[],this.requestID&&cancelAnimationFrame(this.requestID)}start(){this.running||(this.running=!0,this.prevTime=V.now(),this.startTime=this.prevTime,this.perfStartTime=this.prevTime,document.addEventListener("visibilitychange",this.onVisibilityChange,!1),this.requestID=requestAnimationFrame(this.tick))}tick(){if(!this.running||!this.isVisible)return;const{performances:e}=this.options,t=V.now(),s=t-this.prevTime,r=t-this.startTime;if(s>this.frameDuration){if(e.enabled){this.perfSamples.push(r);if(e.sampleDuration&&t-this.perfStartTime>e.sampleDuration||this.perfSamples.length>e.samplesCount){const e=this.perfSamples.reduce(((e,t)=>e+t))/this.perfSamples.length;this.performance=this.frameDuration/e,this.emit("perf",this.performance),this.perfSamples=[],this.perfStartTime=t}}this.prevTime=t-s%this.frameDuration,this.startTime=t,this.emit("tick",r)}this.requestID=requestAnimationFrame(this.tick)}stop(){document.removeEventListener("visibilitychange",this.onVisibilityChange,!1),this.reset()}onVisibilityChange(){this.isVisible=!document.hidden,this.isVisible&&(this.reset(),this.start())}}V.defaultOptions={fps:60,performances:{enabled:!0,samplesCount:200,sampleDuration:4e3}},V.now=()=>(performance||Date).now(),V.fpsToMs=e=>1/e*1e3;const j=[{time:Math.floor(Date.now()/1e3),init:!1,avg:0},{time:Math.floor(Date.now()/1e3),avg:0},{time:Math.floor(Date.now()/1e3),avg:0}];function K(e=100){const t=new V({performances:{enabled:!0,samplesCount:3,sampleDuration:e}});return new Promise(((e,s)=>{t.once("perf",(r=>{if(t.stop(),!r)return s(new Error("CpuUsage: ratio perf not found."));const i=100-100*r,n=i/L.default().length;!function(e){const t=Math.floor(Date.now()/1e3);(!j[0].init||t-j[0].time>60)&&(j[0].init=!0,j[0].time=t,j[0].avg=e),t-j[1].time>300&&(j[1].time=t,j[1].avg=e),t-j[2].time>900&&(j[2].time=t,j[2].avg=e)}(i),e({avg:i,usages:L.default().map((e=>n))})})),t.start()}))}K.loadavg=function(){return j.map((e=>e.avg))};const z=K.loadavg;var Q=Object.freeze({__proto__:null,hostname:()=>"undefined"!=typeof location?location.hostname:"",release:()=>"undefined"!=typeof navigator?navigator.appVersion:"",userInfo:()=>({uid:1e3,gid:1e3,username:"moleculer",homedir:"/home/moleculer",shell:"/bin/bash"}),endianness:()=>"LE",uptime:()=>Date.now(),type:()=>"Browser",networkInterfaces:()=>({}),getNetworkInterfaces:()=>({}),arch:()=>"javascript",platform:()=>"browser",tmpdir:()=>"/tmp",tmpDir:()=>"/tmp",EOL:"\n",homedir:()=>"/",loadavg:z,totalmem:()=>performance?performance.memory.totalJSHeapSize:Number.MAX_VALUE,freemem:()=>performance?performance.memory.totalJSHeapSize-performance.memory.usedJSHeapSize:Number.MAX_VALUE,cpus:L.default});const Z=[];for(let e=0;e<256;e++)Z[e]=(e<16?"0":"")+e.toString(16);const W=new Map,J=[],X={b:1,kb:1024,mb:1<<20,gb:1<<30,tb:Math.pow(1024,4),pb:Math.pow(1024,5)},ee=/^((-|\+)?(\d+(?:\.\d+)?)) *(kb|mb|gb|tb|pb)$/i;class te extends R.default{}const se=["h","m","s","ms","μs","ns"],re=[36e5,6e4,1e3,1,.001,1e-6],ie={isFunction:e=>"function"==typeof e,isString:e=>"string"==typeof e||e instanceof String,isObject:e=>null!==e&&"object"==typeof e&&!(e instanceof String),isPlainObject:e=>null!=e&&(Object.getPrototypeOf(e)===Object.prototype||null===Object.getPrototypeOf(e)),flatten:e=>Array.prototype.reduce.call(e,((e,t)=>e.concat(t)),[]),humanize(e){if(null==e)return"?";for(let t=0;t<re.length;t++){const s=e/re[t];if(s>=1)return""+Math.floor(s)+se[t]}return"now"},generateToken(){const e=4294967295*Math.random()|0,t=4294967295*Math.random()|0,s=4294967295*Math.random()|0,r=4294967295*Math.random()|0;return Z[255&e]+Z[e>>8&255]+Z[e>>16&255]+Z[e>>24&255]+"-"+Z[255&t]+Z[t>>8&255]+"-"+Z[t>>16&15|64]+Z[t>>24&255]+"-"+Z[63&s|128]+Z[s>>8&255]+"-"+Z[s>>16&255]+Z[s>>24&255]+Z[255&r]+Z[r>>8&255]+Z[r>>16&255]+Z[r>>24&255]},removeFromArray(e,t){if(!e||0==e.length)return e;const s=e.indexOf(t);return-1!==s&&e.splice(s,1),e},getNodeID:()=>Q.hostname().toLowerCase()+"-"+H.pid,getIpList(){const e=[],t=[],s=Q.networkInterfaces();for(let r in s)for(let i in s[r]){const n=s[r][i];if("IPv4"===n.family){if(n.internal){t.push(n.address);break}e.push(n.address);break}}return e.length>0?e:t},isPromise:e=>null!=e&&"function"==typeof e.then,polyfillPromise(e){ie.isFunction(e.method)||(e.method=function(t){return function(){try{const s=t.apply(this,arguments);return e.resolve(s)}catch(t){return e.reject(t)}}}),ie.isFunction(e.delay)||(e.delay=function(t){return new e((e=>i.setTimeout(e,+t)))},e.prototype.delay=function(t){return this.then((s=>e.delay(t).then((()=>s))))}),ie.isFunction(e.prototype.timeout)||(e.TimeoutError=te,e.prototype.timeout=function(t,s){let r;const n=new e(((n,o)=>{r=i.setTimeout((()=>o(new e.TimeoutError(s))),+t)}));return e.race([n,this]).then((e=>(clearTimeout(r),e))).catch((e=>{throw clearTimeout(r),e}))}),ie.isFunction(e.mapSeries)||(e.mapSeries=function(t,s){const r=Promise.method(s),i=[];return t.reduce(((e,t,s)=>e.then((e=>(i[s]=e,r(t,s))))),e.resolve()).then((e=>(i[t.length]=e,i.slice(1))))})},clearRequireCache(e){Object.keys(require.cache).forEach((function(t){t==e&&delete require.cache[t]}))},match(e,t){if(-1==t.indexOf("?")){const s=t.indexOf("*");if(-1==s)return t===e;const r=t.length;if(r>2&&t.endsWith("**")&&s>r-3)return t=t.substring(0,r-2),e.startsWith(t);if(r>1&&t.endsWith("*")&&s>r-2)return t=t.substring(0,r-1),!!e.startsWith(t)&&-1==e.indexOf(".",r);if(1==r&&0==s)return-1==e.indexOf(".");if(2==r&&0==s&&1==t.lastIndexOf("*"))return!0}const s=t;let r=W.get(s);return null==r&&(t.startsWith("$")&&(t="\\"+t),t="^"+(t=(t=(t=(t=t.replace(/\?/g,".")).replace(/\*\*/g,"§§§")).replace(/\*/g,"[^\\.]*")).replace(/§§§/g,".*"))+"$",r=new RegExp(t,""),W.set(s,r)),r.test(e)},deprecate(e,t){1==arguments.length&&(t=e),-1===J.indexOf(e)&&(console.warn(v.default.yellow().bold("DeprecationWarning: "+t)),J.push(e))},safetyObject:(e,t)=>JSON.parse(JSON.stringify(e,function(e={maxSafeObjectSize:1/0}){const t=new WeakSet;return function(s,r){if("object"==typeof r&&null!==r){const s=r.constructor&&r.constructor.name||typeof r;if(e.maxSafeObjectSize&&"length"in r&&r.length>e.maxSafeObjectSize)return`[${s} ${r.length}]`;if(e.maxSafeObjectSize&&"size"in r&&r.size>e.maxSafeObjectSize)return`[${s} ${r.size}]`;if(t.has(r))return;t.add(r)}return r}}(t))),dotSet(e,t,s){const r=t.split("."),i=r.shift();if(r.length>0){if(Object.prototype.hasOwnProperty.call(e,i)){if(null==e[i])e[i]={};else if("object"!=typeof e[i])throw new Error("Value already set and it's not an object")}else e[i]={};return e[i]=ie.dotSet(e[i],r.join("."),s),e}return e[t]=s,e},makeDirs(e){e.split(I.default.sep).reduce(((e,t)=>{const s=I.default.join(e,t,I.default.sep);return A.default.existsSync(s)||A.default.mkdirSync(s),s}),"")},parseByteString(e){if("number"==typeof e&&!isNaN(e))return e;if("string"!=typeof e)return null;let t,s=ee.exec(e),r="b";if(s)t=parseFloat(s[1]),r=s[4].toLowerCase();else{if(t=parseInt(e,10),Number.isNaN(t))return null;r="b"}return Math.floor(X[r]*t)}};var ne=ie;var oe=class{constructor(e,t){this.registry=t,this.type=e.type,this.name=e.name,this.description=e.description,this.labelNames=e.labelNames||[],this.unit=e.unit,this.aggregator=e.aggregator||t.opts.defaultAggregator,this.lastSnapshot=null,this.dirty=!0,this.values=new Map}setDirty(){this.dirty=!0}clearDirty(){this.dirty=!1}get(e){const t=this.hashingLabels(e);return this.values.get(t)}reset(){throw new Error("Not implemented")}resetAll(){throw new Error("Not implemented")}clear(){this.values=new Map,this.changed()}hashingLabels(e){if(0==this.labelNames.length||null==e||"object"!=typeof e)return"";const t=[];for(let s=0;s<this.labelNames.length;s++){const r=e[this.labelNames[s]];"number"==typeof r?t.push(r):"string"==typeof r?t.push('"'+r+'"'):"boolean"==typeof r?t.push(""+r):t.push("")}return t.join("|")}snapshot(){return!this.dirty&&this.lastSnapshot||(this.lastSnapshot=this.generateSnapshot(),this.clearDirty()),this.lastSnapshot}generateSnapshot(){throw new Error("Not implemented")}changed(e,t,s){this.setDirty(),this.registry.changed(this,e,t,s)}toObject(){return{type:this.type,name:this.name,description:this.description,labelNames:this.labelNames,unit:this.unit,values:this.snapshot()}}};var ae=class{constructor(e,t,s){this.metric=e,this.item=t,this.min=s,this.rate=0,this.lastValue=0,this.lastTickTime=Date.now(),this.value=null,this.timer=i.setInterval((()=>this.tick()),5e3).unref()}update(e){this.value=e}tick(){const e=Date.now(),t=(e-this.lastTickTime)/1e3;this.lastTickTime=e;const s=this.value-this.lastValue;this.lastValue=this.value;const r=s/t*60;let i=this.rate+.5*(r-this.rate);Math.abs(i)<.05&&(i=0);const n=Math.abs(i-this.rate)>.01;this.rate=i,n&&this.metric.changed(this.item.value,this.item.labels,e)}reset(){this.lastValue=0,this.value=null,this.rate=0}};const{pick:le}=O.default;var ce=class extends oe{constructor(e,t){super(e,t),this.type=q.TYPE_GAUGE,this.rate=e.rate}increment(e,t,s){null==t&&(t=1);const r=this.get(e);return this.set((r?r.value:0)+t,e,s)}decrement(e,t,s){null==t&&(t=1);const r=this.get(e);return this.set((r?r.value:0)-t,e,s)}set(e,t,s){const r=this.hashingLabels(t);let i=this.values.get(r);return i?i.value!=e&&(i.value=e,i.timestamp=null==s?Date.now():s,i.rate&&i.rate.update(e),this.changed(e,t,s)):(i={value:e,labels:le(t,this.labelNames),timestamp:null==s?Date.now():s},this.values.set(r,i),this.rate&&(i.rate=new ae(this,i,1),i.rate.update(e)),this.changed(e,t,s)),i}reset(e,t){return this.set(0,e,t)}resetAll(e){this.values.forEach((t=>{t.value=0,t.timestamp=null==e?Date.now():e})),this.changed(null,null,e)}generateSnapshot(){return Array.from(this.values.keys()).map((e=>{const t=this.values.get(e),s={key:e,value:t.value,labels:t.labels,timestamp:t.timestamp};return t.rate&&(s.rate=t.rate.rate),s}))}};var he=class extends ce{constructor(e,t){super(e,t),this.type=q.TYPE_COUNTER}decrement(){throw new Error("Counter can't be decreased.")}};const{isPlainObject:ue}=ne,de=(e,t)=>e-t,pe=(e,t,s)=>(e[t]=s,e);class me extends oe{constructor(e,t){super(e,t),this.type=q.TYPE_HISTOGRAM,ue(e.linearBuckets)?this.buckets=me.generateLinearBuckets(e.linearBuckets.start,e.linearBuckets.width,e.linearBuckets.count):ue(e.exponentialBuckets)?this.buckets=me.generateExponentialBuckets(e.exponentialBuckets.start,e.exponentialBuckets.factor,e.exponentialBuckets.count):Array.isArray(e.buckets)?this.buckets=Array.from(e.buckets):!0===e.buckets&&(this.buckets=this.registry.opts.defaultBuckets),this.buckets&&this.buckets.sort(de),Array.isArray(e.quantiles)?this.quantiles=Array.from(e.quantiles):!0===e.quantiles&&(this.quantiles=this.registry.opts.defaultQuantiles),this.quantiles&&(this.quantiles.sort(de),this.maxAgeSeconds=e.maxAgeSeconds||this.registry.opts.defaultMaxAgeSeconds,this.ageBuckets=e.ageBuckets||this.registry.opts.defaultAgeBuckets),this.rate=e.rate}observe(e,t,s){const r=this.hashingLabels(t);let i=this.values.get(r);if(i||(i=this.resetItem({labels:O.default.pick(t,this.labelNames)}),this.rate&&(i.rate=new ae(this,i,1)),this.values.set(r,i)),i.timestamp=null==s?Date.now():s,i.sum+=e,i.count++,i.lastValue=e,i.bucketValues){const t=this.buckets.length;for(let s=0;s<t;s++)e<=this.buckets[s]&&(i.bucketValues[this.buckets[s]]+=1)}return i.quantileValues&&i.quantileValues.add(e),i.rate&&i.rate.update(i.count),this.changed(e,t,s),i}createBucketValues(){return this.buckets.reduce(((e,t)=>pe(e,t,0)),{})}generateSnapshot(){return Array.from(this.values.keys()).map((e=>this.generateItemSnapshot(this.values.get(e),e)))}generateItemSnapshot(e,t){const s={key:t,labels:e.labels,count:e.count,sum:e.sum,lastValue:e.lastValue,timestamp:e.timestamp};return this.buckets&&(s.buckets=this.buckets.reduce(((t,s)=>pe(t,s,e.bucketValues[s])),{})),this.quantiles&&Object.assign(s,e.quantileValues.snapshot()),e.rate&&(s.rate=e.rate.rate),s}resetItem(e,t){return e.timestamp=null==t?Date.now():t,e.sum=0,e.count=0,e.lastValue=null,this.buckets&&(e.bucketValues=this.createBucketValues()),this.quantiles&&(e.quantileValues=new Ee(this,this.quantiles,this.maxAgeSeconds,this.ageBuckets)),e}reset(e,t){const s=this.hashingLabels(e),r=this.values.get(s);r&&(this.resetItem(r,t),this.changed(null,e,t))}resetAll(e){this.values.forEach((t=>this.resetItem(t,e))),this.changed()}static generateLinearBuckets(e,t,s){const r=[];for(let i=0;i<s;i++)r.push(e+i*t);return r}static generateExponentialBuckets(e,t,s){const r=[];for(let i=0;i<s;i++)r[i]=e*Math.pow(t,i);return r}}class Ee{constructor(e,t,s,r){this.metric=e,this.quantiles=Array.from(t),this.maxAgeSeconds=s,this.ageBuckets=r,this.ringBuckets=[];for(let e=0;e<r;e++)this.ringBuckets.push(new ge);this.dirty=!0,this.currentBucket=-1,this.rotate(),this.lastSnapshot=null,this.setDirty()}setDirty(){this.dirty=!0,this.metric.setDirty()}clearDirty(){this.dirty=!1}rotate(){this.currentBucket=(this.currentBucket+1)%this.ageBuckets,this.ringBuckets[this.currentBucket].clear(),this.setDirty(),i.setTimeout((()=>this.rotate()),this.maxAgeSeconds/this.ageBuckets*1e3).unref()}add(e){this.setDirty(),this.ringBuckets[this.currentBucket].add(e)}snapshot(){if(!this.dirty&&this.lastSnapshot)return this.lastSnapshot;const e=this.ringBuckets.reduce(((e,t)=>e.concat(t.samples)),[]);e.sort(de);const t=e.length?e.reduce(((e,t)=>e+t),0)/e.length:null,s=e.length>1?e.reduce(((e,s)=>e+Math.pow(s-t,2)),0)/(e.length-1):null,r=s?Math.sqrt(s):null;return this.lastSnapshot={min:e.length?e[0]:null,mean:t,variance:s,stdDev:r,max:e.length?e[e.length-1]:null,quantiles:this.quantiles.reduce(((t,s)=>pe(t,s,e[Math.ceil(s*e.length)-1])),{})},this.clearDirty(),this.lastSnapshot}}class ge{constructor(){this.count=0,this.samples=[]}add(e){this.samples.push(e),this.count++}clear(){this.count=0,this.samples.length=0}}me.Bucket=ge,me.TimeWindowQuantiles=Ee;var fe=me;const{pick:_e}=O.default;var Te=class extends oe{constructor(e,t){super(e,t),this.type=q.TYPE_INFO}set(e,t,s){const r=this.hashingLabels(t);let i=this.values.get(r);return i?e!=i.value&&(i.value=e,i.timestamp=null==s?Date.now():s,this.changed(e,t,s)):(i={value:e,labels:_e(t,this.labelNames),timestamp:null==s?Date.now():s},this.values.set(r,i),this.changed(e,t,s)),i}reset(e,t){return this.set(null,e,t)}resetAll(e){this.values.forEach((t=>{t.value=null,t.timestamp=null==e?Date.now():e})),this.changed()}generateSnapshot(){return Array.from(this.values.keys()).map((e=>{const t=this.values.get(e);return{key:e,value:t.value,labels:t.labels,timestamp:t.timestamp}}))}};const{BrokerOptionsError:ve}=F,Se={Base:oe,Counter:he,Gauge:ce,Histogram:fe,Info:Te};var be=Object.assign(Se,{resolve:function(e){const t=function(e){if(!e)return null;let t=Object.keys(Se).find((t=>t.toLowerCase()==e.toLowerCase()));return t?Se[t]:void 0}(e);if(!t)throw new ve(`Invalid metric type '${e}'.`,{type:e});return t},register:function(e,t){Se[e]=t}});const{match:Oe,isString:ye}=ne;var Ie=class{constructor(e){this.opts=O.default.defaultsDeep(e,{includes:null,excludes:null,metricNamePrefix:null,metricNameSuffix:null,metricNameFormatter:null,labelNameFormatter:null}),ye(this.opts.includes)&&(this.opts.includes=[this.opts.includes]),ye(this.opts.excludes)&&(this.opts.excludes=[this.opts.excludes])}init(e){this.registry=e,this.broker=this.registry.broker,this.logger=this.registry.logger}stop(){return Promise.resolve()}matchMetricName(e){return!(Array.isArray(this.opts.includes)&&!this.opts.includes.some((t=>Oe(e,t))))&&!(Array.isArray(this.opts.excludes)&&!this.opts.excludes.every((t=>!Oe(e,t))))}formatMetricName(e){return e=(this.opts.metricNamePrefix?this.opts.metricNamePrefix:"")+e+(this.opts.metricNameSuffix?this.opts.metricNameSuffix:""),this.opts.metricNameFormatter?this.opts.metricNameFormatter(e):e}formatLabelName(e){return this.opts.labelNameFormatter?this.opts.labelNameFormatter(e):e}metricChanged(){}};const{isFunction:Re}=ne;var Ce=class extends Ie{constructor(e){super(e),this.opts=O.default.defaultsDeep(this.opts,{interval:5,logger:null,colors:!0,onlyChanges:!0}),this.opts.colors||(v.default.enabled=!1),this.lastChanges=new Set}init(e){super.init(e),this.opts.interval>0&&(this.timer=i.setInterval((()=>this.print()),1e3*this.opts.interval),this.timer.unref())}labelsToStr(e){const t=Object.keys(e);return 0==t.length?v.default.gray("{}"):v.default.gray("{")+t.map((t=>`${v.default.gray(this.formatLabelName(t))}: ${v.default.magenta(""+e[t])}`)).join(", ")+v.default.gray("}")}print(){let e=this.registry.list({includes:this.opts.includes,excludes:this.opts.excludes});this.opts.onlyChanges&&(e=e.filter((e=>this.lastChanges.has(e.name)))),0!=e.length&&(this.log(v.default.gray(`------------------- [ METRICS START (${e.length}) ] -------------------`)),e.forEach((e=>{if(this.log(v.default.cyan().bold(this.formatMetricName(e.name))+" "+v.default.gray("("+e.type+")")),0==e.values.size)this.log(v.default.gray("  <no values>"));else{const t=e.unit?v.default.gray(this.registry.pluralizeUnit(e.unit)):"";e.values.forEach((s=>{let r;const i=this.labelsToStr(s.labels);switch(e.type){case q.TYPE_COUNTER:case q.TYPE_GAUGE:case q.TYPE_INFO:r=""===s.value?v.default.grey("<empty string>"):v.default.green().bold(s.value),null!=s.rate&&(r=r+v.default.grey(" | Rate: ")+(null!=s.rate?v.default.green().bold(s.rate.toFixed(2)):"-"));break;case q.TYPE_HISTOGRAM:{const e=[];e.push("Count: "+s.count),s.buckets&&Object.keys(s.buckets).forEach((t=>{e.push(`${t}: ${null!=s.buckets[t]?s.buckets[t]:"-"}`)})),s.quantiles&&(e.push("Min: "+(null!=s.min?s.min.toFixed(2):"-")),e.push("Mean: "+(null!=s.mean?s.mean.toFixed(2):"-")),e.push("Var: "+(null!=s.variance?s.variance.toFixed(2):"-")),e.push("StdDev: "+(null!=s.stdDev?s.stdDev.toFixed(2):"-")),e.push("Max: "+(null!=s.max?s.max.toFixed(2):"-")),Object.keys(s.quantiles).forEach((t=>{e.push(`${t}: ${null!=s.quantiles[t]?s.quantiles[t].toFixed(2):"-"}`)}))),null!=s.rate&&e.push("Rate: "+(null!=s.rate?s.rate.toFixed(2):"-")),r=v.default.green().bold(e.join(" | "));break}}this.log(`  ${i}: ${r} ${t}`)}))}this.log("")})),this.log(v.default.gray(`-------------------- [ METRICS END (${e.length}) ] --------------------`)),this.lastChanges.clear())}log(...e){return Re(this.opts.logger)?this.opts.logger(...e):this.logger.info(...e)}metricChanged(e){this.matchMetricName(e.name)&&this.lastChanges.add(e.name)}},Le=!1;var Ae=class extends Ie{constructor(e){super(e),this.opts=O.default.defaultsDeep(this.opts,{eventName:"$metrics.snapshot",broadcast:!1,groups:null,onlyChanges:!1,interval:5}),this.lastChanges=new Set}init(e){super.init(e),this.opts.interval>0&&(this.timer=i.setInterval((()=>this.sendEvent()),1e3*this.opts.interval),this.timer.unref())}sendEvent(){let e=this.registry.list({includes:this.opts.includes,excludes:this.opts.excludes});this.opts.onlyChanges&&(e=e.filter((e=>this.lastChanges.has(e.name)))),0!=e.length&&(this.opts.broadcast?(this.logger.debug(`Send metrics.snapshot (${e.length} metrics) broadcast events.`),this.broker.broadcast(this.opts.eventName,e,{groups:this.opts.groups})):(this.logger.debug(`Send metrics.snapshot (${e.length} metrics) events.`),this.broker.emit(this.opts.eventName,e,{groups:this.opts.groups})),this.lastChanges.clear())}metricChanged(e){this.matchMetricName(e.name)&&this.lastChanges.add(e.name)}};const{isObject:Ne,isString:Pe}=ne,{BrokerOptionsError:Me}=F,ke={Base:Ie,Console:Ce,CSV:Le,Event:Ae,Datadog:Le,Prometheus:Le,StatsD:Le};function Ue(e){if(!e)return null;let t=Object.keys(ke).find((t=>t.toLowerCase()==e.toLowerCase()));return t?ke[t]:void 0}var De=Object.assign(ke,{resolve:function(e){if(e instanceof ke.Base)return e;if(Pe(e)){let t=Ue(e);if(t)return new t}else if(Ne(e)){let t=Ue(e.type);if(t)return new t(e.options);throw new Me(`Invalid metric reporter type '${e.type}'.`,{type:e.type})}throw new Me(`Invalid metric reporter type '${e}'.`,{type:e})},register:function(e,t){ke[e]=t}});let we,xe;try{we=Le}catch(e){}function He(){try{const e=Le();e&&(this.register({name:q.PROCESS_GC_TIME,type:q.TYPE_GAUGE,unit:q.UNIT_NANOSECONDS,description:"GC time"}),this.register({name:q.PROCESS_GC_TOTAL_TIME,type:q.TYPE_GAUGE,unit:q.UNIT_MILLISECONDS,description:"Total time of GC"}),this.register({name:q.PROCESS_GC_EXECUTED_TOTAL,type:q.TYPE_GAUGE,labelNames:["type"],unit:null,description:"Number of executed GC"}),e.on("stats",(e=>{this.set(q.PROCESS_GC_TIME,e.pause),this.increment(q.PROCESS_GC_TOTAL_TIME,null,e.pause/1e6),1==e.gctype&&this.increment(q.PROCESS_GC_EXECUTED_TOTAL,{type:"scavenge"}),2==e.gctype&&this.increment(q.PROCESS_GC_EXECUTED_TOTAL,{type:"marksweep"}),4==e.gctype&&this.increment(q.PROCESS_GC_EXECUTED_TOTAL,{type:"incremental"}),8==e.gctype&&this.increment(q.PROCESS_GC_EXECUTED_TOTAL,{type:"weakphantom"}),15==e.gctype&&(this.increment(q.PROCESS_GC_EXECUTED_TOTAL,{type:"scavenge"}),this.increment(q.PROCESS_GC_EXECUTED_TOTAL,{type:"marksweep"}),this.increment(q.PROCESS_GC_EXECUTED_TOTAL,{type:"incremental"}),this.increment(q.PROCESS_GC_EXECUTED_TOTAL,{type:"weakphantom"}))})))}catch(e){}}function $e(){try{xe=Le,xe&&(this.register({name:q.PROCESS_EVENTLOOP_LAG_MIN,type:q.TYPE_GAUGE,unit:q.UNIT_MILLISECONDS,description:"Minimum of event loop lag"}),this.register({name:q.PROCESS_EVENTLOOP_LAG_AVG,type:q.TYPE_GAUGE,unit:q.UNIT_MILLISECONDS,description:"Average of event loop lag"}),this.register({name:q.PROCESS_EVENTLOOP_LAG_MAX,type:q.TYPE_GAUGE,unit:q.UNIT_MILLISECONDS,description:"Maximum of event loop lag"}),this.register({name:q.PROCESS_EVENTLOOP_LAG_COUNT,type:q.TYPE_GAUGE,description:"Number of event loop lag samples."}))}catch(e){}}var Be={registerCommonMetrics:function(){this.logger.debug("Registering common metrics...");const e=this.register({name:q.PROCESS_ARGUMENTS,type:q.TYPE_INFO,labelNames:["index"],description:"Process arguments"});H.argv.map(((t,s)=>e.set(t,{index:s}))),this.register({name:q.PROCESS_PID,type:q.TYPE_INFO,description:"Process PID"}).set(H.pid),this.register({name:q.PROCESS_PPID,type:q.TYPE_INFO,description:"Process parent PID"}).set(H.ppid),this.register({name:q.PROCESS_MEMORY_HEAP_SIZE_TOTAL,type:q.TYPE_GAUGE,unit:q.UNIT_BYTE,description:"Process heap size"}),this.register({name:q.PROCESS_MEMORY_HEAP_SIZE_USED,type:q.TYPE_GAUGE,unit:q.UNIT_BYTE,description:"Process used heap size"}),this.register({name:q.PROCESS_MEMORY_RSS,type:q.TYPE_GAUGE,unit:q.UNIT_BYTE,description:"Process RSS size"}),this.register({name:q.PROCESS_MEMORY_EXTERNAL,type:q.TYPE_GAUGE,unit:q.UNIT_BYTE,description:"Process external memory size"}),this.register({name:q.PROCESS_MEMORY_HEAP_SPACE_SIZE_TOTAL,type:q.TYPE_GAUGE,labelNames:["space"],unit:q.UNIT_BYTE,description:"Process total heap space size"}),this.register({name:q.PROCESS_MEMORY_HEAP_SPACE_SIZE_USED,type:q.TYPE_GAUGE,labelNames:["space"],unit:q.UNIT_BYTE,description:"Process used heap space size"}),this.register({name:q.PROCESS_MEMORY_HEAP_SPACE_SIZE_AVAILABLE,type:q.TYPE_GAUGE,labelNames:["space"],unit:q.UNIT_BYTE,description:"Process available heap space size"}),this.register({name:q.PROCESS_MEMORY_HEAP_SPACE_SIZE_PHYSICAL,type:q.TYPE_GAUGE,labelNames:["space"],unit:q.UNIT_BYTE,description:"Process physical heap space size"}),this.register({name:q.PROCESS_MEMORY_HEAP_STAT_HEAP_SIZE_TOTAL,type:q.TYPE_GAUGE,unit:q.UNIT_BYTE,description:"Process heap stat size"}),this.register({name:q.PROCESS_MEMORY_HEAP_STAT_EXECUTABLE_SIZE_TOTAL,type:q.TYPE_GAUGE,unit:q.UNIT_BYTE,description:"Process heap stat executable size"}),this.register({name:q.PROCESS_MEMORY_HEAP_STAT_PHYSICAL_SIZE_TOTAL,type:q.TYPE_GAUGE,unit:q.UNIT_BYTE,description:"Process heap stat physical size"}),this.register({name:q.PROCESS_MEMORY_HEAP_STAT_AVAILABLE_SIZE_TOTAL,type:q.TYPE_GAUGE,unit:q.UNIT_BYTE,description:"Process heap stat available size"}),this.register({name:q.PROCESS_MEMORY_HEAP_STAT_USED_HEAP_SIZE,type:q.TYPE_GAUGE,unit:q.UNIT_BYTE,description:"Process heap stat used size"}),this.register({name:q.PROCESS_MEMORY_HEAP_STAT_HEAP_SIZE_LIMIT,type:q.TYPE_GAUGE,unit:q.UNIT_BYTE,description:"Process heap stat size limit"}),this.register({name:q.PROCESS_MEMORY_HEAP_STAT_MALLOCATED_MEMORY,type:q.TYPE_GAUGE,unit:q.UNIT_BYTE,description:"Process heap stat mallocated size"}),this.register({name:q.PROCESS_MEMORY_HEAP_STAT_PEAK_MALLOCATED_MEMORY,type:q.TYPE_GAUGE,unit:q.UNIT_BYTE,description:"Peak of process heap stat mallocated size"}),this.register({name:q.PROCESS_MEMORY_HEAP_STAT_ZAP_GARBAGE,type:q.TYPE_GAUGE,description:"Process heap stat zap garbage"}),this.register({name:q.PROCESS_UPTIME,type:q.TYPE_GAUGE,unit:q.UNIT_SECONDS,description:"Process uptime"}),this.register({name:q.PROCESS_INTERNAL_ACTIVE_HANDLES,type:q.TYPE_GAUGE,unit:q.UNIT_HANDLE,description:"Number of active process handlers"}),this.register({name:q.PROCESS_INTERNAL_ACTIVE_REQUESTS,type:q.TYPE_GAUGE,unit:q.UNIT_REQUEST,description:"Number of active process requests"}),this.register({name:q.PROCESS_VERSIONS_NODE,type:q.TYPE_INFO,description:"Node version"}).set(H.versions.node),this.register({name:q.OS_MEMORY_FREE,type:q.TYPE_GAUGE,unit:q.UNIT_BYTE,description:"OS free memory size"}),this.register({name:q.OS_MEMORY_USED,type:q.TYPE_GAUGE,unit:q.UNIT_BYTE,description:"OS used memory size"}),this.register({name:q.OS_MEMORY_TOTAL,type:q.TYPE_GAUGE,unit:q.UNIT_BYTE,description:"OS total memory size"}),this.register({name:q.OS_UPTIME,type:q.TYPE_GAUGE,unit:q.UNIT_SECONDS,description:"OS uptime"}),this.register({name:q.OS_TYPE,type:q.TYPE_INFO,description:"OS type"}).set(Q.type()),this.register({name:q.OS_RELEASE,type:q.TYPE_INFO,description:"OS release"}).set(Q.release()),this.register({name:q.OS_HOSTNAME,type:q.TYPE_INFO,description:"Hostname"}).set(Q.hostname()),this.register({name:q.OS_ARCH,type:q.TYPE_INFO,description:"OS architecture"}).set(Q.arch()),this.register({name:q.OS_PLATFORM,type:q.TYPE_INFO,description:"OS platform"}).set(Q.platform());const t=function(){try{return Q.userInfo()}catch(e){return{}}}();this.register({name:q.OS_USER_UID,type:q.TYPE_INFO,description:"UID"}).set(t.uid),this.register({name:q.OS_USER_GID,type:q.TYPE_INFO,description:"GID"}).set(t.gid),this.register({name:q.OS_USER_USERNAME,type:q.TYPE_INFO,description:"Username"}).set(t.username),this.register({name:q.OS_USER_HOMEDIR,type:q.TYPE_INFO,description:"User's home directory"}).set(t.homedir),this.register({name:q.OS_NETWORK_ADDRESS,type:q.TYPE_INFO,labelNames:["interface","family"],description:"Network address"}),this.register({name:q.OS_NETWORK_MAC,type:q.TYPE_INFO,labelNames:["interface","family"],description:"MAC address"}),this.register({name:q.OS_DATETIME_UNIX,type:q.TYPE_GAUGE,description:"Current datetime in Unix format"}),this.register({name:q.OS_DATETIME_ISO,type:q.TYPE_INFO,description:"Current datetime in ISO string"}),this.register({name:q.OS_DATETIME_UTC,type:q.TYPE_INFO,description:"Current UTC datetime"}),this.register({name:q.OS_DATETIME_TZ_OFFSET,type:q.TYPE_GAUGE,description:"Timezone offset"}),this.register({name:q.OS_CPU_LOAD_1,type:q.TYPE_GAUGE,description:"CPU load1"}),this.register({name:q.OS_CPU_LOAD_5,type:q.TYPE_GAUGE,description:"CPU load5"}),this.register({name:q.OS_CPU_LOAD_15,type:q.TYPE_GAUGE,description:"CPU load15"}),this.register({name:q.OS_CPU_UTILIZATION,type:q.TYPE_GAUGE,description:"CPU utilization"}),this.register({name:q.OS_CPU_USER,type:q.TYPE_GAUGE,description:"CPU user time"}),this.register({name:q.OS_CPU_SYSTEM,type:q.TYPE_GAUGE,description:"CPU system time"}),this.register({name:q.OS_CPU_TOTAL,type:q.TYPE_GAUGE,unit:q.UNIT_CPU,description:"Number of CPUs"}),this.register({name:q.OS_CPU_INFO_MODEL,type:q.TYPE_INFO,labelNames:["index"],description:"CPU model"}),this.register({name:q.OS_CPU_INFO_SPEED,type:q.TYPE_GAUGE,labelNames:["index"],unit:q.UNIT_GHZ,description:"CPU speed"}),this.register({name:q.OS_CPU_INFO_TIMES_USER,type:q.TYPE_GAUGE,labelNames:["index"],description:"CPU user time"}),this.register({name:q.OS_CPU_INFO_TIMES_SYS,type:q.TYPE_GAUGE,labelNames:["index"],description:"CPU system time"}),He.call(this),$e.call(this),this.logger.debug(`Registered ${this.store.size} common metrics.`)},updateCommonMetrics:function(){this.logger.debug("Update common metric values...");const e=this.timer(),t=H.memoryUsage();if(this.set(q.PROCESS_MEMORY_HEAP_SIZE_TOTAL,t.heapTotal),this.set(q.PROCESS_MEMORY_HEAP_SIZE_USED,t.heapUsed),this.set(q.PROCESS_MEMORY_RSS,t.rss),this.set(q.PROCESS_MEMORY_EXTERNAL,t.external),we&&we.getHeapSpaceStatistics){we.getHeapSpaceStatistics().forEach((e=>{const t=e.space_name;this.set(q.PROCESS_MEMORY_HEAP_SPACE_SIZE_TOTAL,e.space_size,{space:t}),this.set(q.PROCESS_MEMORY_HEAP_SPACE_SIZE_USED,e.space_used_size,{space:t}),this.set(q.PROCESS_MEMORY_HEAP_SPACE_SIZE_AVAILABLE,e.space_available_size,{space:t}),this.set(q.PROCESS_MEMORY_HEAP_SPACE_SIZE_PHYSICAL,e.physical_space_size,{space:t})}))}if(we&&we.getHeapStatistics){const e=we.getHeapStatistics();this.set(q.PROCESS_MEMORY_HEAP_STAT_HEAP_SIZE_TOTAL,e.total_heap_size),this.set(q.PROCESS_MEMORY_HEAP_STAT_EXECUTABLE_SIZE_TOTAL,e.total_heap_size_executable),this.set(q.PROCESS_MEMORY_HEAP_STAT_PHYSICAL_SIZE_TOTAL,e.total_physical_size),this.set(q.PROCESS_MEMORY_HEAP_STAT_AVAILABLE_SIZE_TOTAL,e.total_available_size),this.set(q.PROCESS_MEMORY_HEAP_STAT_USED_HEAP_SIZE,e.used_heap_size),this.set(q.PROCESS_MEMORY_HEAP_STAT_HEAP_SIZE_LIMIT,e.heap_size_limit),this.set(q.PROCESS_MEMORY_HEAP_STAT_MALLOCATED_MEMORY,e.malloced_memory),this.set(q.PROCESS_MEMORY_HEAP_STAT_PEAK_MALLOCATED_MEMORY,e.peak_malloced_memory),this.set(q.PROCESS_MEMORY_HEAP_STAT_ZAP_GARBAGE,e.does_zap_garbage)}this.set(q.PROCESS_UPTIME,H.uptime()),this.set(q.PROCESS_INTERNAL_ACTIVE_HANDLES,H._getActiveHandles().length),this.set(q.PROCESS_INTERNAL_ACTIVE_REQUESTS,H._getActiveRequests().length);const s=Q.freemem(),r=Q.totalmem(),n=r-s;this.set(q.OS_MEMORY_FREE,s),this.set(q.OS_MEMORY_USED,n),this.set(q.OS_MEMORY_TOTAL,r),this.set(q.OS_UPTIME,Q.uptime()),this.set(q.OS_TYPE,Q.type()),this.set(q.OS_RELEASE,Q.release()),this.set(q.OS_HOSTNAME,Q.hostname()),this.set(q.OS_ARCH,Q.arch()),this.set(q.OS_PLATFORM,Q.platform());const o=(()=>{const e=[],t=[],s=Q.networkInterfaces();for(let r in s)for(let i in s[r]){const n=s[r][i];n.internal?t.push({f:n,iface:r}):e.push({f:n,iface:r})}return e.length>0?e:t})();for(let{f:e,iface:t}of o)this.set(q.OS_NETWORK_ADDRESS,e.address,{interface:t,family:e.family}),this.set(q.OS_NETWORK_MAC,e.mac,{interface:t,family:e.family});const a=new Date;this.set(q.OS_DATETIME_UNIX,a.valueOf()),this.set(q.OS_DATETIME_ISO,a.toISOString()),this.set(q.OS_DATETIME_UTC,a.toUTCString()),this.set(q.OS_DATETIME_TZ_OFFSET,a.getTimezoneOffset());const l=Q.loadavg();if(this.set(q.OS_CPU_LOAD_1,l[0]),this.set(q.OS_CPU_LOAD_5,l[1]),this.set(q.OS_CPU_LOAD_15,l[2]),xe&&xe.sense){const e=xe.sense();this.set(q.PROCESS_EVENTLOOP_LAG_MIN,e.min),this.set(q.PROCESS_EVENTLOOP_LAG_AVG,e.num?e.sum/e.num:0),this.set(q.PROCESS_EVENTLOOP_LAG_MAX,e.max),this.set(q.PROCESS_EVENTLOOP_LAG_COUNT,e.num)}const c=e();return this.broker.Promise.resolve().then((()=>function(e=100){return new Promise(((t,s)=>{try{const r=Q.cpus().map((e=>e.times));i.setTimeout((()=>{try{const n=Q.cpus().map((e=>e.times));i.setTimeout((()=>{try{const e=Q.cpus().map((e=>e.times)),s=[];for(let t=0;t<r.length;t++){const i=r[t].idle,o=r[t].idle+r[t].user+r[t].nice+r[t].sys+r[t].irq,a=n[t].idle,l=n[t].idle+n[t].user+n[t].nice+n[t].sys+n[t].irq,c=e[t].idle,h=(1-(a-i)/(l-o)+(1-(c-a)/(e[t].idle+e[t].user+e[t].nice+e[t].sys+e[t].irq-l)))/2*100;s.push(h)}t({avg:s.reduce(((e,t)=>e+t),0)/s.length,usages:s})}catch(e){s(e)}}),e)}catch(e){s(e)}}),e)}catch(e){s(e)}}))}().then((e=>{this.set(q.OS_CPU_UTILIZATION,e.avg);try{const e=Q.cpus();this.set(q.OS_CPU_TOTAL,e.length),this.set(q.OS_CPU_USER,e.reduce(((e,t)=>e+t.times.user),0)),this.set(q.OS_CPU_SYSTEM,e.reduce(((e,t)=>e+t.times.sys),0)),e.forEach(((e,t)=>{this.set(q.OS_CPU_INFO_MODEL,e.model,{index:t}),this.set(q.OS_CPU_INFO_SPEED,e.speed,{index:t}),this.set(q.OS_CPU_INFO_TIMES_USER,e.times.user,{index:t}),this.set(q.OS_CPU_INFO_TIMES_SYS,e.times.sys,{index:t})}))}catch(e){}})))).catch((()=>{})).then((()=>{this.logger.debug(`Collected common metric values in ${c.toFixed(3)} msec.`)}))}};const{match:Ge,isFunction:Fe,isPlainObject:qe,isString:Ye}=ne,{registerCommonMetrics:Ve,updateCommonMetrics:je}=Be,Ke=/^[a-zA-Z_][a-zA-Z0-9-_:.]*$/,ze=/^[a-zA-Z_][a-zA-Z0-9-_.]*$/;var Qe={METRIC:q,MetricRegistry:class{constructor(e,t){this.broker=e,this.logger=e.getLogger("metrics"),this.dirty=!0,!0!==t&&!1!==t||(t={enabled:t}),this.opts=O.default.defaultsDeep({},t,{enabled:!0,collectProcessMetrics:"test"!==H.env.NODE_ENV,collectInterval:5,reporter:!1,defaultBuckets:[1,5,10,25,50,100,250,500,1e3,2500,5e3,1e4],defaultQuantiles:[.5,.9,.95,.99,.999],defaultMaxAgeSeconds:60,defaultAgeBuckets:10,defaultAggregator:"sum"}),this.store=new Map,this.opts.enabled&&this.logger.info("Metrics: Enabled")}init(){if(this.opts.enabled){if(this.opts.reporter){const e=Array.isArray(this.opts.reporter)?this.opts.reporter:[this.opts.reporter];this.reporter=O.default.compact(e).map((e=>{const t=De.resolve(e);return t.init(this),t}));const t=this.reporter.map((e=>this.broker.getConstructorName(e)));this.logger.info(`Metric reporter${t.length>1?"s":""}: ${t.join(", ")}`)}this.opts.collectProcessMetrics&&(this.collectTimer=i.setInterval((()=>{je.call(this)}),1e3*this.opts.collectInterval),this.collectTimer.unref(),Ve.call(this),je.call(this))}}stop(){if(this.collectTimer&&clearInterval(this.collectTimer),this.reporter)return this.broker.Promise.all(this.reporter.map((e=>e.stop())))}isEnabled(){return this.opts.enabled}register(e){if(!qe(e))throw new Error("Wrong argument. Must be an Object.");if(!e.type)throw new Error("The metric 'type' property is mandatory.");if(!e.name)throw new Error("The metric 'name' property is mandatory.");if(!Ke.test(e.name))throw new Error("The metric 'name' is not valid: "+e.name);Array.isArray(e.labelNames)&&e.labelNames.forEach((t=>{if(!ze.test(t))throw new Error(`The '${e.name}' metric label name is not valid: ${t}`)}));const t=be.resolve(e.type);if(!this.opts.enabled)return null;const s=new t(e,this);return this.store.set(e.name,s),s}hasMetric(e){return this.store.has(e)}getMetric(e){const t=this.store.get(e);return t||null}increment(e,t,s=1,r){if(!this.opts.enabled)return null;const i=this.getMetric(e);if(!Fe(i.increment))throw new Error("Invalid metric type. Incrementing works only with counter & gauge metric types.");return i.increment(t,s,r)}decrement(e,t,s=1,r){if(!this.opts.enabled)return null;const i=this.getMetric(e);if(!Fe(i.decrement))throw new Error("Invalid metric type. Decrementing works only with gauge metric type.");return i.decrement(t,s,r)}set(e,t,s,r){if(!this.opts.enabled)return null;const i=this.getMetric(e);if(!Fe(i.set))throw new Error("Invalid metric type. Value setting works only with counter, gauge & info metric types.");return i.set(t,s,r)}observe(e,t,s,r){if(!this.opts.enabled)return null;const i=this.getMetric(e);if(!Fe(i.observe))throw new Error("Invalid metric type. Observing works only with histogram metric type.");return i.observe(t,s,r)}reset(e,t,s){if(!this.opts.enabled)return null;this.getMetric(e).reset(t,s)}resetAll(e,t){if(!this.opts.enabled)return null;this.getMetric(e).resetAll(t)}timer(e,t,s){let r;if(e&&this.opts.enabled&&(r=this.getMetric(e),!Fe(r.observe)&&!Fe(r.set)))throw new Error("Invalid metric type. Timing works only with histogram or gauge metric types");const i=H.hrtime();return()=>{const e=H.hrtime(i),n=1e3*(e[0]+e[1]/1e9);return r&&(r.type==q.TYPE_HISTOGRAM?r.observe(n,t,s):r.type==q.TYPE_GAUGE&&r.set(n,t,s)),n}}changed(e,t,s,r){this.dirty=!0,Array.isArray(this.reporter)&&this.reporter.forEach((i=>i.metricChanged(e,t,s,r)))}list(e){const t=[],s=null!=(e=e||{}).types?Ye(e.types)?[e.types]:e.types:null,r=null!=e.includes?Ye(e.includes)?[e.includes]:e.includes:null,i=null!=e.excludes?Ye(e.excludes)?[e.excludes]:e.excludes:null;return this.store.forEach((e=>{s&&!s.some((t=>e.type==t))||r&&!r.some((t=>Ge(e.name,t)))||i&&!i.every((t=>!Ge(e.name,t)))||t.push(e.toObject())})),t}pluralizeUnit(e){switch(e){case q.UNIT_GHZ:return e}return e+"s"}},BaseMetric:oe,CounterMetric:he,GaugeMetric:ce,HistrogramMetric:fe,InfoMetric:Te,Reporters:De};const{Packet:Ze}=G,{Transform:We}=C.default,{METRIC:Je}=Qe;var Xe=class{constructor(e,t,s){this.broker=e,this.Promise=e.Promise,this.logger=e.getLogger("transit"),this.nodeID=e.nodeID,this.metrics=e.metrics,this.instanceID=e.instanceID,this.tx=t,this.opts=s,this.discoverer=e.registry.discoverer,this.pendingRequests=new Map,this.pendingReqStreams=new Map,this.pendingResStreams=new Map,this.stat={packets:{sent:{count:0,bytes:0},received:{count:0,bytes:0}}},this.connected=!1,this.disconnecting=!1,this.isReady=!1;const r=(e,t)=>this.messageHandler(e,t);this.publish=this.broker.wrapMethod("transitPublish",this.publish,this),this.messageHandler=this.broker.wrapMethod("transitMessageHandler",this.messageHandler,this),this.tx&&(this.tx.init(this,r,this.afterConnect.bind(this)),this.tx.send=this.broker.wrapMethod("transporterSend",this.tx.send,this.tx),this.tx.receive=this.broker.wrapMethod("transporterReceive",this.tx.receive,this.tx,{reverse:!0})),this.__connectResolve=null,this.registerMoleculerMetrics()}registerMoleculerMetrics(){this.broker.isMetricsEnabled()&&(this.metrics.register({name:Je.MOLECULER_TRANSIT_READY,type:Je.TYPE_GAUGE,description:"Transit is ready"}).set(0),this.metrics.register({name:Je.MOLECULER_TRANSIT_CONNECTED,type:Je.TYPE_GAUGE,description:"Transit is connected"}).set(0),this.metrics.register({name:Je.MOLECULER_TRANSIT_PONG_TIME,type:Je.TYPE_GAUGE,labelNames:["targetNodeID"],description:"Ping time"}),this.metrics.register({name:Je.MOLECULER_TRANSIT_PONG_SYSTIME_DIFF,type:Je.TYPE_GAUGE,labelNames:["targetNodeID"],description:"System time difference between nodes"}),this.metrics.register({name:Je.MOLECULER_TRANSIT_ORPHAN_RESPONSE_TOTAL,type:Je.TYPE_COUNTER,description:"Number of orphan responses"}))}afterConnect(e){return this.Promise.resolve().then((()=>e?this.discoverer.sendLocalNodeInfo():this.makeSubscriptions())).then((()=>this.discoverer.discoverAllNodes())).delay(500).then((()=>(this.connected=!0,this.metrics.set(Je.MOLECULER_TRANSIT_CONNECTED,1),this.broker.broadcastLocal("$transporter.connected",{wasReconnect:!!e}),this.__connectResolve&&(this.__connectResolve(),this.__connectResolve=null),null)))}connect(){return this.logger.info("Connecting to the transporter..."),new this.Promise((e=>{this.__connectResolve=e;const t=()=>{let e=!1;const s=s=>{this.disconnecting||e||(this.logger.warn("Connection is failed.",s&&s.message||"Unknown error"),this.logger.debug(s),this.opts.disableReconnect||(e=!0,i.setTimeout((()=>{this.logger.info("Reconnecting..."),t()}),5e3)))};this.tx.connect(s).catch(s)};t()}))}disconnect(){return this.connected=!1,this.isReady=!1,this.disconnecting=!0,this.metrics.set(Je.MOLECULER_TRANSIT_CONNECTED,0),this.broker.broadcastLocal("$transporter.disconnected",{graceFul:!0}),this.Promise.resolve().then((()=>{if(this.tx.connected)return this.discoverer.localNodeDisconnected().then((()=>this.tx.disconnect()))})).then((()=>this.disconnecting=!1))}ready(){if(this.connected)return this.isReady=!0,this.metrics.set(Je.MOLECULER_TRANSIT_READY,1),this.discoverer.localNodeReady()}sendDisconnectPacket(){return this.publish(new Ze(G.PACKET_DISCONNECT)).catch((e=>this.logger.debug("Unable to send DISCONNECT packet.",e)))}makeSubscriptions(){return this.subscribing=this.tx.makeSubscriptions([{cmd:G.PACKET_EVENT,nodeID:this.nodeID},{cmd:G.PACKET_REQUEST,nodeID:this.nodeID},{cmd:G.PACKET_RESPONSE,nodeID:this.nodeID},{cmd:G.PACKET_DISCOVER},{cmd:G.PACKET_DISCOVER,nodeID:this.nodeID},{cmd:G.PACKET_INFO},{cmd:G.PACKET_INFO,nodeID:this.nodeID},{cmd:G.PACKET_DISCONNECT},{cmd:G.PACKET_HEARTBEAT},{cmd:G.PACKET_PING},{cmd:G.PACKET_PING,nodeID:this.nodeID},{cmd:G.PACKET_PONG,nodeID:this.nodeID}]).then((()=>{this.subscribing=null})),this.subscribing}messageHandler(e,t){try{const s=t.payload;if(!s)throw new F.MoleculerServerError("Missing response payload.",500,"MISSING_PAYLOAD");if(s.ver!==this.broker.PROTOCOL_VERSION&&!this.opts.disableVersionCheck)throw new F.ProtocolVersionMismatchError({nodeID:s.sender,actual:this.broker.PROTOCOL_VERSION,received:s.ver});if(s.sender===this.nodeID){if(e===G.PACKET_INFO&&s.instanceID!==this.instanceID)return this.broker.fatal("ServiceBroker has detected a nodeID conflict, use unique nodeIDs. ServiceBroker stopped.");if(e!==G.PACKET_EVENT&&e!==G.PACKET_REQUEST&&e!==G.PACKET_RESPONSE)return}return e===G.PACKET_REQUEST?this.requestHandler(s):(e===G.PACKET_RESPONSE?this.responseHandler(s):e===G.PACKET_EVENT?this.eventHandler(s):e===G.PACKET_DISCOVER?this.discoverer.sendLocalNodeInfo(s.sender):e===G.PACKET_INFO?this.discoverer.processRemoteNodeInfo(s.sender,s):e===G.PACKET_DISCONNECT?this.discoverer.remoteNodeDisconnected(s.sender,!1):e===G.PACKET_HEARTBEAT?this.discoverer.heartbeatReceived(s.sender,s):e===G.PACKET_PING?this.sendPong(s):e===G.PACKET_PONG&&this.processPong(s),!0)}catch(s){this.logger.error(s,e,t)}return!1}eventHandler(e){if(this.logger.debug(`Event '${e.event}' received from '${e.sender}' node`+(e.groups?` in '${e.groups.join(", ")}' group(s)`:"")+"."),!this.broker.started)return void this.logger.warn(`Incoming '${e.event}' event from '${e.sender}' node is dropped, because broker is stopped.`);const t=new this.broker.ContextFactory(this.broker);t.id=e.id,t.eventName=e.event,t.setParams(e.data,this.broker.options.contextParamsCloning),t.eventGroups=e.groups,t.eventType=e.broadcast?"broadcast":"emit",t.meta=e.meta||{},t.level=e.level,t.tracing=!!e.tracing,t.parentID=e.parentID,t.requestID=e.requestID,t.caller=e.caller,t.nodeID=e.sender,this.broker.emitLocalServices(t)}requestHandler(e){this.logger.debug(`<= Request '${e.action}' received from '${e.sender}' node.`);try{if(!this.broker.started)throw this.logger.warn(`Incoming '${e.action}' request from '${e.sender}' node is dropped because broker is stopped.`),new F.ServiceNotAvailableError({action:e.action,nodeID:this.nodeID});let t;if(void 0!==e.stream&&(t=this._handleIncomingRequestStream(e),null===t))return this.Promise.resolve();const s=this.broker._getLocalActionEndpoint(e.action),r=new this.broker.ContextFactory(this.broker);r.setEndpoint(s),r.id=e.id,r.setParams(t||e.params,this.broker.options.contextParamsCloning),r.parentID=e.parentID,r.requestID=e.requestID,r.caller=e.caller,r.meta=e.meta||{},r.level=e.level,r.tracing=e.tracing,r.nodeID=e.sender,null!=e.timeout&&(r.options.timeout=e.timeout);const i=s.action.handler(r);return i.ctx=r,i.then((t=>this.sendResponse(e.sender,e.id,r.meta,t,null))).catch((t=>this.sendResponse(e.sender,e.id,r.meta,null,t)))}catch(t){return this.sendResponse(e.sender,e.id,e.meta,null,t)}}_handleIncomingRequestStream(e){let t=this.pendingReqStreams.get(e.id),s=!1;if(!e.stream&&!t)return!1;if(t||(s=!0,this.logger.debug(`<= New stream is received from '${e.sender}'. Seq: ${e.seq}`),t=new We({objectMode:e.meta&&e.meta.$streamObjectMode,transform:function(e,t,s){return this.push(e),s()}}),t.$prevSeq=-1,t.$pool=new Map,this.pendingReqStreams.set(e.id,t)),e.seq>t.$prevSeq+1)return this.logger.info(`Put the chunk into pool (size: ${t.$pool.size}). Seq: ${e.seq}`),t.$pool.set(e.seq,e),s?t:null;if(t.$prevSeq=e.seq,t.$prevSeq>0){if(!e.stream)return e.meta&&e.meta.$streamError&&t.emit("error",this._createErrFromPayload(e.meta.$streamError,e.sender)),this.logger.debug(`<= Stream closing is received from '${e.sender}'. Seq: ${e.seq}`),t.end(),this.pendingReqStreams.delete(e.id),null;this.logger.debug(`<= Stream chunk is received from '${e.sender}'. Seq: ${e.seq}`),t.write("Buffer"===e.params.type?l.Buffer.from(e.params.data):e.params)}if(t.$pool.size>0){this.logger.warn("Has stored packets. Size: "+t.$pool.size);const e=t.$prevSeq+1,s=t.$pool.get(e);s&&(t.$pool.delete(e),setImmediate((()=>this.requestHandler(s))))}return s?t:null}_createErrFromPayload(e,t){let s=F.recreateError(e);return s||(s=new Error(e.message),s.name=e.name,s.code=e.code,s.type=e.type,s.data=e.data),s.retryable=e.retryable,s.nodeID=e.nodeID||t,e.stack&&(s.stack=e.stack),s}responseHandler(e){const t=e.id,s=this.pendingRequests.get(t);if(null==s)return this.logger.debug("Orphan response is received. Maybe the request is timed out earlier. ID:",e.id,", Sender:",e.sender),void this.metrics.increment(Je.MOLECULER_TRANSIT_ORPHAN_RESPONSE_TOTAL);this.logger.debug(`<= Response '${s.action.name}' is received from '${e.sender}'.`),s.ctx.nodeID=e.sender,Object.assign(s.ctx.meta||{},e.meta||{}),null!=e.stream&&this._handleIncomingResponseStream(e,s)||(this.removePendingRequest(t),e.success?s.resolve(e.data):s.reject(this._createErrFromPayload(e.error,e.sender)))}_handleIncomingResponseStream(e,t){let s=this.pendingResStreams.get(e.id);if(!s&&!e.stream)return!1;if(s||(this.logger.debug(`<= New stream is received from '${e.sender}'. Seq: ${e.seq}`),s=new We({objectMode:e.meta&&e.meta.$streamObjectMode,transform:function(e,t,s){return this.push(e),s()}}),s.$prevSeq=-1,s.$pool=new Map,this.pendingResStreams.set(e.id,s),t.resolve(s)),e.seq>s.$prevSeq+1)return this.logger.info(`Put the chunk into pool (size: ${s.$pool.size}). Seq: ${e.seq}`),s.$pool.set(e.seq,e),!0;if(s.$prevSeq=e.seq,s.$prevSeq>0){if(!e.stream)return e.success||s.emit("error",this._createErrFromPayload(e.error,e.sender)),this.logger.debug(`<= Stream closing is received from '${e.sender}'. Seq: ${e.seq}`),s.end(),this.removePendingRequest(e.id),!0;this.logger.debug(`<= Stream chunk is received from '${e.sender}'. Seq: ${e.seq}`),s.write("Buffer"===e.data.type?l.Buffer.from(e.data.data):e.data)}if(s.$pool.size>0){this.logger.warn("Has stored packets. Size: "+s.$pool.size);const e=s.$prevSeq+1,t=s.$pool.get(e);t&&(s.$pool.delete(e),setImmediate((()=>this.responseHandler(t))))}return!0}request(e){return this.opts.maxQueueSize&&this.pendingRequests.size>=this.opts.maxQueueSize?this.Promise.reject(new F.QueueIsFullError({action:e.action.name,nodeID:this.nodeID,size:this.pendingRequests.size,limit:this.opts.maxQueueSize})):new this.Promise(((t,s)=>this._sendRequest(e,t,s)))}_sendRequest(e,t,s){const r=e.params&&!0===e.params.readable&&"function"==typeof e.params.on&&"function"==typeof e.params.pipe,i={action:e.action,nodeID:e.nodeID,ctx:e,resolve:t,reject:s,stream:r},n={id:e.id,action:e.action.name,params:r?null:e.params,meta:e.meta,timeout:e.options.timeout,level:e.level,tracing:e.tracing,parentID:e.parentID,requestID:e.requestID,caller:e.caller,stream:r};n.stream&&((!0===e.params.readableObjectMode||e.params._readableState&&!0===e.params._readableState.objectMode)&&(n.meta=n.meta||{},n.meta.$streamObjectMode=!0),n.seq=0);const o=new Ze(G.PACKET_REQUEST,e.nodeID,n),a=e.nodeID?`'${e.nodeID}'`:"someone";this.logger.debug(`=> Send '${e.action.name}' request to ${a} node.`);const c=t=>this.logger.error(`Unable to send '${e.action.name}' request to ${a} node.`,t);return this.pendingRequests.set(e.id,i),this.publish(o).then((()=>{if(r){n.meta={},(!0===e.params.readableObjectMode||e.params._readableState&&!0===e.params._readableState.objectMode)&&(n.meta.$streamObjectMode=!0);const t=e.params;t.on("data",(s=>{t.pause();const r=[];if(s instanceof l.Buffer&&this.opts.maxChunkSize>0&&s.length>this.opts.maxChunkSize){let e=s.length,t=0;for(;t<e;)r.push(s.slice(t,t+=this.opts.maxChunkSize))}else r.push(s);for(const t of r){const s=Object.assign({},n);s.seq=++n.seq,s.stream=!0,s.params=t,this.logger.debug(`=> Send stream chunk to ${a} node. Seq: ${s.seq}`),this.publish(new Ze(G.PACKET_REQUEST,e.nodeID,s)).catch(c)}t.resume()})),t.on("end",(()=>{const t=Object.assign({},n);return t.seq=++n.seq,t.params=null,t.stream=!1,this.logger.debug(`=> Send stream closing to ${a} node. Seq: ${t.seq}`),this.publish(new Ze(G.PACKET_REQUEST,e.nodeID,t)).catch(c)})),t.on("error",(t=>{const s=Object.assign({},n);return s.seq=++n.seq,s.stream=!1,s.meta.$streamError=this._createPayloadErrorField(t),s.params=null,this.logger.debug(`=> Send stream error to ${a} node.`,s.meta.$streamError),this.publish(new Ze(G.PACKET_REQUEST,e.nodeID,s)).catch(c)}))}})).catch((e=>{c(e),s(e)}))}sendEvent(e){const t=e.eventGroups;return e.endpoint?this.logger.debug(`=> Send '${e.eventName}' event to '${e.nodeID}' node`+(t?` in '${t.join(", ")}' group(s)`:"")+"."):this.logger.debug(`=> Send '${e.eventName}' event to '${t.join(", ")}' group(s).`),this.publish(new Ze(G.PACKET_EVENT,e.endpoint?e.nodeID:null,{id:e.id,event:e.eventName,data:e.params,groups:t,broadcast:"broadcast"==e.eventType,meta:e.meta,level:e.level,tracing:e.tracing,parentID:e.parentID,requestID:e.requestID,caller:e.caller,needAck:e.needAck})).catch((t=>this.logger.error(`Unable to send '${e.eventName}' event to groups.`,t)))}removePendingRequest(e){this.pendingRequests.delete(e),this.pendingReqStreams.delete(e),this.pendingResStreams.delete(e)}removePendingRequestByNodeID(e){this.logger.debug(`Remove pending requests of '${e}' node.`),this.pendingRequests.forEach(((t,s)=>{t.nodeID===e&&(this.pendingRequests.delete(s),t.reject(new F.RequestRejectedError({action:t.action.name,nodeID:t.nodeID})),this.pendingReqStreams.delete(s),this.pendingResStreams.delete(s))}))}_createPayloadErrorField(e){return{name:e.name,message:e.message,nodeID:e.nodeID||this.nodeID,code:e.code,type:e.type,retryable:e.retryable,stack:e.stack,data:e.data}}sendResponse(e,t,s,r,i){const n={id:t,meta:s,success:null==i,data:r};i&&(n.error=this._createPayloadErrorField(i));const o=s=>this.logger.error(`Unable to send '${t}' response to '${e}' node.`,s);if(r&&!0===r.readable&&"function"==typeof r.on&&"function"==typeof r.pipe){n.stream=!0,(!0===r.readableObjectMode||r._readableState&&!0===r._readableState.objectMode)&&(n.meta=n.meta||{},n.meta.$streamObjectMode=!0),n.seq=0;const t=r;return t.pause(),t.on("data",(s=>{t.pause();const r=[];if(s instanceof l.Buffer&&this.opts.maxChunkSize>0&&s.length>this.opts.maxChunkSize){let e=s.length,t=0;for(;t<e;)r.push(s.slice(t,t+=this.opts.maxChunkSize))}else r.push(s);for(const t of r){const s=Object.assign({},n);s.seq=++n.seq,s.stream=!0,s.data=t,this.logger.debug(`=> Send stream chunk to ${e} node. Seq: ${s.seq}`),this.publish(new Ze(G.PACKET_RESPONSE,e,s)).catch(o)}t.resume()})),t.on("end",(()=>{const t=Object.assign({},n);return t.stream=!1,t.seq=++n.seq,t.data=null,this.logger.debug(`=> Send stream closing to ${e} node. Seq: ${t.seq}`),this.publish(new Ze(G.PACKET_RESPONSE,e,t)).catch(o)})),t.on("error",(t=>{const s=Object.assign({},n);return s.stream=!1,s.seq=++n.seq,t&&(s.success=!1,s.error=this._createPayloadErrorField(t)),this.logger.debug(`=> Send stream error to ${e} node.`,s.error),this.publish(new Ze(G.PACKET_RESPONSE,e,s)).catch(o)})),n.data=null,this.publish(new Ze(G.PACKET_RESPONSE,e,n)).then((()=>{n.stream&&t.resume()})).catch(o)}return this.publish(new Ze(G.PACKET_RESPONSE,e,n)).catch(o)}discoverNodes(){return this.publish(new Ze(G.PACKET_DISCOVER)).catch((e=>this.logger.error("Unable to send DISCOVER packet.",e)))}discoverNode(e){return this.publish(new Ze(G.PACKET_DISCOVER,e)).catch((t=>this.logger.error(`Unable to send DISCOVER packet to '${e}' node.`,t)))}sendNodeInfo(e,t){if(!this.connected||!this.isReady)return this.Promise.resolve();return(!t&&this.broker.options.disableBalancer?this.tx.makeBalancedSubscriptions():this.Promise.resolve()).then((()=>this.publish(new Ze(G.PACKET_INFO,t,{services:e.services,ipList:e.ipList,hostname:e.hostname,client:e.client,config:e.config,instanceID:this.broker.instanceID,metadata:e.metadata,seq:e.seq})))).catch((e=>this.logger.error(`Unable to send INFO packet to '${t}' node.`,e)))}sendPing(e,t){return this.publish(new Ze(G.PACKET_PING,e,{time:Date.now(),id:t||this.broker.generateUid()})).catch((t=>this.logger.error(`Unable to send PING packet to '${e}' node.`,t)))}sendPong(e){return this.publish(new Ze(G.PACKET_PONG,e.sender,{time:e.time,id:e.id,arrived:Date.now()})).catch((t=>this.logger.error(`Unable to send PONG packet to '${e.sender}' node.`,t)))}processPong(e){const t=Date.now(),s=t-e.time,r=Math.round(t-e.arrived-s/2);this.broker.broadcastLocal("$node.pong",{nodeID:e.sender,elapsedTime:s,timeDiff:r,id:e.id}),this.metrics.set(Je.MOLECULER_TRANSIT_PONG_TIME,s,{targetNodeID:e.sender}),this.metrics.set(Je.MOLECULER_TRANSIT_PONG_SYSTIME_DIFF,r,{targetNodeID:e.sender})}sendHeartbeat(e){return this.publish(new Ze(G.PACKET_HEARTBEAT,null,{cpu:e.cpu})).catch((e=>this.logger.error("Unable to send HEARTBEAT packet.",e)))}subscribe(e,t){return this.tx.subscribe(e,t)}publish(e){return this.subscribing?this.subscribing.then((()=>this.tx.prepublish(e))):this.tx.prepublish(e)}};var et=class{constructor(e,t,s){this.registry=e,this.broker=t,this.opts=s||{}}select(){throw new Error("Not implemented method!")}};var tt=class extends et{constructor(e,t,s){super(e,t,s),this.counter=0}select(e){return this.counter>=e.length&&(this.counter=0),e[this.counter++]}};const{random:st}=O.default;var rt=class extends et{select(e){return e[st(0,e.length-1)]}};const{random:it}=O.default;var nt=class extends et{constructor(e,t,s){super(e,t,s),this.opts=O.default.defaultsDeep(s,{sampleCount:5,lowLatency:10,collectCount:5,pingInterval:10}),this.brokerStopped=!1,this.hostAvgLatency=new Map,this.hostMap=new Map,this.broker.transit&&(0===this.broker.localBus.listenerCount("$node.latencyMaster")?(this.broker.localBus.on("$node.latencyMaster",(function(){})),this.broker.localBus.on("$node.pong",this.processPong.bind(this)),this.broker.localBus.on("$node.connected",this.addNode.bind(this)),this.broker.localBus.on("$node.disconnected",this.removeHostMap.bind(this)),this.broker.localBus.on("$broker.started",this.discovery.bind(this)),this.broker.localBus.on("$broker.stopped",(()=>this.brokerStopped=!0))):this.broker.localBus.on("$node.latencySlave.removeHost",this.removeHostLatency.bind(this)),this.broker.localBus.on("$node.latencySlave",this.updateLatency.bind(this)))}discovery(){return this.broker.transit.sendPing().then((()=>{i.setTimeout((()=>this.pingHosts()),1e3*this.opts.pingInterval).unref()}))}pingHosts(){if(this.brokerStopped)return;const e=Array.from(this.hostMap.values());return this.broker.Promise.all(e.map((e=>{const t=e.nodeList[it(0,e.nodeList.length-1)];return this.broker.transit.sendPing(t)}))).then((()=>{i.setTimeout((()=>this.pingHosts()),1e3*this.opts.pingInterval).unref()}))}processPong(e){let t=this.registry.nodes.get(e.nodeID);if(!t)return;let s=this.getHostLatency(t);s.historicLatency.length>this.opts.collectCount-1&&s.historicLatency.shift(),s.historicLatency.push(e.elapsedTime);const r=s.historicLatency.reduce(((e,t)=>e+t),0)/s.historicLatency.length;this.broker.localBus.emit("$node.latencySlave",{hostname:t.hostname,avgLatency:r})}getHostLatency(e){let t=this.hostMap.get(e.hostname);return void 0===t&&(t={historicLatency:[],nodeList:[e.id]},this.hostMap.set(e.hostname,t)),t}addNode(e){let t=e.node,s=this.getHostLatency(t);-1===s.nodeList.indexOf(t.id)&&s.nodeList.push(t.id)}removeHostMap(e){let t=e.node,s=this.hostMap.get(t.hostname);void 0!==s&&(s.nodeList=s.nodeList.filter((e=>e!==t.id)),0==s.nodeList.length&&(this.broker.localBus.emit("$node.latencySlave.removeHost",t.hostname),this.hostMap.delete(t.hostname)))}updateLatency(e){this.hostAvgLatency.set(e.hostname,e.avgLatency)}removeHostLatency(e){this.hostAvgLatency.delete(e)}select(e){let t=null,s=null;const r=this.opts.sampleCount,i=r<=0||r>e.length?e.length:r;for(let r=0;r<i;r++){let n;n=i==e.length?e[r]:e[it(0,e.length-1)];const o=this.hostAvgLatency.get(n.node.hostname);if(void 0!==o){if(o<this.opts.lowLatency)return n;(!t||!s||o<s)&&(s=o,t=n)}}return t||e[it(0,e.length-1)]}};const{isFunction:ot}=ne;var at=class extends et{constructor(e,t,s){super(e,t,s),this.opts=O.default.defaultsDeep(s,{shardKey:null,vnodes:10,ringSize:null,cacheSize:1e3}),this.cache=new P.default({max:this.opts.cacheSize,maxAge:null}),this.needRebuild=!0,this.ring=[],t.localBus.on("$node.**",(()=>this.needRebuild=!0))}getKeyFromContext(e){return this.opts.shardKey?ot(this.opts.shardKey)?this.opts.shardKey.call(this,e):this.opts.shardKey.startsWith("#")?O.default.get(e.meta,this.opts.shardKey.slice(1)):O.default.get(e.params,this.opts.shardKey):null}select(e,t){let s=this.getKeyFromContext(t);if(null!=s){this.needRebuild&&this.rebuild(e);const t=this.getNodeIDByKey(s);if(t)return e.find((e=>e.id==t))}return e[O.default.random(0,e.length-1)]}getNodeIDByKey(e){if(this.cache){const t=this.cache.get(e);if(t)return t}const t=this.getHash(e.toString());let s;const r=this.ring.length;for(let e=0;e<r;e++)if(t<=this.ring[e].key){s=this.ring[e];break}return s?(this.cache&&this.cache.set(e,s.nodeID),s.nodeID):null}getHash(e){const t=N.default.createHash("md5").update(e).digest("hex"),s=parseInt(t.substring(0,8),16);return this.opts.ringSize?s%this.opts.ringSize:s}rebuild(e){this.cache.reset(),this.ring=[];const t=e.map((e=>e.id)).sort(),s=t.length*this.opts.vnodes,r=this.opts.ringSize?this.opts.ringSize:Math.pow(2,32),i=r/s;for(let e=0;e<this.opts.vnodes;e++)for(let e=0;e<t.length;e++){const s=t[e];this.ring.push({key:Math.floor(i*(this.ring.length+1)),nodeID:s})}this.ring[this.ring.length-1].key=r,this.needRebuild=!1}};const{isObject:lt,isString:ct}=ne,{BrokerOptionsError:ht}=F,ut={Base:et,RoundRobin:tt,Random:rt,CpuUsage:K,Latency:nt,Shard:at};function dt(e){if(!e)return null;let t=Object.keys(ut).find((t=>t.toLowerCase()==e.toLowerCase()));return t?ut[t]:void 0}var pt=Object.assign(ut,{resolve:function(e){if(Object.prototype.isPrototypeOf.call(ut.Base,e))return e;if(ct(e)){let t=dt(e);if(t)return t;throw new ht(`Invalid strategy type '${e}'.`,{type:e})}if(lt(e)){let t=dt(e.type||"RoundRobin");if(t)return t;throw new ht(`Invalid strategy type '${e.type}'.`,{type:e.type})}return ut.RoundRobin},register:function(e,t){ut[e]=t}});var mt=class{constructor(e){this.Promise=Promise,this.opts=O.default.defaultsDeep({},e,{heartbeatInterval:null,heartbeatTimeout:null,disableHeartbeatChecks:!1,disableOfflineNodeRemoving:!1,cleanOfflineNodesTimeout:600}),this.heartbeatTimer=null,this.checkNodesTimer=null,this.offlineTimer=null,this.localNode=null}init(e){this.registry=e,this.broker=e.broker,this.Promise=this.broker.Promise,this.broker&&(this.logger=this.broker.getLogger("Discovery"),this.transit=this.broker.transit,null==this.opts.heartbeatInterval&&(this.opts.heartbeatInterval=this.broker.options.heartbeatInterval),null==this.opts.heartbeatTimeout&&(this.opts.heartbeatTimeout=this.broker.options.heartbeatTimeout)),this.transit&&(this.broker.localBus.on("$transporter.connected",(()=>this.startHeartbeatTimers())),this.broker.localBus.on("$transporter.disconnected",(()=>this.stopHeartbeatTimers()))),this.localNode=this.registry.nodes.localNode,this.registerMoleculerMetrics()}stop(){return this.stopHeartbeatTimers(),this.Promise.resolve()}registerMoleculerMetrics(){}startHeartbeatTimers(){if(this.stopHeartbeatTimers(),this.opts.heartbeatInterval>0){const e=1e3*this.opts.heartbeatInterval+(Math.round(1e3*Math.random())-500);this.heartbeatTimer=i.setInterval((()=>this.beat()),e),this.heartbeatTimer.unref(),this.checkNodesTimer=i.setInterval((()=>this.checkRemoteNodes()),1e3*this.opts.heartbeatTimeout),this.checkNodesTimer.unref(),this.offlineTimer=i.setInterval((()=>this.checkOfflineNodes()),6e4),this.offlineTimer.unref()}}stopHeartbeatTimers(){this.heartbeatTimer&&(clearInterval(this.heartbeatTimer),this.heartbeatTimer=null),this.checkNodesTimer&&(clearInterval(this.checkNodesTimer),this.checkNodesTimer=null),this.offlineTimer&&(clearInterval(this.offlineTimer),this.offlineTimer=null)}disableHeartbeat(){this.opts.heartbeatInterval=0,this.stopHeartbeatTimers()}beat(){return this.localNode.updateLocalInfo(this.broker.getCpuUsage).then((()=>this.sendHeartbeat()))}checkRemoteNodes(){if(this.disableHeartbeatChecks)return;const e=Math.round(H.uptime());this.registry.nodes.toArray().forEach((t=>{!t.local&&t.available&&(t.lastHeartbeatTime?e-t.lastHeartbeatTime>this.broker.options.heartbeatTimeout&&(this.logger.warn(`Heartbeat is not received from '${t.id}' node.`),this.registry.nodes.disconnected(t.id,!0)):t.lastHeartbeatTime=e)}))}checkOfflineNodes(){if(this.disableOfflineNodeRemoving||!this.opts.cleanOfflineNodesTimeout)return;const e=Math.round(H.uptime());this.registry.nodes.toArray().forEach((t=>{t.local||t.available||(t.lastHeartbeatTime?e-t.lastHeartbeatTime>this.opts.cleanOfflineNodesTimeout&&(this.logger.warn(`Removing offline '${t.id}' node from registry because it hasn't submitted heartbeat signal for 10 minutes.`),this.registry.nodes.delete(t.id)):t.lastHeartbeatTime=e)}))}heartbeatReceived(e,t){const s=this.registry.nodes.get(e);s&&s.available?null!=t.seq&&s.seq!==t.seq?this.discoverNode(e):null==t.instanceID||s.instanceID.startsWith(t.instanceID)?s.heartbeat(t):this.discoverNode(e):this.discoverNode(e)}processRemoteNodeInfo(e,t){return this.broker.registry.processNodeInfo(t)}sendHeartbeat(){return this.transit?this.transit.sendHeartbeat(this.localNode):this.Promise.resolve()}discoverNode(){throw new Error("Not implemented")}discoverAllNodes(){throw new Error("Not implemented")}localNodeReady(){return this.sendLocalNodeInfo()}sendLocalNodeInfo(){throw new Error("Not implemented")}localNodeDisconnected(){return this.transit?this.transit.sendDisconnectPacket():this.Promise.resolve()}remoteNodeDisconnected(e,t){return this.registry.nodes.disconnected(e,t)}};var Et=class extends mt{constructor(e){super(e)}init(e){super.init(e)}discoverNode(e){return this.transit?this.transit.discoverNode(e):this.Promise.resolve()}discoverAllNodes(){return this.transit?this.transit.discoverNodes():this.Promise.resolve()}sendLocalNodeInfo(e){if(!this.transit)return this.Promise.resolve();const t=this.broker.getLocalNodeInfo();return this.transit.sendNodeInfo(t,e)}};const{BrokerOptionsError:gt}=F,{isObject:ft,isString:_t}=ne,Tt={Base:mt,Local:Et,Etcd3:Le,Redis:Le};function vt(e){if(!e)return null;let t=Object.keys(Tt).find((t=>t.toLowerCase()==e.toLowerCase()));return t?Tt[t]:void 0}var St=Object.assign(Tt,{resolve:function(e){if(e instanceof Tt.Base)return e;if(_t(e)){let t=vt(e);if(t)return new t;if(e.startsWith("redis://"))return new Tt.Redis(e);if(e.startsWith("etcd3://"))return new Tt.Etcd3(e);throw new gt(`Invalid Discoverer type '${e}'.`,{type:e})}if(ft(e)){let t=vt(e.type||"Local");if(t)return new t(e.options);throw new gt(`Invalid Discoverer type '${e.type}'.`,{type:e.type})}return new Tt.Local},register:function(e,t){Tt[e]=t}});var bt=class{constructor(e){this.id=e,this.instanceID=null,this.available=!0,this.local=!1,this.lastHeartbeatTime=Math.round(H.uptime()),this.config={},this.client={},this.metadata=null,this.ipList=null,this.port=null,this.hostname=null,this.udpAddress=null,this.rawInfo=null,this.services=[],this.cpu=null,this.cpuSeq=null,this.seq=0,this.offlineSince=null}update(e,t){this.metadata=e.metadata,this.ipList=e.ipList,this.hostname=e.hostname,this.port=e.port,this.client=e.client||{},this.config=e.config||{},this.instanceID=e.instanceID,this.services=e.services,this.rawInfo=e;const s=e.seq||1;if(s>this.seq||t)return this.seq=s,!0}updateLocalInfo(e){return e().then((e=>{const t=Math.round(e.avg);this.cpu!=t&&(this.cpu=t,this.cpuSeq++)})).catch((()=>{}))}heartbeat(e){this.available||(this.available=!0,this.offlineSince=null),null!=e.cpu&&(this.cpu=e.cpu,this.cpuSeq=e.cpuSeq||1),this.lastHeartbeatTime=Math.round(H.uptime())}disconnected(){this.available&&(this.offlineSince=Math.round(H.uptime()),this.seq++),this.available=!1}};const{getIpList:Ot}=ne;var yt=class{constructor(e,t){this.registry=e,this.broker=t,this.logger=e.logger,this.nodes=new Map,this.createLocalNode()}createLocalNode(){const e=new bt(this.broker.nodeID);return e.local=!0,e.ipList=Ot(),e.instanceID=this.broker.instanceID,e.hostname=Q.hostname(),e.client={type:"browser",version:this.broker.MOLECULER_VERSION,langVersion:H.version},e.metadata=this.broker.metadata,e.seq=1,this.add(e.id,e),this.localNode=e,e}add(e,t){this.nodes.set(e,t)}has(e){return this.nodes.has(e)}get(e){return this.nodes.get(e)}delete(e){return this.nodes.delete(e)}count(){return this.nodes.size}onlineCount(){let e=0;return this.nodes.forEach((t=>{t.available&&e++})),e}processNodeInfo(e){const t=e.sender;let s=this.get(t),r=!1,i=!1;s?s.available||(i=!0,s.lastHeartbeatTime=Math.round(H.uptime()),s.available=!0,s.offlineSince=null):(r=!0,s=new bt(t),this.add(t,s));return s.update(e,i)&&s.services&&this.registry.registerServices(s,s.services),r?(this.broker.broadcastLocal("$node.connected",{node:s,reconnected:!1}),this.logger.info(`Node '${t}' connected.`),this.registry.updateMetrics()):i?(this.broker.broadcastLocal("$node.connected",{node:s,reconnected:!0}),this.logger.info(`Node '${t}' reconnected.`),this.registry.updateMetrics()):(this.broker.broadcastLocal("$node.updated",{node:s}),this.logger.debug(`Node '${t}' updated.`)),s}disconnected(e,t){let s=this.get(e);s&&s.available&&(s.disconnected(t),this.registry.unregisterServicesByNode(s.id),this.broker.broadcastLocal("$node.disconnected",{node:s,unexpected:!!t}),this.registry.updateMetrics(),this.logger.warn(`Node '${s.id}' disconnected${t?" unexpectedly":""}.`),this.broker.transit&&this.broker.transit.removePendingRequestByNodeID(e))}list({onlyAvailable:e=!1,withServices:t=!1}){let s=[];return this.nodes.forEach((r=>{e&&!r.available||(t?s.push(O.default.omit(r,["rawInfo"])):s.push(O.default.omit(r,["services","rawInfo"])))})),s}toArray(){return Array.from(this.nodes.values())}};var It=class{constructor(e,t,s){this.node=e,this.name=t.name,this.fullName=t.fullName,this.version=t.version,this.settings=t.settings,this.metadata=t.metadata||{},this.local=!!s,this.actions={},this.events={}}equals(e,t){return this.fullName==e&&(null==t||this.node.id==t)}update(e){this.fullName=e.fullName,this.version=e.version,this.settings=e.settings,this.metadata=e.metadata||{}}addAction(e){this.actions[e.name]=e}addEvent(e){this.events[e.name]=e}};const{removeFromArray:Rt}=ne;var Ct=class{constructor(e,t){this.registry=e,this.broker=t,this.logger=e.logger,this.services=[]}add(e,t,s){const r=new It(e,t,s);return this.services.push(r),r}has(e,t){return null!=this.services.find((s=>s.equals(e,t)))}get(e,t){return this.services.find((s=>s.equals(e,t)))}list({onlyLocal:e=!1,onlyAvailable:t=!1,skipInternal:s=!1,withActions:r=!1,withEvents:i=!1,grouping:n=!1}){let o=[];return this.services.forEach((a=>{if(s&&/^\$/.test(a.name))return;if(e&&!a.local)return;if(t&&!a.node.available)return;let l;if(n&&(l=o.find((e=>e.fullName==a.fullName))),l)-1===l.nodes.indexOf(a.node.id)&&l.nodes.push(a.node.id);else{let e={name:a.name,version:a.version,fullName:a.fullName,settings:a.settings,metadata:a.metadata,local:a.local,available:a.node.available};n?e.nodes=[a.node.id]:e.nodeID=a.node.id,r&&(e.actions={},O.default.forIn(a.actions,(t=>{t.protected||(e.actions[t.name]=O.default.omit(t,["handler","remoteHandler","service"]))}))),i&&(e.events={},O.default.forIn(a.events,(t=>{/^\$/.test(t.name)||(e.events[t.name]=O.default.omit(t,["handler","remoteHandler","service"]))}))),o.push(e)}})),o}getLocalNodeServices(){let e=[];return this.services.forEach((t=>{if(!t.local)return;let s={name:t.name,version:t.version,fullName:t.fullName,settings:t.settings,metadata:t.metadata,dependencies:t.dependencies,actions:{}};O.default.forIn(t.actions,(e=>{e.protected||(s.actions[e.name]=O.default.omit(e,["handler","remoteHandler","service"]))})),s.events={},O.default.forIn(t.events,(e=>{s.events[e.name]=O.default.omit(e,["handler","remoteHandler","service"])})),e.push(s)})),e}removeAllByNodeID(e){O.default.remove(this.services,(t=>{if(t.node.id==e)return this.registry.actions.removeByService(t),this.registry.events.removeByService(t),!0}))}remove(e,t){let s=this.get(e,t);s&&(this.registry.actions.removeByService(s),this.registry.events.removeByService(s),Rt(this.services,s))}};const{MoleculerServerError:Lt}=F;var At=class{constructor(e,t,s,r,i,n,o){this.registry=e,this.broker=t,this.logger=e.logger,this.strategy=new n(e,t,o),this.name=s,this.group=r,this.internal=s.startsWith("$"),this.EndPointFactory=i,this.endpoints=[],this.localEndpoints=[]}add(e,t,s){const r=this.endpoints.find((s=>s.node==e&&s.service.name==t.name));if(r)return r.update(s),r;const i=new this.EndPointFactory(this.registry,this.broker,e,t,s);return this.endpoints.push(i),this.setLocalEndpoints(),i}getFirst(){return this.endpoints.length>0?this.endpoints[0]:null}select(e,t){const s=this.strategy.select(e,t);if(!s)throw new Lt("Strategy returned an invalid endpoint.",500,"INVALID_ENDPOINT",{strategy:typeof this.strategy});return s}next(e){if(0===this.endpoints.length)return null;if(this.internal&&this.hasLocal())return this.nextLocal();if(1===this.endpoints.length){const e=this.endpoints[0];return e.isAvailable?e:null}if(!0===this.registry.opts.preferLocal&&this.hasLocal()){const t=this.nextLocal(e);if(t&&t.isAvailable)return t}const t=this.endpoints.filter((e=>e.isAvailable));return 0==t.length?null:this.select(t,e)}nextLocal(e){if(0===this.localEndpoints.length)return null;if(1===this.localEndpoints.length){const e=this.localEndpoints[0];return e.isAvailable?e:null}const t=this.localEndpoints.filter((e=>e.isAvailable));return 0==t.length?null:this.select(t,e)}hasAvailable(){return null!=this.endpoints.find((e=>e.isAvailable))}hasLocal(){return this.localEndpoints.length>0}setLocalEndpoints(){this.localEndpoints=this.endpoints.filter((e=>e.local))}count(){return this.endpoints.length}getEndpointByNodeID(e){const t=this.endpoints.find((t=>t.id==e));return t&&t.isAvailable?t:null}hasNodeID(e){return null!=this.endpoints.find((t=>t.id==e))}removeByService(e){O.default.remove(this.endpoints,(t=>{if(t.service==e)return t.destroy(),!0})),this.setLocalEndpoints()}removeByNodeID(e){O.default.remove(this.endpoints,(t=>{if(t.id==e)return t.destroy(),!0})),this.setLocalEndpoints()}};var Nt=class{constructor(e,t,s){this.registry=e,this.broker=t,this.id=s.id,this.node=s,this.local=s.id===t.nodeID,this.state=!0}destroy(){}get isAvailable(){return this.state}update(){}};var Pt=class extends Nt{constructor(e,t,s,r,i){super(e,t,s),this.service=r,this.event=i}update(e){this.event=e}};var Mt=class{constructor(e,t,s){this.registry=e,this.broker=t,this.logger=e.logger,this.StrategyFactory=s,this.events=[],this.EndpointFactory=Pt}add(e,t,s){const r=s.name,i=s.group||t.name;let n=this.get(r,i);if(!n){const e=s.strategy&&pt.resolve(s.strategy)||this.StrategyFactory,t=s.strategyOptions?s.strategyOptions:this.registry.opts.strategyOptions;n=new At(this.registry,this.broker,r,i,this.EndpointFactory,e,t),this.events.push(n)}return n.add(e,t,s),n}get(e,t){return this.events.find((s=>s.name==e&&s.group==t))}getBalancedEndpoints(e,t){const s=[];return this.events.forEach((r=>{if(ne.match(e,r.name)&&(null==t||0==t.length||-1!=t.indexOf(r.group))){const e=r.next();e&&e.isAvailable&&s.push([e,r.group])}})),s}getGroups(e){return O.default.uniq(this.events.filter((t=>ne.match(e,t.name))).map((e=>e.group)))}getAllEndpoints(e,t){const s=[];return this.events.forEach((r=>{ne.match(e,r.name)&&(null!=t&&0!=t.length&&-1===t.indexOf(r.group)||r.endpoints.forEach((e=>{e.isAvailable&&s.push(e)})))})),O.default.uniqBy(s,"id")}emitLocalServices(e){const t=-1!==["broadcast","broadcastLocal"].indexOf(e.eventType),s=e.nodeID,r=[];return this.events.forEach((i=>{if(ne.match(e.eventName,i.name)&&(null==e.eventGroups||0==e.eventGroups.length||-1!==e.eventGroups.indexOf(i.group)))if(t)i.endpoints.forEach((t=>{if(t.local&&t.event.handler){const i=e.copy(t);i.nodeID=s,r.push(this.callEventHandler(i))}}));else{const t=i.nextLocal();if(t&&t.event.handler){const i=e.copy(t);i.nodeID=s,r.push(this.callEventHandler(i))}}})),this.broker.Promise.all(r)}callEventHandler(e){return e.endpoint.event.handler(e)}removeByService(e){this.events.forEach((t=>{t.removeByService(e)}))}remove(e,t){this.events.forEach((s=>{s.name==e&&s.removeByNodeID(t)}))}list({onlyLocal:e=!1,onlyAvailable:t=!1,skipInternal:s=!1,withEndpoints:r=!1}){let i=[];return this.events.forEach((n=>{if(s&&/^\$/.test(n.name))return;if(e&&!n.hasLocal())return;if(t&&!n.hasAvailable())return;let o={name:n.name,group:n.group,count:n.count(),hasLocal:n.hasLocal(),available:n.hasAvailable()};if(o.count>0){const e=n.endpoints[0];e&&(o.event=O.default.omit(e.event,["handler","remoteHandler","service"]))}r&&o.count>0&&(o.endpoints=n.endpoints.map((e=>({nodeID:e.node.id,state:e.state,available:e.node.available})))),i.push(o)})),i}};var kt=class extends Nt{constructor(e,t,s,r,i){super(e,t,s),this.service=r,this.action=i,this.name=`${this.id}:${this.action.name}`}update(e){this.action=e}};var Ut=class{constructor(e,t,s){this.registry=e,this.broker=t,this.logger=e.logger,this.StrategyFactory=s,this.actions=new Map,this.EndpointFactory=kt}add(e,t,s){let r=this.actions.get(s.name);if(!r){const e=s.strategy&&pt.resolve(s.strategy)||this.StrategyFactory,t=s.strategyOptions?s.strategyOptions:this.registry.opts.strategyOptions;r=new At(this.registry,this.broker,s.name,null,this.EndpointFactory,e,t),this.actions.set(s.name,r)}return r.add(e,t,s),r}get(e){return this.actions.get(e)}isAvailable(e){const t=this.actions.get(e);return!!t&&t.hasAvailable()}removeByService(e){this.actions.forEach((t=>{t.removeByService(e)}))}remove(e,t){const s=this.actions.get(e);s&&s.removeByNodeID(t)}list({onlyLocal:e=!1,onlyAvailable:t=!1,skipInternal:s=!1,withEndpoints:r=!1}){let i=[];return this.actions.forEach(((n,o)=>{if(s&&/^\$/.test(o))return;if(e&&!n.hasLocal())return;if(t&&!n.hasAvailable())return;let a={name:o,count:n.count(),hasLocal:n.hasLocal(),available:n.hasAvailable()};if(a.count>0){const e=n.endpoints[0];e&&(a.action=O.default.omit(e.action,["handler","remoteHandler","service"]))}a.action&&!0===a.action.protected||(r&&a.count>0&&(a.endpoints=n.endpoints.map((e=>({nodeID:e.node.id,state:e.state,available:e.node.available})))),i.push(a))})),i}};const{METRIC:Dt}=Qe;var wt=class{constructor(e){this.broker=e,this.metrics=e.metrics,this.logger=e.getLogger("registry"),this.opts=Object.assign({},e.options.registry),this.StrategyFactory=pt.resolve(this.opts.strategy),this.logger.info("Strategy: "+this.StrategyFactory.name),this.discoverer=St.resolve(this.opts.discoverer),this.logger.info("Discoverer: "+this.broker.getConstructorName(this.discoverer)),this.nodes=new yt(this,e),this.services=new Ct(this,e),this.actions=new Ut(this,e,this.StrategyFactory),this.events=new Mt(this,e,this.StrategyFactory),this.registerMoleculerMetrics(),this.updateMetrics()}init(e){this.discoverer.init(this)}stop(){return this.discoverer.stop()}registerMoleculerMetrics(){this.broker.isMetricsEnabled()&&(this.metrics.register({name:Dt.MOLECULER_REGISTRY_NODES_TOTAL,type:Dt.TYPE_GAUGE,description:"Number of registered nodes"}),this.metrics.register({name:Dt.MOLECULER_REGISTRY_NODES_ONLINE_TOTAL,type:Dt.TYPE_GAUGE,description:"Number of online nodes"}),this.metrics.register({name:Dt.MOLECULER_REGISTRY_SERVICES_TOTAL,type:Dt.TYPE_GAUGE,description:"Number of registered services"}),this.metrics.register({name:Dt.MOLECULER_REGISTRY_SERVICE_ENDPOINTS_TOTAL,type:Dt.TYPE_GAUGE,labelNames:["service"],description:"Number of service endpoints"}),this.metrics.register({name:Dt.MOLECULER_REGISTRY_ACTIONS_TOTAL,type:Dt.TYPE_GAUGE,description:"Number of registered actions"}),this.metrics.register({name:Dt.MOLECULER_REGISTRY_ACTION_ENDPOINTS_TOTAL,type:Dt.TYPE_GAUGE,labelNames:["action"],description:"Number of action endpoints"}),this.metrics.register({name:Dt.MOLECULER_REGISTRY_EVENTS_TOTAL,type:Dt.TYPE_GAUGE,description:"Number of registered events"}),this.metrics.register({name:Dt.MOLECULER_REGISTRY_EVENT_ENDPOINTS_TOTAL,type:Dt.TYPE_GAUGE,labelNames:["event"],description:"Number of event endpoints"}))}updateMetrics(){if(!this.broker.isMetricsEnabled())return;this.metrics.set(Dt.MOLECULER_REGISTRY_NODES_TOTAL,this.nodes.count()),this.metrics.set(Dt.MOLECULER_REGISTRY_NODES_ONLINE_TOTAL,this.nodes.onlineCount());const e=this.services.list({grouping:!0,onlyLocal:!1,onlyAvailable:!1,skipInternal:!1,withActions:!1,withEvents:!1});this.metrics.set(Dt.MOLECULER_REGISTRY_SERVICES_TOTAL,e.length),e.forEach((e=>this.metrics.set(Dt.MOLECULER_REGISTRY_SERVICE_ENDPOINTS_TOTAL,e.nodes?e.nodes.length:0,{service:e.fullName})));const t=this.actions.list({withEndpoints:!0});this.metrics.set(Dt.MOLECULER_REGISTRY_ACTIONS_TOTAL,t.length),t.forEach((e=>this.metrics.set(Dt.MOLECULER_REGISTRY_ACTION_ENDPOINTS_TOTAL,e.endpoints?e.endpoints.length:0,{action:e.name})));const s=this.events.list({withEndpoints:!0});this.metrics.set(Dt.MOLECULER_REGISTRY_EVENTS_TOTAL,s.length),s.forEach((e=>this.metrics.set(Dt.MOLECULER_REGISTRY_EVENT_ENDPOINTS_TOTAL,e.endpoints?e.endpoints.length:0,{event:e.name})))}registerLocalService(e){if(!this.services.has(e.fullName,this.broker.nodeID)){const t=this.services.add(this.nodes.localNode,e,!0);e.actions&&this.registerActions(this.nodes.localNode,t,e.actions),e.events&&this.registerEvents(this.nodes.localNode,t,e.events),this.nodes.localNode.services.push(t),this.regenerateLocalRawInfo(this.broker.started),this.logger.info(`'${e.name}' service is registered.`),this.broker.servicesChanged(!0),this.updateMetrics()}}registerServices(e,t){t.forEach((t=>{let s,r;t.fullName||(t.fullName=this.broker.ServiceFactory.getVersionedFullName(t.name,t.version));let i=this.services.get(t.fullName,e.id);i?(s=Object.assign({},i.actions),r=Object.assign({},i.events),i.update(t)):i=this.services.add(e,t,!1),t.actions&&this.registerActions(e,i,t.actions),s&&O.default.forIn(s,((s,r)=>{t.actions&&t.actions[r]||this.unregisterAction(e,r)})),t.events&&this.registerEvents(e,i,t.events),r&&O.default.forIn(r,((s,r)=>{t.events&&t.events[r]||this.unregisterEvent(e,r)}))}));Array.from(this.services.services).forEach((s=>{if(s.node!=e)return;let r=!1;t.forEach((e=>{s.equals(e.fullName)&&(r=!0)})),r||this.unregisterService(s.fullName,e.id)})),this.broker.servicesChanged(!1),this.updateMetrics()}checkActionVisibility(e,t){return null==e.visibility||"published"==e.visibility||"public"==e.visibility||!("protected"!=e.visibility||!t.local)}registerActions(e,t,s){O.default.forIn(s,(s=>{this.checkActionVisibility(s,e)&&(e.local?s.handler=this.broker.middlewares.wrapHandler("localAction",s.handler,s):this.broker.transit&&(s.handler=this.broker.middlewares.wrapHandler("remoteAction",this.broker.transit.request.bind(this.broker.transit),{...s,service:t})),this.broker.options.disableBalancer&&this.broker.transit&&(s.remoteHandler=this.broker.middlewares.wrapHandler("remoteAction",this.broker.transit.request.bind(this.broker.transit),{...s,service:t})),this.actions.add(e,t,s),t.addAction(s))}))}createPrivateActionEndpoint(e){return new kt(this,this.broker,this.nodes.localNode,e.service,e)}hasService(e,t){return this.services.has(e,t)}getActionEndpoints(e){return this.actions.get(e)}getActionEndpointByNodeId(e,t){const s=this.actions.get(e);if(s)return s.getEndpointByNodeID(t)}unregisterService(e,t){this.services.remove(e,t||this.broker.nodeID),t&&t!=this.broker.nodeID||this.regenerateLocalRawInfo(!0)}unregisterServicesByNode(e){this.services.removeAllByNodeID(e)}unregisterAction(e,t){this.actions.remove(t,e.id)}registerEvents(e,t,s){O.default.forIn(s,(s=>{e.local&&(s.handler=this.broker.middlewares.wrapHandler("localEvent",s.handler,s)),this.events.add(e,t,s),t.addEvent(s)}))}unregisterEvent(e,t){this.events.remove(t,e.id)}regenerateLocalRawInfo(e){let t=this.nodes.localNode;e&&t.seq++;const s=O.default.pick(t,["ipList","hostname","instanceID","client","config","port","seq","metadata"]);return this.broker.started?s.services=this.services.getLocalNodeServices():s.services=[],t.rawInfo=ne.safetyObject(s,this.broker.options),t.rawInfo}getLocalNodeInfo(e){return e||!this.nodes.localNode.rawInfo?this.regenerateLocalRawInfo():this.nodes.localNode.rawInfo}getNodeInfo(e){const t=this.nodes.get(e);return t?t.local?this.getLocalNodeInfo():t.rawInfo:null}processNodeInfo(e){return this.nodes.processNodeInfo(e)}getNodeList(e){return this.nodes.list(e)}getServiceList(e){return this.services.list(e)}getActionList(e){return this.actions.list(e)}getEventList(e){return this.events.list(e)}getNodeRawList(){return this.nodes.toArray().map((e=>e.rawInfo))}},xt=Nt;wt.Endpoint=xt;const{match:Ht,isObject:$t,isString:Bt}=ne;class Gt{constructor(e){this.opts=O.default.defaultsDeep(e,{level:"info",createLogger:null}),this.Promise=Promise}init(e){this.loggerFactory=e,this.broker=this.loggerFactory.broker,this.Promise=this.broker.Promise}stop(){return this.Promise.resolve()}getLogLevel(e){e=e?e.toUpperCase():"";const t=this.opts.level;if(Bt(t))return t;if($t(t)){if(t[e])return t[e];const s=Object.keys(t).find((t=>Ht(e,t)&&"**"!==t));if(s)return t[s];if(t["**"])return t["**"]}return null}getLogHandler(){return null}}Gt.LEVELS=["fatal","error","warn","info","debug","trace"];var Ft=Gt;const{isObject:qt,isFunction:Yt}=ne;var Vt=class extends Ft{constructor(e){super(e),this.opts=O.default.defaultsDeep(this.opts,{colors:!0,moduleColors:!1,formatter:"full",objectPrinter:null,autoPadding:!1}),this.maxPrefixLength=0}init(e){super.init(e),this.opts.colors||(v.default.enabled=!1),this.objectPrinter=this.opts.objectPrinter?this.opts.objectPrinter:e=>M.default.inspect(e,{showHidden:!1,depth:2,colors:v.default.enabled,breakLength:Number.POSITIVE_INFINITY}),this.levelColorStr=Ft.LEVELS.reduce(((e,t)=>(e[t]=function(e){switch(e){case"fatal":return v.default.red().inverse;case"error":return v.default.red;case"warn":return v.default.yellow;case"debug":return v.default.magenta;case"trace":return v.default.gray;default:return v.default.green}}(t)(O.default.padEnd(t.toUpperCase(),5)),e)),{}),this.opts.colors&&!0===this.opts.moduleColors&&(this.opts.moduleColors=["yellow","bold.yellow","cyan","bold.cyan","green","bold.green","magenta","bold.magenta","blue","bold.blue"])}getNextColor(e){if(this.opts.colors&&Array.isArray(this.opts.moduleColors)){let t=0;for(let s=0;s<e.length;s++)t=(t<<5)-t+e.charCodeAt(s),t|=0;return this.opts.moduleColors[Math.abs(t)%this.opts.moduleColors.length]}return"grey"}padLeft(e){return this.opts.autoPadding?" ".repeat(this.maxPrefixLength-e):""}getFormatter(e){const t=this.opts.formatter,s=e&&e.mod?e.mod.toUpperCase():"",r=this.getNextColor(s).split(".").reduce(((e,t)=>e[t]||e()[t]),v.default)(s),i=e?v.default.grey(e.nodeID+"/")+r:"",n=e=>e.map((e=>qt(e)||Array.isArray(e)?this.objectPrinter(e):e));if(Yt(t))return(s,r)=>t.call(this,s,r,e,{printArgs:n});if("json"==t)return v.default.enabled=!1,(t,s)=>[JSON.stringify({ts:Date.now(),level:t,msg:n(s).join(" "),...e})];if("jsonext"==t)return v.default.enabled=!1,(t,s)=>{const r={time:(new Date).toISOString(),level:t,message:"",...e};return s.length>0&&("object"==typeof s[0]?(Object.assign(r,s[0]),r.message=n(s.slice(1)).join(" ")):r.message=n(s).join(" ")),[JSON.stringify(r)]};if("simple"==t)return(e,t)=>[this.levelColorStr[e],"-",...n(t)];if("short"==t){const t=23+e.mod.length;return this.maxPrefixLength=Math.max(t,this.maxPrefixLength),(e,s)=>[v.default.grey(`[${(new Date).toISOString().substr(11)}]`),this.levelColorStr[e],r+this.padLeft(t)+v.default.grey(":"),...n(s)]}if("full"==t){const t=35+e.nodeID.length+e.mod.length;return this.maxPrefixLength=Math.max(t,this.maxPrefixLength),(e,s)=>[v.default.grey(`[${(new Date).toISOString()}]`),this.levelColorStr[e],i+this.padLeft(t)+v.default.grey(":"),...n(s)]}return(s,i)=>{const o=(new Date).toISOString();return[this.render(t,{timestamp:v.default.grey(o),time:v.default.grey(o.substr(11)),level:this.levelColorStr[s],nodeID:v.default.grey(e.nodeID),mod:r,msg:n(i).join(" ")})]}}render(e,t){return e.replace(/\{\s?(\w+)\s?\}/g,((e,s)=>t[s]||""))}};var jt=class extends Vt{constructor(e){super(e),this.maxPrefixLength=0}init(e){super.init(e),this.opts.colors||(v.default.enabled=!1)}getLogHandler(e){const t=e?this.getLogLevel(e.mod):null;if(!t)return null;const s=Vt.LEVELS.indexOf(t),r=this.getFormatter(e);return(e,t)=>{if(Vt.LEVELS.indexOf(e)>s)return;const i=r(e,t);switch(e){case"fatal":case"error":return console.error(...i);case"warn":return console.warn(...i);default:return console.log(...i)}}}};const{isObject:Kt,isString:zt}=ne,{BrokerOptionsError:Qt}=F,Zt={Base:Ft,Formatted:Vt,Bunyan:Le,Console:jt,Datadog:Le,Debug:Le,File:Le,Log4js:Le,Pino:Le,Winston:Le,LEVELS:Ft.LEVELS};function Wt(e){if(!e)return null;let t=Object.keys(Zt).find((t=>t.toLowerCase()==e.toLowerCase()));return t?Zt[t]:void 0}var Jt=Object.assign(Zt,{resolve:function(e){if(e instanceof Zt.Base)return e;if(zt(e)){let t=Wt(e);if(t)return new t}else if(Kt(e)){let t=Wt(e.type);if(t)return new t(e.options);throw new Qt(`Invalid logger configuration. Type: '${e.type}'`,{type:e.type})}throw new Qt(`Invalid logger configuration: '${e}'`,{type:e})},register:function(e,t){Zt[e]=t}});const{isPlainObject:Xt,isString:es}=ne,ts=()=>{},ss=H.cwd();var rs=class{constructor(e){this.broker=e,this.appenders=[],this.cache=new Map}init(e){this.opts=e;const t=this.broker.options.logLevel||"info";!1===e||null==e?this.appenders=[]:!0===e||e===console?this.appenders=[Jt.resolve({type:"Console",options:{level:t}})]:(Array.isArray(e)||(e=[e]),this.appenders=O.default.compact(e).map((e=>es(e)?Jt.resolve({type:e,options:{level:t}}):Xt(e)?Jt.resolve(O.default.defaultsDeep({},e,{options:{level:t}})):Jt.resolve(e)))),this.appenders.forEach((e=>e.init(this)))}stop(){return this.broker.Promise.all(this.appenders.map((e=>e.stop())))}getCallerFromStack(){const e=Error.prepareStackTrace;Error.prepareStackTrace=(e,t)=>t;const t=(new Error).stack;if(Error.prepareStackTrace=e,t.length>2){const e=t[2];return{filename:e.getFileName().substring(ss.length+1),lineNumber:e.getLineNumber(),columnNumber:e.getColumnNumber(),methodName:e.getMethodName(),functionName:e.getFunctionName()}}}getLogger(e){let t=this.cache.get(this.getBindingsKey(e));if(t)return t;t={};const s=this.broker,r=this.appenders,i=O.default.compact(r.map((t=>t.getLogHandler(e))));return Jt.LEVELS.forEach((r=>{if(0==i.length)return t[r]=ts;t[r]=function(...t){if(s.middlewares&&s.middlewares.registeredHooks.newLogEntry&&s.middlewares.callSyncHandlers("newLogEntry",[r,t,e],{}),0!=i.length)for(let e=0;e<i.length;e++)i[e](r,t)}})),t.appenders=r,this.cache.set(this.getBindingsKey(e),t),t}getBindingsKey(e){return e?["nodeID","ns","mod"].map((t=>e[t])).join("|"):""}};const{ValidationError:is}=F;var ns=class{constructor(e){this.opts=O.default.defaultsDeep(e,{paramName:"params"})}init(e){this.broker=e}compile(){throw new Error("Abstract method")}validate(){throw new Error("Abstract method")}convertSchemaToMoleculer(){throw new Error("Abstract method")}middleware(e){const t=this,s=this.opts.paramName;return{name:"Validator",localAction:function(r,i){if(i[s]&&"object"==typeof i[s]){const n=t.compile(i[s]);return function(t){let s=n(null!=t.params?t.params:{});return!0===s?r(t):(s=s.map((e=>Object.assign(e,{nodeID:t.nodeID,action:t.action.name}))),e.Promise.reject(new is("Parameters validation error!",null,s)))}}return r},localEvent:function(r,i){if(i[s]&&"object"==typeof i[s]){const n=t.compile(i[s]);return function(t){let s=n(null!=t.params?t.params:{});return!0===s?r(t):(s=s.map((e=>Object.assign(e,{nodeID:t.nodeID,event:t.event.name}))),e.Promise.reject(new is("Parameters validation error!",null,s)))}}return r}}}};const{ValidationError:os}=F;var as=class extends ns{constructor(e){super(e),this.validator=new k.default(this.opts)}compile(e){return this.validator.compile(e)}validate(e,t){const s=this.validator.validate(e,t);if(!0!==s)throw new os("Parameters validation error!",null,s);return!0}convertSchemaToMoleculer(e){return e}};const{BrokerOptionsError:ls}=F,{isObject:cs,isString:hs}=ne,us={Base:ns,Fastest:as};function ds(e){if(!e)return null;let t=Object.keys(us).find((t=>t.toLowerCase()==e.toLowerCase()));return t?us[t]:void 0}var ps=Object.assign(us,{resolve:function(e){if(e instanceof us.Base)return e;if(hs(e)){let t=ds(e);if(t)return new t;throw new ls(`Invalid Validator type '${e}'.`,{type:e})}if(cs(e)){let t=ds(e.type||"Fastest");if(t)return new t(e.options);throw new ls(`Invalid Validator type '${e.type}'.`,{type:e.type})}return new us.Fastest},register:function(e,t){us[e]=t}});const{METRIC:ms}=Qe,{isObject:Es,isFunction:gs}=ne;var fs=class{constructor(e){this.opts=O.default.defaultsDeep(e,{ttl:null,keygen:null,maxParamsLength:null})}init(e){this.broker=e,this.metrics=e.metrics,this.broker&&(this.logger=e.getLogger("cacher"),this.opts.prefix?this.prefix=this.opts.prefix+"-":(this.prefix="MOL-",this.broker.namespace&&(this.prefix+=this.broker.namespace+"-")),this.registerMoleculerMetrics())}registerMoleculerMetrics(){this.metrics.register({name:ms.MOLECULER_CACHER_GET_TOTAL,type:ms.TYPE_COUNTER,rate:!0}),this.metrics.register({name:ms.MOLECULER_CACHER_GET_TIME,type:ms.TYPE_HISTOGRAM,quantiles:!0,unit:ms.UNIT_MILLISECONDS}),this.metrics.register({name:ms.MOLECULER_CACHER_FOUND_TOTAL,type:ms.TYPE_COUNTER,rate:!0}),this.metrics.register({name:ms.MOLECULER_CACHER_SET_TOTAL,type:ms.TYPE_COUNTER,rate:!0}),this.metrics.register({name:ms.MOLECULER_CACHER_SET_TIME,type:ms.TYPE_HISTOGRAM,quantiles:!0,unit:ms.UNIT_MILLISECONDS}),this.metrics.register({name:ms.MOLECULER_CACHER_DEL_TOTAL,type:ms.TYPE_COUNTER,rate:!0}),this.metrics.register({name:ms.MOLECULER_CACHER_DEL_TIME,type:ms.TYPE_HISTOGRAM,quantiles:!0,unit:ms.UNIT_MILLISECONDS}),this.metrics.register({name:ms.MOLECULER_CACHER_CLEAN_TOTAL,type:ms.TYPE_COUNTER,rate:!0}),this.metrics.register({name:ms.MOLECULER_CACHER_CLEAN_TIME,type:ms.TYPE_HISTOGRAM,quantiles:!0,unit:ms.UNIT_MILLISECONDS}),this.metrics.register({name:ms.MOLECULER_CACHER_EXPIRED_TOTAL,type:ms.TYPE_COUNTER,rate:!0})}close(){return Promise.resolve()}get(){throw new Error("Not implemented method!")}getWithTTL(){throw new Error("Not implemented method!")}set(){throw new Error("Not implemented method!")}del(){throw new Error("Not implemented method!")}clean(){throw new Error("Not implemented method!")}getParamMetaValue(e,t,s){return e.startsWith("#")&&null!=s?O.default.get(s,e.slice(1)):null!=t?O.default.get(t,e):void 0}defaultKeygen(e,t,s,r){if(t||s){const i=e+":";if(!r)return i+this._hashedKey(this._generateKeyFromObject(t));if(1==r.length){const e=this.getParamMetaValue(r[0],t,s);return i+this._hashedKey(Es(e)?this._hashedKey(this._generateKeyFromObject(e)):e)}if(r.length>0)return i+this._hashedKey(r.reduce(((e,r,i)=>{const n=this.getParamMetaValue(r,t,s);return e+(i?"|":"")+(Es(n)||Array.isArray(n)?this._hashedKey(this._generateKeyFromObject(n)):n)}),""))}return e}_hashedKey(e){const t=this.opts.maxParamsLength;if(!t||t<44||e.length<=t)return e;const s=t-44,r=N.default.createHash("sha256").update(e).digest("base64");return s<1?r:e.substring(0,s)+r}_generateKeyFromObject(e){return Array.isArray(e)?e.map((e=>this._generateKeyFromObject(e))).join("|"):Es(e)?Object.keys(e).map((t=>[t,this._generateKeyFromObject(e[t])].join("|"))).join("|"):null!=e?e.toString():"null"}getCacheKey(e,t,s,r){return gs(this.opts.keygen)?this.opts.keygen.call(this,e,t,s,r):this.defaultKeygen(e,t,s,r)}middleware(){return(e,t)=>{const s=O.default.defaultsDeep({},Es(t.cache)?t.cache:{enabled:!!t.cache});if(s.lock=O.default.defaultsDeep({},Es(s.lock)?s.lock:{enabled:!!s.lock}),!1!==s.enabled){const r=gs(s.enabled);return function(i){if(r&&!s.enabled.call(i.service,i))return e(i);if(!1===i.meta.$cache)return e(i);const n=this.getCacheKey(t.name,i.params,i.meta,s.keys);if(!1!==s.lock.enabled){let t;return t=s.lock.staleTime&&this.getWithTTL?this.getWithTTL(n).then((({data:t,ttl:r})=>(null!=t&&s.lock.staleTime&&r&&r<s.lock.staleTime&&this.tryLock(n,s.lock.ttl).then((t=>e(i).then((e=>this.set(n,e,s.ttl).then((()=>t())))).catch((()=>this.del(n).then((()=>t())))))).catch((()=>{})),t))):this.get(n),t.then((t=>null!=t?(i.cachedResult=!0,t):this.lock(n,s.lock.ttl).then((t=>this.get(n).then((r=>null!=r?(i.cachedResult=!0,t().then((()=>r))):e(i).then((e=>(this.set(n,e,s.ttl).then((()=>t())),e))).catch((e=>t().then((()=>Promise.reject(e)))))))))))}return this.get(n).then((t=>null!=t?(i.cachedResult=!0,t):e(i).then((e=>(this.set(n,e,s.ttl),e)))))}.bind(this)}return e}}};var _s=class{constructor(){this.locked=new Map}acquire(e){let t=this.locked.get(e);return t?new Promise((e=>t.push(e))):(t=[],this.locked.set(e,t),Promise.resolve())}isLocked(e){return!!this.locked.get(e)}release(e){let t=this.locked.get(e);return t&&(t.length>0?t.shift()():this.locked.delete(e)),Promise.resolve()}};const{METRIC:Ts}=Qe;var vs=class extends fs{constructor(e){super(e),this.cache=new Map,this._lock=new _s,this.timer=i.setInterval((()=>{this.checkTTL()}),3e4),this.timer.unref(),this.clone=!0===this.opts.clone?O.default.cloneDeep:this.opts.clone}init(e){super.init(e),e.localBus.on("$transporter.connected",(()=>this.clean()))}close(){return clearInterval(this.timer),Promise.resolve()}get(e){this.logger.debug("GET "+e),this.metrics.increment(Ts.MOLECULER_CACHER_GET_TOTAL);const t=this.metrics.timer(Ts.MOLECULER_CACHER_GET_TIME);if(this.cache.has(e)){this.logger.debug("FOUND "+e),this.metrics.increment(Ts.MOLECULER_CACHER_FOUND_TOTAL);let s=this.cache.get(e);if(s.expire&&s.expire<Date.now())return this.logger.debug("EXPIRED "+e),this.metrics.increment(Ts.MOLECULER_CACHER_EXPIRED_TOTAL),this.cache.delete(e),t(),this.broker.Promise.resolve(null);const r=this.clone?this.clone(s.data):s.data;return t(),this.broker.Promise.resolve(r)}return t(),this.broker.Promise.resolve(null)}set(e,t,s){this.metrics.increment(Ts.MOLECULER_CACHER_SET_TOTAL);const r=this.metrics.timer(Ts.MOLECULER_CACHER_SET_TIME);return null==s&&(s=this.opts.ttl),this.cache.set(e,{data:t,expire:s?Date.now()+1e3*s:null}),r(),this.logger.debug("SET "+e),this.broker.Promise.resolve(t)}del(e){this.metrics.increment(Ts.MOLECULER_CACHER_DEL_TOTAL);const t=this.metrics.timer(Ts.MOLECULER_CACHER_DEL_TIME);return(e=Array.isArray(e)?e:[e]).forEach((e=>{this.cache.delete(e),this.logger.debug("REMOVE "+e)})),t(),this.broker.Promise.resolve()}clean(e="**"){this.metrics.increment(Ts.MOLECULER_CACHER_CLEAN_TOTAL);const t=this.metrics.timer(Ts.MOLECULER_CACHER_CLEAN_TIME),s=Array.isArray(e)?e:[e];return this.logger.debug("CLEAN "+s.join(", ")),this.cache.forEach(((e,t)=>{s.some((e=>ne.match(t,e)))&&(this.logger.debug("REMOVE "+t),this.cache.delete(t))})),t(),this.broker.Promise.resolve()}getWithTTL(e){this.logger.debug("GET "+e);let t=null,s=null;if(this.cache.has(e)){this.logger.debug("FOUND "+e);let r=this.cache.get(e),i=Date.now();s=(r.expire-i)/1e3,s=s>0?s:null,this.opts.ttl&&(r.expire=i+1e3*this.opts.ttl),t=this.clone?this.clone(r.data):r.data}return this.broker.Promise.resolve({data:t,ttl:s})}lock(e,t){return this._lock.acquire(e,t).then((()=>()=>this._lock.release(e)))}tryLock(e,t){return this._lock.isLocked(e)?this.broker.Promise.reject(new Error("Locked.")):this._lock.acquire(e,t).then((()=>()=>this._lock.release(e)))}checkTTL(){let e=Date.now();this.cache.forEach(((t,s)=>{let r=this.cache.get(s);r.expire&&r.expire<e&&(this.logger.debug("EXPIRED "+s),this.metrics.increment(Ts.MOLECULER_CACHER_EXPIRED_TOTAL),this.cache.delete(s))}))}};const{METRIC:Ss}=Qe;var bs=class extends fs{constructor(e){super(e),this.cache=new P.default({max:this.opts.max,maxAge:this.opts.ttl?1e3*this.opts.ttl:null,updateAgeOnGet:!!this.opts.ttl}),this._lock=new _s,this.timer=i.setInterval((()=>{this.checkTTL()}),3e4),this.timer.unref(),this.clone=!0===this.opts.clone?O.default.cloneDeep:this.opts.clone}init(e){super.init(e),e.localBus.on("$transporter.connected",(()=>this.clean())),this.opts.lock&&!1!==this.opts.lock.enabled&&this.opts.lock.staleTime&&this.logger.warn("setting lock.staleTime with MemoryLRUCacher is not supported.")}close(){return clearInterval(this.timer),Promise.resolve()}get(e){this.logger.debug("GET "+e),this.metrics.increment(Ss.MOLECULER_CACHER_GET_TOTAL);const t=this.metrics.timer(Ss.MOLECULER_CACHER_GET_TIME);if(this.cache.has(e)){this.logger.debug("FOUND "+e),this.metrics.increment(Ss.MOLECULER_CACHER_FOUND_TOTAL);let s=this.cache.get(e);const r=this.clone?this.clone(s):s;return t(),this.broker.Promise.resolve(r)}return t(),this.broker.Promise.resolve(null)}set(e,t,s){this.metrics.increment(Ss.MOLECULER_CACHER_SET_TOTAL);const r=this.metrics.timer(Ss.MOLECULER_CACHER_SET_TIME);return null==s&&(s=this.opts.ttl),this.cache.set(e,t,s?1e3*s:null),r(),this.logger.debug("SET "+e),this.broker.Promise.resolve(t)}del(e){this.metrics.increment(Ss.MOLECULER_CACHER_DEL_TOTAL);const t=this.metrics.timer(Ss.MOLECULER_CACHER_DEL_TIME);return(e=Array.isArray(e)?e:[e]).forEach((e=>{this.cache.del(e),this.logger.debug("REMOVE "+e)})),t(),this.broker.Promise.resolve()}clean(e="**"){this.metrics.increment(Ss.MOLECULER_CACHER_CLEAN_TOTAL);const t=this.metrics.timer(Ss.MOLECULER_CACHER_CLEAN_TIME),s=Array.isArray(e)?e:[e];return this.logger.debug("CLEAN "+s.join(", ")),this.cache.keys().forEach((e=>{s.some((t=>ne.match(e,t)))&&(this.logger.debug("REMOVE "+e),this.cache.del(e))})),t(),this.broker.Promise.resolve()}getWithTTL(e){return this.get(e).then((e=>({data:e,ttl:null})))}lock(e,t){return this._lock.acquire(e,t).then((()=>()=>this._lock.release(e)))}tryLock(e,t){return this._lock.isLocked(e)?this.broker.Promise.reject(new Error("Locked.")):this._lock.acquire(e,t).then((()=>()=>this._lock.release(e)))}checkTTL(){this.cache.prune()}};const{isObject:Os,isString:ys}=ne,{BrokerOptionsError:Is}=F,Rs={Base:fs,Memory:vs,MemoryLRU:bs,Redis:Le};function Cs(e){if(!e)return null;let t=Object.keys(Rs).find((t=>t.toLowerCase()==e.toLowerCase()));return t?Rs[t]:void 0}var Ls=Object.assign(Rs,{resolve:function(e){if(e instanceof Rs.Base)return e;if(!0===e)return new Rs.Memory;if(ys(e)){let t=Cs(e);if(t)return new t;if(e.startsWith("redis://")&&(t=Rs.Redis),t)return new t(e);throw new Is(`Invalid cacher type '${e}'.`,{type:e})}if(Os(e)){let t=Cs(e.type||"Memory");if(t)return new t(e.options);throw new Is(`Invalid cacher type '${e.type}'.`,{type:e.type})}return null},register:function(e,t){Rs[e]=t}});const{flatten:As}=ne,{BrokerDisconnectedError:Ns}=F;var Ps=class{constructor(e){this.opts=e,this.connected=!1,this.hasBuiltInBalancer=!1}init(e,t,s){e&&(this.transit=e,this.broker=e.broker,this.nodeID=e.nodeID,this.logger=this.broker.getLogger("transporter"),this.prefix="MOL",this.broker.namespace&&(this.prefix+="-"+this.broker.namespace)),this.messageHandler=t,this.afterConnect=s}connect(){throw new Error("Not implemented!")}onConnected(e){return this.connected=!0,this.afterConnect?this.afterConnect(e):this.broker.Promise.resolve()}disconnect(){throw new Error("Not implemented!")}makeSubscriptions(e){return this.broker.Promise.all(e.map((({cmd:e,nodeID:t})=>this.subscribe(e,t))))}incomingMessage(e,t){if(t)try{const s=this.deserialize(e,t);return this.messageHandler(e,s)}catch(s){this.logger.warn("Invalid incoming packet. Type:",e,s),this.logger.debug("Content:",t.toString?t.toString():t)}}receive(e,t){return this.incomingMessage(e,t)}subscribe(){throw new Error("Not implemented!")}subscribeBalancedRequest(){throw new Error("Not implemented!")}subscribeBalancedEvent(){throw new Error("Not implemented!")}unsubscribeFromBalancedCommands(){return this.broker.Promise.resolve()}publish(e){const t=this.getTopicName(e.type,e.target),s=this.serialize(e);return this.send(t,s,{packet:e})}publishBalancedEvent(e,t){const s=`${this.prefix}.${G.PACKET_EVENT}B.${t}.${e.payload.event}`,r=this.serialize(e);return this.send(s,r,{packet:e,balanced:!0})}publishBalancedRequest(e){const t=`${this.prefix}.${G.PACKET_REQUEST}B.${e.payload.action}`,s=this.serialize(e);return this.send(t,s,{packet:e,balanced:!0})}send(){throw new Error("Not implemented!")}getTopicName(e,t){return this.prefix+"."+e+(t?"."+t:"")}makeBalancedSubscriptions(){return this.hasBuiltInBalancer?this.unsubscribeFromBalancedCommands().then((()=>{const e=this.broker.getLocalNodeInfo().services;return this.broker.Promise.all(e.map((e=>{const t=[];return e.actions&&"object"==typeof e.actions&&t.push(Object.keys(e.actions).map((e=>this.subscribeBalancedRequest(e)))),e.events&&"object"==typeof e.events&&t.push(Object.keys(e.events).map((t=>{const s=e.events[t].group||e.name;this.subscribeBalancedEvent(t,s)}))),this.broker.Promise.all(O.default.compact(As(t,!0)))})))})):this.broker.Promise.resolve()}prepublish(e){if(!this.connected)return[G.PACKET_REQUEST,G.PACKET_EVENT,G.PACKET_PING].includes(e.type)?this.broker.Promise.reject(new Ns):this.broker.Promise.resolve();if(e.type===G.PACKET_EVENT&&null==e.target&&e.payload.groups){const t=e.payload.groups;if(t.length>0)return t.forEach((t=>{e.payload.groups=[t],this.publishBalancedEvent(e,t)})),this.broker.Promise.resolve()}else if(e.type===G.PACKET_REQUEST&&null==e.target)return this.publishBalancedRequest(e);return this.publish(e)}serialize(e){return e.payload.ver=this.broker.PROTOCOL_VERSION,e.payload.sender=this.nodeID,this.broker.serializer.serialize(e.payload,e.type)}deserialize(e,t){if(null==t)return null;const s=this.broker.serializer.deserialize(t,e);return new G.Packet(e,null,s)}};const Ms=S.default.EventEmitter2;$.bus=new Ms({wildcard:!0,maxListeners:100});var ks=class extends Ps{constructor(e){super(e),this.bus=$.bus,this.hasBuiltInBalancer=!0,this.subscriptions=[]}connect(){return this.onConnected()}disconnect(){return this.connected=!1,this.subscriptions.forEach((({topic:e,handler:t})=>this.bus.off(e,t))),this.subscriptions=[],this.broker.Promise.resolve()}subscribe(e,t){const s=this.getTopicName(e,t),r=t=>this.receive(e,t);return this.subscriptions.push({topic:s,handler:r}),this.bus.on(s,r),this.broker.Promise.resolve()}subscribeBalancedRequest(){return this.broker.Promise.resolve()}subscribeBalancedEvent(){return this.broker.Promise.resolve()}send(e,t){return this.bus.emit(e,t),this.broker.Promise.resolve()}};const{isObject:Us,isString:Ds}=ne,{BrokerOptionsError:ws}=F,xs={Base:Ps,Fake:ks,NATS:Le,MQTT:Le,Redis:Le,AMQP:Le,AMQP10:Le,Kafka:Le,STAN:Le,TCP:Le};function Hs(e){if(!e)return null;let t=Object.keys(xs).find((t=>t.toLowerCase()==e.toLowerCase()));return t?xs[t]:void 0}var $s=Object.assign(xs,{resolve:function(e){if(e instanceof xs.Base)return e;if(Ds(e)){let t=Hs(e);if(t)return new t;if(e.startsWith("nats://")?t=xs.NATS:e.startsWith("mqtt://")||e.startsWith("mqtts://")?t=xs.MQTT:e.startsWith("redis://")||e.startsWith("rediss://")?t=xs.Redis:e.startsWith("amqp://")||e.startsWith("amqps://")?t=xs.AMQP:e.startsWith("amqp10://")?t=xs.AMQP10:e.startsWith("kafka://")?t=xs.Kafka:e.startsWith("stan://")?t=xs.STAN:e.startsWith("tcp://")&&(t=xs.TCP),t)return new t(e);throw new ws(`Invalid transporter type '${e}'.`,{type:e})}if(Us(e)){let t=Hs(e.type||"NATS");if(t)return new t(e.options);throw new ws(`Invalid transporter type '${e.type}'.`,{type:e.type})}return null},register:function(e,t){xs[e]=t}});var Bs=class{constructor(){}init(e){this.broker=e}serialize(){throw new Error("Not implemented method!")}deserialize(){throw new Error("Not implemented method!")}serializeCustomFields(e,t){switch(e){case G.PACKET_INFO:t.services=JSON.stringify(t.services),t.config&&(t.config=JSON.stringify(t.config)),t.metadata&&(t.metadata=JSON.stringify(t.metadata));break;case G.PACKET_EVENT:this.convertDataToTransport(t,"data","dataType"),t.meta=JSON.stringify(t.meta);break;case G.PACKET_REQUEST:this.convertDataToTransport(t,"params","paramsType"),t.meta=JSON.stringify(t.meta);break;case G.PACKET_RESPONSE:this.convertDataToTransport(t,"data","dataType"),t.meta=JSON.stringify(t.meta),t.error&&(t.error=JSON.stringify(t.error));break;case G.PACKET_GOSSIP_REQ:case G.PACKET_GOSSIP_RES:t.online&&(t.online=JSON.stringify(t.online)),t.offline&&(t.offline=JSON.stringify(t.offline))}return t}deserializeCustomFields(e,t){switch(e){case G.PACKET_INFO:t.services=JSON.parse(t.services),t.config&&(t.config=JSON.parse(t.config)),t.metadata&&(t.metadata=JSON.parse(t.metadata));break;case G.PACKET_EVENT:this.convertDataFromTransport(t,"data","dataType"),t.meta=JSON.parse(t.meta);break;case G.PACKET_REQUEST:this.convertDataFromTransport(t,"params","paramsType"),t.meta=JSON.parse(t.meta);break;case G.PACKET_RESPONSE:this.convertDataFromTransport(t,"data","dataType"),t.meta=JSON.parse(t.meta),t.error&&(t.error=JSON.parse(t.error));break;case G.PACKET_GOSSIP_REQ:case G.PACKET_GOSSIP_RES:t.online&&(t.online=JSON.parse(t.online)),t.offline&&(t.offline=JSON.parse(t.offline))}return t}convertDataToTransport(e,t,s){void 0===e[t]?e[s]=G.DATATYPE_UNDEFINED:null===e[t]?e[s]=G.DATATYPE_NULL:l.Buffer.isBuffer(e[t])?e[s]=G.DATATYPE_BUFFER:(e[s]=G.DATATYPE_JSON,e[t]=l.Buffer.from(JSON.stringify(e[t])))}convertDataFromTransport(e,t,s){switch(e[s]){case G.DATATYPE_UNDEFINED:e[t]=void 0;break;case G.DATATYPE_NULL:e[t]=null;break;case G.DATATYPE_BUFFER:l.Buffer.isBuffer(e[t])||(e[t]=l.Buffer.from(e[t]));break;default:e[t]=JSON.parse(e[t])}delete e[s]}};var Gs=class extends Bs{constructor(){super()}serialize(e){return l.Buffer.from(JSON.stringify(e))}deserialize(e){return JSON.parse(e)}};const{isObject:Fs,isString:qs}=ne,{BrokerOptionsError:Ys}=F,Vs={Base:Bs,JSON:Gs,Avro:Le,MsgPack:Le,ProtoBuf:Le,Thrift:Le,Notepack:Le};function js(e){if(!e)return null;let t=Object.keys(Vs).find((t=>t.toLowerCase()==e.toLowerCase()));return t?Vs[t]:void 0}var Ks=Object.assign(Vs,{resolve:function(e){if(e instanceof Vs.Base)return e;if(qs(e)){let t=js(e);if(t)return new t;throw new Ys(`Invalid serializer type '${e}'.`,{type:e})}if(Fs(e)){let t=js(e.type||"JSON");if(t)return new t(e.options);throw new Ys(`Invalid serializer type '${e.type}'.`,{type:e.type})}return new Vs.JSON},register:function(e,t){Vs[e]=t}}),zs="0.14.11";const{getIpList:Qs}=ne,Zs=zs,Ws=()=>({type:"browser",version:Zs,langVersion:H.version}),Js=()=>{const e=Q.cpus(),t=Q.loadavg(),s={load1:t[0],load5:t[1],load15:t[2],cores:Array.isArray(e)?Q.cpus().length:null};return s.utilization=Math.min(Math.floor(100*t[0]/s.cores),100),s},Xs=()=>{const e={free:Q.freemem(),total:Q.totalmem()};return e.percent=100*e.free/e.total,e},er=()=>{try{return Q.userInfo()}catch(e){return{}}},tr=()=>({uptime:Q.uptime(),type:Q.type(),release:Q.release(),hostname:Q.hostname(),arch:Q.arch(),platform:Q.platform(),user:er()}),sr=()=>({pid:H.pid,memory:H.memoryUsage(),uptime:H.uptime(),argv:H.argv}),rr=()=>({ip:Qs()}),ir=()=>({now:Date.now(),iso:(new Date).toISOString(),utc:(new Date).toUTCString()});var nr=()=>({cpu:Js(),mem:Xs(),os:tr(),process:sr(),client:Ws(),net:rr(),time:ir()});const{isFunction:or,isString:ar}=ne;const{QueueIsFullError:lr}=F,{METRIC:cr}=Qe;const{GracefulStopTimeoutError:hr}=F;const{METRIC:ur}=Qe;const{RequestTimeoutError:dr}=F,{METRIC:pr}=Qe;const{METRIC:mr}=Qe;const{MoleculerError:Er}=F,{METRIC:gr}=Qe,{isFunction:fr,isString:_r}=ne;const{MoleculerError:Tr}=F;function vr(e){return function(t){return e(t).catch((e=>(e instanceof Error||(e=new Tr(e,500)),t.nodeID!==this.nodeID&&this.transit&&this.transit.removePendingRequest(t.id),this.logger.debug(`The '${t.action.name}' request is rejected.`,{requestID:t.requestID},e),Object.defineProperty(e,"ctx",{value:t,writable:!0,enumerable:!1}),t.broker.errorHandler(e,{ctx:t,service:t.service,action:t.action}))))}.bind(this)}function Sr(e){return function(t){return e(t).catch((e=>(e instanceof Error||(e=new Tr(e,500)),this.logger.debug(`Error occured in the '${t.event.name}' event handler in the '${t.service.fullName}' service.`,{requestID:t.requestID},e),Object.defineProperty(e,"ctx",{value:t,writable:!0,enumerable:!1}),t.broker.errorHandler(e,{ctx:t,service:t.service,event:t.event})))).catch((e=>{t.broker.logger.error(e)}))}.bind(this)}const{METRIC:br}=Qe;const{isFunction:Or,isPlainObject:yr}=ne;var Ir=Object.freeze({__proto__:null,deflateRaw:(...e)=>f.deflateSync(...e),inflateRaw:(...e)=>f.inflateSync(...e),gzip:(...e)=>f.gzip(...e),gunzip:(...e)=>f.gunzip(...e),deflate:(...e)=>f.zlibSync(...e),inflate:(...e)=>f.unzlibSync(...e)});const{defaultsDeep:Rr}=O.default,{parseByteString:Cr}=ne,{promisify:Lr}=M.default;const{makeDirs:Ar}=ne;const{makeDirs:Nr,match:Pr,isObject:Mr}=ne;var kr={ActionHook:function(e){function t(t,s,r,i){return or(t)?t.call(s,r,i):Array.isArray(t)?t.reduce(((e,t)=>e.then((e=>t.call(s,r,e)))),e.Promise.resolve(i)):void 0}function s(t,s,r,i){return or(t)?t.call(s,r,i):Array.isArray(t)?t.reduce(((e,t)=>e.catch((e=>t.call(s,r,e)))),e.Promise.reject(i)):void 0}function r(e,t){return ar(e)?t&&or(t[e])?t[e]:null:Array.isArray(e)?O.default.compact(e.map((e=>ar(e)?t&&or(t[e])?t[e]:null:e))):e}return{name:"ActionHook",localAction:function(i,n){const o=n.rawName||n.name,a=n.service&&n.service.schema?n.service.schema.hooks:null;if(a||n.hooks){const l=a&&a.before?r(a.before["*"],n.service):null,c=a&&a.after?r(a.after["*"],n.service):null,h=a&&a.error?r(a.error["*"],n.service):null,u=a&&a.before?r(a.before[o],n.service):null,d=a&&a.after?r(a.after[o],n.service):null,p=a&&a.error?r(a.error[o],n.service):null,m=n.hooks&&n.hooks.before?r(n.hooks.before,n.service):null,E=n.hooks&&n.hooks.after?r(n.hooks.after,n.service):null,g=n.hooks&&n.hooks.error?r(n.hooks.error,n.service):null;if(l||u||m||c||d||E||h||p||g)return function(r){let n=e.Promise.resolve();return l&&(n=n.then((()=>t(l,r.service,r)))),u&&(n=n.then((()=>t(u,r.service,r)))),m&&(n=n.then((()=>t(m,r.service,r)))),n=n.then((()=>i(r))),E&&(n=n.then((e=>t(E,r.service,r,e)))),d&&(n=n.then((e=>t(d,r.service,r,e)))),c&&(n=n.then((e=>t(c,r.service,r,e)))),g&&(n=n.catch((e=>s(g,r.service,r,e)))),p&&(n=n.catch((e=>s(p,r.service,r,e)))),h&&(n=n.catch((e=>s(h,r.service,r,e)))),n}}return i}}},Bulkhead:function(e){return{name:"Bulkhead",created(){e.isMetricsEnabled()&&(e.metrics.register({name:cr.MOLECULER_REQUEST_BULKHEAD_INFLIGHT,type:cr.TYPE_GAUGE,labelNames:["action","service"]}),e.metrics.register({name:cr.MOLECULER_REQUEST_BULKHEAD_QUEUE_SIZE,type:cr.TYPE_GAUGE,labelNames:["action","service"]}),e.metrics.register({name:cr.MOLECULER_EVENT_BULKHEAD_INFLIGHT,type:cr.TYPE_GAUGE,labelNames:["event","service"]}),e.metrics.register({name:cr.MOLECULER_EVENT_BULKHEAD_QUEUE_SIZE,type:cr.TYPE_GAUGE,labelNames:["event","service"]}))},localAction:function(t,s){const r=s.service,i=Object.assign({},this.options.bulkhead||{},s.bulkhead||{});if(i.enabled){const n=[];let o=0;const a=function a(){if(0==n.length)return;if(o>=i.concurrency)return;const l=n.shift();o++,e.metrics.set(cr.MOLECULER_REQUEST_BULKHEAD_INFLIGHT,o,{action:s.name,service:r.fullName}),e.metrics.set(cr.MOLECULER_REQUEST_BULKHEAD_QUEUE_SIZE,n.length,{action:s.name,service:r.fullName}),t(l.ctx).then((t=>{o--,e.metrics.set(cr.MOLECULER_REQUEST_BULKHEAD_INFLIGHT,o,{action:s.name,service:r.fullName}),e.metrics.set(cr.MOLECULER_REQUEST_BULKHEAD_QUEUE_SIZE,n.length,{action:s.name,service:r.fullName}),l.resolve(t),a()})).catch((t=>{o--,e.metrics.set(cr.MOLECULER_REQUEST_BULKHEAD_INFLIGHT,o,{action:s.name,service:r.fullName}),e.metrics.set(cr.MOLECULER_REQUEST_BULKHEAD_QUEUE_SIZE,n.length,{action:s.name,service:r.fullName}),l.reject(t),a()}))};return function(l){if(o<i.concurrency)return o++,e.metrics.set(cr.MOLECULER_REQUEST_BULKHEAD_INFLIGHT,o,{action:s.name,service:r.fullName}),e.metrics.set(cr.MOLECULER_REQUEST_BULKHEAD_QUEUE_SIZE,n.length,{action:s.name,service:r.fullName}),t(l).then((t=>(o--,e.metrics.set(cr.MOLECULER_REQUEST_BULKHEAD_INFLIGHT,o,{action:s.name,service:r.fullName}),e.metrics.set(cr.MOLECULER_REQUEST_BULKHEAD_QUEUE_SIZE,n.length,{action:s.name,service:r.fullName}),a(),t))).catch((t=>(o--,e.metrics.set(cr.MOLECULER_REQUEST_BULKHEAD_INFLIGHT,o,{action:s.name,service:r.fullName}),e.metrics.set(cr.MOLECULER_REQUEST_BULKHEAD_QUEUE_SIZE,n.length,{action:s.name,service:r.fullName}),a(),e.Promise.reject(t))));if(i.maxQueueSize&&n.length>=i.maxQueueSize)return e.Promise.reject(new lr({action:l.action.name,nodeID:l.nodeID}));const c=new Promise(((e,t)=>n.push({resolve:e,reject:t,ctx:l})));return e.metrics.set(cr.MOLECULER_REQUEST_BULKHEAD_QUEUE_SIZE,n.length,{action:s.name,service:r.fullName}),c}.bind(this)}return t},localEvent:function(t,s){const r=s.service,i=Object.assign({},this.options.bulkhead||{},s.bulkhead||{});if(i.enabled){const n=[];let o=0;const a=function a(){if(0==n.length)return;if(o>=i.concurrency)return;const l=n.shift();o++,e.metrics.set(cr.MOLECULER_EVENT_BULKHEAD_INFLIGHT,o,{event:s.name,service:r.fullName}),e.metrics.set(cr.MOLECULER_EVENT_BULKHEAD_QUEUE_SIZE,n.length,{event:s.name,service:r.fullName}),t(l.ctx).then((t=>{o--,e.metrics.set(cr.MOLECULER_EVENT_BULKHEAD_INFLIGHT,o,{event:s.name,service:r.fullName}),e.metrics.set(cr.MOLECULER_EVENT_BULKHEAD_QUEUE_SIZE,n.length,{event:s.name,service:r.fullName}),l.resolve(t),a()})).catch((t=>{o--,e.metrics.set(cr.MOLECULER_EVENT_BULKHEAD_INFLIGHT,o,{event:s.name,service:r.fullName}),e.metrics.set(cr.MOLECULER_EVENT_BULKHEAD_QUEUE_SIZE,n.length,{event:s.name,service:r.fullName}),l.reject(t),a()}))};return function(l){if(o<i.concurrency)return o++,e.metrics.set(cr.MOLECULER_EVENT_BULKHEAD_INFLIGHT,o,{event:s.name,service:r.fullName}),e.metrics.set(cr.MOLECULER_EVENT_BULKHEAD_QUEUE_SIZE,n.length,{event:s.name,service:r.fullName}),t(l).then((t=>(o--,e.metrics.set(cr.MOLECULER_EVENT_BULKHEAD_INFLIGHT,o,{event:s.name,service:r.fullName}),e.metrics.set(cr.MOLECULER_EVENT_BULKHEAD_QUEUE_SIZE,n.length,{event:s.name,service:r.fullName}),a(),t))).catch((t=>(o--,e.metrics.set(cr.MOLECULER_EVENT_BULKHEAD_INFLIGHT,o,{event:s.name,service:r.fullName}),e.metrics.set(cr.MOLECULER_EVENT_BULKHEAD_QUEUE_SIZE,n.length,{event:s.name,service:r.fullName}),a(),e.Promise.reject(t))));if(i.maxQueueSize&&n.length>=i.maxQueueSize)return e.Promise.reject(new lr({event:l.eventName,service:r.fullName,nodeID:l.nodeID}));const c=new Promise(((e,t)=>n.push({resolve:e,reject:t,ctx:l})));return e.metrics.set(cr.MOLECULER_EVENT_BULKHEAD_QUEUE_SIZE,n.length,{event:s.name,service:r.fullName}),c}.bind(this)}return t}}},ContextTracker:function(e){function t(e){if(e.service){const t=e.service._trackedContexts.indexOf(e);-1!==t&&e.service._trackedContexts.splice(t,1)}else{const t=e.broker._trackedContexts.indexOf(e);-1!==t&&e.broker._trackedContexts.splice(t,1)}}function s(e){return this.options.tracking&&this.options.tracking.enabled?function(s){if(!(null!=s.options.tracking?s.options.tracking:this.options.tracking.enabled))return e(s);!function(e){e.service?e.service._trackedContexts.push(e):e.broker._trackedContexts.push(e)}(s);let r=e(s);return r=r.then((e=>(t(s),e))).catch((e=>{throw t(s),e})),r}.bind(this):e}function r(t,s,r,n){return t&&0!==t.length?new e.Promise((e=>{let o=!1;const a=i.setTimeout((()=>{o=!0,s.error(new hr({service:n})),t.length=0,e()}),r);let l=!0;const c=()=>{0===t.length?(clearTimeout(a),e()):(l&&(s.warn(`Waiting for ${t.length} running context(s)...`),l=!1),o||i.setTimeout(c,100))};setImmediate(c)})):e.Promise.resolve()}return{name:"ContextTracker",localAction:s,remoteAction:s,localEvent:s,created(e){e._trackedContexts=[]},serviceStarting(e){e._trackedContexts=[]},serviceStopping:e=>r(e._trackedContexts,e.logger,e.settings.$shutdownTimeout||e.broker.options.tracking.shutdownTimeout,e),stopping:e=>r(e._trackedContexts,e.logger,e.options.tracking.shutdownTimeout)}},CircuitBreaker:function(e){let t;const s=new Map;let r;function n(e){t||(t=i.setInterval((()=>function(){if(!r)return;r.debug("Reset circuit-breaker endpoint states..."),s.forEach(((e,t)=>{if(0==e.count)return r.debug(`Remove '${t}' endpoint state because it is not used`),void s.delete(t);r.debug(`Clean '${t}' endpoint state.`),e.count=0,e.failures=0}))}()),1e3*(e||60)),t.unref())}function o(e,t,r){let i=s.get(e.name);return i||(i={ep:e,service:t,opts:r,count:0,failures:0,state:D.CIRCUIT_CLOSE,cbTimer:null},s.set(e.name,i)),i}function a(t,s){t.count++,t.state===D.CIRCUIT_HALF_OPEN_WAIT?function(t){t.state=D.CIRCUIT_CLOSE,t.ep.state=!0,t.failures=0,t.count=0;const s=t.ep.action,i=t.service.fullName;r.debug(`Circuit breaker has been closed on '${t.ep.name}' endpoint.`,{nodeID:t.ep.id,service:i,action:s.name}),e.broadcast("$circuit-breaker.closed",{nodeID:t.ep.id,service:i,action:s.name}),e.metrics.set(ur.MOLECULER_CIRCUIT_BREAKER_OPENED_ACTIVE,0,{affectedNodeID:t.ep.id,service:i,action:s.name}),e.metrics.set(ur.MOLECULER_CIRCUIT_BREAKER_HALF_OPENED_ACTIVE,0,{affectedNodeID:t.ep.id,service:i,action:s.name}),t.cbTimer&&(clearTimeout(t.cbTimer),t.cbTimer=null)}(t):l(t)}function l(t,s){if(t.count>=t.opts.minRequestCount){t.failures/t.count>=t.opts.threshold&&function(t,s){if(t.state==D.CIRCUIT_OPEN)return;t.state=D.CIRCUIT_OPEN,t.ep.state=!1,t.cbTimer&&(clearTimeout(t.cbTimer),t.cbTimer=null);t.cbTimer=i.setTimeout((()=>c(t)),t.opts.halfOpenTime),t.cbTimer.unref();const n=t.ep.action,o=t.service.fullName,a=t.count>0?t.failures/t.count:0;r.debug(`Circuit breaker has been opened on '${t.ep.name}' endpoint.`,{nodeID:t.ep.id,service:o,action:n.name,failures:t.failures,count:t.count,rate:a}),e.broadcast("$circuit-breaker.opened",{nodeID:t.ep.id,service:o,action:n.name,failures:t.failures,count:t.count,rate:a}),e.metrics.set(ur.MOLECULER_CIRCUIT_BREAKER_OPENED_ACTIVE,1,{affectedNodeID:t.ep.id,service:o,action:n.name}),e.metrics.increment(ur.MOLECULER_CIRCUIT_BREAKER_OPENED_TOTAL,{affectedNodeID:t.ep.id,service:o,action:n.name})}(t)}}function c(t){t.state=D.CIRCUIT_HALF_OPEN,t.ep.state=!0;const s=t.ep.action,i=t.service.fullName;r.debug(`Circuit breaker has been half-opened on '${t.ep.name}' endpoint.`,{nodeID:t.ep.id,service:i,action:s.name}),e.broadcast("$circuit-breaker.half-opened",{nodeID:t.ep.id,service:i,action:s.name}),e.metrics.set(ur.MOLECULER_CIRCUIT_BREAKER_OPENED_ACTIVE,0,{affectedNodeID:t.ep.id,service:i,action:s.name}),e.metrics.set(ur.MOLECULER_CIRCUIT_BREAKER_HALF_OPENED_ACTIVE,1,{affectedNodeID:t.ep.id,service:i,action:s.name}),t.cbTimer&&(clearTimeout(t.cbTimer),t.cbTimer=null)}function h(e,t){const s=t.service,r=Object.assign({},this.options.circuitBreaker||{},t.circuitBreaker||{});return r.enabled?function(t){const n=t.endpoint,h=o(n,s,r);return h.state==D.CIRCUIT_HALF_OPEN&&function(e,t){e.state=D.CIRCUIT_HALF_OPEN_WAIT,e.ep.state=!1,e.cbTimer=i.setTimeout((()=>c(e)),e.opts.halfOpenTime),e.cbTimer.unref()}(h),e(t).then((e=>(a(o(n,s,r)),e))).catch((e=>{if(r.check&&r.check(e)&&h&&(!e.nodeID||e.nodeID==t.nodeID)){!function(e,t,s){e.count++,e.failures++,l(e)}(o(n,s,r))}return this.Promise.reject(e)}))}.bind(this):e}return{name:"CircuitBreaker",created(e){r=e.getLogger("circuit-breaker"),e.CircuitBreakerStore=s;const t=e.options.circuitBreaker;t.enabled&&(n(t.windowTime),e.isMetricsEnabled()&&(e.metrics.register({name:ur.MOLECULER_CIRCUIT_BREAKER_OPENED_ACTIVE,type:ur.TYPE_GAUGE,labelNames:["affectedNodeID","service","action"],description:"Number of active opened circuit-breakers"}),e.metrics.register({name:ur.MOLECULER_CIRCUIT_BREAKER_OPENED_TOTAL,type:ur.TYPE_COUNTER,labelNames:["affectedNodeID","service","action"],description:"Number of opened circuit-breakers"}),e.metrics.register({name:ur.MOLECULER_CIRCUIT_BREAKER_HALF_OPENED_ACTIVE,type:ur.TYPE_GAUGE,labelNames:["affectedNodeID","service","action"],description:"Number of active half-opened circuit-breakers"})))},localAction:h,remoteAction:h,stopped(){t&&clearInterval(t),delete e.CircuitBreakerStore}}},Timeout:function(e){function t(t,s){const r=s.timeout,i=s.name,n=s.service?s.service.fullName:null;return function(s){null==s.options.timeout&&(s.options.timeout=null!=r?r:e.options.requestTimeout),s.options.timeout>0&&!s.startHrTime&&(s.startHrTime=H.hrtime());const o=t(s);return s.options.timeout>0&&o.timeout?o.timeout(s.options.timeout).catch((t=>{if(t instanceof e.Promise.TimeoutError){const r=s.nodeID;this.logger.warn(`Request '${i}' is timed out.`,{requestID:s.requestID,nodeID:r,timeout:s.options.timeout}),t=new dr({action:i,nodeID:r}),e.metrics.increment(pr.MOLECULER_REQUEST_TIMEOUT_TOTAL,{service:n,action:i})}throw t})):o}.bind(this)}return{name:"Timeout",created(e){e.isMetricsEnabled()&&e.metrics.register({name:pr.MOLECULER_REQUEST_TIMEOUT_TOTAL,type:pr.TYPE_COUNTER,labelNames:["service","action"],description:"Number of timed out requests",rate:!0})},localAction:t,remoteAction:t}},Retry:function(e){function t(t,s){const r=s.name,i=s.service?s.service.fullName:null,n=Object.assign({},this.options.retryPolicy,s.retryPolicy||{});return n.enabled?function(o){const a="number"==typeof o.options.retries?o.options.retries:n.retries;return null==o._retryAttempts&&(o._retryAttempts=0),t(o).catch((t=>{if(o.nodeID!=e.nodeID&&o.endpoint.local)return Promise.reject(t);if(n.check(t)&&(e.metrics.increment(mr.MOLECULER_REQUEST_RETRY_ATTEMPTS_TOTAL,{service:i,action:s.name}),o._retryAttempts<a)){o._retryAttempts++,o.span&&(o.span.setError(t),o.span.addTags({retryAttempts:o._retryAttempts}),o.finishSpan(o.span));const i=Math.min(n.delay*Math.pow(n.factor,o._retryAttempts-1),n.maxDelay);return e.logger.warn(`Retry to call '${r}' action after ${i} ms...`,{requestID:o.requestID,attempts:o._retryAttempts}),e.Promise.delay(i).then((()=>{const t=o.copy();return t._retryAttempts=o._retryAttempts,"private"==s.visibility?o.service.actions[s.rawName](o.params,{ctx:t}):e.call(r,o.params,{ctx:t})}))}return Promise.reject(t)}))}.bind(this):t}return{name:"Retry",created(){e.isMetricsEnabled()&&e.metrics.register({name:mr.MOLECULER_REQUEST_RETRY_ATTEMPTS_TOTAL,type:mr.TYPE_COUNTER,labelNames:["service","action"],description:"Number of retries",rate:!0})},localAction:t,remoteAction:t}},Fallback:function(e){function t(t,s){return function(r){return t(r).catch((t=>{if(r.options.fallbackResponse)return function(t,s){return e.logger.warn(`The '${t.action.name}' request is failed. Return fallback response.`,{requestID:t.requestID,err:s.message}),e.metrics.increment(gr.MOLECULER_REQUEST_FALLBACK_TOTAL,{action:t.action.name}),t.fallbackResult=!0,fr(t.options.fallbackResponse)?t.options.fallbackResponse(t,s):Promise.resolve(t.options.fallbackResponse)}(r,t);if(s.fallback&&s.service){const i=s.service,n=_r(s.fallback)?i[s.fallback]:s.fallback;if(!fr(n))throw new Er(`The 'fallback' of '${s.name}' action is not a Function or valid method name: ${s.fallback}`);return i.logger.warn(`The '${r.action.name}' request is failed. Return fallback response.`,{requestID:r.requestID,err:t.message}),e.metrics.increment(gr.MOLECULER_REQUEST_FALLBACK_TOTAL,{service:i.fullName,action:s.name}),r.fallbackResult=!0,n.call(i,r,t)}return Promise.reject(t)}))}.bind(this)}return{name:"Fallback",created(e){e.isMetricsEnabled()&&e.metrics.register({name:gr.MOLECULER_REQUEST_FALLBACK_TOTAL,type:gr.TYPE_COUNTER,labelNames:["service","action"],description:"Number of fallbacked requests",rate:!0})},localAction:t,remoteAction:t}},ErrorHandler:function(){return{name:"ErrorHandler",localAction:vr,remoteAction:vr,localEvent:Sr}},Metrics:function(e){const t=e.metrics;function s(e,s,r){const i=s.name,n=s.service?s.service.fullName:null;return function(s){const o=s.caller;t.increment(br.MOLECULER_REQUEST_TOTAL,{service:n,action:i,caller:o,type:e}),t.increment(br.MOLECULER_REQUEST_ACTIVE,{service:n,action:i,caller:o,type:e}),t.increment(br.MOLECULER_REQUEST_LEVELS,{service:n,action:i,caller:o,level:s.level});const a=t.timer(br.MOLECULER_REQUEST_TIME,{service:n,action:i,caller:o,type:e});return r(s).then((s=>(a(),t.decrement(br.MOLECULER_REQUEST_ACTIVE,{service:n,action:i,caller:o,type:e}),s))).catch((s=>{throw a(),t.decrement(br.MOLECULER_REQUEST_ACTIVE,{service:n,action:i,caller:o,type:e}),t.increment(br.MOLECULER_REQUEST_ERROR_TOTAL,{service:n,action:i,caller:o,type:e,errorName:s?s.name:null,errorCode:s?s.code:null,errorType:s?s.type:null}),s}))}}return{name:"Metrics",created(){e.isMetricsEnabled()&&(t.register({name:br.MOLECULER_REQUEST_TOTAL,type:br.TYPE_COUNTER,labelNames:["service","action","type","caller"],unit:br.UNIT_REQUEST,description:"Number of requests",rate:!0}),t.register({name:br.MOLECULER_REQUEST_ACTIVE,type:br.TYPE_GAUGE,labelNames:["service","action","type","caller"],unit:br.UNIT_REQUEST,description:"Number of active requests"}),t.register({name:br.MOLECULER_REQUEST_ERROR_TOTAL,type:br.TYPE_COUNTER,labelNames:["service","action","type","caller","errorName","errorCode","errorType"],unit:br.UNIT_REQUEST,description:"Number of request errors",rate:!0}),t.register({name:br.MOLECULER_REQUEST_TIME,type:br.TYPE_HISTOGRAM,labelNames:["service","action","type","caller"],quantiles:!0,buckets:!0,unit:br.UNIT_MILLISECONDS,description:"Request times in milliseconds",rate:!0}),t.register({name:br.MOLECULER_REQUEST_LEVELS,type:br.TYPE_COUNTER,labelNames:["level"],unit:br.UNIT_REQUEST,description:"Number of requests by context level"}),t.register({name:br.MOLECULER_EVENT_EMIT_TOTAL,type:br.TYPE_COUNTER,labelNames:["event","groups"],unit:br.UNIT_EVENT,description:"Number of emitted events",rate:!0}),t.register({name:br.MOLECULER_EVENT_BROADCAST_TOTAL,type:br.TYPE_COUNTER,labelNames:["event","groups"],unit:br.UNIT_EVENT,description:"Number of broadcast events",rate:!0}),t.register({name:br.MOLECULER_EVENT_BROADCASTLOCAL_TOTAL,type:br.TYPE_COUNTER,labelNames:["event","groups"],unit:br.UNIT_EVENT,description:"Number of local broadcast events",rate:!0}),t.register({name:br.MOLECULER_EVENT_RECEIVED_TOTAL,type:br.TYPE_COUNTER,labelNames:["service","group","event","caller"],unit:br.UNIT_EVENT,description:"Number of received events",rate:!0}),t.register({name:br.MOLECULER_EVENT_RECEIVED_ACTIVE,type:br.TYPE_GAUGE,labelNames:["service","group","event","caller"],unit:br.UNIT_REQUEST,description:"Number of active event executions"}),t.register({name:br.MOLECULER_EVENT_RECEIVED_ERROR_TOTAL,type:br.TYPE_COUNTER,labelNames:["service","group","event","caller","errorName","errorCode","errorType"],unit:br.UNIT_REQUEST,description:"Number of event execution errors",rate:!0}),t.register({name:br.MOLECULER_EVENT_RECEIVED_TIME,type:br.TYPE_HISTOGRAM,labelNames:["service","group","event","caller"],quantiles:!0,buckets:!0,unit:br.UNIT_MILLISECONDS,description:"Execution time of events in milliseconds",rate:!0}),t.register({name:br.MOLECULER_TRANSIT_PUBLISH_TOTAL,type:br.TYPE_COUNTER,labelNames:["type"],unit:br.UNIT_PACKET,description:"Number of published packets",rate:!0}),t.register({name:br.MOLECULER_TRANSIT_RECEIVE_TOTAL,type:br.TYPE_COUNTER,labelNames:["type"],unit:br.UNIT_PACKET,description:"Number of received packets",rate:!0}),t.register({name:br.MOLECULER_TRANSIT_REQUESTS_ACTIVE,type:br.TYPE_GAUGE,unit:br.UNIT_REQUEST,description:"Number of active requests"}),t.register({name:br.MOLECULER_TRANSIT_STREAMS_SEND_ACTIVE,type:br.TYPE_GAUGE,unit:br.UNIT_STREAM,description:"Number of active sent streams"}),t.register({name:br.MOLECULER_TRANSPORTER_PACKETS_SENT_TOTAL,type:br.TYPE_COUNTER,unit:br.UNIT_PACKET,description:"Number of sent packets",rate:!0}),t.register({name:br.MOLECULER_TRANSPORTER_PACKETS_SENT_BYTES,type:br.TYPE_COUNTER,unit:br.UNIT_BYTE,description:"Number of sent bytes",rate:!0}),t.register({name:br.MOLECULER_TRANSPORTER_PACKETS_RECEIVED_TOTAL,type:br.TYPE_COUNTER,unit:br.UNIT_PACKET,description:"Number of received packets",rate:!0}),t.register({name:br.MOLECULER_TRANSPORTER_PACKETS_RECEIVED_BYTES,type:br.TYPE_COUNTER,unit:br.UNIT_BYTE,description:"Number of received bytes",rate:!0}))},localAction:(t,r)=>e.isMetricsEnabled()?s("local",r,t):t,remoteAction:(t,r)=>e.isMetricsEnabled()?s("remote",r,t):t,localEvent(s,r){const i=r.service?r.service.name:null;return e.isMetricsEnabled()?function(e){const n=r.group||i;t.increment(br.MOLECULER_EVENT_RECEIVED_TOTAL,{service:i,event:e.eventName,group:n,caller:e.caller}),t.increment(br.MOLECULER_EVENT_RECEIVED_ACTIVE,{service:i,event:e.eventName,group:n,caller:e.caller});const o=t.timer(br.MOLECULER_EVENT_RECEIVED_TIME,{service:i,event:e.eventName,group:n,caller:e.caller});return s.apply(this,arguments).then((s=>(o(),t.decrement(br.MOLECULER_EVENT_RECEIVED_ACTIVE,{service:i,event:e.eventName,group:n,caller:e.caller}),s))).catch((s=>{throw o(),t.decrement(br.MOLECULER_EVENT_RECEIVED_ACTIVE,{service:i,event:e.eventName,group:n,caller:e.caller}),t.increment(br.MOLECULER_EVENT_RECEIVED_ERROR_TOTAL,{service:i,event:e.eventName,group:n,caller:e.caller,errorName:s?s.name:null,errorCode:s?s.code:null,errorType:s?s.type:null}),s}))}.bind(this):s},emit:s=>e.isMetricsEnabled()?function(){return t.increment(br.MOLECULER_EVENT_EMIT_TOTAL,{event:arguments[0]}),s.apply(this,arguments)}:s,broadcast:s=>e.isMetricsEnabled()?function(){return t.increment(br.MOLECULER_EVENT_BROADCAST_TOTAL,{event:arguments[0]}),s.apply(this,arguments)}:s,broadcastLocal:s=>e.isMetricsEnabled()?function(){return t.increment(br.MOLECULER_EVENT_BROADCASTLOCAL_TOTAL,{event:arguments[0]}),s.apply(this,arguments)}:s,transitPublish(s){const r=this;return e.isMetricsEnabled()?function(){t.increment(br.MOLECULER_TRANSIT_PUBLISH_TOTAL,{type:arguments[0].type});const e=s.apply(this,arguments);return t.increment(br.MOLECULER_TRANSIT_REQUESTS_ACTIVE,null,r.pendingRequests.size),t.increment(br.MOLECULER_TRANSIT_STREAMS_SEND_ACTIVE,null,r.pendingReqStreams.size+this.pendingResStreams.size),e}:s},transitMessageHandler:s=>e.isMetricsEnabled()?function(){return t.increment(br.MOLECULER_TRANSIT_RECEIVE_TOTAL,{type:arguments[0]}),s.apply(this,arguments)}:s,transporterSend:s=>e.isMetricsEnabled()?function(){const e=arguments[1];return t.increment(br.MOLECULER_TRANSPORTER_PACKETS_SENT_TOTAL),t.increment(br.MOLECULER_TRANSPORTER_PACKETS_SENT_BYTES,null,e&&e.length?e.length:0),s.apply(this,arguments)}:s,transporterReceive:s=>e.isMetricsEnabled()?function(){const e=arguments[1];return t.increment(br.MOLECULER_TRANSPORTER_PACKETS_RECEIVED_TOTAL),t.increment(br.MOLECULER_TRANSPORTER_PACKETS_RECEIVED_BYTES,null,e&&e.length?e.length:0),s.apply(this,arguments)}:s}},Tracing:function(e){const t=e.tracer;return{name:"Tracing",localAction:e.isTracingEnabled()&&t.opts.actions?function(e,s){let r=s.tracing;return!0!==r&&!1!==r||(r={enabled:!!r}),r=O.default.defaultsDeep({},r,{enabled:!0}),r.enabled?function(s){s.requestID=s.requestID||t.getCurrentTraceID(),s.parentID=s.parentID||t.getActiveSpanID();const i={callingLevel:s.level,action:s.action?{name:s.action.name,rawName:s.action.rawName}:null,remoteCall:s.nodeID!==s.broker.nodeID,callerNodeID:s.nodeID,nodeID:s.broker.nodeID,options:{timeout:s.options.timeout,retries:s.options.retries},requestID:s.requestID},n=t.opts.tags.action;let o;if(o=Or(r.tags)?r.tags:!r.tags&&Or(n)?n:{params:!0,...n,...r.tags},Or(o)){const e=o.call(s.service,s);e&&Object.assign(i,e)}else yr(o)&&(!0===o.params?i.params=null!=s.params&&yr(s.params)?Object.assign({},s.params):s.params:Array.isArray(o.params)&&(i.params=O.default.pick(s.params,o.params)),!0===o.meta?i.meta=null!=s.meta?Object.assign({},s.meta):s.meta:Array.isArray(o.meta)&&(i.meta=O.default.pick(s.meta,o.meta)));let a=`action '${s.action.name}'`;if(r.spanName)switch(typeof r.spanName){case"string":a=r.spanName;break;case"function":a=r.spanName.call(s.service,s)}const l=s.startSpan(a,{id:s.id,type:"action",traceID:s.requestID,parentID:s.parentID,service:s.service,sampled:s.tracing,tags:i});return s.tracing=l.sampled,e(s).then((e=>{const t={fromCache:s.cachedResult};if(Or(o)){const r=o.call(s.service,s,e);r&&Object.assign(t,r)}else yr(o)&&(!0===o.response?t.response=null!=e&&yr(e)?Object.assign({},e):e:Array.isArray(o.response)&&(t.response=O.default.pick(e,o.response)));return l.addTags(t),s.finishSpan(l),e})).catch((e=>{throw l.setError(e),s.finishSpan(l),e}))}.bind(this):e}:null,localEvent:e.isTracingEnabled()&&t.opts.events?function(s,r){const i=r.service;let n=r.tracing;return!0!==n&&!1!==n||(n={enabled:!!n}),n=O.default.defaultsDeep({},n,{enabled:!0}),n.enabled?function(o){o.requestID=o.requestID||t.getCurrentTraceID(),o.parentID=o.parentID||t.getActiveSpanID();const a={event:{name:r.name,group:r.group},eventName:o.eventName,eventType:o.eventType,callerNodeID:o.nodeID,callingLevel:o.level,remoteCall:o.nodeID!==e.nodeID,nodeID:e.nodeID,requestID:o.requestID},l=t.opts.tags.event;let c;if(c=Or(n.tags)?n.tags:!n.tags&&Or(l)?l:{params:!0,...l,...n.tags},Or(c)){const e=c.call(i,o);e&&Object.assign(a,e)}else yr(c)&&(!0===c.params?a.params=null!=o.params&&yr(o.params)?Object.assign({},o.params):o.params:Array.isArray(c.params)&&(a.params=O.default.pick(o.params,c.params)),!0===c.meta?a.meta=null!=o.meta?Object.assign({},o.meta):o.meta:Array.isArray(c.meta)&&(a.meta=O.default.pick(o.meta,c.meta)));let h=`event '${o.eventName}' in '${i.fullName}'`;if(n.spanName)switch(typeof n.spanName){case"string":h=n.spanName;break;case"function":h=n.spanName.call(i,o)}const u=o.startSpan(h,{id:o.id,type:"event",traceID:o.requestID,parentID:o.parentID,service:i,sampled:o.tracing,tags:a});return o.tracing=u.sampled,s.apply(i,arguments).then((()=>{o.finishSpan(u)})).catch((e=>{throw u.setError(e),o.finishSpan(u),e}))}.bind(this):s}:null}},Debounce:function(e){return{name:"Debounce",localEvent:function(t,s){if(s.debounce>0){let r;return function(n){return r&&clearTimeout(r),r=i.setTimeout((()=>(r=null,t(n))),s.debounce),e.Promise.resolve()}.bind(this)}return t}}},Throttle:function(e){return{name:"Throttle",localEvent:function(t,s){if(s.throttle>0){let r=0;return function(i){const n=Date.now();return n-r<s.throttle?e.Promise.resolve():(r=n,t(i))}.bind(this)}return t}}},HotReload:Le,Transmit:{Encryption:function(e,t="aes-256-cbc",s){if(!e||0==e.length)throw new Error("Must be set a password for encryption");return{name:"Encryption",created(){this.logger.info(`The transmission is ENCRYPTED by '${t}'.`)},transporterSend:r=>(i,n,o)=>{const a=s?N.default.createCipheriv(t,e,s):N.default.createCipher(t,e),c=l.Buffer.concat([a.update(n),a.final()]);return r(i,c,o)},transporterReceive:r=>(i,n,o)=>{const a=s?N.default.createDecipheriv(t,e,s):N.default.createDecipher(t,e),c=l.Buffer.concat([a.update(n),a.final()]);return r(i,c,o)}}},Compression:function(e){let t,s;e=Rr(e,{method:"deflate",threshold:"1kb"});const r=Cr(e.threshold);switch(e.method){case"deflate":t=Lr(Ir.deflate),s=Lr(Ir.inflate);break;case"deflateRaw":t=Lr(Ir.deflateRaw),s=Lr(Ir.inflateRaw);break;case"gzip":t=Lr(Ir.gzip),s=Lr(Ir.gunzip);break;default:throw new Error("Unknow compression method: "+e.method)}let i;return{name:"Compression",created(t){i=t.getLogger("TX-COMPRESS"),i.info(`The transmission is COMPRESSED by '${e.method}'. Threshold: ${null!=r?e.threshold:"none"}`)},transporterSend:e=>(s,n,o)=>null!=r&&n.length<r?(i.debug(`Packet '${s}' is small and not compressed. Size: ${n.length}`),e(s,l.Buffer.concat([l.Buffer.from([0]),n]),o)):t(n).then((t=>(i.debug(`Packet '${s}' compressed. Saving: ${Number(100*(1-t.length/n.length)).toFixed(0)}%`,n.length,t.length),e(s,l.Buffer.concat([l.Buffer.from([1]),t]),o)))),transporterReceive:e=>(t,r,n)=>0==r.readInt8(0)?(i.debug(`Packet '${t}' is small and not compressed. Size: ${r.length}`),e(t,r.slice(1),n)):s(r.slice(1)).then((s=>(i.debug(`Packet '${t}' decompressed. Saving: ${Number(100*(1-r.length/s.length)).toFixed(0)}%`,s.length,r.length),e(t,s,n))))}}},Debugging:{TransitLogger:function(e){let t,s,r;function i(e,t){const s=JSON.stringify(t,t instanceof Error?Object.getOwnPropertyNames(t):null,4);A.default.writeFile(I.default.join(r,e),s,(()=>{}))}const n=(e=O.default.defaultsDeep(e,{logger:null,logLevel:"info",logPacketData:!1,folder:null,extension:".json",colors:{receive:"grey",send:"grey"},packetFilter:["HEARTBEAT"]})).colors&&e.colors.send?e.colors.send.split(".").reduce(((e,t)=>e[t]||e()[t]),v.default):e=>e,o=e.colors&&e.colors.receive?e.colors.receive.split(".").reduce(((e,t)=>e[t]||e()[t]),v.default):e=>e;let a;return{name:"TransitLogger",created(i){t=e.logger||i.getLogger("debug"),s=i.nodeID,e.folder&&(r=I.default.join(e.folder,s),Ar(r)),a=e.logLevel?t[e.logLevel]:null},transitPublish:t=>s=>{if(e.packetFilter.includes(s.type))return t(s);const o=s.payload;return a&&(a(n(`=> Send ${s.type} packet to '${s.target||"<all nodes>"}'`)),e.logPacketData&&a("=>",o)),r&&i(`${Date.now()}-send-${s.type}-to-${s.target||"all"}${e.extension}`,o),t(s)},transitMessageHandler:t=>(s,n)=>{if(e.packetFilter.includes(s))return t(s,n);const l=n.payload;return a&&(a(o(`<= Receive ${s} packet from '${l.sender}'`)),e.logPacketData&&a("<=",n.payload)),r&&i(`${Date.now()}-receive-${s}-from-${l.sender}${e.extension}`,l),t(s,n)}}},ActionLogger:function(e){let t,s,r;function i(e,t){const s=JSON.stringify(t,t instanceof Error?Object.getOwnPropertyNames(t):null,4);A.default.writeFile(I.default.join(r,e),s,(()=>{}))}const n=(e=O.default.defaultsDeep(e,{logger:null,logLevel:"info",logParams:!1,logResponse:!1,logMeta:!1,folder:null,extension:".json",colors:{request:"yellow",response:"cyan",error:"red"},whitelist:["**"]})).colors&&e.colors.request?e.colors.request.split(".").reduce(((e,t)=>e[t]||e()[t]),v.default):e=>e,o=e.colors&&e.colors.response?e.colors.response.split(".").reduce(((e,t)=>e[t]||e()[t]),v.default):e=>e,a=e.colors&&e.colors.error?e.colors.error.split(".").reduce(((e,t)=>e[t]||e()[t]),v.default):e=>e;let l;return{name:"ActionLogger",created(i){t=e.logger||i.getLogger("debug"),s=i.nodeID,e.folder&&(r=I.default.join(e.folder,s),Nr(r)),l=e.logLevel?t[e.logLevel]:null},call:t=>(s,c,h)=>{if(!function(t){return!!e.whitelist.find((e=>Pr(t,e)))}(Mr(s)?s.action.name:s))return t(s,c,h);if(l){const t=n(`Calling '${s}'`+(e.logParams?" with params:":"."));e.logParams?l(t,c):l(t),e.logMeta&&h&&h.meta&&l("Meta:",h.meta)}r&&(e.logParams&&i(`${Date.now()}-call-${s}-request${e.extension}`,c),e.logMeta&&h&&h.meta&&i(`${Date.now()}-call-${s}-meta${e.extension}`,h.meta));const u=t(s,c,h),d=u.then((t=>{if(l){const r=o(`Response for '${s}' is received`+(e.logResponse?":":"."));e.logResponse?l(r,t):l(r)}return r&&e.logResponse&&i(`${Date.now()}-call-${s}-response${e.extension}`,t),t})).catch((t=>{throw l&&l(a(`Error for '${s}' is received:`),t),r&&e.logResponse&&i(`${Date.now()}-call-${s}-error${e.extension}`,t),t}));return d.ctx=u.ctx,d}}}}};const{BrokerOptionsError:Ur}=F,{isObject:Dr,isFunction:wr,isString:xr}=ne;var Hr=class{constructor(e){this.broker=e,this.list=[],this.registeredHooks={}}add(e){if(e){if(xr(e)){const t=O.default.get(kr,e);if(!t)throw new Ur(`Invalid built-in middleware type '${e}'.`,{type:e});e=t}if(wr(e)&&(e=e.call(this.broker,this.broker)),!Dr(e))throw new Ur(`Invalid middleware type '${typeof e}'. Accepted only Object of Function.`,{type:typeof e});Object.keys(e).forEach((t=>{wr(e[t])&&(Array.isArray(this.registeredHooks[t])?this.registeredHooks[t].push(e[t]):this.registeredHooks[t]=[e[t]])})),this.list.push(e)}}wrapHandler(e,t,s){return this.registeredHooks[e]&&this.registeredHooks[e].length&&(t=this.registeredHooks[e].reduce(((e,t)=>t.call(this.broker,e,s)),t)),t}callHandlers(e,t,s={}){if(this.registeredHooks[e]&&this.registeredHooks[e].length){return(s.reverse?Array.from(this.registeredHooks[e]).reverse():this.registeredHooks[e]).reduce(((e,s)=>e.then((()=>s.apply(this.broker,t)))),this.broker.Promise.resolve())}return this.broker.Promise.resolve()}callSyncHandlers(e,t,s={}){if(this.registeredHooks[e]&&this.registeredHooks[e].length){return(s.reverse?Array.from(this.registeredHooks[e]).reverse():this.registeredHooks[e]).map((e=>e.apply(this.broker,t)))}}count(){return this.list.length}wrapMethod(e,t,s=this.broker,r={}){if(this.registeredHooks[e]&&this.registeredHooks[e].length){t=(r.reverse?Array.from(this.registeredHooks[e]).reverse():this.registeredHooks[e]).reduce(((e,t)=>t.call(s,e)),t.bind(s))}return t}};const{isObject:$r}=ne;var Br=class{constructor(e){this.opts=e||{},this.Promise=Promise}init(e){this.tracer=e,this.broker=e.broker,this.Promise=this.broker.Promise,this.logger=this.opts.logger||this.tracer.logger}stop(){}spanStarted(){}spanFinished(){}flattenTags(e,t=!1,s=""){return e?Object.keys(e).reduce(((r,i)=>{const n=e[i],o=(s?s+".":"")+i;return $r(n)?Object.assign(r,this.flattenTags(n,t,o)):void 0!==n&&(r[o]=t?String(n):n),r}),{}):null}errorToObject(e){return e?O.default.pick(e,this.tracer.opts.errorFields):null}};const Gr=O.default.repeat,{humanize:Fr,isFunction:qr}=ne;var Yr=class extends Br{constructor(e){super(e),this.opts=O.default.defaultsDeep(this.opts,{logger:null,colors:!0,width:100,gaugeWidth:40}),this.opts.colors||(v.default.enabled=!1),this.spans={}}init(e){super.init(e)}stop(){return this.spans={},this.broker.Promise.resolve()}spanStarted(e){if(this.spans[e.id]={span:e,children:[]},e.parentID){const t=this.spans[e.parentID];t&&t.children.push(e.id)}}spanFinished(e){this.spans[e.parentID]||(this.printRequest(e.id),this.removeSpanWithChildren(e.id))}removeSpanWithChildren(e){const t=this.spans[e];t&&(t.children&&t.children.length>0&&t.children.forEach((e=>this.removeSpanWithChildren(e))),delete this.spans[e])}drawTableTop(){this.log(v.default.grey("┌"+Gr("─",this.opts.width-2)+"┐"))}drawHorizonalLine(){this.log(v.default.grey("├"+Gr("─",this.opts.width-2)+"┤"))}drawLine(e){this.log(v.default.grey("│ ")+e+v.default.grey(" │"))}drawTableBottom(){this.log(v.default.grey("└"+Gr("─",this.opts.width-2)+"┘"))}getAlignedTexts(e,t){const s=e.length;let r;return s<=t?r=e+Gr(" ",t-s):(r=e.slice(0,Math.max(t-3,0)),r+=Gr(".",Math.min(3,t))),r}drawGauge(e,t){const s=this.opts.gaugeWidth,r=Math.floor(s*e/100),i=Math.max(Math.floor(s*t/100)-r,1),n=Math.max(s-(r+i),0);return[v.default.grey("["),v.default.grey(Gr(".",r)),Gr("■",i),v.default.grey(Gr(".",n)),v.default.grey("]")].join("")}getCaption(e){let t=e.name;return e.tags.fromCache&&(t+=" *"),e.tags.remoteCall&&(t+=" »"),e.error&&(t+=" ×"),t}getColor(e){let t=v.default.bold;return e.tags.fromCache&&(t=t().yellow),e.tags.remoteCall&&(t=t().cyan),null==e.duration&&(t=t().grey),e.error&&(t=t().red),t}getTraceInfo(e){let t=0,s=0,r=(e,i,n)=>{e.level=i,e.parents=n||[],s++,i>t&&(t=i),e.children.length>0&&e.children.forEach(((t,s)=>{const i=this.spans[t];i.first=0==s,i.last=s==e.children.length-1,r(i,e.level+1,[].concat(e.parents,[e]))}))};return r(e,1),{depth:t,total:s}}getSpanIndent(e){if(e.level>1){let t=e.parents.map(((e,t)=>t>0?e.last?"  ":"│ ":"")).join("");return t+=e.last?"└─":"├─",t+(e.children.length>0?"┬─":"──")+" "}return""}printSpanTime(e,t,s){const r=e.span,i=t.span,n=(this.opts.width||80)-4,o=this.opts.gaugeWidth||40,a=null==r.duration?"?":Fr(r.duration),l=this.getSpanIndent(e),c=this.getCaption(r),h=v.default.grey(l)+this.getAlignedTexts(c,n-o-3-a.length-1-l.length)+" "+a,u=r.startTime||i.startTime,d=r.finishTime||i.finishTime;let p=(u-i.startTime)/(i.finishTime-i.startTime)*100,m=(d-i.startTime)/(i.finishTime-i.startTime)*100;Number.isNaN(p)&&Number.isNaN(m)&&(p=0,m=100),m>100&&(m=100);const E=this.getColor(r);this.drawLine(E(h+" "+this.drawGauge(p,m))),e.children.length>0&&e.children.forEach(((r,i)=>this.printSpanTime(this.spans[r],t,s+1,e,{first:0==i,last:i==e.children.length-1})))}printRequest(e){const t=this.spans[e];if(!t)return;const s=this.opts.width-4;this.drawTableTop();const{total:r,depth:i}=this.getTraceInfo(t),n=this.getAlignedTexts(e,s-"ID: ".length-"Depth: ".length-(""+i).length-"Total: ".length-(""+r).length-2),o=v.default.grey("ID: ")+v.default.bold(n)+" "+v.default.grey("Depth: ")+v.default.bold(i)+" "+v.default.grey("Total: ")+v.default.bold(r);this.drawLine(o),this.drawHorizonalLine(),this.printSpanTime(t,t,1,null,{}),this.drawTableBottom()}log(...e){return qr(this.opts.logger)?this.opts.logger(...e):this.logger.info(...e)}};const{isFunction:Vr}=ne;var jr=class extends Br{constructor(e){super(e),this.opts=O.default.defaultsDeep(this.opts,{eventName:"$tracing.spans",sendStartSpan:!1,sendFinishSpan:!0,broadcast:!1,groups:null,interval:5,spanConverter:null,defaultTags:null}),this.queue=[]}init(e){super.init(e),this.opts.interval>0&&(this.timer=i.setInterval((()=>this.flush()),1e3*this.opts.interval),this.timer.unref()),this.defaultTags=Vr(this.opts.defaultTags)?this.opts.defaultTags.call(this,e):this.opts.defaultTags}stop(){return this.timer&&(clearInterval(this.timer),this.timer=null),this.Promise.resolve()}spanStarted(e){this.opts.sendStartSpan&&(this.queue.push(e),this.timer||this.flush())}spanFinished(e){this.opts.sendFinishSpan&&(this.queue.push(e),this.timer||this.flush())}flush(){if(0==this.queue.length)return;const e=this.generateTracingData();this.queue.length=0,this.opts.broadcast?(this.logger.debug(`Send tracing spans (${e.length} spans) broadcast events.`),this.broker.broadcast(this.opts.eventName,e,{groups:this.opts.groups})):(this.logger.debug(`Send tracing spans (${e.length} spans) events.`),this.broker.emit(this.opts.eventName,e,{groups:this.opts.groups}))}generateTracingData(){return Vr(this.opts.spanConverter)?this.queue.map((e=>this.opts.spanConverter.call(this,e))):Array.from(this.queue).map((e=>{const t=Object.assign({},e);return t.error&&(t.error=this.errorToObject(e.error)),t}))}};const{isObject:Kr,isFunction:zr}=ne;var Qr=class extends Br{constructor(e){super(e),this.opts=O.default.defaultsDeep(this.opts,{})}init(e){super.init(e),this.broker=e.broker}spanStarted(e){const t=this.generateMetricPayload(e);this.broker.emit("metrics.trace.span.start",t)}spanFinished(e){const t=this.generateMetricPayload(e);this.broker.emit("metrics.trace.span.finish",t)}generateMetricPayload(e){let t={id:e.id,requestID:e.traceID,level:e.tags.callingLevel,startTime:e.startTime,remoteCall:e.tags.remoteCall};return e.opts.ctx&&this.processExtraMetrics(e.opts.ctx,t),t.action=e.tags.action,t.service=e.service,e.parentID&&(t.parent=e.parentID),t.nodeID=this.broker.nodeID,t.remoteCall&&(t.callerNodeID=e.tags.callerNodeID),e.finishTime&&(t.endTime=e.finishTime,t.duration=e.duration,t.fromCache=e.tags.fromCache,e.error&&(t.error=this.errorToObject(e.error))),t}assignExtraMetrics(e,t,s){let r=e.action.metrics[t];!0===r?s[t]=e[t]:Array.isArray(r)?s[t]=O.default.pick(e[t],r):zr(r)&&(s[t]=r(e[t]))}processExtraMetrics(e,t){Kr(e.action.metrics)&&(this.assignExtraMetrics(e,"params",t),this.assignExtraMetrics(e,"meta",t))}};const Zr="undefined"!=typeof global&&global||"undefined"!=typeof self&&self||window;var Wr=(...e)=>Zr.fetch(...e);const{isFunction:Jr}=ne;var Xr=class extends Br{constructor(e){super(e),this.opts=O.default.defaultsDeep(this.opts,{baseURL:H.env.ZIPKIN_URL||"http://localhost:9411",interval:5,payloadOptions:{debug:!1,shared:!1},defaultTags:null}),this.queue=[]}init(e){super.init(e),Wr.Promise=this.broker.Promise,this.opts.interval>0&&(this.timer=i.setInterval((()=>this.flush()),1e3*this.opts.interval),this.timer.unref()),this.defaultTags=Jr(this.opts.defaultTags)?this.opts.defaultTags.call(this,e):this.opts.defaultTags,this.defaultTags&&(this.defaultTags=this.flattenTags(this.defaultTags,!0))}stop(){return this.timer&&(clearInterval(this.timer),this.timer=null),this.broker.Promise.resolve()}spanFinished(e){this.queue.push(e)}flush(){if(0==this.queue.length)return;const e=this.generateTracingData();this.queue.length=0,Wr(this.opts.baseURL+"/api/v2/spans",{method:"post",body:JSON.stringify(e),headers:{"Content-Type":"application/json"}}).then((t=>{t.status>=400?this.logger.warn(`Unable to upload tracing spans to Zipkin. Status: ${t.status} ${t.statusText}`):this.logger.debug(`Tracing spans (${e.length} spans) are uploaded to Zipkin. Status: ${t.statusText}`)})).catch((e=>{this.logger.warn("Unable to upload tracing spans to Zipkin. Error:"+e.message,e)}))}generateTracingData(){return this.queue.map((e=>this.makePayload(e)))}makePayload(e){const t=e.service?e.service.fullName:null,s={name:e.name,kind:"SERVER",traceId:this.convertID(e.traceID),id:this.convertID(e.id),parentId:this.convertID(e.parentID),localEndpoint:{serviceName:t},remoteEndpoint:{serviceName:t},annotations:[],timestamp:this.convertTime(e.startTime),duration:this.convertTime(e.duration),tags:{service:t,"span.type":e.type},debug:this.opts.payloadOptions.debug,shared:this.opts.payloadOptions.shared};return e.error&&(s.tags.error=e.error.message,s.annotations.push({value:"error",endpoint:{serviceName:t,ipv4:"",port:0},timestamp:this.convertTime(e.finishTime)})),Object.assign(s.tags,this.defaultTags||{},this.flattenTags(e.tags,!0),this.flattenTags(this.errorToObject(e.error),!0,"error")||{}),s}convertID(e){return e?e.replace(/-/g,"").substring(0,16):null}convertTime(e){return null!=e?Math.round(1e3*e):null}};const{isFunction:ei}=ne;var ti=class extends Br{constructor(e){super(e),this.opts=O.default.defaultsDeep(this.opts,{baseURL:H.env.NEW_RELIC_TRACE_API_URL||"https://trace-api.newrelic.com",insertKey:"",interval:5,payloadOptions:{debug:!1,shared:!1},defaultTags:null}),this.queue=[]}init(e){super.init(e),Wr.Promise=this.broker.Promise,this.opts.interval>0&&(this.timer=i.setInterval((()=>this.flush()),1e3*this.opts.interval),this.timer.unref()),this.defaultTags=ei(this.opts.defaultTags)?this.opts.defaultTags.call(this,e):this.opts.defaultTags,this.defaultTags&&(this.defaultTags=this.flattenTags(this.defaultTags,!0))}stop(){return this.timer&&(clearInterval(this.timer),this.timer=null),this.broker.Promise.resolve()}spanFinished(e){this.queue.push(e)}flush(){if(0==this.queue.length)return;const e=this.generateTracingData();this.queue.length=0,Wr(this.opts.baseURL+"/trace/v1",{method:"post",body:JSON.stringify(e),headers:{"Content-Type":"application/json","Api-Key":this.opts.insertKey,"Data-Format":"zipkin","Data-Format-Version":"2"}}).then((t=>{t.status>=400?this.logger.warn(`Unable to upload tracing spans to NewRelic. Status: ${t.status} ${t.statusText}`):this.logger.debug(`Tracing spans (${e.length} spans) uploaded to NewRelic. Status: ${t.statusText}`)})).catch((e=>{this.logger.warn("Unable to upload tracing spans to NewRelic. Error:"+e.message,e)}))}generateTracingData(){return this.queue.map((e=>this.makePayload(e)))}makePayload(e){const t=e.service?e.service.fullName:null,s={name:e.name,kind:"CONSUMER",traceId:this.convertID(e.traceID),id:this.convertID(e.id),parentId:this.convertID(e.parentID),localEndpoint:{serviceName:t},remoteEndpoint:{serviceName:t},annotations:[{timestamp:this.convertTime(e.startTime),value:"sr"},{timestamp:this.convertTime(e.finishTime),value:"ss"}],timestamp:this.convertTime(e.startTime),duration:this.convertTime(e.duration),tags:{service:t,"span.type":e.type},debug:this.opts.payloadOptions.debug,shared:this.opts.payloadOptions.shared};return e.error&&(s.tags.error=e.error.message,s.annotations.push({value:"error",endpoint:{serviceName:t,ipv4:"",port:0},timestamp:this.convertTime(e.finishTime)})),Object.assign(s.tags,this.defaultTags||{},this.flattenTags(e.tags,!0),this.flattenTags(this.errorToObject(e.error),!0,"error")||{}),s}convertID(e){return e?e.replace(/-/g,"").substring(0,16):null}convertTime(e){return null!=e?Math.round(1e3*e):null}};const{isObject:si,isString:ri}=ne,{BrokerOptionsError:ii}=F,ni={Base:Br,Console:Yr,Datadog:Le,Event:jr,EventLegacy:Qr,Jaeger:Le,Zipkin:Xr,NewRelic:ti};function oi(e){if(!e)return null;let t=Object.keys(ni).find((t=>t.toLowerCase()==e.toLowerCase()));return t?ni[t]:void 0}var ai=Object.assign(ni,{resolve:function(e){if(e instanceof ni.Base)return e;if(ri(e)){let t=oi(e);if(t)return new t;throw new ii(`Invalid tracing exporter type '${e}'.`,{type:e})}if(si(e)){let t=oi(e.type);if(t)return new t(e.options);throw new ii(`Invalid tracing exporter type '${e.type}'.`,{type:e.type})}throw new ii(`Invalid tracing exporter type '${e}'.`,{type:e})},register:function(e,t){ni[e]=t}});var li=class{constructor(e){this.opts=O.default.defaultsDeep(e,{tracesPerSecond:1}),this.lastTime=Date.now(),this.balance=0,this.maxBalance=this.opts.tracesPerSecond<1?1:this.opts.tracesPerSecond}check(e=1){const t=Date.now(),s=(t-this.lastTime)/1e3;return this.lastTime=t,this.balance+=s*this.opts.tracesPerSecond,this.balance>this.maxBalance&&(this.balance=this.maxBalance),this.balance>=e&&(this.balance-=e,!0)}};const ci=hi()-1e9*H.uptime();function hi(){const e=H.hrtime();return 1e9*e[0]+e[1]}function ui(){return(hi()-ci)/1e6}const di=ui(),pi=Date.now();var mi=()=>pi+ui()-di;function Ei(e,t,s,r=!1){Object.defineProperty(e,t,{value:s,writable:!!r,enumerable:!1})}var gi=class{constructor(e,t,s){Ei(this,"tracer",e,!0),Ei(this,"logger",this.tracer.logger,!0),Ei(this,"opts",s||{}),Ei(this,"meta",{}),this.name=t,this.type=this.opts.type||"custom",this.id=this.opts.id||this.tracer.broker.generateUid(),this.traceID=this.opts.traceID||this.id,this.parentID=this.opts.parentID,this.opts.service&&("string"==typeof this.opts.service?this.service={name:this.opts.service,fullName:this.opts.service}:this.service={name:this.opts.service.name,version:this.opts.service.version,fullName:this.opts.service.fullName}),this.priority=null!=this.opts.priority?this.opts.priority:5,this.sampled=null!=this.opts.sampled?this.opts.sampled:this.tracer.shouldSample(this),this.startTime=null,this.finishTime=null,this.duration=null,this.error=null,this.logs=[],this.tags={},this.opts.defaultTags&&this.addTags(this.opts.defaultTags),this.opts.tags&&this.addTags(this.opts.tags)}start(e){return this.logger.debug(`[${this.id}] Span '${this.name}' is started.`),this.startTime=e||mi(),this.tracer.spanStarted(this),this}addTags(e){return Object.assign(this.tags,e),this}log(e,t,s){return s=s||mi(),this.logs.push({name:e,fields:t||{},time:s,elapsed:s-this.startTime}),this.logger.debug(`[${this.id}] Span '${this.name}' has a new log event: ${e}.`),this}setError(e){return this.error=null==e||e,this}finish(e){return this.finishTime=e||mi(),this.duration=this.finishTime-this.startTime,this.logger.debug(`[${this.id}] Span '${this.name}' is finished. Duration: ${Number(this.duration).toFixed(3)} ms`,this.tags),this.tracer.spanFinished(this),this}isActive(){return null==this.finishTime}startSpan(e,t){const s={traceID:this.traceID,parentID:this.id,sampled:this.sampled,service:this.service};return this.tracer.startSpan(e,t?Object.assign(s,t):s)}};const{isFunction:fi}=ne;var _i={Tracer:class{constructor(e,t){this.broker=e,this.logger=e.getLogger("tracer"),!0!==t&&!1!==t||(t={enabled:t}),this.opts=O.default.defaultsDeep({},t,{enabled:!0,exporter:null,sampling:{rate:1,tracesPerSecond:null,minPriority:null},actions:!0,events:!1,errorFields:["name","message","code","type","data"],stackTrace:!1,defaultTags:null,tags:{action:null,event:null}}),this.opts.stackTrace&&-1===this.opts.errorFields.indexOf("stack")&&this.opts.errorFields.push("stack"),this.sampleCounter=0,null!=this.opts.sampling.tracesPerSecond&&this.opts.sampling.tracesPerSecond>0&&(this.rateLimiter=new li({tracesPerSecond:this.opts.sampling.tracesPerSecond})),this.opts.enabled&&this.logger.info("Tracing: Enabled")}init(){if(this.opts.enabled&&(this.defaultTags=fi(this.opts.defaultTags)?this.opts.defaultTags.call(this,this):this.opts.defaultTags,this.opts.exporter)){const e=Array.isArray(this.opts.exporter)?this.opts.exporter:[this.opts.exporter];this.exporter=O.default.compact(e).map((e=>{const t=ai.resolve(e);return t.init(this),t}));const t=this.exporter.map((e=>this.broker.getConstructorName(e)));this.logger.info(`Tracing exporter${t.length>1?"s":""}: ${t.join(", ")}`)}}stop(){return this.exporter?this.broker.Promise.all(this.exporter.map((e=>e.stop()))):this.broker.Promise.resolve()}isEnabled(){return this.opts.enabled}shouldSample(e){return!(null!=this.opts.sampling.minPriority&&e.priority<this.opts.sampling.minPriority)&&(this.rateLimiter?this.rateLimiter.check():0!=this.opts.sampling.rate&&(1==this.opts.sampling.rate||++this.sampleCounter*this.opts.sampling.rate>=1&&(this.sampleCounter=0,!0)))}startSpan(e,t={}){let s={};t.parentSpan&&(s.traceID=t.parentSpan.traceID,s.parentID=t.parentSpan.id,s.sampled=t.parentSpan.sampled);const r=new gi(this,e,Object.assign({type:"custom",defaultTags:this.defaultTags},s,t,{parentSpan:void 0}));return r.start(),r}invokeExporter(e,t){this.exporter&&this.exporter.forEach((s=>s[e].apply(s,t)))}getCurrentTraceID(){return null}getActiveSpanID(){return null}spanStarted(e){e.sampled&&this.invokeExporter("spanStarted",[e])}spanFinished(e){e.sampled&&this.invokeExporter("spanFinished",[e])}},Span:gi,Exporters:ai};const{ServiceSchemaError:Ti,MoleculerError:vi}=F,{isObject:Si,isFunction:bi,flatten:Oi}=ne;function yi(e){return bi(e)?{handler:e}:e}function Ii(e){return Array.isArray(e)?e:[e]}function Ri(e){return e.length>0&&-1!==["ctx","context"].indexOf(e[0].toLowerCase())}class Ci{constructor(e,t){if(!Si(e))throw new Ti("Must set a ServiceBroker instance!");this.broker=e,e&&(this.Promise=e.Promise),t&&this.parseServiceSchema(t)}parseServiceSchema(e){if(!Si(e))throw new Ti("The service schema can't be null. Maybe is it not a service schema?");if(this.originalSchema=O.default.cloneDeep(e),e.mixins&&(e=Ci.applyMixins(e)),bi(e.merged)?e.merged.call(this,e):Array.isArray(e.merged)&&e.merged.forEach((t=>t.call(this,e))),this.broker.callMiddlewareHookSync("serviceCreating",[this,e]),!e.name)throw console.error("Service name can't be empty! Maybe it is not a valid Service schema. Maybe is it not a service schema?",{schema:e}),new Ti("Service name can't be empty! Maybe it is not a valid Service schema. Maybe is it not a service schema?",{schema:e});this.name=e.name,this.version=e.version,this.settings=e.settings||{},this.metadata=e.metadata||{},this.schema=e,this.fullName=Ci.getVersionedFullName(this.name,!0!==this.settings.$noVersionPrefix?this.version:void 0),this.logger=this.broker.getLogger(this.fullName,{svc:this.name,ver:this.version}),this.actions={},this.events={};const t={name:this.name,version:this.version,fullName:this.fullName,settings:this._getPublicSettings(this.settings),metadata:this.metadata,actions:{},events:{}};Si(e.methods)&&O.default.forIn(e.methods,((e,t)=>{if(-1!=["name","version","settings","metadata","dependencies","schema","broker","actions","logger","created","started","stopped","_start","_stop","_init"].indexOf(t))throw new Ti(`Invalid method name '${t}' in '${this.name}' service!`);this._createMethod(e,t)})),Si(e.actions)&&O.default.forIn(e.actions,((e,s)=>{if(!1===e)return;let r=this._createAction(e,s);t.actions[r.name]=r;const i=this.broker.middlewares.wrapHandler("localAction",r.handler,r),n=this.broker.registry.createPrivateActionEndpoint(r);this.actions[s]=(e,t)=>{let s;return s=t&&t.ctx?t.ctx:this.broker.ContextFactory.create(this.broker,n,e,t||{}),i(s)}})),Si(e.events)&&O.default.forIn(e.events,((e,s)=>{const r=this._createEvent(e,s);t.events[r.name]=r,this.events[r.name]=(e,t)=>{let i;if(t&&t.ctx)i=t.ctx;else{const s={id:this.broker.nodeID,event:r};i=this.broker.ContextFactory.create(this.broker,s,e,t||{})}return i.eventName=s,i.eventType="emit",i.eventGroups=[r.group||this.name],r.handler(i)}})),this._serviceSpecification=t,this._init()}_getPublicSettings(e){return e&&Array.isArray(e.$secureSettings)?O.default.omit(e,[].concat(e.$secureSettings,["$secureSettings"])):e}_init(){this.logger.debug(`Service '${this.fullName}' is creating...`),bi(this.schema.created)?this.schema.created.call(this):Array.isArray(this.schema.created)&&this.schema.created.forEach((e=>e.call(this))),this.broker.addLocalService(this),this.broker.callMiddlewareHookSync("serviceCreated",[this]),this.logger.debug(`Service '${this.fullName}' created.`)}_start(){return this.logger.debug(`Service '${this.fullName}' is starting...`),this.Promise.resolve().then((()=>this.broker.callMiddlewareHook("serviceStarting",[this]))).then((()=>{if(this.schema.dependencies)return this.waitForServices(this.schema.dependencies,this.settings.$dependencyTimeout||0,this.settings.$dependencyInterval||this.broker.options.dependencyInterval)})).then((()=>bi(this.schema.started)?this.Promise.method(this.schema.started).call(this):Array.isArray(this.schema.started)?this.schema.started.map((e=>this.Promise.method(e.bind(this)))).reduce(((e,t)=>e.then((()=>t()))),this.Promise.resolve()):void 0)).then((()=>(this.broker.registerLocalService(this._serviceSpecification),null))).then((()=>this.broker.callMiddlewareHook("serviceStarted",[this]))).then((()=>this.logger.info(`Service '${this.fullName}' started.`)))}_stop(){return this.logger.debug(`Service '${this.fullName}' is stopping...`),this.Promise.resolve().then((()=>this.broker.callMiddlewareHook("serviceStopping",[this],{reverse:!0}))).then((()=>{if(bi(this.schema.stopped))return this.Promise.method(this.schema.stopped).call(this);if(Array.isArray(this.schema.stopped)){return Array.from(this.schema.stopped).reverse().map((e=>this.Promise.method(e.bind(this)))).reduce(((e,t)=>e.then((()=>t()))),this.Promise.resolve())}return this.Promise.resolve()})).then((()=>this.broker.callMiddlewareHook("serviceStopped",[this],{reverse:!0}))).then((()=>this.logger.info(`Service '${this.fullName}' stopped.`)))}_createAction(e,t){let s;if(bi(e))s={handler:e};else{if(!Si(e))throw new Ti(`Invalid action definition in '${t}' action in '${this.fullName}' service!`);s=O.default.cloneDeep(e)}let r=s.handler;if(!bi(r))throw new Ti(`Missing action handler on '${t}' action in '${this.fullName}' service!`);return s.rawName=s.name||t,!0!==this.settings.$noServiceNamePrefix?s.name=this.fullName+"."+s.rawName:s.name=s.rawName,void 0===s.cache&&void 0!==this.settings.$cache&&(s.cache=this.settings.$cache),s.service=this,s.handler=this.Promise.method(r.bind(this)),s}_createMethod(e,t){let s;if(bi(e))s={handler:e};else{if(!Si(e))throw new Ti(`Invalid method definition in '${t}' method in '${this.fullName}' service!`);s=e}if(!bi(s.handler))throw new Ti(`Missing method handler on '${t}' method in '${this.fullName}' service!`);return s.name=t,s.service=this,s.handler=s.handler.bind(this),this[t]=this.broker.middlewares.wrapHandler("localMethod",s.handler,s),s}_createEvent(e,t){let s,r;if(bi(e)||Array.isArray(e))s={handler:e};else{if(!Si(e))throw new Ti(`Invalid event definition in '${t}' event in '${this.fullName}' service!`);s=O.default.cloneDeep(e)}if(!bi(s.handler)&&!Array.isArray(s.handler))throw new Ti(`Missing event handler on '${t}' event in '${this.fullName}' service!`);if(bi(s.handler)){const e=U.default(s.handler);r=this.Promise.method(s.handler),r.__newSignature=!0===s.context||Ri(e)}else Array.isArray(s.handler)&&(r=s.handler.map((e=>{const t=U.default(e);return(e=this.Promise.method(e)).__newSignature=!0===s.context||Ri(t),e})));s.name||(s.name=t),s.service=this;const i=this;return bi(r)?s.handler=function(e){return r.apply(i,r.__newSignature?[e]:[e.params,e.nodeID,e.eventName,e])}:Array.isArray(r)&&(s.handler=function(e){return i.Promise.all(r.map((t=>t.apply(i,t.__newSignature?[e]:[e.params,e.nodeID,e.eventName,e]))))}),s}emitLocalEventHandler(e,t,s){return this.events[e]?this.events[e](t,s):Promise.reject(new vi(`No '${e}' registered local event handler`,500,"NOT_FOUND_EVENT",{eventName:e}))}waitForServices(e,t,s){return this.broker.waitForServices(e,t,s,this.logger)}static applyMixins(e){if(e.mixins){const t=Array.isArray(e.mixins)?e.mixins:[e.mixins];if(t.length>0){const s=Array.from(t).reverse().reduce(((e,t)=>(t.mixins&&(t=Ci.applyMixins(t)),e?Ci.mergeSchemas(e,t):t)),null);return Ci.mergeSchemas(s,e)}}return e}static mergeSchemas(e,t){const s=O.default.cloneDeep(e),r=O.default.cloneDeep(t);return Object.keys(r).forEach((e=>{if(-1!==["name","version"].indexOf(e)&&void 0!==r[e])s[e]=r[e];else if("settings"==e)s[e]=Ci.mergeSchemaSettings(r[e],s[e]);else if("metadata"==e)s[e]=Ci.mergeSchemaMetadata(r[e],s[e]);else if("hooks"==e)s[e]=Ci.mergeSchemaHooks(r[e],s[e]||{});else if("actions"==e)s[e]=Ci.mergeSchemaActions(r[e],s[e]||{});else if("methods"==e)s[e]=Ci.mergeSchemaMethods(r[e],s[e]);else if("events"==e)s[e]=Ci.mergeSchemaEvents(r[e],s[e]||{});else if(-1!==["merged","created","started","stopped"].indexOf(e))s[e]=Ci.mergeSchemaLifecycleHandlers(r[e],s[e]);else if("mixins"==e)s[e]=Ci.mergeSchemaUniqArray(r[e],s[e]);else if("dependencies"==e)s[e]=Ci.mergeSchemaUniqArray(r[e],s[e]);else{const t="mergeSchema"+e.replace(/./,e[0].toUpperCase());bi(Ci[t])?s[e]=Ci[t](r[e],s[e]):s[e]=Ci.mergeSchemaUnknown(r[e],s[e])}})),s}static mergeSchemaSettings(e,t){if(t&&t.$secureSettings||e&&e.$secureSettings){const s=e&&e.$secureSettings?e.$secureSettings:[],r=t&&t.$secureSettings?t.$secureSettings:[];t||(t={}),t.$secureSettings=O.default.uniq([].concat(s,r))}return O.default.defaultsDeep(e,t)}static mergeSchemaMetadata(e,t){return O.default.defaultsDeep(e,t)}static mergeSchemaUniqArray(e,t){return O.default.uniqWith(O.default.compact(Oi([e,t])),O.default.isEqual)}static mergeSchemaDependencies(e,t){return Ci.mergeSchemaUniqArray(e,t)}static mergeSchemaHooks(e,t){return Object.keys(e).forEach((s=>{null==t[s]&&(t[s]={}),Object.keys(e[s]).forEach((r=>{const i=Ii(e[s][r]),n=Ii(t[s][r]);t[s][r]=O.default.compact(Oi("before"==s?[n,i]:[i,n]))}))})),t}static mergeSchemaActions(e,t){return Object.keys(e).forEach((s=>{if(!1===e[s]&&t[s])return void delete t[s];const r=yi(e[s]),i=yi(t[s]);r&&r.hooks&&i&&i.hooks&&Object.keys(r.hooks).forEach((e=>{const t=Ii(r.hooks[e]),s=Ii(i.hooks[e]);r.hooks[e]=O.default.compact(Oi("before"==e?[s,t]:[t,s]))})),t[s]=O.default.defaultsDeep(r,i)})),t}static mergeSchemaMethods(e,t){return Object.assign(t||{},e||{})}static mergeSchemaEvents(e,t){return Object.keys(e).forEach((s=>{const r=yi(e[s]),i=yi(t[s]);let n=O.default.compact(Oi([i?i.handler:null,r?r.handler:null]));1==n.length&&(n=n[0]),t[s]=O.default.defaultsDeep(r,i),t[s].handler=n})),t}static mergeSchemaLifecycleHandlers(e,t){return O.default.compact(Oi([t,e]))}static mergeSchemaUnknown(e,t){return void 0!==e?e:t}static getVersionedFullName(e,t){return null!=t?("number"==typeof t?"v"+t:t)+"."+e:e}}var Li=Ci;const{isString:Ai}=ne,{RequestSkippedError:Ni,MaxCallLevelError:Pi}=F;function Mi(e,t){return t&&Object.assign(e.meta,t),e.meta}class ki{constructor(e,t){this.broker=e,this.broker?(this.nodeID=this.broker.nodeID,this.id=this.broker.generateUid()):this.nodeID=null,t?this.setEndpoint(t):(this.endpoint=null,this.service=null,this.action=null,this.event=null),this.eventName=null,this.eventType=null,this.eventGroups=null,this.options={timeout:null,retries:null},this.parentID=null,this.caller=null,this.level=1,this.params=null,this.meta={},this.locals={},this.requestID=this.id,this.tracing=null,this.span=null,this._spanStack=[],this.needAck=null,this.ackID=null,this.cachedResult=!1}static create(e,t,s,r={}){const i=new e.ContextFactory(e,t);if(null!=t&&i.setEndpoint(t),null!=s){let t=!!e&&e.options.contextParamsCloning;null!=r.paramsCloning&&(t=r.paramsCloning),i.setParams(s,t)}return i.options=r,null!=r.requestID?i.requestID=r.requestID:null!=r.parentCtx&&null!=r.parentCtx.requestID&&(i.requestID=r.parentCtx.requestID),null!=r.parentCtx&&null!=r.parentCtx.meta?i.meta=Object.assign({},r.parentCtx.meta||{},r.meta||{}):null!=r.meta&&(i.meta=r.meta),null!=r.parentCtx&&(i.tracing=r.parentCtx.tracing,i.level=r.parentCtx.level+1,r.parentCtx.span?i.parentID=r.parentCtx.span.id:i.parentID=r.parentCtx.id,r.parentCtx.service&&(i.caller=r.parentCtx.service.fullName)),r.caller&&(i.caller=r.caller),null!=r.parentSpan&&(i.parentID=r.parentSpan.id,i.requestID=r.parentSpan.traceID,i.tracing=r.parentSpan.sampled),r.needAck&&(i.needAck=r.needAck),i}copy(e){const t=new this.constructor(this.broker);return t.nodeID=this.nodeID,t.setEndpoint(e||this.endpoint),t.options=this.options,t.parentID=this.parentID,t.caller=this.caller,t.level=this.level,t.params=this.params,t.meta=this.meta,t.locals=this.locals,t.requestID=this.requestID,t.tracing=this.tracing,t.span=this.span,t.needAck=this.needAck,t.ackID=this.ackID,t.eventName=this.eventName,t.eventType=this.eventType,t.eventGroups=this.eventGroups,t.cachedResult=this.cachedResult,t}setEndpoint(e){this.endpoint=e,e&&(this.nodeID=e.id,e.action?(this.action=e.action,this.service=this.action.service,this.event=null):e.event&&(this.event=e.event,this.service=this.event.service,this.action=null))}setParams(e,t=!1){this.params=t&&e?Object.assign({},e):e}call(e,t,s){const r=Object.assign({parentCtx:this},s);if(this.options.timeout>0&&this.startHrTime){const t=H.hrtime(this.startHrTime),s=1e3*t[0]+t[1]/1e6,i=this.options.timeout-s;if(i<=0)return this.broker.Promise.reject(new Ni({action:e,nodeID:this.broker.nodeID}));(!r.timeout||i<r.timeout)&&(r.timeout=i)}if(this.broker.options.maxCallLevel>0&&this.level>=this.broker.options.maxCallLevel)return this.broker.Promise.reject(new Pi({nodeID:this.broker.nodeID,level:this.level}));let i=this.broker.call(e,t,r);return i.then((e=>(i.ctx&&Mi(this,i.ctx.meta),e))).catch((e=>(i.ctx&&Mi(this,i.ctx.meta),this.broker.Promise.reject(e))))}mcall(e,t){const s=Object.assign({parentCtx:this},t);if(this.options.timeout>0&&this.startHrTime){const t=H.hrtime(this.startHrTime),r=1e3*t[0]+t[1]/1e6,i=this.options.timeout-r;if(i<=0){const t=(Array.isArray(e)?e:Object.values(e)).map((e=>e.action)).join(", ");return this.broker.Promise.reject(new Ni({action:t,nodeID:this.broker.nodeID}))}(!s.timeout||i<s.timeout)&&(s.timeout=i)}if(this.broker.options.maxCallLevel>0&&this.level>=this.broker.options.maxCallLevel)return this.broker.Promise.reject(new Pi({nodeID:this.broker.nodeID,level:this.level}));let r=this.broker.mcall(e,s);return r.then((e=>(Array.isArray(r.ctx)&&r.ctx.length&&r.ctx.forEach((e=>Mi(this,e.meta))),e))).catch((e=>(Array.isArray(r.ctx)&&r.ctx.length&&r.ctx.forEach((e=>Mi(this,e.meta))),this.broker.Promise.reject(e))))}emit(e,t,s){return Array.isArray(s)||Ai(s)?s={groups:s}:null==s&&(s={}),s.groups&&!Array.isArray(s.groups)&&(s.groups=[s.groups]),s.parentCtx=this,this.broker.emit(e,t,s)}broadcast(e,t,s){return Array.isArray(s)||Ai(s)?s={groups:s}:null==s&&(s={}),s.groups&&!Array.isArray(s.groups)&&(s.groups=[s.groups]),s.parentCtx=this,this.broker.broadcast(e,t,s)}startSpan(e,t){let s;return s=this.span?this.span.startSpan(e,Object.assign({ctx:this},t)):this.broker.tracer.startSpan(e,Object.assign({ctx:this},t)),this._spanStack.push(s),this.span=s,s}finishSpan(e,t){if(!e.isActive())return;e.finish(t);const s=this._spanStack.findIndex((t=>t==e));-1!==s?(this._spanStack.splice(s,1),this.span=this._spanStack[this._spanStack.length-1]):this.service.logger.warn("This span is not assigned to this context",e)}toJSON(){return O.default.pick(this,["id","nodeID","action.name","event.name","service.name","service.version","service.fullName","options","parentID","caller","level","params","meta","requestID","tracing","span","needAck","ackID","eventName","eventType","eventGroups","cachedResult"])}[M.default.inspect.custom](e,t){if(e<0)return t.stylize("[Context]","special");const s=M.default.inspect(this.toJSON(),t);return`${t.stylize("Context","special")}< ${s} >`}}var Ui=ki;const{MoleculerClientError:Di}=F;const wi=S.default.EventEmitter2,{MetricRegistry:xi,METRIC:Hi}=Qe,{Tracer:$i}=_i,Bi={namespace:"",nodeID:null,logger:!0,logLevel:null,transporter:null,requestTimeout:0,retryPolicy:{enabled:!1,retries:5,delay:100,maxDelay:1e3,factor:2,check:e=>e&&!!e.retryable},contextParamsCloning:!1,maxCallLevel:0,heartbeatInterval:10,heartbeatTimeout:30,tracking:{enabled:!1,shutdownTimeout:5e3},disableBalancer:!1,registry:{strategy:"RoundRobin",preferLocal:!0},circuitBreaker:{enabled:!1,threshold:.5,windowTime:60,minRequestCount:20,halfOpenTime:1e4,check:e=>e&&e.code>=500},bulkhead:{enabled:!1,concurrency:10,maxQueueSize:100},transit:{maxQueueSize:5e4,maxChunkSize:262144,disableReconnect:!1,disableVersionCheck:!1},uidGenerator:null,errorHandler:null,cacher:null,serializer:null,validator:!0,metrics:!1,tracing:!1,internalServices:!0,internalMiddlewares:!0,dependencyInterval:1e3,hotReload:!1,middlewares:null,replCommands:null,replDelimiter:null,metadata:{},skipProcessEventRegistration:!1,maxSafeObjectSize:null};class Gi{constructor(e){try{if(this.options=O.default.defaultsDeep(e,Bi),this.options.Promise?this.Promise=this.options.Promise:this.Promise=Promise,ne.polyfillPromise(this.Promise),Gi.Promise=this.Promise,this.started=!1,this.ServiceFactory=this.options.ServiceFactory||Li,this.ContextFactory=this.options.ContextFactory||Ui,this.namespace=this.options.namespace||"",this.metadata=this.options.metadata||{},this.nodeID=this.options.nodeID||ne.getNodeID(),this.instanceID=ne.generateToken(),this.services=[],this.localBus=new wi({wildcard:!0,maxListeners:100}),this.loggerFactory=new rs(this),this.loggerFactory.init(this.options.logger),this.logger=this.getLogger("broker"),this.logger.info(`Moleculer v${this.MOLECULER_VERSION} is starting...`),this.logger.info("Namespace: "+(this.namespace||"<not defined>")),this.logger.info("Node ID: "+this.nodeID),this.metrics=new xi(this,this.options.metrics),this.metrics.init(),this.registerMoleculerMetrics(),this.middlewares=new Hr(this),this.registry=new wt(this),this.cacher=Ls.resolve(this.options.cacher),this.cacher){this.cacher.init(this);const e=this.getConstructorName(this.cacher);this.logger.info("Cacher: "+e)}this.serializer=Ks.resolve(this.options.serializer),this.serializer.init(this);const t=this.getConstructorName(this.serializer);if(this.logger.info("Serializer: "+t),this.options.validator&&(this.validator=ps.resolve(this.options.validator),this.validator)){const e=this.getConstructorName(this.validator);this.logger.info("Validator: "+e),this.validator.init(this)}if(this.tracer=new $i(this,this.options.tracing),this.tracer.init(),this.registerMiddlewares(this.options.middlewares),this.options.transporter){const e=$s.resolve(this.options.transporter);this.transit=new Xe(this,e,this.options.transit);const t=this.getConstructorName(e);this.logger.info("Transporter: "+t),this.options.disableBalancer&&(e.hasBuiltInBalancer?this.logger.info("The broker built-in balancer is DISABLED."):(this.logger.warn(`The ${t} has no built-in balancer. Broker balancer is ENABLED.`),this.options.disableBalancer=!1))}this.options.disableBalancer&&(this.call=this.callWithoutBalancer),this.registry.init(this),this.options.internalServices&&this.registerInternalServices(this.options.internalServices),this.callMiddlewareHookSync("created",[this]),ne.isFunction(this.options.created)&&this.options.created(this),this._closeFn=()=>{this.stop().catch((e=>this.logger.error(e))).then((()=>H.exit(0)))},H.setMaxListeners(0),!1===this.options.skipProcessEventRegistration&&(H.on("beforeExit",this._closeFn),H.on("exit",this._closeFn),H.on("SIGINT",this._closeFn),H.on("SIGTERM",this._closeFn))}catch(e){this.logger?this.fatal("Unable to create ServiceBroker.",e,!0):(console.error("Unable to create ServiceBroker.",e),H.exit(1))}}registerMiddlewares(e){if(Array.isArray(e)&&e.length>0&&(O.default.compact(e).forEach((e=>this.middlewares.add(e))),this.logger.info(`Registered ${this.middlewares.count()} custom middleware(s).`)),this.options.internalMiddlewares){const e=this.middlewares.count();if(this.middlewares.add("ActionHook"),this.validator&&ne.isFunction(this.validator.middleware)){const e=this.validator.middleware(this);ne.isPlainObject(e)?this.middlewares.add(e):this.middlewares.add({localAction:e})}if(this.middlewares.add("Bulkhead"),this.cacher&&ne.isFunction(this.cacher.middleware)){const e=this.cacher.middleware();ne.isPlainObject(e)?this.middlewares.add(e):this.middlewares.add({localAction:e})}this.middlewares.add("ContextTracker"),this.middlewares.add("CircuitBreaker"),this.middlewares.add("Timeout"),this.middlewares.add("Retry"),this.middlewares.add("Fallback"),this.middlewares.add("ErrorHandler"),this.middlewares.add("Tracing"),this.middlewares.add("Metrics"),this.middlewares.add("Debounce"),this.middlewares.add("Throttle"),this.options.hotReload&&this.middlewares.add("HotReload"),this.logger.info(`Registered ${this.middlewares.count()-e} internal middleware(s).`)}this.createService=this.wrapMethod("createService",this.createService),this.registerLocalService=this.wrapMethod("registerLocalService",this.registerLocalService),this.destroyService=this.wrapMethod("destroyService",this.destroyService),this.call=this.wrapMethod("call",this.call),this.callWithoutBalancer=this.wrapMethod("call",this.callWithoutBalancer),this.mcall=this.wrapMethod("mcall",this.mcall),this.emit=this.wrapMethod("emit",this.emit),this.broadcast=this.wrapMethod("broadcast",this.broadcast),this.broadcastLocal=this.wrapMethod("broadcastLocal",this.broadcastLocal),this.metrics.set(Hi.MOLECULER_BROKER_MIDDLEWARES_TOTAL,this.middlewares.count())}registerMoleculerMetrics(){this.isMetricsEnabled()&&(this.metrics.register({name:Hi.MOLECULER_NODE_TYPE,type:Hi.TYPE_INFO,description:"Moleculer implementation type"}).set("nodejs"),this.metrics.register({name:Hi.MOLECULER_NODE_VERSIONS_MOLECULER,type:Hi.TYPE_INFO,description:"Moleculer version number"}).set(Gi.MOLECULER_VERSION),this.metrics.register({name:Hi.MOLECULER_NODE_VERSIONS_PROTOCOL,type:Hi.TYPE_INFO,description:"Moleculer protocol version"}).set(Gi.PROTOCOL_VERSION),this.metrics.register({name:Hi.MOLECULER_BROKER_NAMESPACE,type:Hi.TYPE_INFO,description:"Moleculer namespace"}).set(this.namespace),this.metrics.register({name:Hi.MOLECULER_BROKER_STARTED,type:Hi.TYPE_GAUGE,description:"ServiceBroker started"}).set(0),this.metrics.register({name:Hi.MOLECULER_BROKER_LOCAL_SERVICES_TOTAL,type:Hi.TYPE_GAUGE,description:"Number of local services"}).set(0),this.metrics.register({name:Hi.MOLECULER_BROKER_MIDDLEWARES_TOTAL,type:Hi.TYPE_GAUGE,description:"Number of local middlewares"}).set(0))}start(){const e=Date.now();return this.Promise.resolve().then((()=>{})).then((()=>this.callMiddlewareHook("starting",[this]))).then((()=>{if(this.transit)return this.transit.connect()})).then((()=>this.Promise.all(this.services.map((e=>e._start.call(e)))).catch((e=>{throw this.logger.error("Unable to start all services.",e),e})))).then((()=>{this.started=!0,this.metrics.set(Hi.MOLECULER_BROKER_STARTED,1),this.broadcastLocal("$broker.started"),this.registry.regenerateLocalRawInfo(!0)})).then((()=>{if(this.transit)return this.transit.ready()})).then((()=>this.callMiddlewareHook("started",[this]))).then((()=>{if(ne.isFunction(this.options.started))return this.options.started(this)})).then((()=>{const t=Date.now()-e;this.logger.info(`✔ ServiceBroker with ${this.services.length} service(s) is started successfully in ${ne.humanize(t)}.`)}))}stop(){return this.started=!1,this.Promise.resolve().then((()=>{if(this.transit)return this.registry.regenerateLocalRawInfo(!0),this.registry.discoverer.sendLocalNodeInfo()})).then((()=>this.callMiddlewareHook("stopping",[this],{reverse:!0}))).then((()=>this.Promise.all(this.services.map((e=>e._stop.call(e)))).catch((e=>{this.logger.error("Unable to stop all services.",e)})))).then((()=>{if(this.transit)return this.transit.disconnect()})).then((()=>{if(this.cacher)return this.cacher.close()})).then((()=>{if(this.metrics)return this.metrics.stop()})).then((()=>{if(this.tracer)return this.tracer.stop()})).then((()=>this.registry.stop())).then((()=>this.callMiddlewareHook("stopped",[this],{reverse:!0}))).then((()=>{if(ne.isFunction(this.options.stopped))return this.options.stopped(this)})).catch((e=>{this.logger.error(e)})).then((()=>{this.logger.info("ServiceBroker is stopped. Good bye."),this.metrics.set(Hi.MOLECULER_BROKER_STARTED,0),this.broadcastLocal("$broker.stopped"),!1===this.options.skipProcessEventRegistration&&(H.removeListener("beforeExit",this._closeFn),H.removeListener("exit",this._closeFn),H.removeListener("SIGINT",this._closeFn),H.removeListener("SIGTERM",this._closeFn))})).then((()=>this.loggerFactory.stop())).catch((()=>{}))}repl(){let e;try{e=Le}catch(e){return console.error("The 'moleculer-repl' package is missing. Please install it with 'npm install moleculer-repl' command."),this.logger.error("The 'moleculer-repl' package is missing. Please install it with 'npm install moleculer-repl' command."),void this.logger.debug("ERROR",e)}if(e){let t=null;const s=this.options.replDelimiter,r=this.options.replCommands;return s&&(t={delimiter:s}),r&&(t={...t,customCommands:r}),e(this,t)}}errorHandler(e,t){if(this.options.errorHandler)return this.options.errorHandler.call(this,e,t);throw e}wrapMethod(e,t,s,r){return this.middlewares.wrapMethod(e,t,s,r)}callMiddlewareHook(e,t,s){return this.middlewares.callHandlers(e,t,s)}callMiddlewareHookSync(e,t,s){return this.middlewares.callSyncHandlers(e,t,s)}isMetricsEnabled(){return this.metrics.isEnabled()}isTracingEnabled(){return this.tracer.isEnabled()}getLogger(e,t){let s=Object.assign({nodeID:this.nodeID,ns:this.namespace,mod:e},t);return this.loggerFactory.getLogger(s)}fatal(e,t,s=!0){this.logger?this.logger.fatal(e,t):console.error(e,t),s&&H.exit(1)}loadServices(e="./services",t="**/*.service.js"){let s;return this.logger.debug(`Search services in '${e}/${t}'...`),s=Array.isArray(t)?t.map((t=>I.default.join(e,t))):y.default.sync(I.default.join(e,t)),s&&s.forEach((e=>this.loadService(e))),s.length}loadService(e){let t,s;try{t=require.resolve(I.default.resolve(e)),this.logger.debug(`Load service '${I.default.basename(t)}'...`);const r=B();let i;return s=null!=r.default?r.default:r,s=this.normalizeSchemaConstructor(s),Object.prototype.isPrototypeOf.call(this.ServiceFactory,s)?(i=new s(this),this.started&&this._restartService(i)):ne.isFunction(s)?(i=s(this),i instanceof this.ServiceFactory?this.started&&this._restartService(i):i=this.createService(i)):s&&(i=this.createService(s)),i&&(i.__filename=t),i}catch(t){throw this.logger.error(`Failed to load service '${e}'`,t),t}}createService(e,t){let s;if(e=this.normalizeSchemaConstructor(e),Object.prototype.isPrototypeOf.call(this.ServiceFactory,e))s=new e(this,t);else{let r=e;t&&(r=this.ServiceFactory.mergeSchemas(e,t)),s=new this.ServiceFactory(this,r)}return this.started&&this._restartService(s),s}_restartService(e){return e._start.call(e).catch((e=>this.logger.error("Unable to start service.",e)))}addLocalService(e){this.services.push(e),this.metrics.set(Hi.MOLECULER_BROKER_LOCAL_SERVICES_TOTAL,this.services.length)}registerLocalService(e){this.registry.registerLocalService(e)}destroyService(e){let t,s;return ne.isString(e)?(t=e,e=this.getLocalService(e)):ne.isPlainObject(e)&&(t=e.name,s=e.version,e=this.getLocalService(e.name,e.version)),e?this.Promise.resolve().then((()=>e._stop())).catch((t=>{this.logger.error(`Unable to stop '${e.fullName}' service.`,t)})).then((()=>{ne.removeFromArray(this.services,e),this.registry.unregisterService(e.fullName,this.nodeID),this.logger.info(`Service '${e.fullName}' is stopped.`),this.servicesChanged(!0),this.metrics.set(Hi.MOLECULER_BROKER_LOCAL_SERVICES_TOTAL,this.services.length)})):this.Promise.reject(new F.ServiceNotFoundError({service:t,version:s}))}servicesChanged(e=!1){this.broadcastLocal("$services.changed",{localService:e}),this.started&&e&&this.transit&&this.registry.discoverer.sendLocalNodeInfo()}registerInternalServices(e){e=ne.isObject(e)?e:{},this.createService({name:"$node",actions:{list:{cache:!1,tracing:!1,params:{withServices:{type:"boolean",optional:!0,convert:!0,default:!1},onlyAvailable:{type:"boolean",optional:!0,convert:!0,default:!1}},handler(e){return this.broker.registry.getNodeList(e.params)}},services:{cache:!1,tracing:!1,params:{onlyLocal:{type:"boolean",optional:!0,convert:!0,default:!1},skipInternal:{type:"boolean",optional:!0,convert:!0,default:!1},withActions:{type:"boolean",optional:!0,convert:!0,default:!1},withEvents:{type:"boolean",optional:!0,convert:!0,default:!1},onlyAvailable:{type:"boolean",optional:!0,convert:!0,default:!1},grouping:{type:"boolean",optional:!0,convert:!0,default:!0}},handler(e){return this.broker.registry.getServiceList(e.params)}},actions:{cache:!1,tracing:!1,params:{onlyLocal:{type:"boolean",optional:!0,convert:!0,default:!1},skipInternal:{type:"boolean",optional:!0,convert:!0,default:!1},withEndpoints:{type:"boolean",optional:!0,convert:!0,default:!1},onlyAvailable:{type:"boolean",optional:!0,convert:!0,default:!1}},handler(e){return this.broker.registry.getActionList(e.params)}},events:{cache:!1,tracing:!1,params:{onlyLocal:{type:"boolean",optional:!0,convert:!0,default:!1},skipInternal:{type:"boolean",optional:!0,convert:!0,default:!1},withEndpoints:{type:"boolean",optional:!0,convert:!0,default:!1},onlyAvailable:{type:"boolean",optional:!0,convert:!0,default:!1}},handler(e){return this.broker.registry.getEventList(e.params)}},health:{cache:!1,tracing:!1,handler(){return this.broker.getHealthStatus()}},options:{cache:!1,tracing:!1,params:{},handler(){return ne.safetyObject(this.broker.options,this.broker.options)}},metrics:{cache:!1,tracing:!1,params:{types:{type:"multi",optional:!0,rules:[{type:"string"},{type:"array",items:"string"}]},includes:{type:"multi",optional:!0,rules:[{type:"string"},{type:"array",items:"string"}]},excludes:{type:"multi",optional:!0,rules:[{type:"string"},{type:"array",items:"string"}]}},handler(e){return this.broker.isMetricsEnabled()?this.broker.metrics.list(e.params):this.Promise.reject(new Di("Metrics feature is disabled",400,"METRICS_DISABLED"))}}}},e.$node)}getLocalService(e,t){if(1==arguments.length){if(ne.isString(e))return this.services.find((t=>t.fullName==e));if(ne.isPlainObject(e))return this.services.find((t=>t.name==e.name&&t.version==e.version))}return this.services.find((s=>s.name==e&&s.version==t))}waitForServices(e,t,s,r=this.logger){if(Array.isArray(e)||(e=[e]),0==(e=O.default.uniq(O.default.compact(e.map((e=>ne.isPlainObject(e)&&e.name?this.ServiceFactory.getVersionedFullName(e.name,e.version):ne.isString(e)?e:void 0))))).length)return this.Promise.resolve();r.info(`Waiting for service(s) '${e.join(", ")}'...`);const n=Date.now();return new this.Promise(((o,a)=>{const l=()=>{const c=e.filter((e=>this.registry.hasService(e)));return c.length==e.length?(r.info(`Service(s) '${e.join(", ")}' are available.`),o()):(r.debug(`${c.length} of ${e.length} services are available. Waiting further...`),t&&Date.now()-n>t?a(new F.MoleculerServerError("Services waiting is timed out.",500,"WAITFOR_SERVICES",{services:e})):void i.setTimeout(l,s||this.options.dependencyInterval||1e3))};l()}))}findNextActionEndpoint(e,t,s){if("string"!=typeof e)return e;if(t&&t.nodeID){const s=t.nodeID,r=this.registry.getActionEndpointByNodeId(e,s);return r||(this.logger.warn(`Service '${e}' is not found on '${s}' node.`),new F.ServiceNotFoundError({action:e,nodeID:s}))}{const t=this.registry.getActionEndpoints(e);if(!t)return this.logger.warn(`Service '${e}' is not registered.`),new F.ServiceNotFoundError({action:e});const r=t.next(s);if(!r){const t=`Service '${e}' is not available.`;return this.logger.warn(t),new F.ServiceNotAvailableError({action:e})}return r}}call(e,t,s={}){let r;if(void 0===t&&(t={}),null!=s.ctx){const i=this.findNextActionEndpoint(e,s,s.ctx);if(i instanceof Error)return this.Promise.reject(i).catch((r=>this.errorHandler(r,{actionName:e,params:t,opts:s})));r=s.ctx,r.endpoint=i,r.nodeID=i.id,r.action=i.action,r.service=i.action.service}else{r=this.ContextFactory.create(this,null,t,s);const i=this.findNextActionEndpoint(e,s,r);if(i instanceof Error)return this.Promise.reject(i).catch((r=>this.errorHandler(r,{actionName:e,params:t,opts:s})));r.setEndpoint(i)}r.endpoint.local?this.logger.debug("Call action locally.",{action:r.action.name,requestID:r.requestID}):this.logger.debug("Call action on remote node.",{action:r.action.name,nodeID:r.nodeID,requestID:r.requestID});let i=r.endpoint.action.handler(r);return i.ctx=r,i}callWithoutBalancer(e,t,s={}){void 0===t&&(t={});let r,i=null,n=null;if("string"!=typeof e)n=e,e=n.action.name,i=n.id;else if(s.nodeID){if(i=s.nodeID,n=this.registry.getActionEndpointByNodeId(e,i),!n)return this.logger.warn(`Service '${e}' is not found on '${i}' node.`),this.Promise.reject(new F.ServiceNotFoundError({action:e,nodeID:i})).catch((r=>this.errorHandler(r,{nodeID:i,actionName:e,params:t,opts:s})))}else{const r=this.registry.getActionEndpoints(e);if(null==r)return this.logger.warn(`Service '${e}' is not registered.`),this.Promise.reject(new F.ServiceNotFoundError({action:e})).catch((r=>this.errorHandler(r,{actionName:e,params:t,opts:s})));if(n=r.getFirst(),null==n){const r=`Service '${e}' is not available.`;return this.logger.warn(r),this.Promise.reject(new F.ServiceNotAvailableError({action:e})).catch((r=>this.errorHandler(r,{actionName:e,params:t,opts:s})))}}null!=s.ctx?(r=s.ctx,n&&(r.endpoint=n,r.action=n.action)):r=this.ContextFactory.create(this,n,t,s),r.nodeID=i,this.logger.debug("Call action on a node.",{action:r.action.name,nodeID:r.nodeID,requestID:r.requestID});let o=n.action.remoteHandler(r);return o.ctx=r,o}_getLocalActionEndpoint(e,t){let s=this.registry.getActionEndpoints(e);if(null==s||!s.hasLocal())throw this.logger.warn(`Service '${e}' is not registered locally.`),new F.ServiceNotFoundError({action:e,nodeID:this.nodeID});let r=s.nextLocal(t);if(!r)throw this.logger.warn(`Service '${e}' is not available locally.`),new F.ServiceNotAvailableError({action:e,nodeID:this.nodeID});return r}mcall(e,t){if(Array.isArray(e))return this.Promise.all(e.map((e=>this.call(e.action,e.params,e.options||t))));if(ne.isObject(e)){let s={},r=Object.keys(e).map((r=>{const i=e[r],n=i.options||t;return this.call(i.action,i.params,n).then((e=>s[r]=e))})),i=this.Promise.all(r);return i.ctx=r.map((e=>e.ctx)),i.then((()=>s))}return this.Promise.reject(new F.MoleculerServerError("Invalid calling definition.",500,"INVALID_PARAMETERS"))}emit(e,t,s){Array.isArray(s)||ne.isString(s)?s={groups:s}:null==s&&(s={}),s.groups&&!Array.isArray(s.groups)&&(s.groups=[s.groups]);const r=[],i=this.ContextFactory.create(this,null,t,s);if(i.eventName=e,i.eventType="emit",i.eventGroups=s.groups,this.logger.debug(`Emit '${e}' event`+(s.groups?` to '${s.groups.join(", ")}' group(s)`:"")+"."),/^\$/.test(e)&&this.localBus.emit(e,t),!this.options.disableBalancer){const t=this.registry.events.getBalancedEndpoints(e,s.groups),n={};return t.forEach((([e,t])=>{if(e.id==this.nodeID){const t=i.copy(e);r.push(this.registry.events.callEventHandler(t))}else{const s=n[e.id];s?s.groups.push(t):n[e.id]={ep:e,groups:[t]}}})),this.transit&&O.default.forIn(n,(e=>{const t=i.copy(e.ep);t.eventGroups=e.groups,r.push(this.transit.sendEvent(t))})),this.Promise.all(r)}if(this.transit){let t=s.groups;return t&&0!=t.length||(t=this.getEventGroups(e)),0==t.length?this.Promise.resolve():(i.eventGroups=t,this.transit.sendEvent(i))}}broadcast(e,t,s){Array.isArray(s)||ne.isString(s)?s={groups:s}:null==s&&(s={}),s.groups&&!Array.isArray(s.groups)&&(s.groups=[s.groups]);const r=[];if(this.logger.debug(`Broadcast '${e}' event`+(s.groups?` to '${s.groups.join(", ")}' group(s)`:"")+"."),this.transit){const i=this.ContextFactory.create(this,null,t,s);if(i.eventName=e,i.eventType="broadcast",i.eventGroups=s.groups,this.options.disableBalancer){let t=s.groups;if(t&&0!=t.length||(t=this.getEventGroups(e)),0==t.length)return;const r=this.registry.events.getAllEndpoints(e,t);return this.Promise.all(r.map((e=>{const s=i.copy(e);return s.eventGroups=t,this.transit.sendEvent(s)})))}this.registry.events.getAllEndpoints(e,s.groups).forEach((e=>{if(e.id!=this.nodeID){const t=i.copy(e);r.push(this.transit.sendEvent(t))}}))}return r.push(this.broadcastLocal(e,t,s)),this.Promise.all(r)}broadcastLocal(e,t,s){Array.isArray(s)||ne.isString(s)?s={groups:s}:null==s&&(s={}),s.groups&&!Array.isArray(s.groups)&&(s.groups=[s.groups]),this.logger.debug(`Broadcast '${e}' local event`+(s.groups?` to '${s.groups.join(", ")}' group(s)`:"")+"."),/^\$/.test(e)&&this.localBus.emit(e,t);const r=this.ContextFactory.create(this,null,t,s);return r.eventName=e,r.eventType="broadcastLocal",r.eventGroups=s.groups,this.emitLocalServices(r)}ping(e,t=2e3){if(this.transit&&this.transit.connected){if(ne.isString(e))return new this.Promise((s=>{const r=i.setTimeout((()=>{this.localBus.off("$node.pong",n),s(null)}),t),n=t=>{t.nodeID==e&&(clearTimeout(r),this.localBus.off("$node.pong",n),s(t))};this.localBus.on("$node.pong",n),this.transit.sendPing(e)}));{const s={};let r=e;r||(r=this.registry.getNodeList({onlyAvailable:!0}).filter((e=>e.id!=this.nodeID)).map((e=>e.id))),r.forEach((e=>s[e]=null));const n=new Set(r);return new this.Promise((e=>{const o=i.setTimeout((()=>{this.localBus.off("$node.pong",a),e(s)}),t),a=t=>{s[t.nodeID]=t,n.delete(t.nodeID),0==n.size&&(clearTimeout(o),this.localBus.off("$node.pong",a),e(s))};this.localBus.on("$node.pong",a),r.forEach((e=>this.transit.sendPing(e)))}))}}return this.Promise.resolve(e?null:[])}getHealthStatus(){return nr(this)}getLocalNodeInfo(){return this.registry.getLocalNodeInfo()}getEventGroups(e){return this.registry.events.getGroups(e)}hasEventListener(e){return this.registry.events.getAllEndpoints(e).length>0}getEventListeners(e){return this.registry.events.getAllEndpoints(e)}emitLocalServices(e){return this.registry.events.emitLocalServices(e)}getCpuUsage(){return K()}generateUid(){return this.options.uidGenerator?this.options.uidGenerator.call(this,this):ne.generateToken()}getConstructorName(e){let t=e.prototype;return t&&t.constructor&&t.constructor.name?t.constructor.name:e.constructor&&e.constructor.name?e.constructor.name:void 0}normalizeSchemaConstructor(e){if(Object.prototype.isPrototypeOf.call(this.ServiceFactory,e))return e;let t=this.getConstructorName(this.ServiceFactory),s=this.getConstructorName(e);return t===s?(Object.setPrototypeOf(e,this.ServiceFactory),e):(s=this.getConstructorName(e.__proto__),t===s?(Object.setPrototypeOf(e.__proto__,this.ServiceFactory),e):e._isMockFunction&&(s=this.getConstructorName(e.prototype.__proto__),t===s)?(Object.setPrototypeOf(e,this.ServiceFactory),e):e)}}Gi.MOLECULER_VERSION=zs,Gi.prototype.MOLECULER_VERSION=Gi.MOLECULER_VERSION,Gi.PROTOCOL_VERSION="4",Gi.prototype.PROTOCOL_VERSION=Gi.PROTOCOL_VERSION,Gi.defaultOptions=Bi;var Fi=Gi;const{CIRCUIT_CLOSE:qi,CIRCUIT_HALF_OPEN:Yi,CIRCUIT_HALF_OPEN_WAIT:Vi,CIRCUIT_OPEN:ji}=D;var Ki={ServiceBroker:Fi,Loggers:Jt,Service:Li,Context:Ui,Cachers:Ls,Transporters:$s,Serializers:Ks,Strategies:pt,Validators:ps,Validator:as,TracerExporters:ai,MetricTypes:be,MetricReporters:De,METRIC:q,Registry:wt,Discoverers:St,Middlewares:kr,Errors:F,Runner:Le,Utils:ne,CIRCUIT_CLOSE:qi,CIRCUIT_HALF_OPEN:Yi,CIRCUIT_HALF_OPEN_WAIT:Vi,CIRCUIT_OPEN:ji,MOLECULER_VERSION:Fi.MOLECULER_VERSION,PROTOCOL_VERSION:Fi.PROTOCOL_VERSION};v.default.enabled=!1;const zi=Ki.ServiceBroker,Qi=Ki.Loggers,Zi=Ki.Service,Wi=Ki.Context,Ji=Ki.Cachers,Xi=Ki.Transporters,en=Ki.Serializers,tn=Ki.Strategies,sn=Ki.Validators,rn=Ki.TracerExporters,nn=Ki.MetricTypes,on=Ki.MetricReporters,an=Ki.METRIC,ln=Ki.Registry,cn=Ki.Discoverers,hn=Ki.Middlewares,un=Ki.Errors,dn=Ki.Utils,pn=Ki.CIRCUIT_CLOSE,mn=Ki.CIRCUIT_HALF_OPEN,En=Ki.CIRCUIT_HALF_OPEN_WAIT,gn=Ki.CIRCUIT_OPEN,fn=Ki.MOLECULER_VERSION,_n=Ki.PROTOCOL_VERSION;e.CIRCUIT_CLOSE=pn,e.CIRCUIT_HALF_OPEN=mn,e.CIRCUIT_HALF_OPEN_WAIT=En,e.CIRCUIT_OPEN=gn,e.Cachers=Ji,e.Context=Wi,e.Discoverers=cn,e.Errors=un,e.Loggers=Qi,e.METRIC=an,e.MOLECULER_VERSION=fn,e.MetricReporters=on,e.MetricTypes=nn,e.Middlewares=hn,e.PROTOCOL_VERSION=_n,e.Registry=ln,e.Runner=!1,e.Serializers=en,e.Service=Zi,e.ServiceBroker=zi,e.Strategies=tn,e.TracerExporters=rn,e.Transporters=Xi,e.Utils=dn,e.Validators=sn,Object.defineProperty(e,"__esModule",{value:!0})}));
//# sourceMappingURL=moleculer.js.map

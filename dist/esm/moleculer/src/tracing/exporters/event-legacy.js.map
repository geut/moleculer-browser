{"version":3,"file":"event-legacy.js","sources":["../../../../../../src/moleculer/src/tracing/exporters/event-legacy.js"],"sourcesContent":["\"use strict\";\n\nconst _ \t\t\t\t\t\t= require(\"lodash\");\nconst BaseTraceExporter \t\t= require(\"./base\");\nconst { isObject, isFunction }\t= require(\"../../utils\");\n\n/**\n * Event Trace Exporter. It sends same trace events as in Moleculer <= v0.13.\n *\n * @class EventLegacyTraceExporter\n */\nclass EventLegacyTraceExporter extends BaseTraceExporter {\n\n\t/**\n\t * Creates an instance of EventLegacyTraceExporter.\n\t * @param {Object?} opts\n\t * @memberof EventLegacyTraceExporter\n\t */\n\tconstructor(opts) {\n\t\tsuper(opts);\n\n\t\tthis.opts = _.defaultsDeep(this.opts, {\n\t\t});\n\t}\n\n\t/**\n\t * Initialize Trace Exporter.\n\t *\n\t * @param {Tracer} tracer\n\t * @memberof EventLegacyTraceExporter\n\t */\n\tinit(tracer) {\n\t\tsuper.init(tracer);\n\t\tthis.broker = tracer.broker;\n\t}\n\n\t/**\n\t * Span is started.\n\t *\n\t * @param {Span} span\n\t * @memberof BaseTraceExporter\n\t */\n\tspanStarted(span) {\n\t\tconst payload = this.generateMetricPayload(span);\n\t\tthis.broker.emit(\"metrics.trace.span.start\", payload);\n\t}\n\n\t/**\n\t * Span is finished.\n\t *\n\t * @param {Span} span\n\t * @memberof EventLegacyTraceExporter\n\t */\n\tspanFinished(span) {\n\t\tconst payload = this.generateMetricPayload(span);\n\t\tthis.broker.emit(\"metrics.trace.span.finish\", payload);\n\t}\n\n\t/**\n\t * Generate metrics payload\n\t *\n\t * @param {Context} ctx\n\t * @returns {Object}\n\t */\n\tgenerateMetricPayload(span) {\n\t\tlet payload = {\n\t\t\tid: span.id,\n\t\t\trequestID: span.traceID,\n\t\t\tlevel: span.tags.callingLevel,\n\t\t\tstartTime: span.startTime,\n\t\t\tremoteCall: span.tags.remoteCall\n\t\t};\n\n\t\t// Process extra metrics\n\t\tif (span.opts.ctx)\n\t\t\tthis.processExtraMetrics(span.opts.ctx, payload);\n\n\t\tpayload.action = span.tags.action;\n\t\tpayload.service = span.service;\n\n\t\tif (span.parentID)\n\t\t\tpayload.parent = span.parentID;\n\n\t\tpayload.nodeID = this.broker.nodeID;\n\t\tif (payload.remoteCall)\n\t\t\tpayload.callerNodeID = span.tags.callerNodeID;\n\n\t\tif (span.finishTime) {\n\t\t\tpayload.endTime = span.finishTime;\n\t\t\tpayload.duration = span.duration;\n\t\t\tpayload.fromCache = span.tags.fromCache;\n\n\t\t\tif (span.error) {\n\t\t\t\tpayload.error = this.errorToObject(span.error);\n\t\t\t}\n\t\t}\n\n\t\treturn payload;\n\t}\n\n\t/**\n\t * Assign extra metrics taking into account action definitions\n\t *\n\t * @param {Context} ctx\n\t * @param {string} name Field of the context to be assigned.\n\t * @param {any} payload Object for assignment.\n\t *\n\t * @private\n\t */\n\tassignExtraMetrics(ctx, name, payload) {\n\t\tlet def = ctx.action.metrics[name];\n\t\t// if metrics definitions is boolean do default, metrics=true\n\t\tif (def === true) {\n\t\t\tpayload[name] = ctx[name];\n\t\t} else if (Array.isArray(def)) {\n\t\t\tpayload[name] = _.pick(ctx[name], def);\n\t\t} else if (isFunction(def)) {\n\t\t\tpayload[name] = def(ctx[name]);\n\t\t}\n\t}\n\n\t/**\n\t * Decide and process extra metrics taking into account action definitions\n\t *\n\t * @param {Context} ctx\n\t * @param {any} payload Object for assignment.\n\t *\n\t * @private\n\t */\n\tprocessExtraMetrics(ctx, payload) {\n\t\t// extra metrics (params and meta)\n\t\tif (isObject(ctx.action.metrics)) {\n\t\t\t// custom metrics def\n\t\t\tthis.assignExtraMetrics(ctx, \"params\", payload);\n\t\t\tthis.assignExtraMetrics(ctx, \"meta\", payload);\n\t\t}\n\t}\n\n\n}\n\nmodule.exports = EventLegacyTraceExporter;\n"],"names":["require$$0","BaseTraceExporter"],"mappings":"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"}
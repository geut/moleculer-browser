{"version":3,"file":"event.js","sources":["../../../../../../src/moleculer/src/tracing/exporters/event.js"],"sourcesContent":["\"use strict\";\n\nconst _ \t\t\t\t\t= require(\"lodash\");\nconst BaseTraceExporter \t= require(\"./base\");\nconst { isFunction } \t\t= require(\"../../utils\");\n\n/**\n * Event Trace Exporter.\n *\n * @class EventTraceExporter\n */\nclass EventTraceExporter extends BaseTraceExporter {\n\n\t/**\n\t * Creates an instance of EventTraceExporter.\n\t * @param {Object?} opts\n\t * @memberof EventTraceExporter\n\t */\n\tconstructor(opts) {\n\t\tsuper(opts);\n\n\t\tthis.opts = _.defaultsDeep(this.opts, {\n\t\t\t/** @type {String} Base URL for Zipkin server. */\n\t\t\teventName: \"$tracing.spans\",\n\n\t\t\tsendStartSpan: false,\n\t\t\tsendFinishSpan: true,\n\n\t\t\tbroadcast: false,\n\n\t\t\tgroups: null,\n\n\t\t\t/** @type {Number} Batch send time interval. */\n\t\t\tinterval: 5,\n\n\t\t\tspanConverter: null,\n\n\t\t\t/** @type {Object?} Default span tags */\n\t\t\tdefaultTags: null\n\t\t});\n\n\t\tthis.queue = [];\n\t}\n\n\t/**\n\t * Initialize Trace Exporter.\n\t *\n\t * @param {Tracer} tracer\n\t * @memberof EventTraceExporter\n\t */\n\tinit(tracer) {\n\t\tsuper.init(tracer);\n\n\t\tif (this.opts.interval > 0) {\n\t\t\tthis.timer = setInterval(() => this.flush(), this.opts.interval * 1000);\n\t\t\tthis.timer.unref();\n\t\t}\n\n\t\tthis.defaultTags = isFunction(this.opts.defaultTags) ? this.opts.defaultTags.call(this, tracer) : this.opts.defaultTags;\n\t}\n\n\t/**\n\t * Stop Trace exporter\n\t */\n\tstop() {\n\t\tif (this.timer) {\n\t\t\tclearInterval(this.timer);\n\t\t\tthis.timer = null;\n\t\t}\n\t\treturn this.Promise.resolve();\n\t}\n\n\t/**\n\t * Span is started.\n\t *\n\t * @param {Span} span\n\t * @memberof BaseTraceExporter\n\t */\n\tspanStarted(span) {\n\t\tif (this.opts.sendStartSpan) {\n\t\t\tthis.queue.push(span);\n\t\t\tif (!this.timer)\n\t\t\t\tthis.flush();\n\t\t}\n\t}\n\n\t/**\n\t * Span is finished.\n\t *\n\t * @param {Span} span\n\t * @memberof EventTraceExporter\n\t */\n\tspanFinished(span) {\n\t\tif (this.opts.sendFinishSpan) {\n\t\t\tthis.queue.push(span);\n\t\t\tif (!this.timer)\n\t\t\t\tthis.flush();\n\t\t}\n\t}\n\n\t/**\n\t * Flush tracing data to Datadog server\n\t *\n\t * @memberof EventTraceExporter\n\t */\n\tflush() {\n\t\tif (this.queue.length == 0) return;\n\n\t\tconst data = this.generateTracingData();\n\t\tthis.queue.length = 0;\n\n\t\tif (this.opts.broadcast) {\n\t\t\tthis.logger.debug(`Send tracing spans (${data.length} spans) broadcast events.`);\n\t\t\tthis.broker.broadcast(this.opts.eventName, data, { groups: this.opts.groups });\n\t\t} else {\n\t\t\tthis.logger.debug(`Send tracing spans (${data.length} spans) events.`);\n\t\t\tthis.broker.emit(this.opts.eventName, data, { groups: this.opts.groups });\n\t\t}\n\t}\n\n\t/**\n\t * Generate tracing data with custom converter\n\t *\n\t * @returns {Array<Object>}\n\t * @memberof EventTraceExporter\n\t */\n\tgenerateTracingData() {\n\t\tif (isFunction(this.opts.spanConverter))\n\t\t\treturn this.queue.map(span => this.opts.spanConverter.call(this, span));\n\n\t\treturn Array.from(this.queue).map(span => {\n\t\t\tconst newSpan = Object.assign({}, span);\n\t\t\tif (newSpan.error)\n\t\t\t\tnewSpan.error = this.errorToObject(span.error);\n\n\t\t\treturn newSpan;\n\t\t});\n\t}\n\n}\n\nmodule.exports = EventTraceExporter;\n"],"names":["require$$0","BaseTraceExporter"],"mappings":"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"}
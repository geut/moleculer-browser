import t from"lodash";import e from"kleur";import i from"../../utils.js";import s from"./base.js";const r=t.repeat,{humanize:n,isFunction:h}=i;var a=class extends s{constructor(i){super(i),this.opts=t.defaultsDeep(this.opts,{logger:null,colors:!0,width:100,gaugeWidth:40}),this.opts.colors||(e.enabled=!1),this.spans={}}init(t){super.init(t)}stop(){return this.spans={},this.broker.Promise.resolve()}spanStarted(t){if(this.spans[t.id]={span:t,children:[]},t.parentID){const e=this.spans[t.parentID];e&&e.children.push(t.id)}}spanFinished(t){this.spans[t.parentID]||(this.printRequest(t.id),this.removeSpanWithChildren(t.id))}removeSpanWithChildren(t){const e=this.spans[t];e&&(e.children&&e.children.length>0&&e.children.forEach((t=>this.removeSpanWithChildren(t))),delete this.spans[t])}drawTableTop(){this.log(e.grey("┌"+r("─",this.opts.width-2)+"┐"))}drawHorizonalLine(){this.log(e.grey("├"+r("─",this.opts.width-2)+"┤"))}drawLine(t){this.log(e.grey("│ ")+t+e.grey(" │"))}drawTableBottom(){this.log(e.grey("└"+r("─",this.opts.width-2)+"┘"))}getAlignedTexts(t,e){const i=t.length;let s;return i<=e?s=t+r(" ",e-i):(s=t.slice(0,Math.max(e-3,0)),s+=r(".",Math.min(3,e))),s}drawGauge(t,i){const s=this.opts.gaugeWidth,n=Math.floor(s*t/100),h=Math.max(Math.floor(s*i/100)-n,1),a=Math.max(s-(n+h),0);return[e.grey("["),e.grey(r(".",n)),r("■",h),e.grey(r(".",a)),e.grey("]")].join("")}getCaption(t){let e=t.name;return t.tags.fromCache&&(e+=" *"),t.tags.remoteCall&&(e+=" »"),t.error&&(e+=" ×"),e}getColor(t){let i=e.bold;return t.tags.fromCache&&(i=i().yellow),t.tags.remoteCall&&(i=i().cyan),null==t.duration&&(i=i().grey),t.error&&(i=i().red),i}getTraceInfo(t){let e=0,i=0,s=(t,r,n)=>{t.level=r,t.parents=n||[],i++,r>e&&(e=r),t.children.length>0&&t.children.forEach(((e,i)=>{const r=this.spans[e];r.first=0==i,r.last=i==t.children.length-1,s(r,t.level+1,[].concat(t.parents,[t]))}))};return s(t,1),{depth:e,total:i}}getSpanIndent(t){if(t.level>1){let e=t.parents.map(((t,e)=>e>0?t.last?"  ":"│ ":"")).join("");return e+=t.last?"└─":"├─",e+(t.children.length>0?"┬─":"──")+" "}return""}printSpanTime(t,i,s){const r=t.span,h=i.span,a=(this.opts.width||80)-4,o=this.opts.gaugeWidth||40,l=null==r.duration?"?":n(r.duration),g=this.getSpanIndent(t),p=this.getCaption(r),d=e.grey(g)+this.getAlignedTexts(p,a-o-3-l.length-1-g.length)+" "+l,c=r.startTime||h.startTime,m=r.finishTime||h.finishTime;let u=(c-h.startTime)/(h.finishTime-h.startTime)*100,T=(m-h.startTime)/(h.finishTime-h.startTime)*100;Number.isNaN(u)&&Number.isNaN(T)&&(u=0,T=100),T>100&&(T=100);const f=this.getColor(r);this.drawLine(f(d+" "+this.drawGauge(u,T))),t.children.length>0&&t.children.forEach(((e,r)=>this.printSpanTime(this.spans[e],i,s+1,t,{first:0==r,last:r==t.children.length-1})))}printRequest(t){const i=this.spans[t];if(!i)return;const s=this.opts.width-4;this.drawTableTop();const{total:r,depth:n}=this.getTraceInfo(i),h=this.getAlignedTexts(t,s-"ID: ".length-"Depth: ".length-(""+n).length-"Total: ".length-(""+r).length-2),a=e.grey("ID: ")+e.bold(h)+" "+e.grey("Depth: ")+e.bold(n)+" "+e.grey("Total: ")+e.bold(r);this.drawLine(a),this.drawHorizonalLine(),this.printSpanTime(i,i,1,null,{}),this.drawTableBottom()}log(...t){return h(this.opts.logger)?this.opts.logger(...t):this.logger.info(...t)}};export default a;
//# sourceMappingURL=console.js.map

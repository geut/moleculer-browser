{"version":3,"file":"rate-limiter.js","sources":["../../../../../src/moleculer/src/tracing/rate-limiter.js"],"sourcesContent":["/*\n * moleculer\n * Copyright (c) 2019 MoleculerJS (https://github.com/moleculerjs/moleculer)\n * MIT Licensed\n */\n\n\"use strict\";\n\nconst _ = require(\"lodash\");\n\n/**\n * Rate Limiter class for Tracing.\n *\n * Inspired by\n * \thttps://github.com/jaegertracing/jaeger-client-node/blob/master/src/rate_limiter.js\n *\n * @class RateLimiter\n */\nclass RateLimiter {\n\tconstructor(opts) {\n\t\tthis.opts = _.defaultsDeep(opts, {\n\t\t\ttracesPerSecond: 1\n\t\t});\n\n\t\tthis.lastTime = Date.now();\n\t\tthis.balance = 0;\n\t\tthis.maxBalance = this.opts.tracesPerSecond < 1 ? 1 : this.opts.tracesPerSecond;\n\t}\n\n\tcheck(cost = 1) {\n\t\tconst now = Date.now();\n\t\tconst elapsedTime = (now - this.lastTime) / 1000;\n\t\tthis.lastTime = now;\n\n\t\tthis.balance += elapsedTime * this.opts.tracesPerSecond;\n\t\tif (this.balance > this.maxBalance)\n\t\t\tthis.balance = this.maxBalance;\n\n\t\tif (this.balance >= cost) {\n\t\t\tthis.balance -= cost;\n\t\t\treturn true;\n\t\t}\n\n\t\treturn false;\n\t}\n}\n\nmodule.exports = RateLimiter;\n"],"names":[],"mappings":";;AAUA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,MAAM,WAAW,CAAC;AAClB,CAAC,WAAW,CAAC,IAAI,EAAE;AACnB,EAAE,IAAI,CAAC,IAAI,GAAG,CAAC,CAAC,YAAY,CAAC,IAAI,EAAE;AACnC,GAAG,eAAe,EAAE,CAAC;AACrB,GAAG,CAAC,CAAC;AACL;AACA,EAAE,IAAI,CAAC,QAAQ,GAAG,IAAI,CAAC,GAAG,EAAE,CAAC;AAC7B,EAAE,IAAI,CAAC,OAAO,GAAG,CAAC,CAAC;AACnB,EAAE,IAAI,CAAC,UAAU,GAAG,IAAI,CAAC,IAAI,CAAC,eAAe,GAAG,CAAC,GAAG,CAAC,GAAG,IAAI,CAAC,IAAI,CAAC,eAAe,CAAC;AAClF,EAAE;AACF;AACA,CAAC,KAAK,CAAC,IAAI,GAAG,CAAC,EAAE;AACjB,EAAE,MAAM,GAAG,GAAG,IAAI,CAAC,GAAG,EAAE,CAAC;AACzB,EAAE,MAAM,WAAW,GAAG,CAAC,GAAG,GAAG,IAAI,CAAC,QAAQ,IAAI,IAAI,CAAC;AACnD,EAAE,IAAI,CAAC,QAAQ,GAAG,GAAG,CAAC;AACtB;AACA,EAAE,IAAI,CAAC,OAAO,IAAI,WAAW,GAAG,IAAI,CAAC,IAAI,CAAC,eAAe,CAAC;AAC1D,EAAE,IAAI,IAAI,CAAC,OAAO,GAAG,IAAI,CAAC,UAAU;AACpC,GAAG,IAAI,CAAC,OAAO,GAAG,IAAI,CAAC,UAAU,CAAC;AAClC;AACA,EAAE,IAAI,IAAI,CAAC,OAAO,IAAI,IAAI,EAAE;AAC5B,GAAG,IAAI,CAAC,OAAO,IAAI,IAAI,CAAC;AACxB,GAAG,OAAO,IAAI,CAAC;AACf,GAAG;AACH;AACA,EAAE,OAAO,KAAK,CAAC;AACf,EAAE;AACF,CAAC;AACD;eACc,GAAG;;;;"}
{"version":3,"file":"tracer.js","sources":["../../../../../src/moleculer/src/tracing/tracer.js"],"sourcesContent":["/*\n * moleculer\n * Copyright (c) 2020 MoleculerJS (https://github.com/moleculerjs/moleculer)\n * MIT Licensed\n */\n\n\"use strict\";\n\nconst _ = require(\"lodash\");\nconst Exporters = require(\"./exporters\");\n//const AsyncStorage = require(\"../async-storage\");\nconst RateLimiter = require(\"./rate-limiter\");\nconst Span = require(\"./span\");\nconst { isFunction } = require(\"../utils\");\n\n/**\n * Moleculer Tracer class\n */\nclass Tracer {\n\n\t/**\n\t * Creates an instance of Tracer.\n\t *\n\t * @param {ServiceBroker} broker\n\t * @param {Object} opts\n\t * @memberof Tracer\n\t */\n\tconstructor(broker, opts) {\n\t\tthis.broker = broker;\n\t\tthis.logger = broker.getLogger(\"tracer\");\n\n\t\tif (opts === true || opts === false)\n\t\t\topts = { enabled: opts };\n\n\t\tthis.opts = _.defaultsDeep({}, opts, {\n\t\t\tenabled: true,\n\n\t\t\texporter: null,\n\n\t\t\tsampling: {\n\t\t\t\t// Constants sampling\n\t\t\t\trate: 1.0, // 0.0 - Never, 1.0 > x > 0.0 - Fix, 1.0 - Always\n\n\t\t\t\t// Ratelimiting sampling https://opencensus.io/tracing/sampling/ratelimited/\n\t\t\t\ttracesPerSecond: null, // 1: 1 trace / sec, 5: 5 traces / sec, 0.1: 1 trace / 10 secs\n\n\t\t\t\tminPriority: null\n\t\t\t},\n\n\t\t\tactions: true,\n\t\t\tevents: false,\n\n\t\t\terrorFields: [\"name\", \"message\", \"code\", \"type\", \"data\"],\n\t\t\tstackTrace: false,\n\n\t\t\tdefaultTags: null,\n\n\t\t\ttags: {\n\t\t\t\taction: null,\n\t\t\t\tevent: null,\n\t\t\t}\n\t\t});\n\n\t\tif (this.opts.stackTrace && this.opts.errorFields.indexOf(\"stack\") === -1)\n\t\t\tthis.opts.errorFields.push(\"stack\");\n\n\t\tthis.sampleCounter = 0;\n\n\t\tif (this.opts.sampling.tracesPerSecond != null && this.opts.sampling.tracesPerSecond > 0) {\n\t\t\tthis.rateLimiter = new RateLimiter({\n\t\t\t\ttracesPerSecond: this.opts.sampling.tracesPerSecond\n\t\t\t});\n\t\t}\n\n\t\t//this.scope = new AsyncStorage(this.broker);\n\t\t//this.scope.enable();\n\t\t//this._scopeEnabled = true;\n\n\t\tif (this.opts.enabled)\n\t\t\tthis.logger.info(\"Tracing: Enabled\");\n\t}\n\n\t/**\n\t * Initialize Tracer.\n\t */\n\tinit() {\n\t\tif (this.opts.enabled) {\n\n\t\t\tthis.defaultTags = isFunction(this.opts.defaultTags) ? this.opts.defaultTags.call(this, this) : this.opts.defaultTags;\n\n\t\t\t// Create Exporter instances\n\t\t\tif (this.opts.exporter) {\n\t\t\t\tconst exporters = Array.isArray(this.opts.exporter) ? this.opts.exporter : [this.opts.exporter];\n\n\t\t\t\tthis.exporter = _.compact(exporters).map(r => {\n\t\t\t\t\tconst exporter = Exporters.resolve(r);\n\t\t\t\t\texporter.init(this);\n\t\t\t\t\treturn exporter;\n\t\t\t\t});\n\n\t\t\t\tconst exporterNames = this.exporter.map(exporter => this.broker.getConstructorName(exporter));\n\t\t\t\tthis.logger.info(`Tracing exporter${exporterNames.length > 1 ? \"s\": \"\"}: ${exporterNames.join(\", \")}`);\n\t\t\t}\n\n\t\t}\n\t}\n\n\t/**\n\t * Stop Tracer.\n\t */\n\tstop() {\n\t\tif (this.exporter) {\n\t\t\treturn this.broker.Promise.all(this.exporter.map(r => r.stop()));\n\t\t}\n\t\treturn this.broker.Promise.resolve();\n\t}\n\n\t/**\n\t * Check tracing is enabled\n\t *\n\t * @returns {boolean}\n\t * @memberof MetricRegistry\n\t */\n\tisEnabled() {\n\t\treturn this.opts.enabled;\n\t}\n\n\t/**\n\t * Disable trace hooks and clear the store - noop if scope is already stopped\n\t *\n\t * @memberof Tracer\n\t *\n\tstopAndClearScope() {\n\t\tif (this._scopeEnabled) {\n\t\t\tthis.scope.stop();\n\t\t\tthis._scopeEnabled = false;\n\t\t}\n\t}*/\n\n\t/**\n\t * Renable the trace hooks - noop if scope is already enabled\n\t *\n\t * @memberof Tracer\n\t *\n\trestartScope() {\n\t\tif (!this._scopeEnabled) {\n\t\t\tthis.scope.enable();\n\t\t\tthis._scopeEnabled = true;\n\t\t}\n\t}*/\n\n\t/**\n\t * Decide that span should be sampled.\n\t *\n\t * @param {Span} span\n\t * @returns {Boolean}\n\t * @memberof Tracer\n\t */\n\tshouldSample(span) {\n\t\tif (this.opts.sampling.minPriority != null) {\n\t\t\tif (span.priority < this.opts.sampling.minPriority)\n\t\t\t\treturn false;\n\t\t}\n\n\t\tif (this.rateLimiter) {\n\t\t\treturn this.rateLimiter.check();\n\t\t}\n\n\t\tif (this.opts.sampling.rate == 0)\n\t\t\treturn false;\n\n\t\tif (this.opts.sampling.rate == 1)\n\t\t\treturn true;\n\n\t\tif (++this.sampleCounter * this.opts.sampling.rate >= 1.0) {\n\t\t\tthis.sampleCounter = 0;\n\t\t\treturn true;\n\t\t}\n\n\t\treturn false;\n\t}\n\n\t/**\n\t * Start a new Span.\n\t *\n\t * @param {String} name\n\t * @param {Object?} opts\n\t * @returns {Span}\n\t *\n\t * @memberof Tracer\n\t */\n\tstartSpan(name, opts = {}) {\n\t\tlet parentOpts = {};\n\t\tif (opts.parentSpan) {\n\t\t\tparentOpts.traceID = opts.parentSpan.traceID;\n\t\t\tparentOpts.parentID = opts.parentSpan.id;\n\t\t\tparentOpts.sampled = opts.parentSpan.sampled;\n\t\t}\n\n\t\tconst span = new Span(this, name, Object.assign({\n\t\t\ttype: \"custom\",\n\t\t\tdefaultTags: this.defaultTags\n\t\t}, parentOpts, opts, { parentSpan: undefined }));\n\n\t\tspan.start();\n\n\t\treturn span;\n\t}\n\n\t/**\n\t * Invoke Exporter method.\n\t *\n\t * @param {String} method\n\t * @param {Array<any>} args\n\t * @memberof Tracer\n\t */\n\tinvokeExporter(method, args) {\n\t\tif (this.exporter) {\n\t\t\tthis.exporter.forEach(exporter => exporter[method].apply(exporter, args));\n\t\t}\n\t}\n\n\t/**\n\t * Set the active span\n\t *\n\t * @param {Span} span\n\t * @memberof Tracer\n\t *\n\tsetCurrentSpan(span) {\n\t\tconst state = this.scope.getSessionData() || {\n\t\t\tspans: []\n\t\t};\n\n\t\tstate.spans.push(span);\n\t\tthis.scope.setSessionData(state);\n\n\t\tspan.meta.state = state;\n\t}*/\n\n\t/**\n\t * Remove the active span (because async block destroyed)\n\t *\n\t * @param {Span} span\n\t * @memberof Tracer\n\t *\n\tremoveCurrentSpan(span) {\n\t\tconst state = span.meta.state || this.scope.getSessionData();\n\t\tif (state && state.spans.length > 0) {\n\t\t\tconst idx = state.spans.indexOf(span);\n\t\t\tif (idx >= 0)\n\t\t\t\tstate.spans.splice(idx, 1);\n\t\t}\n\t}*/\n\n\t/**\n\t * Get the current active span\n\t *\n\t * @returns {Span}\n\t * @memberof Tracer\n\t *\n\tgetCurrentSpan() {\n\t\tconst state = this.scope.getSessionData();\n\t\treturn state ? state.spans[state.spans.length - 1] : null;\n\t}*/\n\n\t/**\n\t * Get the current trace ID\n\t *\n\t * @returns\n\t * @memberof Tracer\n\t */\n\tgetCurrentTraceID() {\n\t\treturn null;\n\t\t//const span = this.getCurrentSpan();\n\t\t//return span ? span.traceID : null;\n\t}\n\n\t/**\n\t * Get the active span ID (for the next span as parent ID)\n\t *\n\t * @returns\n\t * @memberof Tracer\n\t */\n\tgetActiveSpanID() {\n\t\treturn null;\n\t\t//const span = this.getCurrentSpan();\n\t\t//return span ? span.id : null;\n\t}\n\n\t/**\n\t * Called when a span started. Call exporters.\n\t *\n\t * @param {Span} span\n\t * @memberof Tracer\n\t */\n\tspanStarted(span) {\n\t\t//this.setCurrentSpan(span);\n\n\t\tif (span.sampled)\n\t\t\tthis.invokeExporter(\"spanStarted\", [span]);\n\t}\n\n\t/**\n\t * Called when a span finished. Call exporters.\n\t *\n\t * @param {Span} span\n\t * @memberof Tracer\n\t */\n\tspanFinished(span) {\n\t\t//this.removeCurrentSpan(span);\n\n\t\tif (span.sampled)\n\t\t\tthis.invokeExporter(\"spanFinished\", [span]);\n\t}\n}\n\nmodule.exports = Tracer;\n"],"names":["require$$0","RateLimiter","exporters","Exporters","span","Span"],"mappings":"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G;AACH,EAAE;AACF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,CAAC,iBAAiB,GAAG;AACrB,EAAE,OAAO,IAAI,CAAC;AACd;AACA;AACA,EAAE;AACF;AACA;AACA;AACA;AACA;AACA;AACA;AACA,CAAC,eAAe,GAAG;AACnB,EAAE,OAAO,IAAI,CAAC;AACd;AACA;AACA,EAAE;AACF;AACA;AACA;AACA;AACA;AACA;AACA;AACA,CAAC,WAAW,CAAC,IAAI,EAAE;AACnB;AACA;AACA,EAAE,IAAI,IAAI,CAAC,OAAO;AAClB,GAAG,IAAI,CAAC,cAAc,CAAC,aAAa,EAAE,CAAC,IAAI,CAAC,CAAC,CAAC;AAC9C,EAAE;AACF;AACA;AACA;AACA;AACA;AACA;AACA;AACA,CAAC,YAAY,CAAC,IAAI,EAAE;AACpB;AACA;AACA,EAAE,IAAI,IAAI,CAAC,OAAO;AAClB,GAAG,IAAI,CAAC,cAAc,CAAC,cAAc,EAAE,CAAC,IAAI,CAAC,CAAC,CAAC;AAC/C,EAAE;AACF,CAAC;AACD;UACc,GAAG;;;;"}
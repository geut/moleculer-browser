{"version":3,"file":"span.js","sources":["../../../../../src/moleculer/src/tracing/span.js"],"sourcesContent":["\"use strict\";\n\nconst now = require(\"./now\");\n\nfunction defProp(instance, propName, value, readOnly = false) {\n\tObject.defineProperty(instance, propName, {\n\t\tvalue,\n\t\twritable: !!readOnly,\n\t\tenumerable: false\n\t});\n}\n\n/**\n * Trace Span class\n *\n * @class Span\n */\nclass Span {\n\n\t/**\n\t * Creates an instance of Span.\n\t * @param {Tracer} tracer\n\t * @param {String} name\n\t * @param {Object?} opts\n\t *\n\t * @memberof Span\n\t */\n\tconstructor(tracer, name, opts) {\n\t\tdefProp(this, \"tracer\", tracer, true);\n\t\tdefProp(this, \"logger\", this.tracer.logger, true);\n\t\tdefProp(this, \"opts\", opts || {});\n\t\tdefProp(this, \"meta\", {});\n\n\t\tthis.name = name;\n\t\tthis.type = this.opts.type || \"custom\";\n\t\tthis.id = this.opts.id || this.tracer.broker.generateUid();\n\t\tthis.traceID = this.opts.traceID || this.id;\n\t\tthis.parentID = this.opts.parentID;\n\n\t\tif (this.opts.service) {\n\t\t\tif (typeof this.opts.service == \"string\") {\n\t\t\t\tthis.service = {\n\t\t\t\t\tname: this.opts.service,\n\t\t\t\t\tfullName: this.opts.service,\n\t\t\t\t};\n\t\t\t} else {\n\t\t\t\tthis.service = {\n\t\t\t\t\tname: this.opts.service.name,\n\t\t\t\t\tversion: this.opts.service.version,\n\t\t\t\t\tfullName: this.opts.service.fullName,\n\t\t\t\t};\n\t\t\t}\n\t\t}\n\n\t\tthis.priority = this.opts.priority != null ? this.opts.priority : 5;\n\t\tthis.sampled = this.opts.sampled != null ? this.opts.sampled : this.tracer.shouldSample(this);\n\n\t\tthis.startTime = null;\n\t\tthis.finishTime = null;\n\t\tthis.duration = null;\n\n\t\tthis.error = null;\n\n\t\tthis.logs = [];\n\t\tthis.tags = {};\n\n\t\tif (this.opts.defaultTags)\n\t\t\tthis.addTags(this.opts.defaultTags);\n\n\t\tif (this.opts.tags)\n\t\t\tthis.addTags(this.opts.tags);\n\t}\n\n\t/**\n\t * Start span.\n\t *\n\t * @param {Number?} time\n\t * @returns {Span}\n\t * @memberof Span\n\t */\n\tstart(time) {\n\t\tthis.logger.debug(`[${this.id}] Span '${this.name}' is started.`);\n\n\t\tthis.startTime = time || now();\n\t\t// console.log(`\"${this.name}\" start time: ${this.startTime}`);\n\n\t\tthis.tracer.spanStarted(this);\n\n\t\treturn this;\n\t}\n\n\t/**\n\t * Add tags. It will be merged with previous tags.\n\t *\n\t * @param {Object} obj\n\t * @returns {Span}\n\t *\n\t * @memberof Span\n\t */\n\taddTags(obj) {\n\t\tObject.assign(this.tags, obj);\n\n\t\treturn this;\n\t}\n\n\t/**\n\t * Log a trace event.\n\t *\n\t * @param {String} name\n\t * @param {Object?} fields\n\t * @param {Number?} time\n\t * @returns {Span}\n\t * @memberof Span\n\t */\n\tlog(name, fields, time) {\n\t\ttime = time || now();\n\n\t\tthis.logs.push({\n\t\t\tname,\n\t\t\tfields: fields || {},\n\t\t\ttime,\n\t\t\telapsed: time - this.startTime\n\t\t});\n\n\t\tthis.logger.debug(`[${this.id}] Span '${this.name}' has a new log event: ${name}.`);\n\n\t\treturn this;\n\t}\n\n\t/**\n\t * Set error span.\n\t *\n\t * @param {Error} err\n\t * @memberof Span\n\t */\n\tsetError(err) {\n\t\tthis.error = err != null ? err : true;\n\n\t\treturn this;\n\t}\n\n\t/**\n\t * Finish span.\n\t *\n\t * @param {Number?} time\n\t * @returns {Span}\n\t * @memberof Span\n\t */\n\tfinish(time) {\n\t\tthis.finishTime = time ? time : now();\n\t\tthis.duration = this.finishTime - this.startTime;\n\n\t\t// console.log(`\"${this.name}\" stop time: ${this.finishTime}  Duration: ${this.duration}`);\n\n\t\tthis.logger.debug(`[${this.id}] Span '${this.name}' is finished. Duration: ${Number(this.duration).toFixed(3)} ms`, this.tags);\n\n\t\tthis.tracer.spanFinished(this);\n\n\t\treturn this;\n\t}\n\n\t/**\n\t * Check the span is active or finished.\n\t *\n\t * @returns {boolean}\n\t */\n\tisActive() {\n\t\treturn this.finishTime == null;\n\t}\n\n\t/**\n\t * Start a child span.\n\t *\n\t * @param {String} name\n\t * @param {Object?} opts\n\t * @returns {Span} Child span\n\t * @memberof Span\n\t */\n\tstartSpan(name, opts) {\n\t\tconst r = {\n\t\t\ttraceID: this.traceID,\n\t\t\tparentID: this.id,\n\t\t\tsampled: this.sampled,\n\t\t\tservice: this.service\n\t\t};\n\t\treturn this.tracer.startSpan(name, opts ? Object.assign(r, opts) : r);\n\t}\n\n}\n\nmodule.exports = Span;\n"],"names":["now"],"mappings":"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"}
{"version":3,"file":"span.js","sources":["../../../../../src/moleculer/src/tracing/span.js"],"sourcesContent":["\"use strict\";\n\nconst now = require(\"./now\");\n\nfunction defProp(instance, propName, value, readOnly = false) {\n\tObject.defineProperty(instance, propName, {\n\t\tvalue,\n\t\twritable: !!readOnly,\n\t\tenumerable: false\n\t});\n}\n\n/**\n * Trace Span class\n *\n * @class Span\n */\nclass Span {\n\n\t/**\n\t * Creates an instance of Span.\n\t * @param {Tracer} tracer\n\t * @param {String} name\n\t * @param {Object?} opts\n\t *\n\t * @memberof Span\n\t */\n\tconstructor(tracer, name, opts) {\n\t\tdefProp(this, \"tracer\", tracer, true);\n\t\tdefProp(this, \"logger\", this.tracer.logger, true);\n\t\tdefProp(this, \"opts\", opts || {});\n\t\tdefProp(this, \"meta\", {});\n\n\t\tthis.name = name;\n\t\tthis.type = this.opts.type || \"custom\";\n\t\tthis.id = this.opts.id || this.tracer.broker.generateUid();\n\t\tthis.traceID = this.opts.traceID || this.id;\n\t\tthis.parentID = this.opts.parentID;\n\n\t\tif (this.opts.service) {\n\t\t\tif (typeof this.opts.service == \"string\") {\n\t\t\t\tthis.service = {\n\t\t\t\t\tname: this.opts.service,\n\t\t\t\t\tfullName: this.opts.service,\n\t\t\t\t};\n\t\t\t} else {\n\t\t\t\tthis.service = {\n\t\t\t\t\tname: this.opts.service.name,\n\t\t\t\t\tversion: this.opts.service.version,\n\t\t\t\t\tfullName: this.opts.service.fullName,\n\t\t\t\t};\n\t\t\t}\n\t\t}\n\n\t\tthis.priority = this.opts.priority != null ? this.opts.priority : 5;\n\t\tthis.sampled = this.opts.sampled != null ? this.opts.sampled : this.tracer.shouldSample(this);\n\n\t\tthis.startTime = null;\n\t\tthis.finishTime = null;\n\t\tthis.duration = null;\n\n\t\tthis.error = null;\n\n\t\tthis.logs = [];\n\t\tthis.tags = {};\n\n\t\tif (this.opts.defaultTags)\n\t\t\tthis.addTags(this.opts.defaultTags);\n\n\t\tif (this.opts.tags)\n\t\t\tthis.addTags(this.opts.tags);\n\t}\n\n\t/**\n\t * Start span.\n\t *\n\t * @param {Number?} time\n\t * @returns {Span}\n\t * @memberof Span\n\t */\n\tstart(time) {\n\t\tthis.logger.debug(`[${this.id}] Span '${this.name}' is started.`);\n\n\t\tthis.startTime = time || now();\n\t\t// console.log(`\"${this.name}\" start time: ${this.startTime}`);\n\n\t\tthis.tracer.spanStarted(this);\n\n\t\treturn this;\n\t}\n\n\t/**\n\t * Add tags. It will be merged with previous tags.\n\t *\n\t * @param {Object} obj\n\t * @returns {Span}\n\t *\n\t * @memberof Span\n\t */\n\taddTags(obj) {\n\t\tObject.assign(this.tags, obj);\n\n\t\treturn this;\n\t}\n\n\t/**\n\t * Log a trace event.\n\t *\n\t * @param {String} name\n\t * @param {Object?} fields\n\t * @param {Number?} time\n\t * @returns {Span}\n\t * @memberof Span\n\t */\n\tlog(name, fields, time) {\n\t\ttime = time || now();\n\n\t\tthis.logs.push({\n\t\t\tname,\n\t\t\tfields: fields || {},\n\t\t\ttime,\n\t\t\telapsed: time - this.startTime\n\t\t});\n\n\t\tthis.logger.debug(`[${this.id}] Span '${this.name}' has a new log event: ${name}.`);\n\n\t\treturn this;\n\t}\n\n\t/**\n\t * Set error span.\n\t *\n\t * @param {Error} err\n\t * @memberof Span\n\t */\n\tsetError(err) {\n\t\tthis.error = err != null ? err : true;\n\n\t\treturn this;\n\t}\n\n\t/**\n\t * Finish span.\n\t *\n\t * @param {Number?} time\n\t * @returns {Span}\n\t * @memberof Span\n\t */\n\tfinish(time) {\n\t\tthis.finishTime = time ? time : now();\n\t\tthis.duration = this.finishTime - this.startTime;\n\n\t\t// console.log(`\"${this.name}\" stop time: ${this.finishTime}  Duration: ${this.duration}`);\n\n\t\tthis.logger.debug(`[${this.id}] Span '${this.name}' is finished. Duration: ${Number(this.duration).toFixed(3)} ms`, this.tags);\n\n\t\tthis.tracer.spanFinished(this);\n\n\t\treturn this;\n\t}\n\n\t/**\n\t * Check the span is active or finished.\n\t *\n\t * @returns {boolean}\n\t */\n\tisActive() {\n\t\treturn this.finishTime == null;\n\t}\n\n\t/**\n\t * Start a child span.\n\t *\n\t * @param {String} name\n\t * @param {Object?} opts\n\t * @returns {Span} Child span\n\t * @memberof Span\n\t */\n\tstartSpan(name, opts) {\n\t\tconst r = {\n\t\t\ttraceID: this.traceID,\n\t\t\tparentID: this.id,\n\t\t\tsampled: this.sampled,\n\t\t\tservice: this.service\n\t\t};\n\t\treturn this.tracer.startSpan(name, opts ? Object.assign(r, opts) : r);\n\t}\n\n}\n\nmodule.exports = Span;\n"],"names":["defProp","instance","propName","value","readOnly","Object","defineProperty","writable","enumerable","[object Object]","tracer","name","opts","this","logger","type","id","broker","generateUid","traceID","parentID","service","fullName","version","priority","sampled","shouldSample","startTime","finishTime","duration","error","logs","tags","defaultTags","addTags","time","debug","now","spanStarted","obj","assign","fields","push","elapsed","err","Number","toFixed","spanFinished","r","startSpan"],"mappings":"wBAIA,SAASA,EAAQC,EAAUC,EAAUC,EAAOC,GAAW,GACtDC,OAAOC,eAAeL,EAAUC,EAAU,CACzCC,MAAAA,EACAI,WAAYH,EACZI,YAAY,UASd,MAUCC,YAAYC,EAAQC,EAAMC,GACzBZ,EAAQa,KAAM,SAAUH,GAAQ,GAChCV,EAAQa,KAAM,SAAUA,KAAKH,OAAOI,QAAQ,GAC5Cd,EAAQa,KAAM,OAAQD,GAAQ,IAC9BZ,EAAQa,KAAM,OAAQ,IAEtBA,KAAKF,KAAOA,EACZE,KAAKE,KAAOF,KAAKD,KAAKG,MAAQ,SAC9BF,KAAKG,GAAKH,KAAKD,KAAKI,IAAMH,KAAKH,OAAOO,OAAOC,cAC7CL,KAAKM,QAAUN,KAAKD,KAAKO,SAAWN,KAAKG,GACzCH,KAAKO,SAAWP,KAAKD,KAAKQ,SAEtBP,KAAKD,KAAKS,UACmB,iBAArBR,KAAKD,KAAKS,QACpBR,KAAKQ,QAAU,CACdV,KAAME,KAAKD,KAAKS,QAChBC,SAAUT,KAAKD,KAAKS,SAGrBR,KAAKQ,QAAU,CACdV,KAAME,KAAKD,KAAKS,QAAQV,KACxBY,QAASV,KAAKD,KAAKS,QAAQE,QAC3BD,SAAUT,KAAKD,KAAKS,QAAQC,WAK/BT,KAAKW,SAAiC,MAAtBX,KAAKD,KAAKY,SAAmBX,KAAKD,KAAKY,SAAW,EAClEX,KAAKY,QAA+B,MAArBZ,KAAKD,KAAKa,QAAkBZ,KAAKD,KAAKa,QAAUZ,KAAKH,OAAOgB,aAAab,MAExFA,KAAKc,UAAY,KACjBd,KAAKe,WAAa,KAClBf,KAAKgB,SAAW,KAEhBhB,KAAKiB,MAAQ,KAEbjB,KAAKkB,KAAO,GACZlB,KAAKmB,KAAO,GAERnB,KAAKD,KAAKqB,aACbpB,KAAKqB,QAAQrB,KAAKD,KAAKqB,aAEpBpB,KAAKD,KAAKoB,MACbnB,KAAKqB,QAAQrB,KAAKD,KAAKoB,MAUzBvB,MAAM0B,GAQL,OAPAtB,KAAKC,OAAOsB,MAAM,IAAIvB,KAAKG,aAAaH,KAAKF,qBAE7CE,KAAKc,UAAYQ,GAAQE,IAGzBxB,KAAKH,OAAO4B,YAAYzB,MAEjBA,KAWRJ,QAAQ8B,GAGP,OAFAlC,OAAOmC,OAAO3B,KAAKmB,KAAMO,GAElB1B,KAYRJ,IAAIE,EAAM8B,EAAQN,GAYjB,OAXAA,EAAOA,GAAQE,IAEfxB,KAAKkB,KAAKW,KAAK,CACd/B,KAAAA,EACA8B,OAAQA,GAAU,GAClBN,KAAAA,EACAQ,QAASR,EAAOtB,KAAKc,YAGtBd,KAAKC,OAAOsB,MAAM,IAAIvB,KAAKG,aAAaH,KAAKF,8BAA8BA,MAEpEE,KASRJ,SAASmC,GAGR,OAFA/B,KAAKiB,MAAe,MAAPc,GAAcA,EAEpB/B,KAURJ,OAAO0B,GAUN,OATAtB,KAAKe,WAAaO,GAAcE,IAChCxB,KAAKgB,SAAWhB,KAAKe,WAAaf,KAAKc,UAIvCd,KAAKC,OAAOsB,MAAM,IAAIvB,KAAKG,aAAaH,KAAKF,gCAAgCkC,OAAOhC,KAAKgB,UAAUiB,QAAQ,QAASjC,KAAKmB,MAEzHnB,KAAKH,OAAOqC,aAAalC,MAElBA,KAQRJ,WACC,OAA0B,MAAnBI,KAAKe,WAWbnB,UAAUE,EAAMC,GACf,MAAMoC,EAAI,CACT7B,QAASN,KAAKM,QACdC,SAAUP,KAAKG,GACfS,QAASZ,KAAKY,QACdJ,QAASR,KAAKQ,SAEf,OAAOR,KAAKH,OAAOuC,UAAUtC,EAAMC,EAAOP,OAAOmC,OAAOQ,EAAGpC,GAAQoC"}
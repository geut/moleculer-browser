{"version":3,"file":"formatted.js","sources":["../../../../../src/moleculer/src/loggers/formatted.js"],"sourcesContent":["/*\n * moleculer\n * Copyright (c) 2019 MoleculerJS (https://github.com/moleculerjs/moleculer)\n * MIT Licensed\n */\n\n/* eslint-disable no-console */\n\n\"use strict\";\n\nconst BaseLogger \t= require(\"./base\");\nconst _ \t\t\t= require(\"lodash\");\nconst kleur \t\t= require(\"kleur\");\nconst util \t\t\t= require(\"util\");\nconst { isObject, isFunction }\t= require(\"../utils\");\n\n\nfunction getColor(type) {\n\tswitch(type) {\n\t\tcase \"fatal\": return kleur.red().inverse;\n\t\tcase \"error\": return kleur.red;\n\t\tcase \"warn\": return kleur.yellow;\n\t\tcase \"debug\": return kleur.magenta;\n\t\tcase \"trace\": return kleur.gray;\n\t\tdefault: return kleur.green;\n\t}\n}\n\n/**\n * Formatted abstract logger for Moleculer\n *\n * @class FormattedLogger\n * @extends {BaseLogger}\n */\nclass FormattedLogger extends BaseLogger {\n\n\t/**\n\t * Creates an instance of FormattedLogger.\n\t * @param {Object} opts\n\t * @memberof FormattedLogger\n\t */\n\tconstructor(opts) {\n\t\tsuper(opts);\n\n\t\tthis.opts = _.defaultsDeep(this.opts, {\n\t\t\tcolors: true,\n\t\t\tmoduleColors: false,\n\t\t\tformatter: \"full\",\n\t\t\tobjectPrinter: null,\n\t\t\tautoPadding: false\n\t\t});\n\n\t\tthis.maxPrefixLength = 0;\n\t}\n\n\tinit(loggerFactory) {\n\t\tsuper.init(loggerFactory);\n\n\t\tif (!this.opts.colors)\n\t\t\tkleur.enabled = false;\n\n\t\tthis.objectPrinter = this.opts.objectPrinter ? this.opts.objectPrinter : o => util.inspect(o, { showHidden: false, depth: 2, colors: kleur.enabled, breakLength: Number.POSITIVE_INFINITY });\n\n\t\t// Generate colorful log level names\n\t\tthis.levelColorStr = BaseLogger.LEVELS.reduce((a, level) => {\n\t\t\ta[level] = getColor(level)(_.padEnd(level.toUpperCase(), 5));\n\t\t\treturn a;\n\t\t}, {});\n\n\t\tif (this.opts.colors && this.opts.moduleColors === true) {\n\t\t\tthis.opts.moduleColors = [\n\t\t\t\t\"yellow\", \"bold.yellow\",\n\t\t\t\t\"cyan\", \"bold.cyan\",\n\t\t\t\t\"green\", \"bold.green\",\n\t\t\t\t\"magenta\", \"bold.magenta\",\n\t\t\t\t\"blue\", \"bold.blue\",\n\t\t\t\t/*\"red\",*/\n\t\t\t\t/*\"grey\",*/\n\t\t\t\t/*\"white,\"*/\n\t\t\t];\n\t\t}\n\t}\n\n\t/**\n\t * Get a color for the module name.\n\t */\n\tgetNextColor(mod) {\n\t\tif (this.opts.colors && Array.isArray(this.opts.moduleColors)) {\n\t\t\t// Credits: \"visionmedia/debug\" https://github.com/visionmedia/debug/blob/master/src/common.js#L45\n\t\t\tlet hash = 0;\n\n\t\t\tfor (let i = 0; i < mod.length; i++) {\n\t\t\t\thash = ((hash << 5) - hash) + mod.charCodeAt(i);\n\t\t\t\thash |= 0; // Convert to 32bit integer\n\t\t\t}\n\n\t\t\treturn this.opts.moduleColors[Math.abs(hash) % this.opts.moduleColors.length];\n\t\t}\n\n\t\treturn \"grey\";\n\t}\n\n\tpadLeft(len) {\n\t\tif (this.opts.autoPadding)\n\t\t\treturn \" \".repeat(this.maxPrefixLength - len);\n\n\t\treturn \"\";\n\t}\n\n\t/**\n\t *\n\t * @param {object} bindings\n\t */\n\tgetFormatter(bindings) {\n\t\tconst formatter = this.opts.formatter;\n\n\t\tconst mod = (bindings && bindings.mod) ? bindings.mod.toUpperCase() : \"\";\n\t\tconst c = this.getNextColor(mod);\n\t\tconst modColorName = c.split(\".\").reduce((a,b) => a[b] || a()[b], kleur)(mod);\n\t\tconst moduleColorName = bindings ? kleur.grey(bindings.nodeID + \"/\") + modColorName : \"\";\n\n\t\tconst printArgs = args => {\n\t\t\treturn args.map(p => {\n\t\t\t\tif (isObject(p) || Array.isArray(p))\n\t\t\t\t\treturn this.objectPrinter(p);\n\t\t\t\treturn p;\n\t\t\t});\n\t\t};\n\n\t\tif (isFunction(formatter)) {\n\t\t\treturn (type, args) => formatter.call(this, type, args, bindings, { printArgs });\n\n\t\t} else if (formatter == \"json\") {\n\t\t\t// {\"ts\":1581243299731,\"level\":\"info\",\"msg\":\"Moleculer v0.14.0-rc2 is starting...\",\"nodeID\":\"console\",\"ns\":\"\",\"mod\":\"broker\"}\n\t\t\tkleur.enabled = false;\n\t\t\treturn (type, args) => [JSON.stringify({ ts: Date.now(), level: type, msg: printArgs(args).join(\" \"), ...bindings })];\n\t\t} else if (formatter == \"jsonext\") {\n\t\t\t// {\"time\":\"2020-02-09T10:44:35.285Z\",\"level\":\"info\",\"message\":\"Moleculer v0.14.0-rc2 is starting...\",\"nodeID\":\"console\",\"ns\":\"\",\"mod\":\"broker\"}\n\t\t\tkleur.enabled = false;\n\t\t\treturn (type, args) => {\n\t\t\t\tconst res = {\n\t\t\t\t\ttime: new Date().toISOString(),\n\t\t\t\t\tlevel: type,\n\t\t\t\t\tmessage: \"\",\n\t\t\t\t\t...bindings\n\t\t\t\t};\n\t\t\t\tif (args.length > 0) {\n\t\t\t\t\tif (typeof(args[0]) == \"object\"/* && !(args[0] instanceof Error)*/) {\n\t\t\t\t\t\tObject.assign(res, args[0]);\n\t\t\t\t\t\tres.message = printArgs(args.slice(1)).join(\" \");\n\t\t\t\t\t} else {\n\t\t\t\t\t\tres.message = printArgs(args).join(\" \");\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\treturn [JSON.stringify(res)];\n\t\t\t};\n\t\t} else if (formatter == \"simple\") {\n\t\t\t// INFO  - Moleculer v0.14.0-beta3 is starting...\n\t\t\treturn (type, args) => [this.levelColorStr[type], \"-\", ...printArgs(args)];\n\t\t} else if (formatter == \"short\") {\n\t\t\t// [08:42:12.973Z] INFO  BROKER: Moleculer v0.14.0-beta3 is starting...\n\t\t\tconst prefixLen = 23 + bindings.mod.length;\n\t\t\tthis.maxPrefixLength = Math.max(prefixLen, this.maxPrefixLength);\n\t\t\treturn (type, args) => [kleur.grey(`[${new Date().toISOString().substr(11)}]`), this.levelColorStr[type], modColorName + this.padLeft(prefixLen) + kleur.grey(\":\"), ...printArgs(args)];\n\t\t} else if (formatter == \"full\") {\n\t\t\t// [2019-08-31T08:40:53.481Z] INFO  bobcsi-pc-7100/BROKER: Moleculer v0.14.0-beta3 is starting...\n\t\t\tconst prefixLen = 35 + bindings.nodeID.length + bindings.mod.length;\n\t\t\tthis.maxPrefixLength = Math.max(prefixLen, this.maxPrefixLength);\n\t\t\treturn (type, args) => [kleur.grey(`[${new Date().toISOString()}]`), this.levelColorStr[type], moduleColorName + this.padLeft(prefixLen) + kleur.grey(\":\"), ...printArgs(args)];\n\t\t} else {\n\t\t\t// [{timestamp}] {level} {nodeID}/{mod}: {msg}\n\n\t\t\treturn (type, args) => {\n\t\t\t\tconst timestamp = new Date().toISOString();\n\t\t\t\treturn [this.render(formatter, {\n\t\t\t\t\ttimestamp: kleur.grey(timestamp),\n\t\t\t\t\ttime: kleur.grey(timestamp.substr(11)),\n\n\t\t\t\t\tlevel: this.levelColorStr[type],\n\t\t\t\t\tnodeID: kleur.grey(bindings.nodeID),\n\t\t\t\t\tmod: modColorName,\n\t\t\t\t\tmsg: printArgs(args).join(\" \")\n\t\t\t\t})];\n\t\t\t};\n\t\t}\n\t}\n\n\t/**\n\t * Interpolate a text.\n\t *\n\t * @param {Strimg} str\n\t * @param {Object} obj\n\t * @returns {String}\n\t */\n\trender(str, obj) {\n\t\treturn str.replace(/\\{\\s?(\\w+)\\s?\\}/g, (match, v) => obj[v] || \"\");\n\t}\n\n}\n\nmodule.exports = FormattedLogger;\n"],"names":["isObject","isFunction","require$$0","BaseLogger","[object Object]","opts","super","this","_","defaultsDeep","colors","moduleColors","formatter","objectPrinter","autoPadding","maxPrefixLength","loggerFactory","init","kleur","enabled","o","util","inspect","showHidden","depth","breakLength","Number","POSITIVE_INFINITY","levelColorStr","LEVELS","reduce","a","level","type","red","inverse","yellow","magenta","gray","green","getColor","padEnd","toUpperCase","mod","Array","isArray","hash","i","length","charCodeAt","Math","abs","len","repeat","bindings","modColorName","getNextColor","split","b","c","moduleColorName","grey","nodeID","printArgs","args","map","p","call","JSON","stringify","ts","Date","now","msg","join","res","time","toISOString","message","Object","assign","slice","prefixLen","max","substr","padLeft","timestamp","render","str","obj","replace","match","v"],"mappings":"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"}
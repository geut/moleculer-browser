{"version":3,"file":"base.js","sources":["../../../../../src/moleculer/src/serializers/base.js"],"sourcesContent":["/*\n * moleculer\n * Copyright (c) 2018 MoleculerJS (https://github.com/moleculerjs/moleculer)\n * MIT Licensed\n */\n\n\"use strict\";\n\nconst P = require(\"../packets\");\n\n/**\n * Abstract serializer class\n *\n * @class Serializer\n */\nclass Serializer {\n\n\t/**\n\t * Creates an instance of Serializer.\n\t *\n\t * @memberof Serializer\n\t */\n\tconstructor() {\n\t}\n\n\t/**\n\t * Initialize Serializer\n\t *\n\t * @param {any} broker\n\t *\n\t * @memberof Serializer\n\t */\n\tinit(broker) {\n\t\tthis.broker = broker;\n\t\t/*if (this.broker) {\n\t\t\tthis.logger = broker.getLogger(\"serializer\");\n\t\t}*/\n\t}\n\n\t/**\n\t * Serializer a JS object to Buffer\n\t *\n\t * @param {Object} obj\n\t * @param {String} type of packet\n\t * @returns {Buffer}\n\t *\n\t * @memberof Serializer\n\t */\n\tserialize(/*obj, type*/) {\n\t\t/* istanbul ignore next */\n\t\tthrow new Error(\"Not implemented method!\");\n\t}\n\n\t/**\n\t * Deserialize Buffer to JS object\n\t *\n\t * @param {Buffer} buf\n\t * @param {String} type of packet\n\t * @returns {Object}\n\t *\n\t * @memberof Serializer\n\t */\n\tdeserialize(/*buf, type*/) {\n\t\t/* istanbul ignore next */\n\t\tthrow new Error(\"Not implemented method!\");\n\t}\n\n\t/**\n\t * Serialize custom fields (stringify)\n\t *\n\t * @param {String} type\n\t * @param {Packet} obj\n\t * @returns {Packet}\n\t * @memberof Serializer\n\t */\n\tserializeCustomFields(type, obj) {\n\t\tswitch (type) {\n\t\t\tcase P.PACKET_INFO: {\n\t\t\t\tobj.services = JSON.stringify(obj.services);\n\t\t\t\tif (obj.config)\n\t\t\t\t\tobj.config = JSON.stringify(obj.config);\n\t\t\t\tif (obj.metadata)\n\t\t\t\t\tobj.metadata = JSON.stringify(obj.metadata);\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tcase P.PACKET_EVENT: {\n\t\t\t\tthis.convertDataToTransport(obj, \"data\", \"dataType\");\n\t\t\t\tobj.meta = JSON.stringify(obj.meta);\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tcase P.PACKET_REQUEST: {\n\t\t\t\tthis.convertDataToTransport(obj, \"params\", \"paramsType\");\n\t\t\t\tobj.meta = JSON.stringify(obj.meta);\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tcase P.PACKET_RESPONSE: {\n\t\t\t\tthis.convertDataToTransport(obj, \"data\", \"dataType\");\n\t\t\t\tobj.meta = JSON.stringify(obj.meta);\n\t\t\t\tif (obj.error)\n\t\t\t\t\tobj.error = JSON.stringify(obj.error);\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tcase P.PACKET_GOSSIP_REQ: {\n\t\t\t\tif (obj.online)\n\t\t\t\t\tobj.online = JSON.stringify(obj.online);\n\t\t\t\tif (obj.offline)\n\t\t\t\t\tobj.offline = JSON.stringify(obj.offline);\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tcase P.PACKET_GOSSIP_RES: {\n\t\t\t\tif (obj.online)\n\t\t\t\t\tobj.online = JSON.stringify(obj.online);\n\t\t\t\tif (obj.offline)\n\t\t\t\t\tobj.offline = JSON.stringify(obj.offline);\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\n\t\treturn obj;\n\t}\n\n\t/**\n\t * Deserialize custom fields\n\t *\n\t * @param {String} type\n\t * @param {Packet} obj\n\t * @returns {Packet}\n\t * @memberof Serializer\n\t */\n\tdeserializeCustomFields(type, obj) {\n\t\tswitch (type) {\n\t\t\tcase P.PACKET_INFO: {\n\t\t\t\tobj.services = JSON.parse(obj.services);\n\t\t\t\tif (obj.config)\n\t\t\t\t\tobj.config = JSON.parse(obj.config);\n\t\t\t\tif (obj.metadata)\n\t\t\t\t\tobj.metadata = JSON.parse(obj.metadata);\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tcase P.PACKET_EVENT: {\n\t\t\t\tthis.convertDataFromTransport(obj, \"data\", \"dataType\");\n\t\t\t\tobj.meta = JSON.parse(obj.meta);\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tcase P.PACKET_REQUEST: {\n\t\t\t\tthis.convertDataFromTransport(obj, \"params\", \"paramsType\");\n\t\t\t\tobj.meta = JSON.parse(obj.meta);\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tcase P.PACKET_RESPONSE: {\n\t\t\t\tthis.convertDataFromTransport(obj, \"data\", \"dataType\");\n\t\t\t\tobj.meta = JSON.parse(obj.meta);\n\t\t\t\tif (obj.error)\n\t\t\t\t\tobj.error = JSON.parse(obj.error);\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tcase P.PACKET_GOSSIP_REQ: {\n\t\t\t\tif (obj.online)\n\t\t\t\t\tobj.online = JSON.parse(obj.online);\n\t\t\t\tif (obj.offline)\n\t\t\t\t\tobj.offline = JSON.parse(obj.offline);\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tcase P.PACKET_GOSSIP_RES: {\n\t\t\t\tif (obj.online)\n\t\t\t\t\tobj.online = JSON.parse(obj.online);\n\t\t\t\tif (obj.offline)\n\t\t\t\t\tobj.offline = JSON.parse(obj.offline);\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\n\t\treturn obj;\n\t}\n\n\tconvertDataToTransport(obj, field, fieldType) {\n\t\tif (obj[field] === undefined) {\n\t\t\tobj[fieldType] = P.DATATYPE_UNDEFINED;\n\t\t} else if (obj[field] === null) {\n\t\t\tobj[fieldType] = P.DATATYPE_NULL;\n\t\t} else if (Buffer.isBuffer(obj[field])) {\n\t\t\tobj[fieldType] = P.DATATYPE_BUFFER;\n\t\t} else {\n\t\t\t// JSON\n\t\t\tobj[fieldType] = P.DATATYPE_JSON;\n\t\t\tobj[field] = Buffer.from(JSON.stringify(obj[field]));\n\t\t}\n\t}\n\n\tconvertDataFromTransport(obj, field, fieldType) {\n\t\tconst type = obj[fieldType];\n\t\tswitch(type) {\n\t\t\tcase P.DATATYPE_UNDEFINED: {\n\t\t\t\tobj[field] = undefined;\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tcase P.DATATYPE_NULL: {\n\t\t\t\tobj[field] = null;\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tcase P.DATATYPE_BUFFER: {\n\t\t\t\tif (!Buffer.isBuffer(obj[field]))\n\t\t\t\t\tobj[field] = Buffer.from(obj[field]);\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tdefault: {\n\t\t\t\t// JSON\n\t\t\t\tobj[field] = JSON.parse(obj[field]);\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\n\t\tdelete obj[fieldType];\n\t}\n}\n\nmodule.exports = Serializer;\n"],"names":["P"],"mappings":"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"}
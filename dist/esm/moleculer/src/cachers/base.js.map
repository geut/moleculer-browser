{"version":3,"file":"base.js","sources":["../../../../../src/moleculer/src/cachers/base.js"],"sourcesContent":["/*\n * moleculer\n * Copyright (c) 2019 MoleculerJS (https://github.com/moleculerjs/moleculer)\n * MIT Licensed\n */\n\n\"use strict\";\n\nconst _ \t\t\t= require(\"lodash\");\nconst crypto\t\t= require(\"crypto\");\nconst { METRIC }\t= require(\"../metrics\");\nconst { isObject, isFunction }\t= require(\"../utils\");\n\n/**\n * Abstract cacher class\n *\n * @class Cacher\n */\nclass Cacher {\n\n\t/**\n\t * Creates an instance of Cacher.\n\t *\n\t * @param {object} opts\n\t *\n\t * @memberof Cacher\n\t */\n\tconstructor(opts) {\n\t\tthis.opts = _.defaultsDeep(opts, {\n\t\t\tttl: null,\n\t\t\tkeygen: null,\n\t\t\tmaxParamsLength: null\n\t\t});\n\t}\n\n\t/**\n\t * Initialize cacher\n\t *\n\t * @param {any} broker\n\t *\n\t * @memberof Cacher\n\t */\n\tinit(broker) {\n\t\tthis.broker = broker;\n\t\tthis.metrics = broker.metrics;\n\n\t\tif (this.broker) {\n\t\t\tthis.logger = broker.getLogger(\"cacher\");\n\n\t\t\tif (this.opts.prefix) {\n\t\t\t\tthis.prefix = this.opts.prefix + \"-\";\n\t\t\t} else {\n\t\t\t\tthis.prefix = \"MOL-\";\n\t\t\t\tif (this.broker.namespace)\n\t\t\t\t\tthis.prefix += this.broker.namespace + \"-\";\n\t\t\t}\n\n\t\t\tthis.registerMoleculerMetrics();\n\t\t}\n\t}\n\n\t/**\n\t * Register Moleculer Transit Core metrics.\n\t */\n\tregisterMoleculerMetrics() {\n\t\tthis.metrics.register({ name: METRIC.MOLECULER_CACHER_GET_TOTAL, type: METRIC.TYPE_COUNTER, rate: true });\n\t\tthis.metrics.register({ name: METRIC.MOLECULER_CACHER_GET_TIME, type: METRIC.TYPE_HISTOGRAM, quantiles: true, unit: METRIC.UNIT_MILLISECONDS });\n\n\t\tthis.metrics.register({ name: METRIC.MOLECULER_CACHER_FOUND_TOTAL, type: METRIC.TYPE_COUNTER, rate: true });\n\n\t\tthis.metrics.register({ name: METRIC.MOLECULER_CACHER_SET_TOTAL, type: METRIC.TYPE_COUNTER, rate: true });\n\t\tthis.metrics.register({ name: METRIC.MOLECULER_CACHER_SET_TIME, type: METRIC.TYPE_HISTOGRAM, quantiles: true, unit: METRIC.UNIT_MILLISECONDS });\n\n\t\tthis.metrics.register({ name: METRIC.MOLECULER_CACHER_DEL_TOTAL, type: METRIC.TYPE_COUNTER, rate: true });\n\t\tthis.metrics.register({ name: METRIC.MOLECULER_CACHER_DEL_TIME, type: METRIC.TYPE_HISTOGRAM, quantiles: true, unit: METRIC.UNIT_MILLISECONDS });\n\n\t\tthis.metrics.register({ name: METRIC.MOLECULER_CACHER_CLEAN_TOTAL, type: METRIC.TYPE_COUNTER, rate: true });\n\t\tthis.metrics.register({ name: METRIC.MOLECULER_CACHER_CLEAN_TIME, type: METRIC.TYPE_HISTOGRAM, quantiles: true, unit: METRIC.UNIT_MILLISECONDS });\n\n\t\tthis.metrics.register({ name: METRIC.MOLECULER_CACHER_EXPIRED_TOTAL, type: METRIC.TYPE_COUNTER, rate: true });\n\t}\n\n\t/**\n\t * Close cacher\n\t *\n\t * @memberof Cacher\n\t */\n\tclose() {\n\t\t/* istanbul ignore next */\n\t\treturn Promise.resolve();\n\t}\n\n\t/**\n\t * Get a cached content by key\n\t *\n\t * @param {any} key\n\t *\n\t * @memberof Cacher\n\t */\n\tget(/*key*/) {\n\t\t/* istanbul ignore next */\n\t\tthrow new Error(\"Not implemented method!\");\n\t}\n\n\t/**\n\t * Get a cached content and ttl by key\n\t *\n\t * @param {any} key\n\t *\n\t * @memberof Cacher\n\t */\n\tgetWithTTL(/*key*/) {\n\t\t/* istanbul ignore next */\n\t\tthrow new Error(\"Not implemented method!\");\n\t}\n\n\t/**\n\t * Set a content by key to cache\n\t *\n\t * @param {any} key\n\t * @param {any} data\n\t * @param {Number?} ttl\n\t *\n\t * @memberof Cacher\n\t */\n\tset(/*key, data, ttl*/) {\n\t\t/* istanbul ignore next */\n\t\tthrow new Error(\"Not implemented method!\");\n\t}\n\n\t/**\n\t * Delete a content by key from cache\n\t *\n\t * @param {string|Array<string>} key\n\t *\n\t * @memberof Cacher\n\t */\n\tdel(/*key*/) {\n\t\t/* istanbul ignore next */\n\t\tthrow new Error(\"Not implemented method!\");\n\t}\n\n\n\t/**\n\t * Clean cache. Remove every key by match\n\t * @param {string|Array<string>} match string. Default is \"**\"\n\t * @returns {Promise}\n\t *\n\t * @memberof Cacher\n\t */\n\tclean(/*match = \"**\"*/) {\n\t\t/* istanbul ignore next */\n\t\tthrow new Error(\"Not implemented method!\");\n\t}\n\n\t/**\n\t * Get a value from params or meta by `key`.\n\t * If the key starts with `#` it reads from `meta`, otherwise from `params`.\n\t *\n\t * @param {String} key\n\t * @param {Object} params\n\t * @param {Object} meta\n\t * @returns {any}\n\t * @memberof Cacher\n\t */\n\tgetParamMetaValue(key, params, meta) {\n\t\tif (key.startsWith(\"#\") && meta != null)\n\t\t\treturn _.get(meta, key.slice(1));\n\t\telse if (params != null)\n\t\t\treturn _.get(params, key);\n\t}\n\n\t/**\n\t * Default cache key generator\n\t *\n\t * @param {String} actionName\n\t * @param {Object|null} params\n\t * @param {Object} meta\n\t * @param {Array|null} keys\n\t * @returns {String}\n\t * @memberof Cacher\n\t */\n\tdefaultKeygen(actionName, params, meta, keys) {\n\t\tif (params || meta) {\n\t\t\tconst keyPrefix = actionName + \":\";\n\t\t\tif (keys) {\n\t\t\t\tif (keys.length == 1) {\n\t\t\t\t\t// Fast solution for ['id'] key\n\t\t\t\t\tconst val = this.getParamMetaValue(keys[0], params, meta);\n\t\t\t\t\treturn keyPrefix + this._hashedKey(isObject(val) ? this._hashedKey(this._generateKeyFromObject(val)) : val);\n\t\t\t\t}\n\n\t\t\t\tif (keys.length > 0) {\n\t\t\t\t\treturn keyPrefix + this._hashedKey(keys.reduce((a, key, i) => {\n\t\t\t\t\t\tconst val = this.getParamMetaValue(key, params, meta);\n\t\t\t\t\t\treturn a + (i ? \"|\" : \"\") + (isObject(val) || Array.isArray(val) ? this._hashedKey(this._generateKeyFromObject(val)) : val);\n\t\t\t\t\t}, \"\"));\n\t\t\t\t}\n\t\t\t}\n\t\t\telse {\n\t\t\t\treturn keyPrefix + this._hashedKey(this._generateKeyFromObject(params));\n\t\t\t}\n\t\t}\n\t\treturn actionName;\n\t}\n\n\t_hashedKey(key) {\n\t\tconst maxParamsLength = this.opts.maxParamsLength;\n\t\tif (!maxParamsLength || maxParamsLength < 44 || key.length <= maxParamsLength)\n\t\t\treturn key;\n\n\t\tconst prefixLength = maxParamsLength - 44;\n\n\t\tconst base64Hash = crypto.createHash(\"sha256\").update(key).digest(\"base64\");\n\t\tif (prefixLength < 1)\n\t\t\treturn base64Hash;\n\n\t\treturn key.substring(0, prefixLength) + base64Hash;\n\t}\n\n\t_generateKeyFromObject(obj) {\n\t\tif (Array.isArray(obj)) {\n\t\t\treturn obj.map(o => this._generateKeyFromObject(o)).join(\"|\");\n\t\t}\n\t\telse if (isObject(obj)) {\n\t\t\treturn Object.keys(obj).map(key => [key, this._generateKeyFromObject(obj[key])].join(\"|\")).join(\"|\");\n\t\t}\n\t\telse if (obj != null) {\n\t\t\treturn obj.toString();\n\t\t} else {\n\t\t\treturn \"null\";\n\t\t}\n\t}\n\n\t/**\n\t * Get a cache key by name and params.\n\t * Concatenate the name and the hashed params object\n\t *\n\t * @param {String} name\n\t * @param {Object} params\n\t * @param {Object} meta\n\t * @param {Array|null} keys\n\t * @returns {String}\n\t */\n\tgetCacheKey(actionName, params, meta, keys) {\n\t\tif (isFunction(this.opts.keygen))\n\t\t\treturn this.opts.keygen.call(this, actionName, params, meta, keys);\n\t\telse\n\t\t\treturn this.defaultKeygen(actionName, params, meta, keys);\n\t}\n\n\t/**\n\t * Register cacher as a middleware\n\t *\n\t * @memberof Cacher\n\t */\n\tmiddleware() {\n\t\treturn (handler, action) => {\n\t\t\tconst opts = _.defaultsDeep({}, isObject(action.cache) ? action.cache : { enabled: !!action.cache });\n\t\t\topts.lock = _.defaultsDeep({}, isObject(opts.lock) ? opts.lock : { enabled: !!opts.lock });\n\t\t\tif (opts.enabled !== false) {\n\t\t\t\tconst isEnabledFunction = isFunction(opts.enabled);\n\n\t\t\t\treturn function cacherMiddleware(ctx) {\n\t\t\t\t\tif (isEnabledFunction) {\n\t\t\t\t\t\tif (!opts.enabled.call(ctx.service, ctx)) {\n\t\t\t\t\t\t\t// Cache is disabled. Call the handler only.\n\t\t\t\t\t\t\treturn handler(ctx);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\t// Disable caching with `ctx.meta.$cache = false`\n\t\t\t\t\tif (ctx.meta[\"$cache\"] === false)\n\t\t\t\t\t\treturn handler(ctx);\n\n\t\t\t\t\tconst cacheKey = this.getCacheKey(action.name, ctx.params, ctx.meta, opts.keys);\n\t\t\t\t\t// Using lock\n\t\t\t\t\tif(opts.lock.enabled !== false){\n\t\t\t\t\t\tlet cachePromise;\n\t\t\t\t\t\tif(opts.lock.staleTime && this.getWithTTL){ // If enable cache refresh\n\t\t\t\t\t\t\tcachePromise = this.getWithTTL(cacheKey).then(({ data, ttl }) => {\n\t\t\t\t\t\t\t\tif (data != null) {\n\t\t\t\t\t\t\t\t\tif(opts.lock.staleTime && ttl && ttl < opts.lock.staleTime){\n\t\t\t\t\t\t\t\t\t\t// Cache is stale, try to refresh it.\n\t\t\t\t\t\t\t\t\t\tthis.tryLock(cacheKey, opts.lock.ttl).then(unlock=>{\n\t\t\t\t\t\t\t\t\t\t\treturn handler(ctx).then(result => {\n\t\t\t\t\t\t\t\t\t\t\t\t// Save the result to the cache and realse the lock.\n\t\t\t\t\t\t\t\t\t\t\t\treturn this.set(cacheKey, result, opts.ttl).then(()=>unlock());\n\t\t\t\t\t\t\t\t\t\t\t}).catch((/*err*/) => {\n\t\t\t\t\t\t\t\t\t\t\t\treturn this.del(cacheKey).then(()=>unlock());\n\t\t\t\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\t\t\t}).catch((/*err*/)=>{\n\t\t\t\t\t\t\t\t\t\t\t// The cache is refreshing on somewhere else.\n\t\t\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\treturn data;\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tcachePromise = this.get(cacheKey);\n\t\t\t\t\t\t}\n\t\t\t\t\t\treturn cachePromise.then(data=>{\n\t\t\t\t\t\t\tif (data != null) {\n\t\t\t\t\t\t\t\t// Found in the cache! Don't call handler, return with the content\n\t\t\t\t\t\t\t\tctx.cachedResult = true;\n\t\t\t\t\t\t\t\treturn data;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t// Not found in the cache! Acquire a lock\n\t\t\t\t\t\t\treturn this.lock(cacheKey, opts.lock.ttl).then(unlock => {\n\t\t\t\t\t\t\t\treturn this.get(cacheKey).then(content => {\n\t\t\t\t\t\t\t\t\tif (content != null) {\n\t\t\t\t\t\t\t\t\t\t// Cache found. Realse the lock and return the value.\n\t\t\t\t\t\t\t\t\t\tctx.cachedResult = true;\n\t\t\t\t\t\t\t\t\t\treturn unlock().then(() => {\n\t\t\t\t\t\t\t\t\t\t\treturn content;\n\t\t\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t// Call the handler\n\t\t\t\t\t\t\t\t\treturn handler(ctx).then(result => {\n\t\t\t\t\t\t\t\t\t\t// Save the result to the cache and realse the lock.\n\t\t\t\t\t\t\t\t\t\tthis.set(cacheKey, result, opts.ttl).then(()=>unlock());\n\t\t\t\t\t\t\t\t\t\treturn result;\n\t\t\t\t\t\t\t\t\t}).catch(e => {\n\t\t\t\t\t\t\t\t\t\treturn unlock().then(() => {\n\t\t\t\t\t\t\t\t\t\t\treturn Promise.reject(e);\n\t\t\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t\t// Not using lock\n\t\t\t\t\treturn this.get(cacheKey).then(content => {\n\t\t\t\t\t\tif (content != null) {\n\t\t\t\t\t\t\t// Found in the cache! Don't call handler, return with the content\n\t\t\t\t\t\t\tctx.cachedResult = true;\n\t\t\t\t\t\t\treturn content;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\t// Call the handler\n\t\t\t\t\t\treturn handler(ctx).then(result => {\n\t\t\t\t\t\t\t// Save the result to the cache\n\t\t\t\t\t\t\tthis.set(cacheKey, result, opts.ttl);\n\n\t\t\t\t\t\t\treturn result;\n\t\t\t\t\t\t});\n\t\t\t\t\t});\n\t\t\t\t}.bind(this);\n\t\t\t}\n\n\t\t\treturn handler;\n\t\t};\n\t}\n\n}\n\nmodule.exports = Cacher;\n"],"names":["require$$0","require$$1"],"mappings":";;;;;AAUA,MAAM,EAAE,MAAM,EAAE,GAAGA,OAAqB,CAAC;AACzC,MAAM,EAAE,QAAQ,EAAE,UAAU,EAAE,GAAGC,OAAmB,CAAC;AACrD;AACA;AACA;AACA;AACA;AACA;AACA,MAAM,MAAM,CAAC;AACb;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,CAAC,WAAW,CAAC,IAAI,EAAE;AACnB,EAAE,IAAI,CAAC,IAAI,GAAG,CAAC,CAAC,YAAY,CAAC,IAAI,EAAE;AACnC,GAAG,GAAG,EAAE,IAAI;AACZ,GAAG,MAAM,EAAE,IAAI;AACf,GAAG,eAAe,EAAE,IAAI;AACxB,GAAG,CAAC,CAAC;AACL,EAAE;AACF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,CAAC,IAAI,CAAC,MAAM,EAAE;AACd,EAAE,IAAI,CAAC,MAAM,GAAG,MAAM,CAAC;AACvB,EAAE,IAAI,CAAC,OAAO,GAAG,MAAM,CAAC,OAAO,CAAC;AAChC;AACA,EAAE,IAAI,IAAI,CAAC,MAAM,EAAE;AACnB,GAAG,IAAI,CAAC,MAAM,GAAG,MAAM,CAAC,SAAS,CAAC,QAAQ,CAAC,CAAC;AAC5C;AACA,GAAG,IAAI,IAAI,CAAC,IAAI,CAAC,MAAM,EAAE;AACzB,IAAI,IAAI,CAAC,MAAM,GAAG,IAAI,CAAC,IAAI,CAAC,MAAM,GAAG,GAAG,CAAC;AACzC,IAAI,MAAM;AACV,IAAI,IAAI,CAAC,MAAM,GAAG,MAAM,CAAC;AACzB,IAAI,IAAI,IAAI,CAAC,MAAM,CAAC,SAAS;AAC7B,KAAK,IAAI,CAAC,MAAM,IAAI,IAAI,CAAC,MAAM,CAAC,SAAS,GAAG,GAAG,CAAC;AAChD,IAAI;AACJ;AACA,GAAG,IAAI,CAAC,wBAAwB,EAAE,CAAC;AACnC,GAAG;AACH,EAAE;AACF;AACA;AACA;AACA;AACA,CAAC,wBAAwB,GAAG;AAC5B,EAAE,IAAI,CAAC,OAAO,CAAC,QAAQ,CAAC,EAAE,IAAI,EAAE,MAAM,CAAC,0BAA0B,EAAE,IAAI,EAAE,MAAM,CAAC,YAAY,EAAE,IAAI,EAAE,IAAI,EAAE,CAAC,CAAC;AAC5G,EAAE,IAAI,CAAC,OAAO,CAAC,QAAQ,CAAC,EAAE,IAAI,EAAE,MAAM,CAAC,yBAAyB,EAAE,IAAI,EAAE,MAAM,CAAC,cAAc,EAAE,SAAS,EAAE,IAAI,EAAE,IAAI,EAAE,MAAM,CAAC,iBAAiB,EAAE,CAAC,CAAC;AAClJ;AACA,EAAE,IAAI,CAAC,OAAO,CAAC,QAAQ,CAAC,EAAE,IAAI,EAAE,MAAM,CAAC,4BAA4B,EAAE,IAAI,EAAE,MAAM,CAAC,YAAY,EAAE,IAAI,EAAE,IAAI,EAAE,CAAC,CAAC;AAC9G;AACA,EAAE,IAAI,CAAC,OAAO,CAAC,QAAQ,CAAC,EAAE,IAAI,EAAE,MAAM,CAAC,0BAA0B,EAAE,IAAI,EAAE,MAAM,CAAC,YAAY,EAAE,IAAI,EAAE,IAAI,EAAE,CAAC,CAAC;AAC5G,EAAE,IAAI,CAAC,OAAO,CAAC,QAAQ,CAAC,EAAE,IAAI,EAAE,MAAM,CAAC,yBAAyB,EAAE,IAAI,EAAE,MAAM,CAAC,cAAc,EAAE,SAAS,EAAE,IAAI,EAAE,IAAI,EAAE,MAAM,CAAC,iBAAiB,EAAE,CAAC,CAAC;AAClJ;AACA,EAAE,IAAI,CAAC,OAAO,CAAC,QAAQ,CAAC,EAAE,IAAI,EAAE,MAAM,CAAC,0BAA0B,EAAE,IAAI,EAAE,MAAM,CAAC,YAAY,EAAE,IAAI,EAAE,IAAI,EAAE,CAAC,CAAC;AAC5G,EAAE,IAAI,CAAC,OAAO,CAAC,QAAQ,CAAC,EAAE,IAAI,EAAE,MAAM,CAAC,yBAAyB,EAAE,IAAI,EAAE,MAAM,CAAC,cAAc,EAAE,SAAS,EAAE,IAAI,EAAE,IAAI,EAAE,MAAM,CAAC,iBAAiB,EAAE,CAAC,CAAC;AAClJ;AACA,EAAE,IAAI,CAAC,OAAO,CAAC,QAAQ,CAAC,EAAE,IAAI,EAAE,MAAM,CAAC,4BAA4B,EAAE,IAAI,EAAE,MAAM,CAAC,YAAY,EAAE,IAAI,EAAE,IAAI,EAAE,CAAC,CAAC;AAC9G,EAAE,IAAI,CAAC,OAAO,CAAC,QAAQ,CAAC,EAAE,IAAI,EAAE,MAAM,CAAC,2BAA2B,EAAE,IAAI,EAAE,MAAM,CAAC,cAAc,EAAE,SAAS,EAAE,IAAI,EAAE,IAAI,EAAE,MAAM,CAAC,iBAAiB,EAAE,CAAC,CAAC;AACpJ;AACA,EAAE,IAAI,CAAC,OAAO,CAAC,QAAQ,CAAC,EAAE,IAAI,EAAE,MAAM,CAAC,8BAA8B,EAAE,IAAI,EAAE,MAAM,CAAC,YAAY,EAAE,IAAI,EAAE,IAAI,EAAE,CAAC,CAAC;AAChH,EAAE;AACF;AACA;AACA;AACA;AACA;AACA;AACA,CAAC,KAAK,GAAG;AACT;AACA,EAAE,OAAO,OAAO,CAAC,OAAO,EAAE,CAAC;AAC3B,EAAE;AACF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,CAAC,GAAG,UAAU;AACd;AACA,EAAE,MAAM,IAAI,KAAK,CAAC,yBAAyB,CAAC,CAAC;AAC7C,EAAE;AACF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,CAAC,UAAU,UAAU;AACrB;AACA,EAAE,MAAM,IAAI,KAAK,CAAC,yBAAyB,CAAC,CAAC;AAC7C,EAAE;AACF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,CAAC,GAAG,qBAAqB;AACzB;AACA,EAAE,MAAM,IAAI,KAAK,CAAC,yBAAyB,CAAC,CAAC;AAC7C,EAAE;AACF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,CAAC,GAAG,UAAU;AACd;AACA,EAAE,MAAM,IAAI,KAAK,CAAC,yBAAyB,CAAC,CAAC;AAC7C,EAAE;AACF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,CAAC,KAAK,mBAAmB;AACzB;AACA,EAAE,MAAM,IAAI,KAAK,CAAC,yBAAyB,CAAC,CAAC;AAC7C,EAAE;AACF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,CAAC,iBAAiB,CAAC,GAAG,EAAE,MAAM,EAAE,IAAI,EAAE;AACtC,EAAE,IAAI,GAAG,CAAC,UAAU,CAAC,GAAG,CAAC,IAAI,IAAI,IAAI,IAAI;AACzC,GAAG,OAAO,CAAC,CAAC,GAAG,CAAC,IAAI,EAAE,GAAG,CAAC,KAAK,CAAC,CAAC,CAAC,CAAC,CAAC;AACpC,OAAO,IAAI,MAAM,IAAI,IAAI;AACzB,GAAG,OAAO,CAAC,CAAC,GAAG,CAAC,MAAM,EAAE,GAAG,CAAC,CAAC;AAC7B,EAAE;AACF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,CAAC,aAAa,CAAC,UAAU,EAAE,MAAM,EAAE,IAAI,EAAE,IAAI,EAAE;AAC/C,EAAE,IAAI,MAAM,IAAI,IAAI,EAAE;AACtB,GAAG,MAAM,SAAS,GAAG,UAAU,GAAG,GAAG,CAAC;AACtC,GAAG,IAAI,IAAI,EAAE;AACb,IAAI,IAAI,IAAI,CAAC,MAAM,IAAI,CAAC,EAAE;AAC1B;AACA,KAAK,MAAM,GAAG,GAAG,IAAI,CAAC,iBAAiB,CAAC,IAAI,CAAC,CAAC,CAAC,EAAE,MAAM,EAAE,IAAI,CAAC,CAAC;AAC/D,KAAK,OAAO,SAAS,GAAG,IAAI,CAAC,UAAU,CAAC,QAAQ,CAAC,GAAG,CAAC,GAAG,IAAI,CAAC,UAAU,CAAC,IAAI,CAAC,sBAAsB,CAAC,GAAG,CAAC,CAAC,GAAG,GAAG,CAAC,CAAC;AACjH,KAAK;AACL;AACA,IAAI,IAAI,IAAI,CAAC,MAAM,GAAG,CAAC,EAAE;AACzB,KAAK,OAAO,SAAS,GAAG,IAAI,CAAC,UAAU,CAAC,IAAI,CAAC,MAAM,CAAC,CAAC,CAAC,EAAE,GAAG,EAAE,CAAC,KAAK;AACnE,MAAM,MAAM,GAAG,GAAG,IAAI,CAAC,iBAAiB,CAAC,GAAG,EAAE,MAAM,EAAE,IAAI,CAAC,CAAC;AAC5D,MAAM,OAAO,CAAC,IAAI,CAAC,GAAG,GAAG,GAAG,EAAE,CAAC,IAAI,QAAQ,CAAC,GAAG,CAAC,IAAI,KAAK,CAAC,OAAO,CAAC,GAAG,CAAC,GAAG,IAAI,CAAC,UAAU,CAAC,IAAI,CAAC,sBAAsB,CAAC,GAAG,CAAC,CAAC,GAAG,GAAG,CAAC,CAAC;AAClI,MAAM,EAAE,EAAE,CAAC,CAAC,CAAC;AACb,KAAK;AACL,IAAI;AACJ,QAAQ;AACR,IAAI,OAAO,SAAS,GAAG,IAAI,CAAC,UAAU,CAAC,IAAI,CAAC,sBAAsB,CAAC,MAAM,CAAC,CAAC,CAAC;AAC5E,IAAI;AACJ,GAAG;AACH,EAAE,OAAO,UAAU,CAAC;AACpB,EAAE;AACF;AACA,CAAC,UAAU,CAAC,GAAG,EAAE;AACjB,EAAE,MAAM,eAAe,GAAG,IAAI,CAAC,IAAI,CAAC,eAAe,CAAC;AACpD,EAAE,IAAI,CAAC,eAAe,IAAI,eAAe,GAAG,EAAE,IAAI,GAAG,CAAC,MAAM,IAAI,eAAe;AAC/E,GAAG,OAAO,GAAG,CAAC;AACd;AACA,EAAE,MAAM,YAAY,GAAG,eAAe,GAAG,EAAE,CAAC;AAC5C;AACA,EAAE,MAAM,UAAU,GAAG,MAAM,CAAC,UAAU,CAAC,QAAQ,CAAC,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC,MAAM,CAAC,QAAQ,CAAC,CAAC;AAC9E,EAAE,IAAI,YAAY,GAAG,CAAC;AACtB,GAAG,OAAO,UAAU,CAAC;AACrB;AACA,EAAE,OAAO,GAAG,CAAC,SAAS,CAAC,CAAC,EAAE,YAAY,CAAC,GAAG,UAAU,CAAC;AACrD,EAAE;AACF;AACA,CAAC,sBAAsB,CAAC,GAAG,EAAE;AAC7B,EAAE,IAAI,KAAK,CAAC,OAAO,CAAC,GAAG,CAAC,EAAE;AAC1B,GAAG,OAAO,GAAG,CAAC,GAAG,CAAC,CAAC,IAAI,IAAI,CAAC,sBAAsB,CAAC,CAAC,CAAC,CAAC,CAAC,IAAI,CAAC,GAAG,CAAC,CAAC;AACjE,GAAG;AACH,OAAO,IAAI,QAAQ,CAAC,GAAG,CAAC,EAAE;AAC1B,GAAG,OAAO,MAAM,CAAC,IAAI,CAAC,GAAG,CAAC,CAAC,GAAG,CAAC,GAAG,IAAI,CAAC,GAAG,EAAE,IAAI,CAAC,sBAAsB,CAAC,GAAG,CAAC,GAAG,CAAC,CAAC,CAAC,CAAC,IAAI,CAAC,GAAG,CAAC,CAAC,CAAC,IAAI,CAAC,GAAG,CAAC,CAAC;AACxG,GAAG;AACH,OAAO,IAAI,GAAG,IAAI,IAAI,EAAE;AACxB,GAAG,OAAO,GAAG,CAAC,QAAQ,EAAE,CAAC;AACzB,GAAG,MAAM;AACT,GAAG,OAAO,MAAM,CAAC;AACjB,GAAG;AACH,EAAE;AACF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,CAAC,WAAW,CAAC,UAAU,EAAE,MAAM,EAAE,IAAI,EAAE,IAAI,EAAE;AAC7C,EAAE,IAAI,UAAU,CAAC,IAAI,CAAC,IAAI,CAAC,MAAM,CAAC;AAClC,GAAG,OAAO,IAAI,CAAC,IAAI,CAAC,MAAM,CAAC,IAAI,CAAC,IAAI,EAAE,UAAU,EAAE,MAAM,EAAE,IAAI,EAAE,IAAI,CAAC,CAAC;AACtE;AACA,GAAG,OAAO,IAAI,CAAC,aAAa,CAAC,UAAU,EAAE,MAAM,EAAE,IAAI,EAAE,IAAI,CAAC,CAAC;AAC7D,EAAE;AACF;AACA;AACA;AACA;AACA;AACA;AACA,CAAC,UAAU,GAAG;AACd,EAAE,OAAO,CAAC,OAAO,EAAE,MAAM,KAAK;AAC9B,GAAG,MAAM,IAAI,GAAG,CAAC,CAAC,YAAY,CAAC,EAAE,EAAE,QAAQ,CAAC,MAAM,CAAC,KAAK,CAAC,GAAG,MAAM,CAAC,KAAK,GAAG,EAAE,OAAO,EAAE,CAAC,CAAC,MAAM,CAAC,KAAK,EAAE,CAAC,CAAC;AACxG,GAAG,IAAI,CAAC,IAAI,GAAG,CAAC,CAAC,YAAY,CAAC,EAAE,EAAE,QAAQ,CAAC,IAAI,CAAC,IAAI,CAAC,GAAG,IAAI,CAAC,IAAI,GAAG,EAAE,OAAO,EAAE,CAAC,CAAC,IAAI,CAAC,IAAI,EAAE,CAAC,CAAC;AAC9F,GAAG,IAAI,IAAI,CAAC,OAAO,KAAK,KAAK,EAAE;AAC/B,IAAI,MAAM,iBAAiB,GAAG,UAAU,CAAC,IAAI,CAAC,OAAO,CAAC,CAAC;AACvD;AACA,IAAI,OAAO,SAAS,gBAAgB,CAAC,GAAG,EAAE;AAC1C,KAAK,IAAI,iBAAiB,EAAE;AAC5B,MAAM,IAAI,CAAC,IAAI,CAAC,OAAO,CAAC,IAAI,CAAC,GAAG,CAAC,OAAO,EAAE,GAAG,CAAC,EAAE;AAChD;AACA,OAAO,OAAO,OAAO,CAAC,GAAG,CAAC,CAAC;AAC3B,OAAO;AACP,MAAM;AACN;AACA;AACA,KAAK,IAAI,GAAG,CAAC,IAAI,CAAC,QAAQ,CAAC,KAAK,KAAK;AACrC,MAAM,OAAO,OAAO,CAAC,GAAG,CAAC,CAAC;AAC1B;AACA,KAAK,MAAM,QAAQ,GAAG,IAAI,CAAC,WAAW,CAAC,MAAM,CAAC,IAAI,EAAE,GAAG,CAAC,MAAM,EAAE,GAAG,CAAC,IAAI,EAAE,IAAI,CAAC,IAAI,CAAC,CAAC;AACrF;AACA,KAAK,GAAG,IAAI,CAAC,IAAI,CAAC,OAAO,KAAK,KAAK,CAAC;AACpC,MAAM,IAAI,YAAY,CAAC;AACvB,MAAM,GAAG,IAAI,CAAC,IAAI,CAAC,SAAS,IAAI,IAAI,CAAC,UAAU,CAAC;AAChD,OAAO,YAAY,GAAG,IAAI,CAAC,UAAU,CAAC,QAAQ,CAAC,CAAC,IAAI,CAAC,CAAC,EAAE,IAAI,EAAE,GAAG,EAAE,KAAK;AACxE,QAAQ,IAAI,IAAI,IAAI,IAAI,EAAE;AAC1B,SAAS,GAAG,IAAI,CAAC,IAAI,CAAC,SAAS,IAAI,GAAG,IAAI,GAAG,GAAG,IAAI,CAAC,IAAI,CAAC,SAAS,CAAC;AACpE;AACA,UAAU,IAAI,CAAC,OAAO,CAAC,QAAQ,EAAE,IAAI,CAAC,IAAI,CAAC,GAAG,CAAC,CAAC,IAAI,CAAC,MAAM,EAAE;AAC7D,WAAW,OAAO,OAAO,CAAC,GAAG,CAAC,CAAC,IAAI,CAAC,MAAM,IAAI;AAC9C;AACA,YAAY,OAAO,IAAI,CAAC,GAAG,CAAC,QAAQ,EAAE,MAAM,EAAE,IAAI,CAAC,GAAG,CAAC,CAAC,IAAI,CAAC,IAAI,MAAM,EAAE,CAAC,CAAC;AAC3E,YAAY,CAAC,CAAC,KAAK,CAAC,aAAa;AACjC,YAAY,OAAO,IAAI,CAAC,GAAG,CAAC,QAAQ,CAAC,CAAC,IAAI,CAAC,IAAI,MAAM,EAAE,CAAC,CAAC;AACzD,YAAY,CAAC,CAAC;AACd,WAAW,CAAC,CAAC,KAAK,CAAC,WAAW;AAC9B;AACA,WAAW,CAAC,CAAC;AACb,UAAU;AACV,SAAS;AACT,QAAQ,OAAO,IAAI,CAAC;AACpB,QAAQ,CAAC,CAAC;AACV,OAAO,MAAM;AACb,OAAO,YAAY,GAAG,IAAI,CAAC,GAAG,CAAC,QAAQ,CAAC,CAAC;AACzC,OAAO;AACP,MAAM,OAAO,YAAY,CAAC,IAAI,CAAC,IAAI,EAAE;AACrC,OAAO,IAAI,IAAI,IAAI,IAAI,EAAE;AACzB;AACA,QAAQ,GAAG,CAAC,YAAY,GAAG,IAAI,CAAC;AAChC,QAAQ,OAAO,IAAI,CAAC;AACpB,QAAQ;AACR;AACA,OAAO,OAAO,IAAI,CAAC,IAAI,CAAC,QAAQ,EAAE,IAAI,CAAC,IAAI,CAAC,GAAG,CAAC,CAAC,IAAI,CAAC,MAAM,IAAI;AAChE,QAAQ,OAAO,IAAI,CAAC,GAAG,CAAC,QAAQ,CAAC,CAAC,IAAI,CAAC,OAAO,IAAI;AAClD,SAAS,IAAI,OAAO,IAAI,IAAI,EAAE;AAC9B;AACA,UAAU,GAAG,CAAC,YAAY,GAAG,IAAI,CAAC;AAClC,UAAU,OAAO,MAAM,EAAE,CAAC,IAAI,CAAC,MAAM;AACrC,WAAW,OAAO,OAAO,CAAC;AAC1B,WAAW,CAAC,CAAC;AACb,UAAU;AACV;AACA,SAAS,OAAO,OAAO,CAAC,GAAG,CAAC,CAAC,IAAI,CAAC,MAAM,IAAI;AAC5C;AACA,UAAU,IAAI,CAAC,GAAG,CAAC,QAAQ,EAAE,MAAM,EAAE,IAAI,CAAC,GAAG,CAAC,CAAC,IAAI,CAAC,IAAI,MAAM,EAAE,CAAC,CAAC;AAClE,UAAU,OAAO,MAAM,CAAC;AACxB,UAAU,CAAC,CAAC,KAAK,CAAC,CAAC,IAAI;AACvB,UAAU,OAAO,MAAM,EAAE,CAAC,IAAI,CAAC,MAAM;AACrC,WAAW,OAAO,OAAO,CAAC,MAAM,CAAC,CAAC,CAAC,CAAC;AACpC,WAAW,CAAC,CAAC;AACb,UAAU,CAAC,CAAC;AACZ,SAAS,CAAC,CAAC;AACX,QAAQ,CAAC,CAAC;AACV,OAAO,CAAC,CAAC;AACT,MAAM;AACN;AACA,KAAK,OAAO,IAAI,CAAC,GAAG,CAAC,QAAQ,CAAC,CAAC,IAAI,CAAC,OAAO,IAAI;AAC/C,MAAM,IAAI,OAAO,IAAI,IAAI,EAAE;AAC3B;AACA,OAAO,GAAG,CAAC,YAAY,GAAG,IAAI,CAAC;AAC/B,OAAO,OAAO,OAAO,CAAC;AACtB,OAAO;AACP;AACA;AACA,MAAM,OAAO,OAAO,CAAC,GAAG,CAAC,CAAC,IAAI,CAAC,MAAM,IAAI;AACzC;AACA,OAAO,IAAI,CAAC,GAAG,CAAC,QAAQ,EAAE,MAAM,EAAE,IAAI,CAAC,GAAG,CAAC,CAAC;AAC5C;AACA,OAAO,OAAO,MAAM,CAAC;AACrB,OAAO,CAAC,CAAC;AACT,MAAM,CAAC,CAAC;AACR,KAAK,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;AACjB,IAAI;AACJ;AACA,GAAG,OAAO,OAAO,CAAC;AAClB,GAAG,CAAC;AACJ,EAAE;AACF;AACA,CAAC;AACD;QACc,GAAG;;;;"}
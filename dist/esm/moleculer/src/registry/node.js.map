{"version":3,"file":"node.js","sources":["../../../../../src/moleculer/src/registry/node.js"],"sourcesContent":["/*\n * moleculer\n * Copyright (c) 2020 MoleculerJS (https://github.com/moleculerjs/moleculer)\n * MIT Licensed\n */\n\n\"use strict\";\n\n/**\n * Node class\n *\n * @class Node\n */\nclass Node {\n\t/**\n\t * Creates an instance of Node.\n\t *\n\t * @param {String} id\n\t *\n\t * @memberof Node\n\t */\n\tconstructor(id) {\n\t\tthis.id = id;\n\t\tthis.instanceID = null;\n\t\tthis.available = true;\n\t\tthis.local = false;\n\t\tthis.lastHeartbeatTime = Math.round(process.uptime());\n\t\tthis.config = {};\n\t\tthis.client = {};\n\t\tthis.metadata = null;\n\n\t\tthis.ipList = null;\n\t\tthis.port = null;\n\t\tthis.hostname = null;\n\t\tthis.udpAddress = null;\n\n\t\tthis.rawInfo = null;\n\t\tthis.services = [];\n\n\t\tthis.cpu = null;\n\t\tthis.cpuSeq = null;\n\n\t\tthis.seq = 0;\n\t\tthis.offlineSince = null;\n\t}\n\n\t/**\n\t * Update properties\n\t *\n\t * @param {object} payload\n\t * @param {boolean} isReconnected\n\t * @memberof Node\n\t */\n\tupdate(payload, isReconnected) {\n\t\t// Update properties\n\t\tthis.metadata = payload.metadata;\n\t\tthis.ipList = payload.ipList;\n\t\tthis.hostname = payload.hostname;\n\t\tthis.port = payload.port;\n\t\tthis.client = payload.client || {};\n\t\tthis.config = payload.config || {};\n\t\tthis.instanceID = payload.instanceID;\n\n\t\t// Process services & events\n\t\tthis.services = payload.services;\n\t\tthis.rawInfo = payload;\n\n\t\tconst newSeq = payload.seq || 1;\n\t\tif (newSeq > this.seq || isReconnected) {\n\t\t\tthis.seq = newSeq;\n\t\t\treturn true;\n\t\t}\n\t}\n\n\t/**\n\t * Update local properties.\n\t *\n\t * @memberof Node\n\t * @param {Function} cpuUsage\n\t */\n\tupdateLocalInfo(cpuUsage) {\n\t\treturn cpuUsage().then(res => {\n\t\t\tconst newVal = Math.round(res.avg);\n\t\t\tif (this.cpu != newVal) {\n\t\t\t\tthis.cpu = newVal;\n\t\t\t\tthis.cpuSeq++;\n\t\t\t}\n\t\t}).catch(() => { /* silent */ });\n\t}\n\n\t/**\n\t * Update heartbeat properties\n\t *\n\t * @param {any} payload\n\t * @memberof Node\n\t */\n\theartbeat(payload) {\n\t\tif (!this.available) {\n\t\t\tthis.available = true;\n\t\t\tthis.offlineSince = null;\n\t\t}\n\n\t\tif (payload.cpu != null) {\n\t\t\tthis.cpu = payload.cpu;\n\t\t\tthis.cpuSeq = payload.cpuSeq || 1;\n\t\t}\n\n\t\tthis.lastHeartbeatTime = Math.round(process.uptime());\n\t}\n\n\t/**\n\t * Node disconnected\n\t *\n\t * @memberof Node\n\t */\n\tdisconnected() {\n\t\tif (this.available) {\n\t\t\tthis.offlineSince = Math.round(process.uptime());\n\t\t\tthis.seq++;\n\t\t}\n\n\t\tthis.available = false;\n\t}\n}\n\nmodule.exports = Node;\n"],"names":["process"],"mappings":"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"}
import t from"lodash";import n from"../errors.js";const{MoleculerServerError:i}=n;var e=class{constructor(t,n,i,e,s,r,o){this.registry=t,this.broker=n,this.logger=t.logger,this.strategy=new r(t,n,o),this.name=i,this.group=e,this.internal=i.startsWith("$"),this.EndPointFactory=s,this.endpoints=[],this.localEndpoints=[]}add(t,n,i){const e=this.endpoints.find((i=>i.node==t&&i.service.name==n.name));if(e)return e.update(i),e;const s=new this.EndPointFactory(this.registry,this.broker,t,n,i);return this.endpoints.push(s),this.setLocalEndpoints(),s}getFirst(){return this.endpoints.length>0?this.endpoints[0]:null}select(t,n){const e=this.strategy.select(t,n);if(!e)throw new i("Strategy returned an invalid endpoint.",500,"INVALID_ENDPOINT",{strategy:typeof this.strategy});return e}next(t){if(0===this.endpoints.length)return null;if(this.internal&&this.hasLocal())return this.nextLocal();if(1===this.endpoints.length){const t=this.endpoints[0];return t.isAvailable?t:null}if(!0===this.registry.opts.preferLocal&&this.hasLocal()){const n=this.nextLocal(t);if(n&&n.isAvailable)return n}const n=this.endpoints.filter((t=>t.isAvailable));return 0==n.length?null:this.select(n,t)}nextLocal(t){if(0===this.localEndpoints.length)return null;if(1===this.localEndpoints.length){const t=this.localEndpoints[0];return t.isAvailable?t:null}const n=this.localEndpoints.filter((t=>t.isAvailable));return 0==n.length?null:this.select(n,t)}hasAvailable(){return null!=this.endpoints.find((t=>t.isAvailable))}hasLocal(){return this.localEndpoints.length>0}setLocalEndpoints(){this.localEndpoints=this.endpoints.filter((t=>t.local))}count(){return this.endpoints.length}getEndpointByNodeID(t){const n=this.endpoints.find((n=>n.id==t));return n&&n.isAvailable?n:null}hasNodeID(t){return null!=this.endpoints.find((n=>n.id==t))}removeByService(n){t.remove(this.endpoints,(t=>{if(t.service==n)return t.destroy(),!0})),this.setLocalEndpoints()}removeByNodeID(n){t.remove(this.endpoints,(t=>{if(t.id==n)return t.destroy(),!0})),this.setLocalEndpoints()}};export default e;
//# sourceMappingURL=endpoint-list.js.map

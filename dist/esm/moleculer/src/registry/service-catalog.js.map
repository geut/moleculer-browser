{"version":3,"file":"service-catalog.js","sources":["../../../../../src/moleculer/src/registry/service-catalog.js"],"sourcesContent":["/*\n * moleculer\n * Copyright (c) 2018 MoleculerJS (https://github.com/moleculerjs/moleculer)\n * MIT Licensed\n */\n\n\"use strict\";\n\nconst _ = require(\"lodash\");\nconst ServiceItem = require(\"./service-item\");\nconst { removeFromArray } = require(\"../utils\");\n\n/**\n * Catalog for services\n *\n * @class ServiceCatalog\n */\nclass ServiceCatalog {\n\n\t/**\n\t * Creates an instance of ServiceCatalog.\n\t *\n\t * @param {Registry} registry\n\t * @param {ServiceBroker} broker\n\t * @memberof ServiceCatalog\n\t */\n\tconstructor(registry, broker) {\n\t\tthis.registry = registry;\n\t\tthis.broker = broker;\n\t\tthis.logger = registry.logger;\n\n\t\tthis.services = [];\n\t}\n\n\t/**\n\t * Add a new service\n\t *\n\t * @param {Node} node\n\t * @param {Object} service\n\t * @param {Boolean} local\n\t *\n\t * @returns {ServiceItem}\n\t *\n\t * @memberof ServiceCatalog\n\t */\n\tadd(node, service, local) {\n\t\tconst item = new ServiceItem(node, service, local);\n\t\tthis.services.push(item);\n\t\treturn item;\n\t}\n\n\t/**\n\t * Check the service is exist\n\t *\n\t * @param {String} fullName\n\t * @param {String} nodeID\n\t * @returns\n\t * @memberof ServiceCatalog\n\t */\n\thas(fullName, nodeID) {\n\t\treturn this.services.find(svc => svc.equals(fullName, nodeID)) != null;\n\t}\n\n\t/**\n\t * Get a service by fullName & nodeID\n\t *\n\t * @param {String} fullName\n\t * @param {String} nodeID\n\t * @returns\n\t * @memberof ServiceCatalog\n\t */\n\tget(fullName, nodeID) {\n\t\treturn this.services.find(svc => svc.equals(fullName, nodeID));\n\t}\n\n\t/**\n\t * Get a filtered list of services with actions\n\t *\n\t * @param {Object} {onlyLocal = false,  onlyAvailable = false, skipInternal = false, withActions = false, withEvents = false, grouping = false}\n\t * @returns {Array}\n\t *\n\t * @memberof Registry\n\t */\n\tlist({ onlyLocal = false, onlyAvailable = false, skipInternal = false, withActions = false, withEvents = false, grouping = false }) {\n\t\tlet res = [];\n\t\tthis.services.forEach(service => {\n\t\t\tif (skipInternal && /^\\$/.test(service.name))\n\t\t\t\treturn;\n\n\t\t\tif (onlyLocal && !service.local)\n\t\t\t\treturn;\n\n\t\t\tif (onlyAvailable && !service.node.available)\n\t\t\t\treturn;\n\n\t\t\tlet item;\n\t\t\tif (grouping)\n\t\t\t\titem = res.find(svc => svc.fullName == service.fullName);\n\n\t\t\tif (!item) {\n\t\t\t\tlet item = {\n\t\t\t\t\tname: service.name,\n\t\t\t\t\tversion: service.version,\n\t\t\t\t\tfullName: service.fullName,\n\t\t\t\t\tsettings: service.settings,\n\t\t\t\t\tmetadata: service.metadata,\n\n\t\t\t\t\tlocal: service.local,\n\t\t\t\t\tavailable: service.node.available,\n\t\t\t\t};\n\n\t\t\t\tif (grouping)\n\t\t\t\t\titem.nodes = [service.node.id];\n\t\t\t\telse\n\t\t\t\t\titem.nodeID = service.node.id;\n\n\t\t\t\tif (withActions) {\n\t\t\t\t\titem.actions = {};\n\n\t\t\t\t\t_.forIn(service.actions, action => {\n\t\t\t\t\t\tif (action.protected) return;\n\n\t\t\t\t\t\titem.actions[action.name] = _.omit(action, [\"handler\", \"remoteHandler\", \"service\"]);\n\t\t\t\t\t});\n\t\t\t\t}\n\n\t\t\t\tif (withEvents) {\n\t\t\t\t\titem.events = {};\n\n\t\t\t\t\t_.forIn(service.events, event => {\n\t\t\t\t\t\t// Skip internal event handlers\n\t\t\t\t\t\tif (/^\\$/.test(event.name)) return;\n\n\t\t\t\t\t\titem.events[event.name] = _.omit(event, [\"handler\", \"remoteHandler\", \"service\"]);\n\t\t\t\t\t});\n\t\t\t\t}\n\n\t\t\t\tres.push(item);\n\n\t\t\t} else {\n\t\t\t\tif (item.nodes.indexOf(service.node.id) === -1)\n\t\t\t\t\titem.nodes.push(service.node.id);\n\t\t\t}\n\t\t});\n\n\t\treturn res;\n\t}\n\n\t/**\n\t * Get local service list for INFO packet\n\t *\n\t * @returns {Object}\n\t * @memberof ServiceCatalog\n\t */\n\tgetLocalNodeServices() {\n\t\tlet res = [];\n\t\tthis.services.forEach(service => {\n\t\t\tif (!service.local)\n\t\t\t\treturn;\n\n\t\t\tlet item = {\n\t\t\t\tname: service.name,\n\t\t\t\tversion: service.version,\n\t\t\t\tfullName: service.fullName,\n\t\t\t\tsettings: service.settings,\n\t\t\t\tmetadata: service.metadata,\n\t\t\t\tdependencies: service.dependencies\n\t\t\t};\n\n\t\t\titem.actions = {};\n\n\t\t\t_.forIn(service.actions, action => {\n\t\t\t\tif (action.protected) return;\n\n\t\t\t\titem.actions[action.name] = _.omit(action, [\"handler\", \"remoteHandler\", \"service\"]);\n\t\t\t});\n\n\t\t\titem.events = {};\n\n\t\t\t_.forIn(service.events, event => {\n\t\t\t\t// Leave internal event handlers, because it can be used for internal events.\n\t\t\t\t//if (/^\\$/.test(event.name)) return;\n\n\t\t\t\titem.events[event.name] = _.omit(event, [\"handler\", \"remoteHandler\", \"service\"]);\n\t\t\t});\n\n\t\t\tres.push(item);\n\t\t});\n\n\t\treturn res;\n\t}\n\n\t/**\n\t * Remove all endpoints by nodeID\n\t *\n\t * @param {String} nodeID\n\t * @memberof ServiceCatalog\n\t */\n\tremoveAllByNodeID(nodeID) {\n\t\t_.remove(this.services, service => {\n\t\t\tif (service.node.id == nodeID) {\n\t\t\t\tthis.registry.actions.removeByService(service);\n\t\t\t\tthis.registry.events.removeByService(service);\n\t\t\t\treturn true;\n\t\t\t}\n\t\t});\n\t}\n\n\t/**\n\t * Remove endpoint by fullName & nodeID\n\t *\n\t * @param {String} fullName\n\t * @param {String} nodeID\n\t * @memberof ServiceCatalog\n\t */\n\tremove(fullName, nodeID) {\n\t\tlet service = this.get(fullName, nodeID);\n\t\tif (service) {\n\t\t\tthis.registry.actions.removeByService(service);\n\t\t\tthis.registry.events.removeByService(service);\n\n\t\t\tremoveFromArray(this.services, service);\n\t\t}\n\t}\n}\n\nmodule.exports = ServiceCatalog;\n"],"names":["require$$0","ServiceItem"],"mappings":"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"}
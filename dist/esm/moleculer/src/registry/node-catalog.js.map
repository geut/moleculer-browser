{"version":3,"file":"node-catalog.js","sources":["../../../../../src/moleculer/src/registry/node-catalog.js"],"sourcesContent":["/*\n * moleculer\n * Copyright (c) 2020 MoleculerJS (https://github.com/moleculerjs/moleculer)\n * MIT Licensed\n */\n\n\"use strict\";\n\nconst _ \t\t\t= require(\"lodash\");\nconst os \t\t\t= require(\"os\");\nconst Node \t\t\t= require(\"./node\");\nconst { getIpList } = require(\"../utils\");\n\n/**\n * Catalog for nodes\n *\n * @class NodeCatalog\n */\nclass NodeCatalog {\n\n\t/**\n\t * Creates an instance of NodeCatalog.\n\t *\n\t * @param {Registry} registry\n\t * @param {ServiceBroker} broker\n\t *\n\t * @memberof NodeCatalog\n\t */\n\tconstructor(registry, broker) {\n\t\tthis.registry = registry;\n\t\tthis.broker = broker;\n\t\tthis.logger = registry.logger;\n\n\t\tthis.nodes = new Map();\n\n\t\tthis.createLocalNode();\n\t}\n\n\t/**\n\t * Create local node with local information\n\t *\n\t * @returns\n\t * @memberof NodeCatalog\n\t */\n\tcreateLocalNode() {\n\t\tconst node = new Node(this.broker.nodeID);\n\t\tnode.local = true;\n\t\tnode.ipList = getIpList();\n\t\tnode.instanceID = this.broker.instanceID;\n\t\tnode.hostname = os.hostname();\n\t\tnode.client = {\n\t\t\ttype: \"nodejs\",\n\t\t\tversion: this.broker.MOLECULER_VERSION,\n\t\t\tlangVersion: process.version\n\t\t};\n\t\tnode.metadata = this.broker.metadata;\n\t\tnode.seq = 1;\n\n\t\tthis.add(node.id, node);\n\n\t\tthis.localNode = node;\n\t\treturn node;\n\t}\n\n\t/**\n\t * Add a new node\n\t *\n\t * @param {String} id\n\t * @param {any} node\n\t * @memberof NodeCatalog\n\t */\n\tadd(id, node) {\n\t\tthis.nodes.set(id, node);\n\t}\n\n\t/**\n\t * Check a node exist by nodeID\n\t *\n\t * @param {String} id\n\t * @returns\n\t * @memberof NodeCatalog\n\t */\n\thas(id) {\n\t\treturn this.nodes.has(id);\n\t}\n\n\t/**\n\t * Get a node by nodeID\n\t *\n\t * @param {String} id\n\t * @returns\n\t * @memberof NodeCatalog\n\t */\n\tget(id) {\n\t\treturn this.nodes.get(id);\n\t}\n\n\t/**\n\t * Delete a node by nodeID\n\t *\n\t * @param {String} id\n\t * @returns\n\t * @memberof NodeCatalog\n\t */\n\tdelete(id) {\n\t\treturn this.nodes.delete(id);\n\t}\n\n\t/**\n\t * Get count of all registered nodes\n\t */\n\tcount() {\n\t\treturn this.nodes.size;\n\t}\n\n\t/**\n\t * Get count of online nodes\n\t */\n\tonlineCount() {\n\t\tlet count = 0;\n\t\tthis.nodes.forEach(node => {\n\t\t\tif (node.available)\n\t\t\t\tcount++;\n\t\t});\n\n\t\treturn count;\n\t}\n\n\t/**\n\t * Process incoming INFO packet payload\n\t *\n\t * @param {any} payload\n\t * @memberof NodeCatalog\n\t */\n\tprocessNodeInfo(payload) {\n\t\tconst nodeID = payload.sender;\n\t\t//let oldNode;\n\t\tlet node = this.get(nodeID);\n\t\tlet isNew = false;\n\t\tlet isReconnected = false;\n\n\t\tif (!node) {\n\t\t\tisNew = true;\n\t\t\tnode = new Node(nodeID);\n\n\t\t\tthis.add(nodeID, node);\n\t\t} else if (!node.available) {\n\t\t\tisReconnected = true;\n\t\t\tnode.lastHeartbeatTime = Math.round(process.uptime());\n\t\t\tnode.available = true;\n\t\t\tnode.offlineSince = null;\n\t\t}\n\n\t\t// Update instance\n\t\tconst needRegister = node.update(payload, isReconnected);\n\n\t\t// Refresh services if 'seq' is greater or it is a reconnected node\n\t\tif (needRegister && node.services) {\n\t\t\tthis.registry.registerServices(node, node.services);\n\t\t}\n\n\t\t// Local notifications\n\t\tif (isNew) {\n\t\t\tthis.broker.broadcastLocal(\"$node.connected\", { node, reconnected: false });\n\t\t\tthis.logger.info(`Node '${nodeID}' connected.`);\n\t\t\tthis.registry.updateMetrics();\n\t\t} else if (isReconnected) {\n\t\t\tthis.broker.broadcastLocal(\"$node.connected\", { node, reconnected: true });\n\t\t\tthis.logger.info(`Node '${nodeID}' reconnected.`);\n\t\t\tthis.registry.updateMetrics();\n\t\t} else {\n\t\t\tthis.broker.broadcastLocal(\"$node.updated\", { node });\n\t\t\tthis.logger.debug(`Node '${nodeID}' updated.`);\n\t\t}\n\n\t\treturn node;\n\t}\n\n\t/**\n\t * Disconnected a node\n\t *\n\t * @param {String} nodeID\n\t * @param {Boolean} isUnexpected\n\t * @memberof NodeCatalog\n\t */\n\tdisconnected(nodeID, isUnexpected) {\n\t\tlet node = this.get(nodeID);\n\t\tif (node && node.available) {\n\t\t\tnode.disconnected(isUnexpected);\n\n\t\t\tthis.registry.unregisterServicesByNode(node.id);\n\n\t\t\tthis.broker.broadcastLocal(\"$node.disconnected\", { node, unexpected: !!isUnexpected });\n\n\t\t\tthis.registry.updateMetrics();\n\n\t\t\tthis.logger.warn(`Node '${node.id}' disconnected${isUnexpected ? \" unexpectedly\" : \"\"}.`);\n\n\t\t\tif (this.broker.transit)\n\t\t\t\tthis.broker.transit.removePendingRequestByNodeID(nodeID);\n\t\t}\n\t}\n\n\n\t/**\n\t * Get a node list\n\t *\n\t * @param {Object} {onlyAvailable = false, withServices = false}\n\t * @returns\n\t * @memberof NodeCatalog\n\t */\n\tlist({ onlyAvailable = false, withServices = false }) {\n\t\tlet res = [];\n\t\tthis.nodes.forEach(node => {\n\t\t\tif (onlyAvailable && !node.available)\n\t\t\t\treturn;\n\n\t\t\tif (withServices)\n\t\t\t\tres.push(_.omit(node, [\"rawInfo\"]));\n\t\t\telse\n\t\t\t\tres.push(_.omit(node, [\"services\", \"rawInfo\"]));\n\t\t});\n\n\t\treturn res;\n\t}\n\n\t/**\n\t * Get a copy from node list.\n\t */\n\ttoArray() {\n\t\treturn Array.from(this.nodes.values());\n\t}\n}\n\nmodule.exports = NodeCatalog;\n"],"names":["require$$0","node","Node","process"],"mappings":"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"}
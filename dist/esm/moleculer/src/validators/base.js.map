{"version":3,"file":"base.js","sources":["../../../../../src/moleculer/src/validators/base.js"],"sourcesContent":["/*\n * moleculer\n * Copyright (c) 2020 MoleculerJS (https://github.com/moleculerjs/moleculer)\n * MIT Licensed\n */\n\n\"use strict\";\n\nconst { ValidationError } = require(\"../errors\");\nconst _ = require(\"lodash\");\n\nclass BaseValidator {\n\n\tconstructor(opts) {\n\t\tthis.opts = _.defaultsDeep(opts, {\n\t\t\tparamName: \"params\"\n\t\t});\n\t}\n\n\tinit(broker) {\n\t\tthis.broker = broker;\n\t}\n\n\t/**\n\t * Compile a validation schema to a checker function.\n\t * @param {any} schema\n\t * @returns {Function}\n\t */\n\tcompile(/*schema*/) {\n\t\tthrow new Error(\"Abstract method\");\n\t}\n\n\t/**\n\t * Validate params againt the schema\n\t * @param {any} params\n\t * @param {any} schema\n\t * @returns {boolean}\n\t */\n\tvalidate(/*params, schema*/) {\n\t\tthrow new Error(\"Abstract method\");\n\t}\n\n\t/**\n\t * Convert the specific validation schema to\n\t * the Moleculer (fastest-validator) validation schema format.\n\t *\n\t * @param {any} schema\n\t * @returns {Object}\n\t */\n\tconvertSchemaToMoleculer(/*schema*/) {\n\t\tthrow new Error(\"Abstract method\");\n\t}\n\n\t/**\n\t * Register validator as a middleware\n\t *\n\t * @memberof BaseValidator\n\t */\n\tmiddleware(broker) {\n\t\tconst self = this;\n\t\tconst paramName = this.opts.paramName;\n\n\t\treturn {\n\t\t\tname: \"Validator\",\n\t\t\tlocalAction: function validatorMiddleware(handler, action) {\n\t\t\t\t// Wrap a param validator\n\t\t\t\tif (action[paramName] && typeof action[paramName] === \"object\") {\n\t\t\t\t\tconst check = self.compile(action[paramName]);\n\t\t\t\t\treturn function validateContextParams(ctx) {\n\t\t\t\t\t\tlet res = check(ctx.params != null ? ctx.params : {});\n\t\t\t\t\t\tif (res === true)\n\t\t\t\t\t\t\treturn handler(ctx);\n\t\t\t\t\t\telse {\n\t\t\t\t\t\t\tres = res.map(data => Object.assign(data, { nodeID: ctx.nodeID, action: ctx.action.name }));\n\t\t\t\t\t\t\treturn broker.Promise.reject(new ValidationError(\"Parameters validation error!\", null, res));\n\t\t\t\t\t\t}\n\t\t\t\t\t};\n\t\t\t\t}\n\t\t\t\treturn handler;\n\t\t\t},\n\n\t\t\tlocalEvent: function validatorMiddleware(handler, event) {\n\t\t\t\t// Wrap a param validator\n\t\t\t\tif (event[paramName] && typeof event[paramName] === \"object\") {\n\t\t\t\t\tconst check = self.compile(event[paramName]);\n\t\t\t\t\treturn function validateContextParams(ctx) {\n\t\t\t\t\t\tlet res = check(ctx.params != null ? ctx.params : {});\n\t\t\t\t\t\tif (res === true)\n\t\t\t\t\t\t\treturn handler(ctx);\n\t\t\t\t\t\telse {\n\t\t\t\t\t\t\tres = res.map(data => Object.assign(data, { nodeID: ctx.nodeID, event: ctx.event.name }));\n\t\t\t\t\t\t\treturn broker.Promise.reject(new ValidationError(\"Parameters validation error!\", null, res));\n\t\t\t\t\t\t}\n\t\t\t\t\t};\n\t\t\t\t}\n\t\t\t\treturn handler;\n\t\t\t}\n\t\t};\n\t}\n}\n\n\nmodule.exports = BaseValidator;\n"],"names":["require$$0"],"mappings":"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"}
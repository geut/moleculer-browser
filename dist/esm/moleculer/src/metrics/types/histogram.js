import{setTimeout as t}from"timers-browserify";import e from"lodash";import s from"../constants.js";import a from"../../utils.js";import i from"./base.js";import r from"../rates.js";const{isPlainObject:u}=a,n=(t,e)=>t-e,h=(t,e,s)=>(t[e]=s,t);class l extends i{constructor(t,e){super(t,e),this.type=s.TYPE_HISTOGRAM,u(t.linearBuckets)?this.buckets=l.generateLinearBuckets(t.linearBuckets.start,t.linearBuckets.width,t.linearBuckets.count):u(t.exponentialBuckets)?this.buckets=l.generateExponentialBuckets(t.exponentialBuckets.start,t.exponentialBuckets.factor,t.exponentialBuckets.count):Array.isArray(t.buckets)?this.buckets=Array.from(t.buckets):!0===t.buckets&&(this.buckets=this.registry.opts.defaultBuckets),this.buckets&&this.buckets.sort(n),Array.isArray(t.quantiles)?this.quantiles=Array.from(t.quantiles):!0===t.quantiles&&(this.quantiles=this.registry.opts.defaultQuantiles),this.quantiles&&(this.quantiles.sort(n),this.maxAgeSeconds=t.maxAgeSeconds||this.registry.opts.defaultMaxAgeSeconds,this.ageBuckets=t.ageBuckets||this.registry.opts.defaultAgeBuckets),this.rate=t.rate}observe(t,s,a){const i=this.hashingLabels(s);let u=this.values.get(i);if(u||(u=this.resetItem({labels:e.pick(s,this.labelNames)}),this.rate&&(u.rate=new r(this,u,1)),this.values.set(i,u)),u.timestamp=null==a?Date.now():a,u.sum+=t,u.count++,u.lastValue=t,u.bucketValues){const e=this.buckets.length;for(let s=0;s<e;s++)t<=this.buckets[s]&&(u.bucketValues[this.buckets[s]]+=1)}return u.quantileValues&&u.quantileValues.add(t),u.rate&&u.rate.update(u.count),this.changed(t,s,a),u}createBucketValues(){return this.buckets.reduce(((t,e)=>h(t,e,0)),{})}generateSnapshot(){return Array.from(this.values.keys()).map((t=>this.generateItemSnapshot(this.values.get(t),t)))}generateItemSnapshot(t,e){const s={key:e,labels:t.labels,count:t.count,sum:t.sum,lastValue:t.lastValue,timestamp:t.timestamp};return this.buckets&&(s.buckets=this.buckets.reduce(((e,s)=>h(e,s,t.bucketValues[s])),{})),this.quantiles&&Object.assign(s,t.quantileValues.snapshot()),t.rate&&(s.rate=t.rate.rate),s}resetItem(t,e){return t.timestamp=null==e?Date.now():e,t.sum=0,t.count=0,t.lastValue=null,this.buckets&&(t.bucketValues=this.createBucketValues()),this.quantiles&&(t.quantileValues=new c(this,this.quantiles,this.maxAgeSeconds,this.ageBuckets)),t}reset(t,e){const s=this.hashingLabels(t),a=this.values.get(s);a&&(this.resetItem(a,e),this.changed(null,t,e))}resetAll(t){this.values.forEach((e=>this.resetItem(e,t))),this.changed()}static generateLinearBuckets(t,e,s){const a=[];for(let i=0;i<s;i++)a.push(t+i*e);return a}static generateExponentialBuckets(t,e,s){const a=[];for(let i=0;i<s;i++)a[i]=t*Math.pow(e,i);return a}}class c{constructor(t,e,s,a){this.metric=t,this.quantiles=Array.from(e),this.maxAgeSeconds=s,this.ageBuckets=a,this.ringBuckets=[];for(let t=0;t<a;t++)this.ringBuckets.push(new o);this.dirty=!0,this.currentBucket=-1,this.rotate(),this.lastSnapshot=null,this.setDirty()}setDirty(){this.dirty=!0,this.metric.setDirty()}clearDirty(){this.dirty=!1}rotate(){this.currentBucket=(this.currentBucket+1)%this.ageBuckets,this.ringBuckets[this.currentBucket].clear(),this.setDirty(),t((()=>this.rotate()),this.maxAgeSeconds/this.ageBuckets*1e3).unref()}add(t){this.setDirty(),this.ringBuckets[this.currentBucket].add(t)}snapshot(){if(!this.dirty&&this.lastSnapshot)return this.lastSnapshot;const t=this.ringBuckets.reduce(((t,e)=>t.concat(e.samples)),[]);t.sort(n);const e=t.length?t.reduce(((t,e)=>t+e),0)/t.length:null,s=t.length>1?t.reduce(((t,s)=>t+Math.pow(s-e,2)),0)/(t.length-1):null,a=s?Math.sqrt(s):null;return this.lastSnapshot={min:t.length?t[0]:null,mean:e,variance:s,stdDev:a,max:t.length?t[t.length-1]:null,quantiles:this.quantiles.reduce(((e,s)=>h(e,s,t[Math.ceil(s*t.length)-1])),{})},this.clearDirty(),this.lastSnapshot}}class o{constructor(){this.count=0,this.samples=[]}add(t){this.samples.push(t),this.count++}clear(){this.count=0,this.samples.length=0}}l.Bucket=o,l.TimeWindowQuantiles=c;var k=l;export default k;
//# sourceMappingURL=histogram.js.map

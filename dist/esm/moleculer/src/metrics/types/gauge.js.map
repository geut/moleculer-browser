{"version":3,"file":"gauge.js","sources":["../../../../../../src/moleculer/src/metrics/types/gauge.js"],"sourcesContent":["/*\n * moleculer\n * Copyright (c) 2019 MoleculerJS (https://github.com/moleculerjs/moleculer)\n * MIT Licensed\n */\n\n\"use strict\";\n\nconst { pick } = require(\"lodash\");\nconst BaseMetric = require(\"./base\");\nconst METRIC = require(\"../constants\");\nconst MetricRate = require(\"../rates\");\n\n/**\n * Gauge metric class.\n *\n * @class GaugeMetric\n * @extends {BaseMetric}\n */\nclass GaugeMetric extends BaseMetric {\n\n\t/**\n\t * Creates an instance of GaugeMetric.\n\t * @param {Object} opts\n\t * @param {MetricRegistry} registry\n\t * @memberof GaugeMetric\n\t */\n\tconstructor(opts, registry) {\n\t\tsuper(opts, registry);\n\t\tthis.type = METRIC.TYPE_GAUGE;\n\t\tthis.rate = opts.rate;\n\t}\n\n\t/**\n\t * Increment value\n\t *\n\t * @param {Object} labels\n\t * @param {Number?} value\n\t * @param {Number?} timestamp\n\t * @returns\n\t * @memberof GaugeMetric\n\t */\n\tincrement(labels, value, timestamp) {\n\t\tif (value == null)\n\t\t\tvalue = 1;\n\n\t\tconst item = this.get(labels);\n\t\treturn this.set((item ? item.value : 0) + value, labels, timestamp);\n\t}\n\n\t/**\n\t * Decrement value.\n\t *\n\t * @param {Object} labels\n\t * @param {Number?} value\n\t * @param {Number?} timestamp\n\t * @returns\n\t * @memberof GaugeMetric\n\t */\n\tdecrement(labels, value, timestamp) {\n\t\tif (value == null)\n\t\t\tvalue = 1;\n\n\t\tconst item = this.get(labels);\n\t\treturn this.set((item ? item.value : 0) - value, labels, timestamp);\n\t}\n\n\t/**\n\t * Set value.\n\t *\n\t * @param {Number?} value\n\t * @param {Object} labels\n\t * @param {Number?} timestamp\n\t * @returns\n\t * @memberof GaugeMetric\n\t */\n\tset(value, labels, timestamp) {\n\t\tconst hash = this.hashingLabels(labels);\n\t\tlet item = this.values.get(hash);\n\t\tif (item) {\n\t\t\tif (item.value != value) {\n\t\t\t\titem.value = value;\n\t\t\t\titem.timestamp = timestamp == null ? Date.now() : timestamp;\n\n\t\t\t\tif (item.rate)\n\t\t\t\t\titem.rate.update(value);\n\n\t\t\t\tthis.changed(value, labels, timestamp);\n\t\t\t}\n\t\t} else {\n\t\t\titem = {\n\t\t\t\tvalue,\n\t\t\t\tlabels: pick(labels, this.labelNames),\n\t\t\t\ttimestamp: timestamp == null ? Date.now() : timestamp,\n\t\t\t};\n\t\t\tthis.values.set(hash, item);\n\n\t\t\tif (this.rate) {\n\t\t\t\titem.rate = new MetricRate(this, item, 1);\n\t\t\t\titem.rate.update(value);\n\t\t\t}\n\n\t\t\tthis.changed(value, labels, timestamp);\n\t\t}\n\n\t\treturn item;\n\t}\n\n\t/**\n\t * Reset item by labels.\n\t *\n\t * @param {Object} labels\n\t * @param {Number?} timestamp\n\t * @returns\n\t * @memberof GaugeMetric\n\t */\n\treset(labels, timestamp) {\n\t\treturn this.set(0, labels, timestamp);\n\t}\n\n\t/**\n\t * Reset all items.\n\t *\n\t * @param {Number?} timestamp\n\t * @memberof GaugeMetric\n\t */\n\tresetAll(timestamp) {\n\t\tthis.values.forEach(item => {\n\t\t\titem.value = 0;\n\t\t\titem.timestamp = timestamp == null ? Date.now() : timestamp;\n\t\t});\n\t\tthis.changed(null, null, timestamp);\n\t}\n\n\t/**\n\t * Generate a snapshot.\n\t *\n\t * @returns {Array<Object>}\n\t * @memberof GaugeMetric\n\t */\n\tgenerateSnapshot() {\n\t\tconst snapshot = Array.from(this.values.keys()).map(key => {\n\t\t\tconst item = this.values.get(key);\n\t\t\tconst res = {\n\t\t\t\tkey,\n\t\t\t\tvalue: item.value,\n\t\t\t\tlabels: item.labels,\n\t\t\t\ttimestamp: item.timestamp\n\t\t\t};\n\n\t\t\tif (item.rate)\n\t\t\t\tres.rate = item.rate.rate;\n\n\t\t\treturn res;\n\t\t});\n\n\t\treturn snapshot;\n\t}\n}\n\nmodule.exports = GaugeMetric;\n"],"names":["require$$0","BaseMetric","METRIC","MetricRate"],"mappings":"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"}
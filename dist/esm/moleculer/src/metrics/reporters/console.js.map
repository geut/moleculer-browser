{"version":3,"file":"console.js","sources":["../../../../../../src/moleculer/src/metrics/reporters/console.js"],"sourcesContent":["/*\n * moleculer\n * Copyright (c) 2019 MoleculerJS (https://github.com/moleculerjs/moleculer)\n * MIT Licensed\n */\n\n\"use strict\";\n\nconst BaseReporter = require(\"./base\");\nconst _ = require(\"lodash\");\nconst kleur = require(\"kleur\");\nconst METRIC = require(\"../constants\");\nconst { isFunction } = require(\"../../utils\");\n\n/**\n * Console reporter for Moleculer Metrics\n *\n * @class ConsoleReporter\n * @extends {BaseReporter}\n */\nclass ConsoleReporter extends BaseReporter {\n\n\t/**\n\t * Creates an instance of ConsoleReporter.\n\t * @param {Object} opts\n\t * @memberof ConsoleReporter\n\t */\n\tconstructor(opts) {\n\t\tsuper(opts);\n\n\t\tthis.opts = _.defaultsDeep(this.opts, {\n\t\t\tinterval: 5,\n\t\t\tlogger: null,\n\t\t\tcolors: true,\n\t\t\tonlyChanges: true,\n\t\t});\n\n\t\tif (!this.opts.colors)\n\t\t\tkleur.enabled = false;\n\n\t\tthis.lastChanges = new Set();\n\t}\n\n\t/**\n\t * Initialize reporter\n\t * @param {MetricRegistry} registry\n\t * @memberof ConsoleReporter\n\t */\n\tinit(registry) {\n\t\tsuper.init(registry);\n\n\t\tif (this.opts.interval > 0) {\n\t\t\tthis.timer = setInterval(() => this.print(), this.opts.interval * 1000);\n\t\t\tthis.timer.unref();\n\t\t}\n\t}\n\n\t/**\n\t * Convert labels to label string\n\t *\n\t * @param {Object} labels\n\t * @returns {String}\n\t * @memberof ConsoleReporter\n\t */\n\tlabelsToStr(labels) {\n\t\tconst keys = Object.keys(labels);\n\t\tif (keys.length == 0)\n\t\t\treturn kleur.gray(\"{}\");\n\n\t\treturn kleur.gray(\"{\") + keys.map(key => `${kleur.gray(this.formatLabelName(key))}: ${kleur.magenta(\"\" + labels[key])}`).join(\", \") + kleur.gray(\"}\");\n\t}\n\n\t/**\n\t * Print metrics to the console.\n\t *\n\t * @memberof ConsoleReporter\n\t */\n\tprint() {\n\t\tlet list = this.registry.list({\n\t\t\tincludes: this.opts.includes,\n\t\t\texcludes: this.opts.excludes,\n\t\t});\n\n\t\tif (this.opts.onlyChanges)\n\t\t\tlist = list.filter(metric => this.lastChanges.has(metric.name));\n\n\t\tif (list.length == 0)\n\t\t\treturn;\n\n\t\tthis.log(kleur.gray(`------------------- [ METRICS START (${list.length}) ] -------------------`));\n\n\t\tlist.forEach(metric => {\n\t\t\tthis.log(kleur.cyan().bold(this.formatMetricName(metric.name)) + \" \" + kleur.gray(\"(\" + metric.type + \")\"));\n\t\t\tif (metric.values.size == 0) {\n\t\t\t\tthis.log(kleur.gray(\"  <no values>\"));\n\t\t\t} else {\n\t\t\t\tconst unit = metric.unit ? kleur.gray(this.registry.pluralizeUnit(metric.unit)) : \"\";\n\t\t\t\tmetric.values.forEach(item => {\n\t\t\t\t\tlet val;\n\t\t\t\t\tconst labelStr = this.labelsToStr(item.labels);\n\t\t\t\t\tswitch(metric.type) {\n\t\t\t\t\t\tcase METRIC.TYPE_COUNTER:\n\t\t\t\t\t\tcase METRIC.TYPE_GAUGE:\n\t\t\t\t\t\tcase METRIC.TYPE_INFO:\n\t\t\t\t\t\t\tval = item.value === \"\" ? kleur.grey(\"<empty string>\") : kleur.green().bold(item.value);\n\t\t\t\t\t\t\tif (item.rate != null) {\n\t\t\t\t\t\t\t\t/*const s = [];\n\t\t\t\t\t\t\t\tObject.keys(item.rates).forEach(b => {\n\t\t\t\t\t\t\t\t\ts.push(`Rate${b}: ${item.rates[b] != null ? item.rates[b].toFixed(2) : \"-\"}`);\n\t\t\t\t\t\t\t\t});\n\n\t\t\t\t\t\t\t\tval = kleur.green().bold(`Value: ${val} | ` + s.join(\" | \"));\n\t\t\t\t\t\t\t\t*/\n\n\t\t\t\t\t\t\t\tval = val + kleur.grey(\" | Rate: \") + (item.rate != null ? kleur.green().bold(item.rate.toFixed(2)) : \"-\");\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\tcase METRIC.TYPE_HISTOGRAM: {\n\t\t\t\t\t\t\tconst s = [];\n\t\t\t\t\t\t\ts.push(`Count: ${item.count}`);\n\n\t\t\t\t\t\t\tif (item.buckets) {\n\t\t\t\t\t\t\t\tObject.keys(item.buckets).forEach(b => {\n\t\t\t\t\t\t\t\t\ts.push(`${b}: ${item.buckets[b] != null ? item.buckets[b] : \"-\"}`);\n\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\tif (item.quantiles) {\n\t\t\t\t\t\t\t\ts.push(`Min: ${item.min != null ? item.min.toFixed(2) : \"-\"}`);\n\t\t\t\t\t\t\t\ts.push(`Mean: ${item.mean != null ? item.mean.toFixed(2) : \"-\"}`);\n\t\t\t\t\t\t\t\ts.push(`Var: ${item.variance != null ? item.variance.toFixed(2) : \"-\"}`);\n\t\t\t\t\t\t\t\ts.push(`StdDev: ${item.stdDev != null ? item.stdDev.toFixed(2) : \"-\"}`);\n\t\t\t\t\t\t\t\ts.push(`Max: ${item.max != null ? item.max.toFixed(2) : \"-\"}`);\n\n\t\t\t\t\t\t\t\tObject.keys(item.quantiles).forEach(key => {\n\t\t\t\t\t\t\t\t\ts.push(`${key}: ${item.quantiles[key] != null ? item.quantiles[key].toFixed(2) : \"-\"}`);\n\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\tif (item.rate != null)\n\t\t\t\t\t\t\t\ts.push(`Rate: ${item.rate != null ? item.rate.toFixed(2) : \"-\"}`);\n\n\t\t\t\t\t\t\tval = kleur.green().bold(s.join(\" | \"));\n\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\tthis.log(`  ${labelStr}: ${val} ${unit}`);\n\t\t\t\t});\n\t\t\t}\n\t\t\tthis.log(\"\");\n\t\t});\n\n\t\tthis.log(kleur.gray(`-------------------- [ METRICS END (${list.length}) ] --------------------`));\n\n\t\tthis.lastChanges.clear();\n\t}\n\n\t/**\n\t * Print messages\n\t *\n\t * @param  {...any} args\n\t */\n\tlog(...args) {\n\t\tif (isFunction(this.opts.logger)) {\n\t\t\treturn this.opts.logger(...args);\n\t\t} else {\n\t\t\treturn this.logger.info(...args);\n\t\t}\n\t}\n\n\t/**\n\t * Some metric has been changed.\n\t *\n\t * @param {BaseMetric} metric\n\t * @param {any} value\n\t * @param {Object} labels\n\t * @param {Number?} timestamp\n\t *\n\t * @memberof BaseReporter\n\t */\n\tmetricChanged(metric) {\n\t\tif (!this.matchMetricName(metric.name)) return;\n\n\t\tthis.lastChanges.add(metric.name);\n\t}\n}\n\nmodule.exports = ConsoleReporter;\n"],"names":["require$$0","BaseReporter","METRIC"],"mappings":"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"}
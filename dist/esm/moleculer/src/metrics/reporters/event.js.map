{"version":3,"file":"event.js","sources":["../../../../../../src/moleculer/src/metrics/reporters/event.js"],"sourcesContent":["/*\n * moleculer\n * Copyright (c) 2019 MoleculerJS (https://github.com/moleculerjs/moleculer)\n * MIT Licensed\n */\n\n\"use strict\";\n\nconst BaseReporter = require(\"./base\");\nconst _ = require(\"lodash\");\n\n/**\n * Event reporter for Moleculer Metrics\n *\n * @class EventReporter\n * @extends {BaseReporter}\n */\nclass EventReporter extends BaseReporter {\n\n\t/**\n\t * Creates an instance of EventReporter.\n\t * @param {Object} opts\n\t * @memberof EventReporter\n\t */\n\tconstructor(opts) {\n\t\tsuper(opts);\n\n\t\tthis.opts = _.defaultsDeep(this.opts, {\n\t\t\teventName: \"$metrics.snapshot\",\n\n\t\t\tbroadcast: false,\n\t\t\tgroups: null,\n\n\t\t\tonlyChanges: false,\n\n\t\t\tinterval: 5,\n\t\t});\n\n\t\tthis.lastChanges = new Set();\n\t}\n\n\t/**\n\t * Initialize reporter.\n\t *\n\t * @param {MetricRegistry} registry\n\t * @memberof EventReporter\n\t */\n\tinit(registry) {\n\t\tsuper.init(registry);\n\n\t\tif (this.opts.interval > 0) {\n\t\t\tthis.timer = setInterval(() => this.sendEvent(), this.opts.interval * 1000);\n\t\t\tthis.timer.unref();\n\t\t}\n\t}\n\n\t/**\n\t * Send metrics snapshot via event.\n\t *\n\t * @memberof EventReporter\n\t */\n\tsendEvent() {\n\t\tlet list = this.registry.list({\n\t\t\tincludes: this.opts.includes,\n\t\t\texcludes: this.opts.excludes,\n\t\t});\n\n\t\tif (this.opts.onlyChanges)\n\t\t\tlist = list.filter(metric => this.lastChanges.has(metric.name));\n\n\t\tif (list.length == 0)\n\t\t\treturn;\n\n\t\tif (this.opts.broadcast) {\n\t\t\tthis.logger.debug(`Send metrics.snapshot (${list.length} metrics) broadcast events.`);\n\t\t\tthis.broker.broadcast(this.opts.eventName, list, { groups: this.opts.groups });\n\t\t} else {\n\t\t\tthis.logger.debug(`Send metrics.snapshot (${list.length} metrics) events.`);\n\t\t\tthis.broker.emit(this.opts.eventName, list, { groups: this.opts.groups });\n\t\t}\n\n\t\tthis.lastChanges.clear();\n\t}\n\n\n\t/**\n\t * Some metric has been changed.\n\t *\n\t * @param {BaseMetric} metric\n\t * @param {any} value\n\t * @param {Object} labels\n\t * @param {Number?} timestamp\n\t *\n\t * @memberof BaseReporter\n\t */\n\tmetricChanged(metric) {\n\t\tif (!this.matchMetricName(metric.name)) return;\n\n\t\tthis.lastChanges.add(metric.name);\n\t}\n}\n\nmodule.exports = EventReporter;\n"],"names":["BaseReporter"],"mappings":"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"}
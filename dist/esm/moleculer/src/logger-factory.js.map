{"version":3,"file":"logger-factory.js","sources":["../../../../src/moleculer/src/logger-factory.js"],"sourcesContent":["/*\n * moleculer\n * Copyright (c) 2020 MoleculerJS (https://github.com/moleculerjs/moleculer)\n * MIT Licensed\n */\n\n\"use strict\";\n\nconst _ = require(\"lodash\");\nconst { isPlainObject, isString } = require(\"./utils\");\nconst Loggers = require(\"./loggers\");\n\nconst noop = () => {};\nconst cwd = process.cwd();\n\n/**\n * Log factory class.\n *\n * @class LoggerFactory\n */\nclass LoggerFactory {\n\n\t/**\n\t * Constructor of LoggerFactory\n\t */\n\tconstructor(broker) {\n\t\tthis.broker = broker;\n\t\tthis.appenders = [];\n\t\tthis.cache = new Map();\n\t}\n\n\t/**\n\t * Initialize module.\n\t */\n\tinit(opts) {\n\t\tthis.opts = opts;\n\n\t\tconst globalLogLevel = this.broker.options.logLevel || \"info\";\n\n\t\tif (opts === false || opts == null) {\n\t\t\t// No logger\n\t\t\tthis.appenders = [];\n\n\t\t} else if (opts === true || opts === console) {\n\t\t\t// Default console logger\n\t\t\tthis.appenders = [Loggers.resolve({\n\t\t\t\ttype: \"Console\",\n\t\t\t\toptions: {\n\t\t\t\t\tlevel: globalLogLevel\n\t\t\t\t}\n\t\t\t})];\n\n\t\t} else {\n\t\t\tif (!Array.isArray(opts)) {\n\t\t\t\topts = [opts];\n\t\t\t}\n\n\t\t\tthis.appenders = _.compact(opts).map(o => {\n\t\t\t\t// Built-in shorthand\n\t\t\t\tif (isString(o))\n\t\t\t\t\treturn Loggers.resolve({ type: o, options: { level: globalLogLevel } });\n\n\t\t\t\t// Build-in with options\n\t\t\t\tif (isPlainObject(o))\n\t\t\t\t\treturn Loggers.resolve(_.defaultsDeep({}, o, { options: { level: globalLogLevel } }));\n\n\t\t\t\t// Custom logger instance\n\t\t\t\treturn Loggers.resolve(o);\n\t\t\t});\n\t\t}\n\n\t\t// Initialize appenders\n\t\tthis.appenders.forEach(app => app.init(this));\n\t}\n\n\t/**\n\t * Stopping all appenders\n\t */\n\tstop() {\n\t\treturn this.broker.Promise.all(this.appenders.map(appender => appender.stop()));\n\t}\n\n\t/**\n\t * Get caller information from error stack trace.\n\t */\n\tgetCallerFromStack() {\n\t\tconst _prepareStackTrace = Error.prepareStackTrace;\n\t\tError.prepareStackTrace = (_, stack) => stack;\n\t\tconst stack = new Error().stack;\n\t\tError.prepareStackTrace = _prepareStackTrace;\n\n\t\tif (stack.length > 2) {\n\t\t\tconst site = stack[2];\n\t\t\treturn {\n\t\t\t\tfilename: site.getFileName().substring(cwd.length + 1),\n\t\t\t\tlineNumber: site.getLineNumber(),\n\t\t\t\tcolumnNumber: site.getColumnNumber(),\n\t\t\t\tmethodName: site.getMethodName(),\n\t\t\t\tfunctionName: site.getFunctionName(),\n\t\t\t};\n\t\t}\n\t}\n\n\t/**\n\t * Get a logger for a module (service, transporter, cacher, context...etc)\n\t *\n\t * @param {Object} bindings\n\t * @returns {ModuleLogger}\n\t *\n\t * @memberof ServiceBroker\n\t */\n\tgetLogger(bindings) {\n\t\tlet logger = this.cache.get(this.getBindingsKey(bindings));\n\t\tif (logger) return logger;\n\n\t\tlogger = {};\n\t\tconst broker = this.broker;\n\t\tconst appenders = this.appenders;\n\n\t\tconst logHandlers = _.compact(appenders.map(app => app.getLogHandler(bindings)));\n\n\t\tLoggers.LEVELS.forEach((type) => {\n\t\t\tif (logHandlers.length == 0)\n\t\t\t\treturn logger[type] = noop;\n\n\t\t\tlogger[type] = function(...args) {\n\t\t\t\tif (broker.middlewares && broker.middlewares.registeredHooks.newLogEntry)\n\t\t\t\t\tbroker.middlewares.callSyncHandlers(\"newLogEntry\", [type, args, bindings], {});\n\n\t\t\t\tif (logHandlers.length == 0) return;\n\n\t\t\t\tfor(let i = 0; i < logHandlers.length; i++)\n\t\t\t\t\tlogHandlers[i](type, args);\n\t\t\t};\n\t\t});\n\n\t\t/*logger.log = function(type, ...args) {\n\t\t\tif (broker.middlewares)\n\t\t\t\tbroker.middlewares.callSyncHandlers(\"newLogEntry\", [type, args, bindings], {});\n\n\t\t\tif (logHandlers.length == 0) return;\n\n\t\t\tlogHandlers.forEach(fn => fn(type, args));\n\t\t};*/\n\n\t\tlogger.appenders = appenders;\n\n\n\t\tthis.cache.set(this.getBindingsKey(bindings), logger);\n\n\t\treturn logger;\n\t}\n\n\t/**\n\t * Create a key from bindings for logger caching.\n\t *\n\t * @param {object} bindings\n\t * @returns {String}\n\t */\n\tgetBindingsKey(bindings) {\n\t\tif (!bindings) return \"\";\n\n\t\treturn [\"nodeID\", \"ns\", \"mod\"]\n\t\t\t.map(key => bindings[key])\n\t\t\t.join(\"|\");\n\t}\n\n}\n\nmodule.exports = LoggerFactory;\n"],"names":["require$$0","process","Loggers"],"mappings":"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"}
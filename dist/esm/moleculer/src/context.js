import t from"../../process.js";import e from"lodash";import s from"./errors.js";import r from"./utils.js";import i from"util";const{isString:n}=r,{RequestSkippedError:a,MaxCallLevelError:o}=s;function l(t,e){return e&&Object.assign(t.meta,e),t.meta}class c{constructor(t,e){this.broker=t,this.broker?(this.nodeID=this.broker.nodeID,this.id=this.broker.generateUid()):this.nodeID=null,e?this.setEndpoint(e):(this.endpoint=null,this.service=null,this.action=null,this.event=null),this.eventName=null,this.eventType=null,this.eventGroups=null,this.options={timeout:null,retries:null},this.parentID=null,this.caller=null,this.level=1,this.params=null,this.meta={},this.locals={},this.requestID=this.id,this.tracing=null,this.span=null,this._spanStack=[],this.needAck=null,this.ackID=null,this.cachedResult=!1}static create(t,e,s,r={}){const i=new t.ContextFactory(t,e);if(null!=e&&i.setEndpoint(e),null!=s){let e=!!t&&t.options.contextParamsCloning;null!=r.paramsCloning&&(e=r.paramsCloning),i.setParams(s,e)}return i.options=r,null!=r.requestID?i.requestID=r.requestID:null!=r.parentCtx&&null!=r.parentCtx.requestID&&(i.requestID=r.parentCtx.requestID),null!=r.parentCtx&&null!=r.parentCtx.meta?i.meta=Object.assign({},r.parentCtx.meta||{},r.meta||{}):null!=r.meta&&(i.meta=r.meta),null!=r.parentCtx&&(i.tracing=r.parentCtx.tracing,i.level=r.parentCtx.level+1,r.parentCtx.span?i.parentID=r.parentCtx.span.id:i.parentID=r.parentCtx.id,r.parentCtx.service&&(i.caller=r.parentCtx.service.fullName)),r.caller&&(i.caller=r.caller),null!=r.parentSpan&&(i.parentID=r.parentSpan.id,i.requestID=r.parentSpan.traceID,i.tracing=r.parentSpan.sampled),r.needAck&&(i.needAck=r.needAck),i}copy(t){const e=new this.constructor(this.broker);return e.nodeID=this.nodeID,e.setEndpoint(t||this.endpoint),e.options=this.options,e.parentID=this.parentID,e.caller=this.caller,e.level=this.level,e.params=this.params,e.meta=this.meta,e.locals=this.locals,e.requestID=this.requestID,e.tracing=this.tracing,e.span=this.span,e.needAck=this.needAck,e.ackID=this.ackID,e.eventName=this.eventName,e.eventType=this.eventType,e.eventGroups=this.eventGroups,e.cachedResult=this.cachedResult,e}setEndpoint(t){this.endpoint=t,t&&(this.nodeID=t.id,t.action?(this.action=t.action,this.service=this.action.service,this.event=null):t.event&&(this.event=t.event,this.service=this.event.service,this.action=null))}setParams(t,e=!1){this.params=e&&t?Object.assign({},t):t}call(e,s,r){const i=Object.assign({parentCtx:this},r);if(this.options.timeout>0&&this.startHrTime){const s=t.hrtime(this.startHrTime),r=1e3*s[0]+s[1]/1e6,n=this.options.timeout-r;if(n<=0)return this.broker.Promise.reject(new a({action:e,nodeID:this.broker.nodeID}));(!i.timeout||n<i.timeout)&&(i.timeout=n)}if(this.broker.options.maxCallLevel>0&&this.level>=this.broker.options.maxCallLevel)return this.broker.Promise.reject(new o({nodeID:this.broker.nodeID,level:this.level}));let n=this.broker.call(e,s,i);return n.then((t=>(n.ctx&&l(this,n.ctx.meta),t))).catch((t=>(n.ctx&&l(this,n.ctx.meta),this.broker.Promise.reject(t))))}mcall(e,s){const r=Object.assign({parentCtx:this},s);if(this.options.timeout>0&&this.startHrTime){const s=t.hrtime(this.startHrTime),i=1e3*s[0]+s[1]/1e6,n=this.options.timeout-i;if(n<=0){const t=(Array.isArray(e)?e:Object.values(e)).map((t=>t.action)).join(", ");return this.broker.Promise.reject(new a({action:t,nodeID:this.broker.nodeID}))}(!r.timeout||n<r.timeout)&&(r.timeout=n)}if(this.broker.options.maxCallLevel>0&&this.level>=this.broker.options.maxCallLevel)return this.broker.Promise.reject(new o({nodeID:this.broker.nodeID,level:this.level}));let i=this.broker.mcall(e,r);return i.then((t=>(Array.isArray(i.ctx)&&i.ctx.length&&i.ctx.forEach((t=>l(this,t.meta))),t))).catch((t=>(Array.isArray(i.ctx)&&i.ctx.length&&i.ctx.forEach((t=>l(this,t.meta))),this.broker.Promise.reject(t))))}emit(t,e,s){return Array.isArray(s)||n(s)?s={groups:s}:null==s&&(s={}),s.groups&&!Array.isArray(s.groups)&&(s.groups=[s.groups]),s.parentCtx=this,this.broker.emit(t,e,s)}broadcast(t,e,s){return Array.isArray(s)||n(s)?s={groups:s}:null==s&&(s={}),s.groups&&!Array.isArray(s.groups)&&(s.groups=[s.groups]),s.parentCtx=this,this.broker.broadcast(t,e,s)}startSpan(t,e){let s;return s=this.span?this.span.startSpan(t,Object.assign({ctx:this},e)):this.broker.tracer.startSpan(t,Object.assign({ctx:this},e)),this._spanStack.push(s),this.span=s,s}finishSpan(t,e){if(!t.isActive())return;t.finish(e);const s=this._spanStack.findIndex((e=>e==t));-1!==s?(this._spanStack.splice(s,1),this.span=this._spanStack[this._spanStack.length-1]):this.service.logger.warn("This span is not assigned to this context",t)}toJSON(){return e.pick(this,["id","nodeID","action.name","event.name","service.name","service.version","service.fullName","options","parentID","caller","level","params","meta","requestID","tracing","span","needAck","ackID","eventName","eventType","eventGroups","cachedResult"])}[i.inspect.custom](t,e){if(t<0)return e.stylize("[Context]","special");const s=i.inspect(this.toJSON(),e);return`${e.stylize("Context","special")}< ${s} >`}}var h=c;export default h;
//# sourceMappingURL=context.js.map

{"version":3,"file":"error-handler.js","sources":["../../../../../src/moleculer/src/middlewares/error-handler.js"],"sourcesContent":["/*\n * moleculer\n * Copyright (c) 2018 MoleculerJS (https://github.com/moleculerjs/moleculer)\n * MIT Licensed\n */\n\n\"use strict\";\n\nconst { MoleculerError } = require(\"../errors\");\n\nfunction wrapActionErrorHandler(handler) {\n\treturn function errorHandlerMiddleware(ctx) {\n\t\t// Call the handler\n\t\treturn handler(ctx)\n\t\t\t.catch(err => {\n\t\t\t\tif (!(err instanceof Error))\n\t\t\t\t\terr = new MoleculerError(err, 500);\n\n\t\t\t\tif (ctx.nodeID !== this.nodeID) {\n\t\t\t\t\t// Remove pending request (the request didn't reach the target service)\n\t\t\t\t\tif (this.transit)\n\t\t\t\t\t\tthis.transit.removePendingRequest(ctx.id);\n\t\t\t\t}\n\n\t\t\t\tthis.logger.debug(`The '${ctx.action.name}' request is rejected.`, { requestID: ctx.requestID }, err);\n\n\t\t\t\tObject.defineProperty(err, \"ctx\", {\n\t\t\t\t\tvalue: ctx,\n\t\t\t\t\twritable: true,\n\t\t\t\t\tenumerable: false\n\t\t\t\t});\n\n\t\t\t\t// Call global errorHandler\n\t\t\t\treturn ctx.broker.errorHandler(err, {\n\t\t\t\t\tctx,\n\t\t\t\t\tservice: ctx.service,\n\t\t\t\t\taction: ctx.action\n\t\t\t\t});\n\t\t\t});\n\n\t}.bind(this);\n}\n\nfunction wrapEventErrorHandler(handler) {\n\treturn function errorHandlerMiddleware(ctx) {\n\t\t// Call the handler\n\t\treturn handler(ctx)\n\t\t\t.catch(err => {\n\t\t\t\tif (!(err instanceof Error))\n\t\t\t\t\terr = new MoleculerError(err, 500);\n\n\t\t\t\tthis.logger.debug(`Error occured in the '${ctx.event.name}' event handler in the '${ctx.service.fullName}' service.`, { requestID: ctx.requestID }, err);\n\n\t\t\t\tObject.defineProperty(err, \"ctx\", {\n\t\t\t\t\tvalue: ctx,\n\t\t\t\t\twritable: true,\n\t\t\t\t\tenumerable: false\n\t\t\t\t});\n\n\t\t\t\t// Call global errorHandler\n\t\t\t\treturn ctx.broker.errorHandler(err, {\n\t\t\t\t\tctx,\n\t\t\t\t\tservice: ctx.service,\n\t\t\t\t\tevent: ctx.event\n\t\t\t\t});\n\t\t\t}).catch(err => {\n\t\t\t\t// No global error Handler, or thrown further, so we handle it because it's an event handler.\n\t\t\t\tctx.broker.logger.error(err);\n\t\t\t});\n\n\t}.bind(this);\n}\n\nmodule.exports = function() {\n\treturn {\n\t\tname: \"ErrorHandler\",\n\n\t\tlocalAction: wrapActionErrorHandler,\n\t\tremoteAction: wrapActionErrorHandler,\n\n\t\tlocalEvent: wrapEventErrorHandler\n\t};\n};\n"],"names":["require$$0"],"mappings":"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"}
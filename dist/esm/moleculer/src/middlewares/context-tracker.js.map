{"version":3,"file":"context-tracker.js","sources":["../../../../../src/moleculer/src/middlewares/context-tracker.js"],"sourcesContent":["/*\n * moleculer\n * Copyright (c) 2020 MoleculerJS (https://github.com/moleculerjs/moleculer)\n * MIT Licensed\n */\n\n\"use strict\";\n\nconst { GracefulStopTimeoutError } = require(\"../errors\");\n\nmodule.exports = function ContextTrackerMiddleware(broker) {\n\n\tfunction addContext(ctx) {\n\t\tif (ctx.service) {\n\t\t// Local request\n\t\t\tctx.service._trackedContexts.push(ctx);\n\t\t} else {\n\t\t// Remote request\n\t\t\tctx.broker._trackedContexts.push(ctx);\n\t\t}\n\t}\n\n\tfunction removeContext(ctx) {\n\t\tif (ctx.service) {\n\t\t\tconst idx = ctx.service._trackedContexts.indexOf(ctx);\n\t\t\tif (idx !== -1)\n\t\t\t\tctx.service._trackedContexts.splice(idx, 1);\n\t\t} else {\n\t\t\tconst idx = ctx.broker._trackedContexts.indexOf(ctx);\n\t\t\tif (idx !== -1)\n\t\t\t\tctx.broker._trackedContexts.splice(idx, 1);\n\t\t}\n\t}\n\n\tfunction wrapTrackerMiddleware(handler) {\n\t\tif (this.options.tracking && this.options.tracking.enabled) {\n\n\t\t\treturn function ContextTrackerMiddleware(ctx) {\n\n\t\t\t\tconst tracked = ctx.options.tracking != null ? ctx.options.tracking : this.options.tracking.enabled;\n\n\t\t\t\t// If no need to track\n\t\t\t\tif (!tracked)\n\t\t\t\t\treturn handler(ctx);\n\n\t\t\t\t// Track the context\n\t\t\t\taddContext(ctx);\n\n\t\t\t\t// Call the handler\n\t\t\t\tlet p = handler(ctx);\n\n\t\t\t\tp = p.then(res => {\n\t\t\t\t\tremoveContext(ctx);\n\t\t\t\t\treturn res;\n\t\t\t\t}).catch(err => {\n\t\t\t\t\tremoveContext(ctx);\n\t\t\t\t\tthrow err;\n\t\t\t\t});\n\n\t\t\t\treturn p;\n\t\t\t}.bind(this);\n\t\t}\n\n\t\treturn handler;\n\t}\n\n\tfunction waitingForActiveContexts(list, logger, time, service) {\n\t\tif (!list || list.length === 0)\n\t\t\treturn broker.Promise.resolve();\n\n\t\treturn new broker.Promise((resolve) => {\n\t\t\tlet timedOut = false;\n\t\t\tconst timeout = setTimeout(() => {\n\t\t\t\ttimedOut = true;\n\t\t\t\tlogger.error(new GracefulStopTimeoutError({ service }));\n\t\t\t\tlist.length = 0; // Clear pointers\n\t\t\t\tresolve();\n\t\t\t}, time);\n\n\t\t\tlet first = true;\n\t\t\tconst checkForContexts = () => {\n\t\t\t\tif (list.length === 0) {\n\t\t\t\t\tclearTimeout(timeout);\n\t\t\t\t\tresolve();\n\t\t\t\t} else {\n\t\t\t\t\tif (first) {\n\t\t\t\t\t\tlogger.warn(`Waiting for ${list.length} running context(s)...`);\n\t\t\t\t\t\tfirst = false;\n\t\t\t\t\t}\n\t\t\t\t\tif (!timedOut)\n\t\t\t\t\t\tsetTimeout(checkForContexts, 100);\n\t\t\t\t}\n\t\t\t};\n\t\t\tsetImmediate(checkForContexts);\n\t\t});\n\t}\n\n\treturn {\n\t\tname: \"ContextTracker\",\n\n\t\tlocalAction: wrapTrackerMiddleware,\n\t\tremoteAction: wrapTrackerMiddleware,\n\n\t\tlocalEvent: wrapTrackerMiddleware,\n\n\t\t// After the broker created\n\t\tcreated(broker) {\n\t\t\tbroker._trackedContexts = [];\n\t\t},\n\n\t\t// Before a local service started\n\t\tserviceStarting(service) {\n\t\t\tservice._trackedContexts = [];\n\t\t},\n\n\t\t// Before a local service stopping\n\t\tserviceStopping(service) {\n\t\t\treturn waitingForActiveContexts(service._trackedContexts, service.logger, service.settings.$shutdownTimeout || service.broker.options.tracking.shutdownTimeout, service);\n\t\t},\n\n\t\t// Before broker stopping\n\t\tstopping(broker) {\n\t\t\treturn waitingForActiveContexts(broker._trackedContexts, broker.logger, broker.options.tracking.shutdownTimeout);\n\t\t},\n\t};\n};\n"],"names":["require$$0"],"mappings":"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"}
{"version":3,"file":"context-tracker.js","sources":["../../../../../src/moleculer/src/middlewares/context-tracker.js"],"sourcesContent":["/*\n * moleculer\n * Copyright (c) 2020 MoleculerJS (https://github.com/moleculerjs/moleculer)\n * MIT Licensed\n */\n\n\"use strict\";\n\nconst { GracefulStopTimeoutError } = require(\"../errors\");\n\nmodule.exports = function ContextTrackerMiddleware(broker) {\n\n\tfunction addContext(ctx) {\n\t\tif (ctx.service) {\n\t\t// Local request\n\t\t\tctx.service._trackedContexts.push(ctx);\n\t\t} else {\n\t\t// Remote request\n\t\t\tctx.broker._trackedContexts.push(ctx);\n\t\t}\n\t}\n\n\tfunction removeContext(ctx) {\n\t\tif (ctx.service) {\n\t\t\tconst idx = ctx.service._trackedContexts.indexOf(ctx);\n\t\t\tif (idx !== -1)\n\t\t\t\tctx.service._trackedContexts.splice(idx, 1);\n\t\t} else {\n\t\t\tconst idx = ctx.broker._trackedContexts.indexOf(ctx);\n\t\t\tif (idx !== -1)\n\t\t\t\tctx.broker._trackedContexts.splice(idx, 1);\n\t\t}\n\t}\n\n\tfunction wrapTrackerMiddleware(handler) {\n\t\tif (this.options.tracking && this.options.tracking.enabled) {\n\n\t\t\treturn function ContextTrackerMiddleware(ctx) {\n\n\t\t\t\tconst tracked = ctx.options.tracking != null ? ctx.options.tracking : this.options.tracking.enabled;\n\n\t\t\t\t// If no need to track\n\t\t\t\tif (!tracked)\n\t\t\t\t\treturn handler(ctx);\n\n\t\t\t\t// Track the context\n\t\t\t\taddContext(ctx);\n\n\t\t\t\t// Call the handler\n\t\t\t\tlet p = handler(ctx);\n\n\t\t\t\tp = p.then(res => {\n\t\t\t\t\tremoveContext(ctx);\n\t\t\t\t\treturn res;\n\t\t\t\t}).catch(err => {\n\t\t\t\t\tremoveContext(ctx);\n\t\t\t\t\tthrow err;\n\t\t\t\t});\n\n\t\t\t\treturn p;\n\t\t\t}.bind(this);\n\t\t}\n\n\t\treturn handler;\n\t}\n\n\tfunction waitingForActiveContexts(list, logger, time, service) {\n\t\tif (!list || list.length === 0)\n\t\t\treturn broker.Promise.resolve();\n\n\t\treturn new broker.Promise((resolve) => {\n\t\t\tlet timedOut = false;\n\t\t\tconst timeout = setTimeout(() => {\n\t\t\t\ttimedOut = true;\n\t\t\t\tlogger.error(new GracefulStopTimeoutError({ service }));\n\t\t\t\tlist.length = 0; // Clear pointers\n\t\t\t\tresolve();\n\t\t\t}, time);\n\n\t\t\tlet first = true;\n\t\t\tconst checkForContexts = () => {\n\t\t\t\tif (list.length === 0) {\n\t\t\t\t\tclearTimeout(timeout);\n\t\t\t\t\tresolve();\n\t\t\t\t} else {\n\t\t\t\t\tif (first) {\n\t\t\t\t\t\tlogger.warn(`Waiting for ${list.length} running context(s)...`);\n\t\t\t\t\t\tfirst = false;\n\t\t\t\t\t}\n\t\t\t\t\tif (!timedOut)\n\t\t\t\t\t\tsetTimeout(checkForContexts, 100);\n\t\t\t\t}\n\t\t\t};\n\t\t\tsetImmediate(checkForContexts);\n\t\t});\n\t}\n\n\treturn {\n\t\tname: \"ContextTracker\",\n\n\t\tlocalAction: wrapTrackerMiddleware,\n\t\tremoteAction: wrapTrackerMiddleware,\n\n\t\tlocalEvent: wrapTrackerMiddleware,\n\n\t\t// After the broker created\n\t\tcreated(broker) {\n\t\t\tbroker._trackedContexts = [];\n\t\t},\n\n\t\t// Before a local service started\n\t\tserviceStarting(service) {\n\t\t\tservice._trackedContexts = [];\n\t\t},\n\n\t\t// Before a local service stopping\n\t\tserviceStopping(service) {\n\t\t\treturn waitingForActiveContexts(service._trackedContexts, service.logger, service.settings.$shutdownTimeout || service.broker.options.tracking.shutdownTimeout, service);\n\t\t},\n\n\t\t// Before broker stopping\n\t\tstopping(broker) {\n\t\t\treturn waitingForActiveContexts(broker._trackedContexts, broker.logger, broker.options.tracking.shutdownTimeout);\n\t\t},\n\t};\n};\n"],"names":["GracefulStopTimeoutError","require$$0","broker","removeContext","ctx","service","idx","_trackedContexts","indexOf","splice","wrapTrackerMiddleware","handler","this","options","tracking","enabled","push","addContext","p","then","res","catch","err","bind","waitingForActiveContexts","list","logger","time","length","Promise","resolve","timedOut","timeout","setTimeout","error","first","checkForContexts","clearTimeout","warn","setImmediate","name","localAction","remoteAction","localEvent","[object Object]","serviceStopping","settings","$shutdownTimeout","shutdownTimeout","stopping"],"mappings":"2EAQA,MAAMA,yBAAEA,GAA6BC,iBAEpB,SAAkCC,GAYlD,SAASC,EAAcC,GACtB,GAAIA,EAAIC,QAAS,CAChB,MAAMC,EAAMF,EAAIC,QAAQE,iBAAiBC,QAAQJ,IACpC,IAATE,GACHF,EAAIC,QAAQE,iBAAiBE,OAAOH,EAAK,OACpC,CACN,MAAMA,EAAMF,EAAIF,OAAOK,iBAAiBC,QAAQJ,IACnC,IAATE,GACHF,EAAIF,OAAOK,iBAAiBE,OAAOH,EAAK,IAI3C,SAASI,EAAsBC,GAC9B,OAAIC,KAAKC,QAAQC,UAAYF,KAAKC,QAAQC,SAASC,QAE3C,SAAkCX,GAKxC,KAHwC,MAAxBA,EAAIS,QAAQC,SAAmBV,EAAIS,QAAQC,SAAWF,KAAKC,QAAQC,SAASC,SAI3F,OAAOJ,EAAQP,IA/BnB,SAAoBA,GACfA,EAAIC,QAEPD,EAAIC,QAAQE,iBAAiBS,KAAKZ,GAGlCA,EAAIF,OAAOK,iBAAiBS,KAAKZ,GA4BhCa,CAAWb,GAGX,IAAIc,EAAIP,EAAQP,GAUhB,OARAc,EAAIA,EAAEC,MAAKC,IACVjB,EAAcC,GACPgB,KACLC,OAAMC,IAER,MADAnB,EAAcC,GACRkB,KAGAJ,GACNK,KAAKX,MAGDD,EAGR,SAASa,EAAyBC,EAAMC,EAAQC,EAAMtB,GACrD,OAAKoB,GAAwB,IAAhBA,EAAKG,OAGX,IAAI1B,EAAO2B,SAASC,IAC1B,IAAIC,GAAW,EACf,MAAMC,EAAUC,GAAW,KAC1BF,GAAW,EACXL,EAAOQ,MAAM,IAAIlC,EAAyB,CAAEK,QAAAA,KAC5CoB,EAAKG,OAAS,EACdE,MACEH,GAEH,IAAIQ,GAAQ,EACZ,MAAMC,EAAmB,KACJ,IAAhBX,EAAKG,QACRS,aAAaL,GACbF,MAEIK,IACHT,EAAOY,KAAK,eAAeb,EAAKG,gCAChCO,GAAQ,GAEJJ,GACJE,EAAWG,EAAkB,OAGhCG,aAAaH,MAzBNlC,EAAO2B,QAAQC,UA6BxB,MAAO,CACNU,KAAM,iBAENC,YAAa/B,EACbgC,aAAchC,EAEdiC,WAAYjC,EAGZkC,QAAQ1C,GACPA,EAAOK,iBAAmB,IAI3BqC,gBAAgBvC,GACfA,EAAQE,iBAAmB,IAI5BsC,gBAAgBxC,GACRmB,EAAyBnB,EAAQE,iBAAkBF,EAAQqB,OAAQrB,EAAQyC,SAASC,kBAAoB1C,EAAQH,OAAOW,QAAQC,SAASkC,gBAAiB3C,GAIjK4C,SAAS/C,GACDsB,EAAyBtB,EAAOK,iBAAkBL,EAAOwB,OAAQxB,EAAOW,QAAQC,SAASkC"}
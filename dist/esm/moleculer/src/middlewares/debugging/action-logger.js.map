{"version":3,"file":"action-logger.js","sources":["../../../../../../src/moleculer/src/middlewares/debugging/action-logger.js"],"sourcesContent":["/*\n * moleculer\n * Copyright (c) 2019 MoleculerJS (https://github.com/moleculerjs/moleculer)\n * MIT Licensed\n */\n\n\"use strict\";\n\nconst _ = require(\"lodash\");\nconst kleur = require(\"kleur\");\nconst fs = require(\"fs\");\nconst path = require(\"path\");\nconst { makeDirs, match, isObject } = require(\"../../utils\");\n\nmodule.exports = function ActionLoggerMiddleware(opts) {\n\topts = _.defaultsDeep(opts, {\n\t\tlogger: null,\n\t\tlogLevel: \"info\",\n\t\tlogParams: false,\n\t\tlogResponse: false,\n\t\tlogMeta: false,\n\n\t\tfolder: null,\n\t\textension: \".json\",\n\n\t\tcolors: {\n\t\t\trequest: \"yellow\",\n\t\t\tresponse: \"cyan\",\n\t\t\terror: \"red\"\n\t\t},\n\t\twhitelist: [\"**\"]\n\t});\n\n\tlet logger;\n\tlet nodeID;\n\n\tlet targetFolder;\n\n\tfunction saveToFile(filename, payload) {\n\t\tconst data = JSON.stringify(payload, payload instanceof Error ? Object.getOwnPropertyNames(payload) : null, 4);\n\t\tfs.writeFile(path.join(targetFolder, filename), data, () => { /* Silent error */ });\n\t}\n\n\tfunction isWhiteListed(actionName) {\n\t\treturn !!opts.whitelist.find(pattern => match(actionName, pattern));\n\t}\n\n\tconst coloringRequest = opts.colors && opts.colors.request ? opts.colors.request.split(\".\").reduce((a,b) => a[b] || a()[b], kleur) : s => s;\n\tconst coloringResponse = opts.colors && opts.colors.response ? opts.colors.response.split(\".\").reduce((a,b) => a[b] || a()[b], kleur) : s => s;\n\tconst coloringError = opts.colors && opts.colors.error ? opts.colors.error.split(\".\").reduce((a,b) => a[b] || a()[b], kleur) : s => s;\n\n\tlet logFn;\n\n\treturn {\n\t\tname: \"ActionLogger\",\n\t\tcreated(broker) {\n\t\t\tlogger = opts.logger || broker.getLogger(\"debug\");\n\t\t\tnodeID = broker.nodeID;\n\n\t\t\tif (opts.folder) {\n\t\t\t\ttargetFolder = path.join(opts.folder, nodeID);\n\t\t\t\tmakeDirs(targetFolder);\n\t\t\t}\n\n\t\t\tlogFn = opts.logLevel ? logger[opts.logLevel] : null;\n\t\t},\n\n\t\tcall(next) {\n\t\t\treturn (actionName, params, callingOpts) => {\n\t\t\t\t// Whitelist filtering\n\t\t\t\tif (!isWhiteListed(isObject(actionName) ? actionName.action.name : actionName)) {\n\t\t\t\t\treturn next(actionName, params, callingOpts);\n\t\t\t\t}\n\n\t\t\t\t// Logging to logger\n\t\t\t\tif (logFn) {\n\t\t\t\t\tconst msg = coloringRequest(`Calling '${actionName}'` + (opts.logParams ? \" with params:\" : \".\"));\n\t\t\t\t\topts.logParams ? logFn(msg, params) : logFn(msg);\n\t\t\t\t\tif (opts.logMeta && callingOpts && callingOpts.meta) {\n\t\t\t\t\t\tlogFn(\"Meta:\", callingOpts.meta);\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\t// Logging to file\n\t\t\t\tif (targetFolder) {\n\t\t\t\t\tif (opts.logParams) {\n\t\t\t\t\t\tsaveToFile(`${Date.now()}-call-${actionName}-request${opts.extension}`, params);\n\t\t\t\t\t}\n\n\t\t\t\t\tif (opts.logMeta && callingOpts && callingOpts.meta) {\n\t\t\t\t\t\tsaveToFile(`${Date.now()}-call-${actionName}-meta${opts.extension}`, callingOpts.meta);\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\t// Call the original method\n\t\t\t\tconst p = next(actionName, params, callingOpts);\n\n\t\t\t\tconst p2 = p\n\t\t\t\t\t.then(response => {\n\n\t\t\t\t\t\t// Log response to logger\n\t\t\t\t\t\tif (logFn) {\n\t\t\t\t\t\t\tconst msg = coloringResponse(`Response for '${actionName}' is received` + (opts.logResponse ? \":\" : \".\"));\n\t\t\t\t\t\t\topts.logResponse ? logFn(msg, response) : logFn(msg);\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\t// Log response to file\n\t\t\t\t\t\tif (targetFolder && opts.logResponse)\n\t\t\t\t\t\t\tsaveToFile(`${Date.now()}-call-${actionName}-response${opts.extension}`, response);\n\n\t\t\t\t\t\treturn response;\n\t\t\t\t\t})\n\t\t\t\t\t.catch(err => {\n\n\t\t\t\t\t\t// Log error to logger\n\t\t\t\t\t\tif (logFn) {\n\t\t\t\t\t\t\tlogFn(coloringError(`Error for '${actionName}' is received:`), err);\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\t// Logger error to file\n\t\t\t\t\t\tif (targetFolder && opts.logResponse)\n\t\t\t\t\t\t\tsaveToFile(`${Date.now()}-call-${actionName}-error${opts.extension}`, err);\n\n\t\t\t\t\t\tthrow err;\n\t\t\t\t\t});\n\n\t\t\t\t// Context issue workaround: https://github.com/moleculerjs/moleculer/issues/413\n\t\t\t\tp2.ctx = p.ctx;\n\n\t\t\t\treturn p2;\n\t\t\t};\n\t\t}\n\t};\n};\n"],"names":["makeDirs","match","isObject","require$$0","opts","logger","nodeID","targetFolder","saveToFile","filename","payload","data","JSON","stringify","Error","Object","getOwnPropertyNames","fs","writeFile","path","join","coloringRequest","_","defaultsDeep","logLevel","logParams","logResponse","logMeta","folder","extension","colors","request","response","error","whitelist","split","reduce","a","b","kleur","s","coloringResponse","coloringError","logFn","name","[object Object]","broker","getLogger","call","next","actionName","params","callingOpts","find","pattern","isWhiteListed","action","msg","meta","Date","now","p","p2","then","catch","err","ctx"],"mappings":"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"}
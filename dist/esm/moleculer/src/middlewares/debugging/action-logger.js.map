{"version":3,"file":"action-logger.js","sources":["../../../../../../src/moleculer/src/middlewares/debugging/action-logger.js"],"sourcesContent":["/*\n * moleculer\n * Copyright (c) 2019 MoleculerJS (https://github.com/moleculerjs/moleculer)\n * MIT Licensed\n */\n\n\"use strict\";\n\nconst _ = require(\"lodash\");\nconst kleur = require(\"kleur\");\nconst fs = require(\"fs\");\nconst path = require(\"path\");\nconst { makeDirs, match, isObject } = require(\"../../utils\");\n\nmodule.exports = function ActionLoggerMiddleware(opts) {\n\topts = _.defaultsDeep(opts, {\n\t\tlogger: null,\n\t\tlogLevel: \"info\",\n\t\tlogParams: false,\n\t\tlogResponse: false,\n\t\tlogMeta: false,\n\n\t\tfolder: null,\n\t\textension: \".json\",\n\n\t\tcolors: {\n\t\t\trequest: \"yellow\",\n\t\t\tresponse: \"cyan\",\n\t\t\terror: \"red\"\n\t\t},\n\t\twhitelist: [\"**\"]\n\t});\n\n\tlet logger;\n\tlet nodeID;\n\n\tlet targetFolder;\n\n\tfunction saveToFile(filename, payload) {\n\t\tconst data = JSON.stringify(payload, payload instanceof Error ? Object.getOwnPropertyNames(payload) : null, 4);\n\t\tfs.writeFile(path.join(targetFolder, filename), data, () => { /* Silent error */ });\n\t}\n\n\tfunction isWhiteListed(actionName) {\n\t\treturn !!opts.whitelist.find(pattern => match(actionName, pattern));\n\t}\n\n\tconst coloringRequest = opts.colors && opts.colors.request ? opts.colors.request.split(\".\").reduce((a,b) => a[b] || a()[b], kleur) : s => s;\n\tconst coloringResponse = opts.colors && opts.colors.response ? opts.colors.response.split(\".\").reduce((a,b) => a[b] || a()[b], kleur) : s => s;\n\tconst coloringError = opts.colors && opts.colors.error ? opts.colors.error.split(\".\").reduce((a,b) => a[b] || a()[b], kleur) : s => s;\n\n\tlet logFn;\n\n\treturn {\n\t\tname: \"ActionLogger\",\n\t\tcreated(broker) {\n\t\t\tlogger = opts.logger || broker.getLogger(\"debug\");\n\t\t\tnodeID = broker.nodeID;\n\n\t\t\tif (opts.folder) {\n\t\t\t\ttargetFolder = path.join(opts.folder, nodeID);\n\t\t\t\tmakeDirs(targetFolder);\n\t\t\t}\n\n\t\t\tlogFn = opts.logLevel ? logger[opts.logLevel] : null;\n\t\t},\n\n\t\tcall(next) {\n\t\t\treturn (actionName, params, callingOpts) => {\n\t\t\t\t// Whitelist filtering\n\t\t\t\tif (!isWhiteListed(isObject(actionName) ? actionName.action.name : actionName)) {\n\t\t\t\t\treturn next(actionName, params, callingOpts);\n\t\t\t\t}\n\n\t\t\t\t// Logging to logger\n\t\t\t\tif (logFn) {\n\t\t\t\t\tconst msg = coloringRequest(`Calling '${actionName}'` + (opts.logParams ? \" with params:\" : \".\"));\n\t\t\t\t\topts.logParams ? logFn(msg, params) : logFn(msg);\n\t\t\t\t\tif (opts.logMeta && callingOpts && callingOpts.meta) {\n\t\t\t\t\t\tlogFn(\"Meta:\", callingOpts.meta);\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\t// Logging to file\n\t\t\t\tif (targetFolder) {\n\t\t\t\t\tif (opts.logParams) {\n\t\t\t\t\t\tsaveToFile(`${Date.now()}-call-${actionName}-request${opts.extension}`, params);\n\t\t\t\t\t}\n\n\t\t\t\t\tif (opts.logMeta && callingOpts && callingOpts.meta) {\n\t\t\t\t\t\tsaveToFile(`${Date.now()}-call-${actionName}-meta${opts.extension}`, callingOpts.meta);\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\t// Call the original method\n\t\t\t\tconst p = next(actionName, params, callingOpts);\n\n\t\t\t\tconst p2 = p\n\t\t\t\t\t.then(response => {\n\n\t\t\t\t\t\t// Log response to logger\n\t\t\t\t\t\tif (logFn) {\n\t\t\t\t\t\t\tconst msg = coloringResponse(`Response for '${actionName}' is received` + (opts.logResponse ? \":\" : \".\"));\n\t\t\t\t\t\t\topts.logResponse ? logFn(msg, response) : logFn(msg);\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\t// Log response to file\n\t\t\t\t\t\tif (targetFolder && opts.logResponse)\n\t\t\t\t\t\t\tsaveToFile(`${Date.now()}-call-${actionName}-response${opts.extension}`, response);\n\n\t\t\t\t\t\treturn response;\n\t\t\t\t\t})\n\t\t\t\t\t.catch(err => {\n\n\t\t\t\t\t\t// Log error to logger\n\t\t\t\t\t\tif (logFn) {\n\t\t\t\t\t\t\tlogFn(coloringError(`Error for '${actionName}' is received:`), err);\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\t// Logger error to file\n\t\t\t\t\t\tif (targetFolder && opts.logResponse)\n\t\t\t\t\t\t\tsaveToFile(`${Date.now()}-call-${actionName}-error${opts.extension}`, err);\n\n\t\t\t\t\t\tthrow err;\n\t\t\t\t\t});\n\n\t\t\t\t// Context issue workaround: https://github.com/moleculerjs/moleculer/issues/413\n\t\t\t\tp2.ctx = p.ctx;\n\n\t\t\t\treturn p2;\n\t\t\t};\n\t\t}\n\t};\n};\n"],"names":["require$$0"],"mappings":"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"}
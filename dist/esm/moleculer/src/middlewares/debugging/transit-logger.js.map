{"version":3,"file":"transit-logger.js","sources":["../../../../../../src/moleculer/src/middlewares/debugging/transit-logger.js"],"sourcesContent":["/*\n * moleculer\n * Copyright (c) 2019 MoleculerJS (https://github.com/moleculerjs/moleculer)\n * MIT Licensed\n */\n\n\"use strict\";\n\nconst _ = require(\"lodash\");\nconst kleur = require(\"kleur\");\nconst fs = require(\"fs\");\nconst path = require(\"path\");\nconst { makeDirs } = require(\"../../utils\");\n\nmodule.exports = function TransitLoggerMiddleware(opts) {\n\topts = _.defaultsDeep(opts, {\n\t\tlogger: null,\n\t\tlogLevel: \"info\",\n\t\tlogPacketData: false,\n\n\t\tfolder: null,\n\t\textension: \".json\",\n\n\t\tcolors: {\n\t\t\treceive: \"grey\",\n\t\t\tsend: \"grey\"\n\t\t},\n\n\t\tpacketFilter: [\"HEARTBEAT\"]\n\t});\n\n\tlet logger;\n\tlet nodeID;\n\n\tlet targetFolder;\n\n\tfunction saveToFile(filename, payload) {\n\t\tconst data = JSON.stringify(payload, payload instanceof Error ? Object.getOwnPropertyNames(payload) : null, 4);\n\t\tfs.writeFile(path.join(targetFolder, filename), data, () => { /* Silent error */ });\n\t}\n\n\tconst coloringSend = opts.colors && opts.colors.send ? opts.colors.send.split(\".\").reduce((a,b) => a[b] || a()[b], kleur) : s => s;\n\tconst coloringReceive = opts.colors && opts.colors.receive ? opts.colors.receive.split(\".\").reduce((a,b) => a[b] || a()[b], kleur) : s => s;\n\n\tlet logFn;\n\n\treturn {\n\t\tname: \"TransitLogger\",\n\t\tcreated(broker) {\n\t\t\tlogger = opts.logger || broker.getLogger(\"debug\");\n\t\t\tnodeID = broker.nodeID;\n\n\t\t\tif (opts.folder) {\n\t\t\t\ttargetFolder = path.join(opts.folder, nodeID);\n\t\t\t\tmakeDirs(targetFolder);\n\t\t\t}\n\n\t\t\tlogFn = opts.logLevel ? logger[opts.logLevel] : null;\n\t\t},\n\n\t\ttransitPublish(next) {\n\t\t\treturn packet => {\n\t\t\t\t// Packet filtering\n\t\t\t\tif (opts.packetFilter.includes(packet.type)) {\n\t\t\t\t\treturn next(packet);\n\t\t\t\t}\n\n\t\t\t\tconst payload = packet.payload;\n\n\t\t\t\t// Logging to logger\n\t\t\t\tif (logFn) {\n\t\t\t\t\tlogFn(coloringSend(`=> Send ${packet.type} packet to '${packet.target || \"<all nodes>\"}'`));\n\t\t\t\t\tif (opts.logPacketData) {\n\t\t\t\t\t\tlogFn(\"=>\", payload);\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tif (targetFolder) {\n\t\t\t\t\tsaveToFile(`${Date.now()}-send-${packet.type}-to-${packet.target || \"all\"}${opts.extension}`, payload);\n\t\t\t\t}\n\n\t\t\t\treturn next(packet);\n\t\t\t};\n\t\t},\n\n\t\ttransitMessageHandler(next) {\n\t\t\treturn (cmd, packet) => {\n\t\t\t\t// Packet filtering\n\t\t\t\tif (opts.packetFilter.includes(cmd)) {\n\t\t\t\t\treturn next(cmd, packet);\n\t\t\t\t}\n\n\t\t\t\tconst payload = packet.payload;\n\n\t\t\t\tif (logFn) {\n\t\t\t\t\tlogFn(coloringReceive(`<= Receive ${cmd} packet from '${payload.sender}'`));\n\t\t\t\t\tif (opts.logPacketData) {\n\t\t\t\t\t\tlogFn(\"<=\", packet.payload);\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tif (targetFolder) {\n\t\t\t\t\tsaveToFile(`${Date.now()}-receive-${cmd}-from-${payload.sender}${opts.extension}`, payload);\n\t\t\t\t}\n\n\t\t\t\treturn next(cmd, packet);\n\t\t\t};\n\t\t}\n\t};\n};\n"],"names":["require$$0"],"mappings":"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"}
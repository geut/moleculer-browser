{"version":3,"file":"transit-logger.js","sources":["../../../../../../src/moleculer/src/middlewares/debugging/transit-logger.js"],"sourcesContent":["/*\n * moleculer\n * Copyright (c) 2019 MoleculerJS (https://github.com/moleculerjs/moleculer)\n * MIT Licensed\n */\n\n\"use strict\";\n\nconst _ = require(\"lodash\");\nconst kleur = require(\"kleur\");\nconst fs = require(\"fs\");\nconst path = require(\"path\");\nconst { makeDirs } = require(\"../../utils\");\n\nmodule.exports = function TransitLoggerMiddleware(opts) {\n\topts = _.defaultsDeep(opts, {\n\t\tlogger: null,\n\t\tlogLevel: \"info\",\n\t\tlogPacketData: false,\n\n\t\tfolder: null,\n\t\textension: \".json\",\n\n\t\tcolors: {\n\t\t\treceive: \"grey\",\n\t\t\tsend: \"grey\"\n\t\t},\n\n\t\tpacketFilter: [\"HEARTBEAT\"]\n\t});\n\n\tlet logger;\n\tlet nodeID;\n\n\tlet targetFolder;\n\n\tfunction saveToFile(filename, payload) {\n\t\tconst data = JSON.stringify(payload, payload instanceof Error ? Object.getOwnPropertyNames(payload) : null, 4);\n\t\tfs.writeFile(path.join(targetFolder, filename), data, () => { /* Silent error */ });\n\t}\n\n\tconst coloringSend = opts.colors && opts.colors.send ? opts.colors.send.split(\".\").reduce((a,b) => a[b] || a()[b], kleur) : s => s;\n\tconst coloringReceive = opts.colors && opts.colors.receive ? opts.colors.receive.split(\".\").reduce((a,b) => a[b] || a()[b], kleur) : s => s;\n\n\tlet logFn;\n\n\treturn {\n\t\tname: \"TransitLogger\",\n\t\tcreated(broker) {\n\t\t\tlogger = opts.logger || broker.getLogger(\"debug\");\n\t\t\tnodeID = broker.nodeID;\n\n\t\t\tif (opts.folder) {\n\t\t\t\ttargetFolder = path.join(opts.folder, nodeID);\n\t\t\t\tmakeDirs(targetFolder);\n\t\t\t}\n\n\t\t\tlogFn = opts.logLevel ? logger[opts.logLevel] : null;\n\t\t},\n\n\t\ttransitPublish(next) {\n\t\t\treturn packet => {\n\t\t\t\t// Packet filtering\n\t\t\t\tif (opts.packetFilter.includes(packet.type)) {\n\t\t\t\t\treturn next(packet);\n\t\t\t\t}\n\n\t\t\t\tconst payload = packet.payload;\n\n\t\t\t\t// Logging to logger\n\t\t\t\tif (logFn) {\n\t\t\t\t\tlogFn(coloringSend(`=> Send ${packet.type} packet to '${packet.target || \"<all nodes>\"}'`));\n\t\t\t\t\tif (opts.logPacketData) {\n\t\t\t\t\t\tlogFn(\"=>\", payload);\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tif (targetFolder) {\n\t\t\t\t\tsaveToFile(`${Date.now()}-send-${packet.type}-to-${packet.target || \"all\"}${opts.extension}`, payload);\n\t\t\t\t}\n\n\t\t\t\treturn next(packet);\n\t\t\t};\n\t\t},\n\n\t\ttransitMessageHandler(next) {\n\t\t\treturn (cmd, packet) => {\n\t\t\t\t// Packet filtering\n\t\t\t\tif (opts.packetFilter.includes(cmd)) {\n\t\t\t\t\treturn next(cmd, packet);\n\t\t\t\t}\n\n\t\t\t\tconst payload = packet.payload;\n\n\t\t\t\tif (logFn) {\n\t\t\t\t\tlogFn(coloringReceive(`<= Receive ${cmd} packet from '${payload.sender}'`));\n\t\t\t\t\tif (opts.logPacketData) {\n\t\t\t\t\t\tlogFn(\"<=\", packet.payload);\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tif (targetFolder) {\n\t\t\t\t\tsaveToFile(`${Date.now()}-receive-${cmd}-from-${payload.sender}${opts.extension}`, payload);\n\t\t\t\t}\n\n\t\t\t\treturn next(cmd, packet);\n\t\t\t};\n\t\t}\n\t};\n};\n"],"names":["makeDirs","require$$0","opts","logger","nodeID","targetFolder","saveToFile","filename","payload","data","JSON","stringify","Error","Object","getOwnPropertyNames","fs","writeFile","path","join","coloringSend","_","defaultsDeep","logLevel","logPacketData","folder","extension","colors","receive","send","packetFilter","split","reduce","a","b","kleur","s","coloringReceive","logFn","name","[object Object]","broker","getLogger","transitPublish","next","packet","includes","type","target","Date","now","transitMessageHandler","cmd","sender"],"mappings":"+GAYA,MAAMA,SAAEA,GAAaC,iBAEJ,SAAiCC,GAiBjD,IAAIC,EACAC,EAEAC,EAEJ,SAASC,EAAWC,EAAUC,GAC7B,MAAMC,EAAOC,KAAKC,UAAUH,EAASA,aAAmBI,MAAQC,OAAOC,oBAAoBN,GAAW,KAAM,GAC5GO,EAAGC,UAAUC,EAAKC,KAAKb,EAAcE,GAAWE,GAAM,SAGvD,MAAMU,GA1BNjB,EAAOkB,EAAEC,aAAanB,EAAM,CAC3BC,OAAQ,KACRmB,SAAU,OACVC,eAAe,EAEfC,OAAQ,KACRC,UAAW,QAEXC,OAAQ,CACPC,QAAS,OACTC,KAAM,QAGPC,aAAc,CAAC,gBAaUH,QAAUxB,EAAKwB,OAAOE,KAAO1B,EAAKwB,OAAOE,KAAKE,MAAM,KAAKC,QAAO,CAACC,EAAEC,IAAMD,EAAEC,IAAMD,IAAIC,IAAIC,GAASC,GAAKA,EAC3HC,EAAkBlC,EAAKwB,QAAUxB,EAAKwB,OAAOC,QAAUzB,EAAKwB,OAAOC,QAAQG,MAAM,KAAKC,QAAO,CAACC,EAAEC,IAAMD,EAAEC,IAAMD,IAAIC,IAAIC,GAASC,GAAKA,EAE1I,IAAIE,EAEJ,MAAO,CACNC,KAAM,gBACNC,QAAQC,GACPrC,EAASD,EAAKC,QAAUqC,EAAOC,UAAU,SACzCrC,EAASoC,EAAOpC,OAEZF,EAAKsB,SACRnB,EAAeY,EAAKC,KAAKhB,EAAKsB,OAAQpB,GACtCJ,EAASK,IAGVgC,EAAQnC,EAAKoB,SAAWnB,EAAOD,EAAKoB,UAAY,MAGjDoB,eAAeC,GACPC,IAEN,GAAI1C,EAAK2B,aAAagB,SAASD,EAAOE,MACrC,OAAOH,EAAKC,GAGb,MAAMpC,EAAUoC,EAAOpC,QAcvB,OAXI6B,IACHA,EAAMlB,EAAa,WAAWyB,EAAOE,mBAAmBF,EAAOG,QAAU,mBACrE7C,EAAKqB,eACRc,EAAM,KAAM7B,IAIVH,GACHC,EAAW,GAAG0C,KAAKC,cAAcL,EAAOE,WAAWF,EAAOG,QAAU,QAAQ7C,EAAKuB,YAAajB,GAGxFmC,EAAKC,IAIdM,sBAAsBP,GACd,CAACQ,EAAKP,KAEZ,GAAI1C,EAAK2B,aAAagB,SAASM,GAC9B,OAAOR,EAAKQ,EAAKP,GAGlB,MAAMpC,EAAUoC,EAAOpC,QAavB,OAXI6B,IACHA,EAAMD,EAAgB,cAAce,kBAAoB3C,EAAQ4C,YAC5DlD,EAAKqB,eACRc,EAAM,KAAMO,EAAOpC,UAIjBH,GACHC,EAAW,GAAG0C,KAAKC,iBAAiBE,UAAY3C,EAAQ4C,SAASlD,EAAKuB,YAAajB,GAG7EmC,EAAKQ,EAAKP"}
{"version":3,"file":"tracing.js","sources":["../../../../../src/moleculer/src/middlewares/tracing.js"],"sourcesContent":["/*\n * moleculer\n * Copyright (c) 2018 MoleculerJS (https://github.com/moleculerjs/moleculer)\n * MIT Licensed\n */\n\n\"use strict\";\n\nconst _ = require(\"lodash\");\nconst { isFunction, isPlainObject } = require(\"../utils\");\n\nmodule.exports = function TracingMiddleware(broker) {\n\n\tconst tracer = broker.tracer;\n\n\tfunction tracingLocalActionMiddleware(handler, action) {\n\t\tlet opts = action.tracing;\n\t\tif (opts === true || opts === false)\n\t\t\topts = { enabled: !!opts };\n\t\topts = _.defaultsDeep({}, opts, { enabled: true });\n\n\t\tif (opts.enabled) {\n\t\t\treturn function tracingLocalActionMiddleware(ctx) {\n\n\t\t\t\tctx.requestID = ctx.requestID || tracer.getCurrentTraceID();\n\t\t\t\tctx.parentID = ctx.parentID || tracer.getActiveSpanID();\n\n\t\t\t\tconst tags = {\n\t\t\t\t\tcallingLevel: ctx.level,\n\t\t\t\t\taction: ctx.action ? {\n\t\t\t\t\t\tname: ctx.action.name,\n\t\t\t\t\t\trawName: ctx.action.rawName\n\t\t\t\t\t} : null,\n\t\t\t\t\tremoteCall: ctx.nodeID !== ctx.broker.nodeID,\n\t\t\t\t\tcallerNodeID: ctx.nodeID,\n\t\t\t\t\tnodeID: ctx.broker.nodeID,\n\t\t\t\t\toptions: {\n\t\t\t\t\t\ttimeout: ctx.options.timeout,\n\t\t\t\t\t\tretries: ctx.options.retries\n\t\t\t\t\t},\n\t\t\t\t\trequestID: ctx.requestID,\n\t\t\t\t};\n\t\t\t\tconst globalActionTags = tracer.opts.tags.action;\n\t\t\t\tlet actionTags;\n\t\t\t\t// local action tags take precedence\n\t\t\t\tif (isFunction(opts.tags)) {\n\t\t\t\t\tactionTags = opts.tags;\n\t\t\t\t} else if (!opts.tags && isFunction(globalActionTags)) {\n\t\t\t\t\tactionTags = globalActionTags;\n\t\t\t\t} else {\n\t\t\t\t\t// By default all params are captured. This can be overridden globally and locally\n\t\t\t\t\tactionTags = { ...{ params: true }, ...globalActionTags, ...opts.tags };\n\t\t\t\t}\n\n\t\t\t\tif (isFunction(actionTags)) {\n\t\t\t\t\tconst res = actionTags.call(ctx.service, ctx);\n\t\t\t\t\tif (res)\n\t\t\t\t\t\tObject.assign(tags, res);\n\n\t\t\t\t} else if (isPlainObject(actionTags)) {\n\t\t\t\t\tif (actionTags.params === true)\n\t\t\t\t\t\ttags.params = ctx.params != null && isPlainObject(ctx.params) ? Object.assign({}, ctx.params) : ctx.params;\n\t\t\t\t\telse if (Array.isArray(actionTags.params))\n\t\t\t\t\t\ttags.params = _.pick(ctx.params, actionTags.params);\n\n\t\t\t\t\tif (actionTags.meta === true)\n\t\t\t\t\t\ttags.meta = ctx.meta != null ? Object.assign({}, ctx.meta) : ctx.meta;\n\t\t\t\t\telse if (Array.isArray(actionTags.meta))\n\t\t\t\t\t\ttags.meta = _.pick(ctx.meta, actionTags.meta);\n\t\t\t\t}\n\n\t\t\t\tlet spanName = `action '${ctx.action.name}'`;\n\t\t\t\tif (opts.spanName) {\n\t\t\t\t\tswitch(typeof opts.spanName) {\n\t\t\t\t\t\tcase \"string\":\n\t\t\t\t\t\t\tspanName = opts.spanName;\n\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\tcase \"function\":\n\t\t\t\t\t\t\tspanName = opts.spanName.call(ctx.service, ctx);\n\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tconst span = ctx.startSpan(spanName, {\n\t\t\t\t\tid: ctx.id,\n\t\t\t\t\ttype: \"action\",\n\t\t\t\t\ttraceID: ctx.requestID,\n\t\t\t\t\tparentID: ctx.parentID,\n\t\t\t\t\tservice: ctx.service,\n\t\t\t\t\tsampled: ctx.tracing,\n\t\t\t\t\ttags\n\t\t\t\t});\n\n\t\t\t\tctx.tracing = span.sampled;\n\n\t\t\t\t// Call the handler\n\t\t\t\treturn handler(ctx).then(res => {\n\t\t\t\t\tconst tags = {\n\t\t\t\t\t\tfromCache: ctx.cachedResult\n\t\t\t\t\t};\n\n\t\t\t\t\tif (isFunction(actionTags)) {\n\t\t\t\t\t\tconst r = actionTags.call(ctx.service, ctx, res);\n\t\t\t\t\t\tif (r)\n\t\t\t\t\t\t\tObject.assign(tags, r);\n\n\t\t\t\t\t} else if (isPlainObject(actionTags)) {\n\t\t\t\t\t\tif (actionTags.response === true)\n\t\t\t\t\t\t\ttags.response = res != null && isPlainObject(res) ? Object.assign({}, res) : res;\n\t\t\t\t\t\telse if (Array.isArray(actionTags.response))\n\t\t\t\t\t\t\ttags.response = _.pick(res, actionTags.response);\n\t\t\t\t\t}\n\n\t\t\t\t\tspan.addTags(tags);\n\t\t\t\t\tctx.finishSpan(span);\n\n\t\t\t\t\t//ctx.duration = span.duration;\n\n\t\t\t\t\treturn res;\n\t\t\t\t}).catch(err => {\n\t\t\t\t\tspan.setError(err);\n\t\t\t\t\tctx.finishSpan(span);\n\n\t\t\t\t\tthrow err;\n\t\t\t\t});\n\n\t\t\t}.bind(this);\n\t\t}\n\n\t\treturn handler;\n\t}\n\n\tfunction tracingLocalEventMiddleware(handler, event) {\n\t\tconst service = event.service;\n\n\t\tlet opts = event.tracing;\n\t\tif (opts === true || opts === false)\n\t\t\topts = { enabled: !!opts };\n\t\topts = _.defaultsDeep({}, opts, { enabled: true  });\n\n\t\tif (opts.enabled) {\n\t\t\treturn function tracingLocalEventMiddleware(ctx) {\n\n\t\t\t\tctx.requestID = ctx.requestID || tracer.getCurrentTraceID();\n\t\t\t\tctx.parentID = ctx.parentID || tracer.getActiveSpanID();\n\n\t\t\t\tconst tags = {\n\t\t\t\t\tevent: {\n\t\t\t\t\t\tname: event.name,\n\t\t\t\t\t\tgroup: event.group\n\t\t\t\t\t},\n\t\t\t\t\teventName: ctx.eventName,\n\t\t\t\t\teventType: ctx.eventType,\n\t\t\t\t\tcallerNodeID: ctx.nodeID,\n\t\t\t\t\tcallingLevel: ctx.level,\n\t\t\t\t\tremoteCall: ctx.nodeID !== broker.nodeID,\n\t\t\t\t\tnodeID: broker.nodeID,\n\t\t\t\t\trequestID: ctx.requestID,\n\t\t\t\t};\n\n\t\t\t\tconst globalEventTags = tracer.opts.tags.event;\n\t\t\t\tlet eventTags;\n\t\t\t\t// local event tags take precedence\n\t\t\t\tif (isFunction(opts.tags)) {\n\t\t\t\t\teventTags = opts.tags;\n\t\t\t\t} else if (!opts.tags && isFunction(globalEventTags)) {\n\t\t\t\t\teventTags = globalEventTags;\n\t\t\t\t} else {\n\t\t\t\t\t// By default all params are captured. This can be overridden globally and locally\n\t\t\t\t\teventTags = { ...{ params: true }, ...globalEventTags, ...opts.tags };\n\t\t\t\t}\n\n\t\t\t\tif (isFunction(eventTags)) {\n\t\t\t\t\tconst res = eventTags.call(service, ctx);\n\t\t\t\t\tif (res)\n\t\t\t\t\t\tObject.assign(tags, res);\n\n\t\t\t\t} else if (isPlainObject(eventTags)) {\n\t\t\t\t\tif (eventTags.params === true)\n\t\t\t\t\t\ttags.params = ctx.params != null && isPlainObject(ctx.params) ? Object.assign({}, ctx.params) : ctx.params;\n\t\t\t\t\telse if (Array.isArray(eventTags.params))\n\t\t\t\t\t\ttags.params = _.pick(ctx.params, eventTags.params);\n\n\t\t\t\t\tif (eventTags.meta === true)\n\t\t\t\t\t\ttags.meta = ctx.meta != null ? Object.assign({}, ctx.meta) : ctx.meta;\n\t\t\t\t\telse if (Array.isArray(eventTags.meta))\n\t\t\t\t\t\ttags.meta = _.pick(ctx.meta, eventTags.meta);\n\t\t\t\t}\n\n\t\t\t\tlet spanName = `event '${ctx.eventName}' in '${service.fullName}'`;\n\t\t\t\tif (opts.spanName) {\n\t\t\t\t\tswitch(typeof opts.spanName) {\n\t\t\t\t\t\tcase \"string\":\n\t\t\t\t\t\t\tspanName = opts.spanName;\n\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\tcase \"function\":\n\t\t\t\t\t\t\tspanName = opts.spanName.call(service, ctx);\n\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tconst span = ctx.startSpan(spanName, {\n\t\t\t\t\tid: ctx.id,\n\t\t\t\t\ttype: \"event\",\n\t\t\t\t\ttraceID: ctx.requestID,\n\t\t\t\t\tparentID: ctx.parentID,\n\t\t\t\t\tservice,\n\t\t\t\t\tsampled: ctx.tracing,\n\t\t\t\t\ttags\n\t\t\t\t});\n\n\t\t\t\tctx.tracing = span.sampled;\n\n\t\t\t\t// Call the handler\n\t\t\t\treturn handler.apply(service, arguments).then(() => {\n\t\t\t\t\tctx.finishSpan(span);\n\t\t\t\t}).catch(err => {\n\t\t\t\t\tspan.setError(err);\n\t\t\t\t\tctx.finishSpan(span);\n\t\t\t\t\tthrow err;\n\t\t\t\t});\n\n\t\t\t}.bind(this);\n\t\t}\n\n\t\treturn handler;\n\t}\n\n\t/*\n\tfunction wrapRemoteTracingMiddleware(handler) {\n\n\t\tif (this.options.tracing) {\n\t\t\treturn function tracingMiddleware(ctx) {\n\t\t\t\tif (ctx.tracing == null) {\n\t\t\t\t\tctx.tracing = shouldTracing(ctx);\n\t\t\t\t}\n\t\t\t\treturn handler(ctx);\n\n\t\t\t}.bind(this);\n\t\t}\n\n\t\treturn handler;\n\t}*/\n\treturn {\n\t\tname: \"Tracing\",\n\n\t\tlocalAction: broker.isTracingEnabled() && tracer.opts.actions ? tracingLocalActionMiddleware : null,\n\t\tlocalEvent: broker.isTracingEnabled() && tracer.opts.events ? tracingLocalEventMiddleware : null,\n\t\t//remoteAction: wrapRemoteTracingMiddleware\n\t};\n};\n"],"names":["isFunction","isPlainObject","require$$0","broker","tracer","name","localAction","isTracingEnabled","opts","actions","handler","action","tracing","enabled","_","defaultsDeep","ctx","requestID","getCurrentTraceID","parentID","getActiveSpanID","tags","callingLevel","level","rawName","remoteCall","nodeID","callerNodeID","options","timeout","retries","globalActionTags","actionTags","params","res","call","service","Object","assign","Array","isArray","pick","meta","spanName","span","startSpan","id","type","traceID","sampled","then","fromCache","cachedResult","r","response","addTags","finishSpan","catch","err","setError","bind","this","localEvent","events","event","group","eventName","eventType","globalEventTags","eventTags","fullName","apply","arguments"],"mappings":"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"}
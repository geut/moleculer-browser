{"version":3,"file":"action-hook.js","sources":["../../../../../src/moleculer/src/middlewares/action-hook.js"],"sourcesContent":["/*\n * moleculer\n * Copyright (c) 2018 MoleculerJS (https://github.com/moleculerjs/moleculer)\n * MIT Licensed\n */\n\n\"use strict\";\n\nconst _ = require(\"lodash\");\nconst { isFunction, isString } = require(\"../utils\");\n\nmodule.exports = function actionHookMiddleware(broker) {\n\n\tfunction callHook(hook, service, ctx, res) {\n\t\tif (isFunction(hook)) {\n\t\t\treturn hook.call(service, ctx, res);\n\t\t} else if (Array.isArray(hook)) {\n\t\t\treturn hook.reduce((p, fn) => p.then(res => fn.call(service, ctx, res)), broker.Promise.resolve(res));\n\t\t}\n\t}\n\n\tfunction callErrorHook(hook, service, ctx, err) {\n\t\tif (isFunction(hook)) {\n\t\t\treturn hook.call(service, ctx, err);\n\t\t} else if (Array.isArray(hook)) {\n\t\t\treturn hook.reduce((p, fn) => p.catch(err => fn.call(service, ctx, err)), broker.Promise.reject(err));\n\t\t}\n\t}\n\n\t/**\n\t * Sanitize hooks. If the hook is a string, convert it to Service method calling.\n\t *\n\t * @param {Function|String|Array<any>} hooks\n\t * @param {Service?} service\n\t * @returns\n\t */\n\tfunction sanitizeHooks(hooks, service) {\n\t\tif (isString(hooks))\n\t\t\treturn service && isFunction(service[hooks]) ? service[hooks] : null;\n\n\t\tif (Array.isArray(hooks)) {\n\t\t\treturn _.compact(hooks.map(h => {\n\t\t\t\tif (isString(h))\n\t\t\t\t\treturn service && isFunction(service[h]) ? service[h] : null;\n\n\t\t\t\treturn h;\n\t\t\t}));\n\t\t}\n\n\t\treturn hooks;\n\t}\n\n\tfunction wrapActionHookMiddleware(handler, action) {\n\t\tconst name = action.rawName || action.name;\n\t\tconst hooks = action.service && action.service.schema ? action.service.schema.hooks : null;\n\t\tif (hooks || action.hooks) {\n\t\t\t// Global hooks\n\t\t\tconst beforeAllHook = hooks && hooks.before ? sanitizeHooks(hooks.before[\"*\"], action.service) : null;\n\t\t\tconst afterAllHook = hooks && hooks.after ? sanitizeHooks(hooks.after[\"*\"], action.service) : null;\n\t\t\tconst errorAllHook = hooks && hooks.error ? sanitizeHooks(hooks.error[\"*\"], action.service) : null;\n\n\t\t\t// Hooks in service\n\t\t\tconst beforeHook = hooks && hooks.before ? sanitizeHooks(hooks.before[name], action.service) : null;\n\t\t\tconst afterHook = hooks && hooks.after ? sanitizeHooks(hooks.after[name], action.service) : null;\n\t\t\tconst errorHook = hooks && hooks.error ? sanitizeHooks(hooks.error[name], action.service) : null;\n\n\t\t\t// Hooks in action definition\n\t\t\tconst actionBeforeHook = action.hooks && action.hooks.before ? sanitizeHooks(action.hooks.before, action.service) : null;\n\t\t\tconst actionAfterHook = action.hooks && action.hooks.after ? sanitizeHooks(action.hooks.after, action.service) : null;\n\t\t\tconst actionErrorHook = action.hooks && action.hooks.error ? sanitizeHooks(action.hooks.error, action.service) : null;\n\n\t\t\tif (beforeAllHook || beforeHook || actionBeforeHook\n\t\t\t\t|| afterAllHook || afterHook || actionAfterHook\n\t\t\t\t|| errorAllHook || errorHook || actionErrorHook) {\n\t\t\t\treturn function actionHookMiddleware(ctx) {\n\t\t\t\t\tlet p = broker.Promise.resolve();\n\n\t\t\t\t\t// Before hook all\n\t\t\t\t\tif (beforeAllHook)\n\t\t\t\t\t\tp = p.then(() => callHook(beforeAllHook, ctx.service, ctx));\n\n\t\t\t\t\t// Before hook\n\t\t\t\t\tif (beforeHook)\n\t\t\t\t\t\tp = p.then(() => callHook(beforeHook, ctx.service, ctx));\n\n\t\t\t\t\t// Before hook in action definition\n\t\t\t\t\tif (actionBeforeHook)\n\t\t\t\t\t\tp = p.then(() => callHook(actionBeforeHook, ctx.service, ctx));\n\n\t\t\t\t\t// Action hook handler\n\t\t\t\t\tp = p.then(() => handler(ctx));\n\n\t\t\t\t\t// After hook in action definition\n\t\t\t\t\tif (actionAfterHook)\n\t\t\t\t\t\tp = p.then(res => callHook(actionAfterHook, ctx.service, ctx, res));\n\n\t\t\t\t\t// After hook\n\t\t\t\t\tif (afterHook)\n\t\t\t\t\t\tp = p.then(res => callHook(afterHook, ctx.service, ctx, res));\n\n\t\t\t\t\t// After hook all\n\t\t\t\t\tif (afterAllHook)\n\t\t\t\t\t\tp = p.then(res => callHook(afterAllHook, ctx.service, ctx, res));\n\n\t\t\t\t\t// Error hook in action definition\n\t\t\t\t\tif (actionErrorHook)\n\t\t\t\t\t\tp = p.catch(err => callErrorHook(actionErrorHook, ctx.service, ctx, err));\n\n\t\t\t\t\t// Error hook\n\t\t\t\t\tif (errorHook)\n\t\t\t\t\t\tp = p.catch(err => callErrorHook(errorHook, ctx.service, ctx, err));\n\n\t\t\t\t\t// Error hook all\n\t\t\t\t\tif (errorAllHook)\n\t\t\t\t\t\tp = p.catch(err => callErrorHook(errorAllHook, ctx.service, ctx, err));\n\n\t\t\t\t\treturn p;\n\t\t\t\t};\n\t\t\t}\n\t\t}\n\n\t\treturn handler;\n\t}\n\n\treturn {\n\t\tname: \"ActionHook\",\n\t\tlocalAction: wrapActionHookMiddleware\n\t};\n};\n"],"names":["require$$0"],"mappings":"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"}
{"version":3,"file":"action-hook.js","sources":["../../../../../src/moleculer/src/middlewares/action-hook.js"],"sourcesContent":["/*\n * moleculer\n * Copyright (c) 2018 MoleculerJS (https://github.com/moleculerjs/moleculer)\n * MIT Licensed\n */\n\n\"use strict\";\n\nconst _ = require(\"lodash\");\nconst { isFunction, isString } = require(\"../utils\");\n\nmodule.exports = function actionHookMiddleware(broker) {\n\n\tfunction callHook(hook, service, ctx, res) {\n\t\tif (isFunction(hook)) {\n\t\t\treturn hook.call(service, ctx, res);\n\t\t} else if (Array.isArray(hook)) {\n\t\t\treturn hook.reduce((p, fn) => p.then(res => fn.call(service, ctx, res)), broker.Promise.resolve(res));\n\t\t}\n\t}\n\n\tfunction callErrorHook(hook, service, ctx, err) {\n\t\tif (isFunction(hook)) {\n\t\t\treturn hook.call(service, ctx, err);\n\t\t} else if (Array.isArray(hook)) {\n\t\t\treturn hook.reduce((p, fn) => p.catch(err => fn.call(service, ctx, err)), broker.Promise.reject(err));\n\t\t}\n\t}\n\n\t/**\n\t * Sanitize hooks. If the hook is a string, convert it to Service method calling.\n\t *\n\t * @param {Function|String|Array<any>} hooks\n\t * @param {Service?} service\n\t * @returns\n\t */\n\tfunction sanitizeHooks(hooks, service) {\n\t\tif (isString(hooks))\n\t\t\treturn service && isFunction(service[hooks]) ? service[hooks] : null;\n\n\t\tif (Array.isArray(hooks)) {\n\t\t\treturn _.compact(hooks.map(h => {\n\t\t\t\tif (isString(h))\n\t\t\t\t\treturn service && isFunction(service[h]) ? service[h] : null;\n\n\t\t\t\treturn h;\n\t\t\t}));\n\t\t}\n\n\t\treturn hooks;\n\t}\n\n\tfunction wrapActionHookMiddleware(handler, action) {\n\t\tconst name = action.rawName || action.name;\n\t\tconst hooks = action.service && action.service.schema ? action.service.schema.hooks : null;\n\t\tif (hooks || action.hooks) {\n\t\t\t// Global hooks\n\t\t\tconst beforeAllHook = hooks && hooks.before ? sanitizeHooks(hooks.before[\"*\"], action.service) : null;\n\t\t\tconst afterAllHook = hooks && hooks.after ? sanitizeHooks(hooks.after[\"*\"], action.service) : null;\n\t\t\tconst errorAllHook = hooks && hooks.error ? sanitizeHooks(hooks.error[\"*\"], action.service) : null;\n\n\t\t\t// Hooks in service\n\t\t\tconst beforeHook = hooks && hooks.before ? sanitizeHooks(hooks.before[name], action.service) : null;\n\t\t\tconst afterHook = hooks && hooks.after ? sanitizeHooks(hooks.after[name], action.service) : null;\n\t\t\tconst errorHook = hooks && hooks.error ? sanitizeHooks(hooks.error[name], action.service) : null;\n\n\t\t\t// Hooks in action definition\n\t\t\tconst actionBeforeHook = action.hooks && action.hooks.before ? sanitizeHooks(action.hooks.before, action.service) : null;\n\t\t\tconst actionAfterHook = action.hooks && action.hooks.after ? sanitizeHooks(action.hooks.after, action.service) : null;\n\t\t\tconst actionErrorHook = action.hooks && action.hooks.error ? sanitizeHooks(action.hooks.error, action.service) : null;\n\n\t\t\tif (beforeAllHook || beforeHook || actionBeforeHook\n\t\t\t\t|| afterAllHook || afterHook || actionAfterHook\n\t\t\t\t|| errorAllHook || errorHook || actionErrorHook) {\n\t\t\t\treturn function actionHookMiddleware(ctx) {\n\t\t\t\t\tlet p = broker.Promise.resolve();\n\n\t\t\t\t\t// Before hook all\n\t\t\t\t\tif (beforeAllHook)\n\t\t\t\t\t\tp = p.then(() => callHook(beforeAllHook, ctx.service, ctx));\n\n\t\t\t\t\t// Before hook\n\t\t\t\t\tif (beforeHook)\n\t\t\t\t\t\tp = p.then(() => callHook(beforeHook, ctx.service, ctx));\n\n\t\t\t\t\t// Before hook in action definition\n\t\t\t\t\tif (actionBeforeHook)\n\t\t\t\t\t\tp = p.then(() => callHook(actionBeforeHook, ctx.service, ctx));\n\n\t\t\t\t\t// Action hook handler\n\t\t\t\t\tp = p.then(() => handler(ctx));\n\n\t\t\t\t\t// After hook in action definition\n\t\t\t\t\tif (actionAfterHook)\n\t\t\t\t\t\tp = p.then(res => callHook(actionAfterHook, ctx.service, ctx, res));\n\n\t\t\t\t\t// After hook\n\t\t\t\t\tif (afterHook)\n\t\t\t\t\t\tp = p.then(res => callHook(afterHook, ctx.service, ctx, res));\n\n\t\t\t\t\t// After hook all\n\t\t\t\t\tif (afterAllHook)\n\t\t\t\t\t\tp = p.then(res => callHook(afterAllHook, ctx.service, ctx, res));\n\n\t\t\t\t\t// Error hook in action definition\n\t\t\t\t\tif (actionErrorHook)\n\t\t\t\t\t\tp = p.catch(err => callErrorHook(actionErrorHook, ctx.service, ctx, err));\n\n\t\t\t\t\t// Error hook\n\t\t\t\t\tif (errorHook)\n\t\t\t\t\t\tp = p.catch(err => callErrorHook(errorHook, ctx.service, ctx, err));\n\n\t\t\t\t\t// Error hook all\n\t\t\t\t\tif (errorAllHook)\n\t\t\t\t\t\tp = p.catch(err => callErrorHook(errorAllHook, ctx.service, ctx, err));\n\n\t\t\t\t\treturn p;\n\t\t\t\t};\n\t\t\t}\n\t\t}\n\n\t\treturn handler;\n\t}\n\n\treturn {\n\t\tname: \"ActionHook\",\n\t\tlocalAction: wrapActionHookMiddleware\n\t};\n};\n"],"names":["isFunction","isString","require$$0","broker","callHook","hook","service","ctx","res","call","Array","isArray","reduce","p","fn","then","Promise","resolve","callErrorHook","err","catch","reject","sanitizeHooks","hooks","_","compact","map","h","name","localAction","handler","action","rawName","schema","beforeAllHook","before","afterAllHook","after","errorAllHook","error","beforeHook","afterHook","errorHook","actionBeforeHook","actionAfterHook","actionErrorHook"],"mappings":"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"}
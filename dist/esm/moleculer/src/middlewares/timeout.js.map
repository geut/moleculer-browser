{"version":3,"file":"timeout.js","sources":["../../../../../src/moleculer/src/middlewares/timeout.js"],"sourcesContent":["/*\n * moleculer\n * Copyright (c) 2019 MoleculerJS (https://github.com/moleculerjs/moleculer)\n * MIT Licensed\n */\n\n\"use strict\";\n\nconst { RequestTimeoutError } = require(\"../errors\");\nconst { METRIC }\t= require(\"../metrics\");\n\nmodule.exports = function(broker) {\n\n\tfunction wrapTimeoutMiddleware(handler, action) {\n\t\tconst actionTimeout = action.timeout;\n\t\tconst actionName = action.name;\n\t\tconst service = action.service ? action.service.fullName : null;\n\n\t\treturn function timeoutMiddleware(ctx) {\n\n\t\t\t// Load opts with default values\n\t\t\tif (ctx.options.timeout == null) {\n\t\t\t\tif (actionTimeout != null)\n\t\t\t\t\tctx.options.timeout = actionTimeout;\n\t\t\t\telse\n\t\t\t\t\tctx.options.timeout = broker.options.requestTimeout;\n\t\t\t}\n\n\t\t\tif (ctx.options.timeout > 0 && !ctx.startHrTime) {\n\t\t\t// For distributed timeout calculation need to be set\n\t\t\t\tctx.startHrTime = process.hrtime();\n\t\t\t}\n\n\t\t\t// Call the handler\n\t\t\tconst p = handler(ctx);\n\t\t\tif (ctx.options.timeout > 0 && p.timeout) {\n\t\t\t\treturn p.timeout(ctx.options.timeout)\n\t\t\t\t\t.catch(err => {\n\t\t\t\t\t\tif (err instanceof broker.Promise.TimeoutError) {\n\t\t\t\t\t\t\tconst nodeID = ctx.nodeID;\n\t\t\t\t\t\t\tthis.logger.warn(`Request '${actionName}' is timed out.`, { requestID: ctx.requestID, nodeID, timeout: ctx.options.timeout });\n\t\t\t\t\t\t\terr = new RequestTimeoutError({ action: actionName, nodeID });\n\n\t\t\t\t\t\t\tbroker.metrics.increment(METRIC.MOLECULER_REQUEST_TIMEOUT_TOTAL, { service, action: actionName });\n\t\t\t\t\t\t}\n\t\t\t\t\t\tthrow err;\n\t\t\t\t\t});\n\t\t\t}\n\n\t\t\treturn p;\n\n\t\t}.bind(this);\n\t}\n\n\treturn {\n\t\tname: \"Timeout\",\n\n\t\tcreated(broker) {\n\t\t\tif (broker.isMetricsEnabled()) {\n\t\t\t\tbroker.metrics.register({ name: METRIC.MOLECULER_REQUEST_TIMEOUT_TOTAL, type: METRIC.TYPE_COUNTER, labelNames: [\"service\", \"action\"], description: \"Number of timed out requests\", rate: true });\n\t\t\t}\n\t\t},\n\n\t\tlocalAction: wrapTimeoutMiddleware,\n\t\tremoteAction: wrapTimeoutMiddleware\n\t};\n};\n"],"names":["require$$0","require$$1","process"],"mappings":"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"}
import e from"../metrics/index.js";const{METRIC:E}=e;export default function(e){const t=e.metrics;function r(e,r,n){const T=r.name,i=r.service?r.service.fullName:null;return function(r){const s=r.caller;t.increment(E.MOLECULER_REQUEST_TOTAL,{service:i,action:T,caller:s,type:e}),t.increment(E.MOLECULER_REQUEST_ACTIVE,{service:i,action:T,caller:s,type:e}),t.increment(E.MOLECULER_REQUEST_LEVELS,{service:i,action:T,caller:s,level:r.level});const c=t.timer(E.MOLECULER_REQUEST_TIME,{service:i,action:T,caller:s,type:e});return n(r).then((r=>(c(),t.decrement(E.MOLECULER_REQUEST_ACTIVE,{service:i,action:T,caller:s,type:e}),r))).catch((r=>{throw c(),t.decrement(E.MOLECULER_REQUEST_ACTIVE,{service:i,action:T,caller:s,type:e}),t.increment(E.MOLECULER_REQUEST_ERROR_TOTAL,{service:i,action:T,caller:s,type:e,errorName:r?r.name:null,errorCode:r?r.code:null,errorType:r?r.type:null}),r}))}}return{name:"Metrics",created(){e.isMetricsEnabled()&&(t.register({name:E.MOLECULER_REQUEST_TOTAL,type:E.TYPE_COUNTER,labelNames:["service","action","type","caller"],unit:E.UNIT_REQUEST,description:"Number of requests",rate:!0}),t.register({name:E.MOLECULER_REQUEST_ACTIVE,type:E.TYPE_GAUGE,labelNames:["service","action","type","caller"],unit:E.UNIT_REQUEST,description:"Number of active requests"}),t.register({name:E.MOLECULER_REQUEST_ERROR_TOTAL,type:E.TYPE_COUNTER,labelNames:["service","action","type","caller","errorName","errorCode","errorType"],unit:E.UNIT_REQUEST,description:"Number of request errors",rate:!0}),t.register({name:E.MOLECULER_REQUEST_TIME,type:E.TYPE_HISTOGRAM,labelNames:["service","action","type","caller"],quantiles:!0,buckets:!0,unit:E.UNIT_MILLISECONDS,description:"Request times in milliseconds",rate:!0}),t.register({name:E.MOLECULER_REQUEST_LEVELS,type:E.TYPE_COUNTER,labelNames:["level"],unit:E.UNIT_REQUEST,description:"Number of requests by context level"}),t.register({name:E.MOLECULER_EVENT_EMIT_TOTAL,type:E.TYPE_COUNTER,labelNames:["event","groups"],unit:E.UNIT_EVENT,description:"Number of emitted events",rate:!0}),t.register({name:E.MOLECULER_EVENT_BROADCAST_TOTAL,type:E.TYPE_COUNTER,labelNames:["event","groups"],unit:E.UNIT_EVENT,description:"Number of broadcast events",rate:!0}),t.register({name:E.MOLECULER_EVENT_BROADCASTLOCAL_TOTAL,type:E.TYPE_COUNTER,labelNames:["event","groups"],unit:E.UNIT_EVENT,description:"Number of local broadcast events",rate:!0}),t.register({name:E.MOLECULER_EVENT_RECEIVED_TOTAL,type:E.TYPE_COUNTER,labelNames:["service","group","event","caller"],unit:E.UNIT_EVENT,description:"Number of received events",rate:!0}),t.register({name:E.MOLECULER_EVENT_RECEIVED_ACTIVE,type:E.TYPE_GAUGE,labelNames:["service","group","event","caller"],unit:E.UNIT_REQUEST,description:"Number of active event executions"}),t.register({name:E.MOLECULER_EVENT_RECEIVED_ERROR_TOTAL,type:E.TYPE_COUNTER,labelNames:["service","group","event","caller","errorName","errorCode","errorType"],unit:E.UNIT_REQUEST,description:"Number of event execution errors",rate:!0}),t.register({name:E.MOLECULER_EVENT_RECEIVED_TIME,type:E.TYPE_HISTOGRAM,labelNames:["service","group","event","caller"],quantiles:!0,buckets:!0,unit:E.UNIT_MILLISECONDS,description:"Execution time of events in milliseconds",rate:!0}),t.register({name:E.MOLECULER_TRANSIT_PUBLISH_TOTAL,type:E.TYPE_COUNTER,labelNames:["type"],unit:E.UNIT_PACKET,description:"Number of published packets",rate:!0}),t.register({name:E.MOLECULER_TRANSIT_RECEIVE_TOTAL,type:E.TYPE_COUNTER,labelNames:["type"],unit:E.UNIT_PACKET,description:"Number of received packets",rate:!0}),t.register({name:E.MOLECULER_TRANSIT_REQUESTS_ACTIVE,type:E.TYPE_GAUGE,unit:E.UNIT_REQUEST,description:"Number of active requests"}),t.register({name:E.MOLECULER_TRANSIT_STREAMS_SEND_ACTIVE,type:E.TYPE_GAUGE,unit:E.UNIT_STREAM,description:"Number of active sent streams"}),t.register({name:E.MOLECULER_TRANSPORTER_PACKETS_SENT_TOTAL,type:E.TYPE_COUNTER,unit:E.UNIT_PACKET,description:"Number of sent packets",rate:!0}),t.register({name:E.MOLECULER_TRANSPORTER_PACKETS_SENT_BYTES,type:E.TYPE_COUNTER,unit:E.UNIT_BYTE,description:"Number of sent bytes",rate:!0}),t.register({name:E.MOLECULER_TRANSPORTER_PACKETS_RECEIVED_TOTAL,type:E.TYPE_COUNTER,unit:E.UNIT_PACKET,description:"Number of received packets",rate:!0}),t.register({name:E.MOLECULER_TRANSPORTER_PACKETS_RECEIVED_BYTES,type:E.TYPE_COUNTER,unit:E.UNIT_BYTE,description:"Number of received bytes",rate:!0}))},localAction:(E,t)=>e.isMetricsEnabled()?r("local",t,E):E,remoteAction:(E,t)=>e.isMetricsEnabled()?r("remote",t,E):E,localEvent(r,n){const T=n.service?n.service.name:null;return e.isMetricsEnabled()?function(e){const i=n.group||T;t.increment(E.MOLECULER_EVENT_RECEIVED_TOTAL,{service:T,event:e.eventName,group:i,caller:e.caller}),t.increment(E.MOLECULER_EVENT_RECEIVED_ACTIVE,{service:T,event:e.eventName,group:i,caller:e.caller});const s=t.timer(E.MOLECULER_EVENT_RECEIVED_TIME,{service:T,event:e.eventName,group:i,caller:e.caller});return r.apply(this,arguments).then((r=>(s(),t.decrement(E.MOLECULER_EVENT_RECEIVED_ACTIVE,{service:T,event:e.eventName,group:i,caller:e.caller}),r))).catch((r=>{throw s(),t.decrement(E.MOLECULER_EVENT_RECEIVED_ACTIVE,{service:T,event:e.eventName,group:i,caller:e.caller}),t.increment(E.MOLECULER_EVENT_RECEIVED_ERROR_TOTAL,{service:T,event:e.eventName,group:i,caller:e.caller,errorName:r?r.name:null,errorCode:r?r.code:null,errorType:r?r.type:null}),r}))}.bind(this):r},emit:r=>e.isMetricsEnabled()?function(){return t.increment(E.MOLECULER_EVENT_EMIT_TOTAL,{event:arguments[0]}),r.apply(this,arguments)}:r,broadcast:r=>e.isMetricsEnabled()?function(){return t.increment(E.MOLECULER_EVENT_BROADCAST_TOTAL,{event:arguments[0]}),r.apply(this,arguments)}:r,broadcastLocal:r=>e.isMetricsEnabled()?function(){return t.increment(E.MOLECULER_EVENT_BROADCASTLOCAL_TOTAL,{event:arguments[0]}),r.apply(this,arguments)}:r,transitPublish(r){const n=this;return e.isMetricsEnabled()?function(){t.increment(E.MOLECULER_TRANSIT_PUBLISH_TOTAL,{type:arguments[0].type});const e=r.apply(this,arguments);return t.increment(E.MOLECULER_TRANSIT_REQUESTS_ACTIVE,null,n.pendingRequests.size),t.increment(E.MOLECULER_TRANSIT_STREAMS_SEND_ACTIVE,null,n.pendingReqStreams.size+this.pendingResStreams.size),e}:r},transitMessageHandler:r=>e.isMetricsEnabled()?function(){return t.increment(E.MOLECULER_TRANSIT_RECEIVE_TOTAL,{type:arguments[0]}),r.apply(this,arguments)}:r,transporterSend:r=>e.isMetricsEnabled()?function(){const e=arguments[1];return t.increment(E.MOLECULER_TRANSPORTER_PACKETS_SENT_TOTAL),t.increment(E.MOLECULER_TRANSPORTER_PACKETS_SENT_BYTES,null,e&&e.length?e.length:0),r.apply(this,arguments)}:r,transporterReceive:r=>e.isMetricsEnabled()?function(){const e=arguments[1];return t.increment(E.MOLECULER_TRANSPORTER_PACKETS_RECEIVED_TOTAL),t.increment(E.MOLECULER_TRANSPORTER_PACKETS_RECEIVED_BYTES,null,e&&e.length?e.length:0),r.apply(this,arguments)}:r}}
//# sourceMappingURL=metrics.js.map

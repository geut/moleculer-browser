{"version":3,"file":"encryption.js","sources":["../../../../../../src/moleculer/src/middlewares/transmit/encryption.js"],"sourcesContent":["/*\n * moleculer\n * Copyright (c) 2019 MoleculerJS (https://github.com/moleculerjs/moleculer)\n * MIT Licensed\n */\n\n\"use strict\";\n\nconst crypto = require(\"crypto\");\n\n/**\n * This is a AES encryption middleware to protect the whole\n * Moleculer transporter communication with AES.\n *\n * @param {String|Buffer} password\n * @param {String?} algorithm\n * @param {String|Buffer?} iv\n */\nmodule.exports = function EncryptionMiddleware(password, algorithm = \"aes-256-cbc\", iv) {\n\tif (!password || password.length == 0) {\n\t\t/* istanbul ignore next */\n\t\tthrow new Error(\"Must be set a password for encryption\");\n\t}\n\n\treturn {\n\t\tname: \"Encryption\",\n\n\t\tcreated() {\n\t\t\t/* istanbul ignore next */\n\t\t\tthis.logger.info(`The transmission is ENCRYPTED by '${algorithm}'.`);\n\t\t},\n\n\t\ttransporterSend(next) {\n\t\t\treturn (topic, data, meta) => {\n\t\t\t\tconst encrypter = iv ? crypto.createCipheriv(algorithm, password, iv) : crypto.createCipher(algorithm, password);\n\t\t\t\tconst res = Buffer.concat([encrypter.update(data), encrypter.final()]);\n\t\t\t\treturn next(topic, res, meta);\n\t\t\t};\n\t\t},\n\n\t\ttransporterReceive(next) {\n\t\t\treturn (cmd, data, s) => {\n\t\t\t\tconst decrypter = iv ? crypto.createDecipheriv(algorithm, password, iv) : crypto.createDecipher(algorithm, password);\n\t\t\t\tconst res = Buffer.concat([decrypter.update(data), decrypter.final()]);\n\t\t\t\treturn next(cmd, res, s);\n\t\t\t};\n\t\t}\n\t};\n};\n"],"names":[],"mappings":";;;AAUA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;cACc,GAAG,SAAS,oBAAoB,CAAC,QAAQ,EAAE,SAAS,GAAG,aAAa,EAAE,EAAE,EAAE;AACxF,CAAC,IAAI,CAAC,QAAQ,IAAI,QAAQ,CAAC,MAAM,IAAI,CAAC,EAAE;AACxC;AACA,EAAE,MAAM,IAAI,KAAK,CAAC,uCAAuC,CAAC,CAAC;AAC3D,EAAE;AACF;AACA,CAAC,OAAO;AACR,EAAE,IAAI,EAAE,YAAY;AACpB;AACA,EAAE,OAAO,GAAG;AACZ;AACA,GAAG,IAAI,CAAC,MAAM,CAAC,IAAI,CAAC,CAAC,kCAAkC,EAAE,SAAS,CAAC,EAAE,CAAC,CAAC,CAAC;AACxE,GAAG;AACH;AACA,EAAE,eAAe,CAAC,IAAI,EAAE;AACxB,GAAG,OAAO,CAAC,KAAK,EAAE,IAAI,EAAE,IAAI,KAAK;AACjC,IAAI,MAAM,SAAS,GAAG,EAAE,GAAG,MAAM,CAAC,cAAc,CAAC,SAAS,EAAE,QAAQ,EAAE,EAAE,CAAC,GAAG,MAAM,CAAC,YAAY,CAAC,SAAS,EAAE,QAAQ,CAAC,CAAC;AACrH,IAAI,MAAM,GAAG,GAAG,MAAM,CAAC,MAAM,CAAC,CAAC,SAAS,CAAC,MAAM,CAAC,IAAI,CAAC,EAAE,SAAS,CAAC,KAAK,EAAE,CAAC,CAAC,CAAC;AAC3E,IAAI,OAAO,IAAI,CAAC,KAAK,EAAE,GAAG,EAAE,IAAI,CAAC,CAAC;AAClC,IAAI,CAAC;AACL,GAAG;AACH;AACA,EAAE,kBAAkB,CAAC,IAAI,EAAE;AAC3B,GAAG,OAAO,CAAC,GAAG,EAAE,IAAI,EAAE,CAAC,KAAK;AAC5B,IAAI,MAAM,SAAS,GAAG,EAAE,GAAG,MAAM,CAAC,gBAAgB,CAAC,SAAS,EAAE,QAAQ,EAAE,EAAE,CAAC,GAAG,MAAM,CAAC,cAAc,CAAC,SAAS,EAAE,QAAQ,CAAC,CAAC;AACzH,IAAI,MAAM,GAAG,GAAG,MAAM,CAAC,MAAM,CAAC,CAAC,SAAS,CAAC,MAAM,CAAC,IAAI,CAAC,EAAE,SAAS,CAAC,KAAK,EAAE,CAAC,CAAC,CAAC;AAC3E,IAAI,OAAO,IAAI,CAAC,GAAG,EAAE,GAAG,EAAE,CAAC,CAAC,CAAC;AAC7B,IAAI,CAAC;AACL,GAAG;AACH,EAAE,CAAC;AACH;;;;"}
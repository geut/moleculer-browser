{"version":3,"file":"encryption.js","sources":["../../../../../../src/moleculer/src/middlewares/transmit/encryption.js"],"sourcesContent":["/*\n * moleculer\n * Copyright (c) 2019 MoleculerJS (https://github.com/moleculerjs/moleculer)\n * MIT Licensed\n */\n\n\"use strict\";\n\nconst crypto = require(\"crypto\");\n\n/**\n * This is a AES encryption middleware to protect the whole\n * Moleculer transporter communication with AES.\n *\n * @param {String|Buffer} password\n * @param {String?} algorithm\n * @param {String|Buffer?} iv\n */\nmodule.exports = function EncryptionMiddleware(password, algorithm = \"aes-256-cbc\", iv) {\n\tif (!password || password.length == 0) {\n\t\t/* istanbul ignore next */\n\t\tthrow new Error(\"Must be set a password for encryption\");\n\t}\n\n\treturn {\n\t\tname: \"Encryption\",\n\n\t\tcreated() {\n\t\t\t/* istanbul ignore next */\n\t\t\tthis.logger.info(`The transmission is ENCRYPTED by '${algorithm}'.`);\n\t\t},\n\n\t\ttransporterSend(next) {\n\t\t\treturn (topic, data, meta) => {\n\t\t\t\tconst encrypter = iv ? crypto.createCipheriv(algorithm, password, iv) : crypto.createCipher(algorithm, password);\n\t\t\t\tconst res = Buffer.concat([encrypter.update(data), encrypter.final()]);\n\t\t\t\treturn next(topic, res, meta);\n\t\t\t};\n\t\t},\n\n\t\ttransporterReceive(next) {\n\t\t\treturn (cmd, data, s) => {\n\t\t\t\tconst decrypter = iv ? crypto.createDecipheriv(algorithm, password, iv) : crypto.createDecipher(algorithm, password);\n\t\t\t\tconst res = Buffer.concat([decrypter.update(data), decrypter.final()]);\n\t\t\t\treturn next(cmd, res, s);\n\t\t\t};\n\t\t}\n\t};\n};\n"],"names":["password","algorithm","iv","length","Error","name","[object Object]","this","logger","info","transporterSend","next","topic","data","meta","encrypter","crypto","createCipheriv","createCipher","res","Buffer","concat","update","final","transporterReceive","cmd","s","decrypter","createDecipheriv","createDecipher"],"mappings":"qEAkBiB,SAA8BA,EAAUC,EAAY,cAAeC,GACnF,IAAKF,GAA+B,GAAnBA,EAASG,OAEzB,MAAM,IAAIC,MAAM,yCAGjB,MAAO,CACNC,KAAM,aAENC,UAECC,KAAKC,OAAOC,KAAK,qCAAqCR,QAGvDS,gBAAgBC,GACR,CAACC,EAAOC,EAAMC,KACpB,MAAMC,EAAYb,EAAKc,EAAOC,eAAehB,EAAWD,EAAUE,GAAMc,EAAOE,aAAajB,EAAWD,GACjGmB,EAAMC,EAAOC,OAAO,CAACN,EAAUO,OAAOT,GAAOE,EAAUQ,UAC7D,OAAOZ,EAAKC,EAAOO,EAAKL,IAI1BU,mBAAmBb,GACX,CAACc,EAAKZ,EAAMa,KAClB,MAAMC,EAAYzB,EAAKc,EAAOY,iBAAiB3B,EAAWD,EAAUE,GAAMc,EAAOa,eAAe5B,EAAWD,GACrGmB,EAAMC,EAAOC,OAAO,CAACM,EAAUL,OAAOT,GAAOc,EAAUJ,UAC7D,OAAOZ,EAAKc,EAAKN,EAAKO"}
{"version":3,"file":"fallback.js","sources":["../../../../../src/moleculer/src/middlewares/fallback.js"],"sourcesContent":["/*\n * moleculer\n * Copyright (c) 2018 MoleculerJS (https://github.com/moleculerjs/moleculer)\n * MIT Licensed\n */\n\n\"use strict\";\n\nconst { MoleculerError } = require(\"../errors\");\nconst { METRIC }\t= require(\"../metrics\");\nconst { isFunction, isString } = require(\"../utils\");\n\nmodule.exports = function FallbackMiddleware(broker) {\n\n\tfunction handleContextFallback(ctx, err) {\n\t\tbroker.logger.warn(`The '${ctx.action.name}' request is failed. Return fallback response.`, { requestID: ctx.requestID, err: err.message });\n\t\tbroker.metrics.increment(METRIC.MOLECULER_REQUEST_FALLBACK_TOTAL, { action: ctx.action.name });\n\t\tctx.fallbackResult = true;\n\n\t\tif (isFunction(ctx.options.fallbackResponse))\n\t\t\treturn ctx.options.fallbackResponse(ctx, err);\n\t\telse\n\t\t\treturn Promise.resolve(ctx.options.fallbackResponse);\n\t}\n\n\tfunction wrapFallbackMiddleware(handler, action) {\n\t\treturn function fallbackMiddleware(ctx) {\n\t\t\t// Call the handler\n\t\t\treturn handler(ctx).catch(err => {\n\n\t\t\t\t// Handle fallback response from calling options\n\t\t\t\tif (ctx.options.fallbackResponse) {\n\t\t\t\t\treturn handleContextFallback(ctx, err);\n\t\t\t\t}\n\n\t\t\t\t// Handle fallback from Action Definition (only locally)\n\t\t\t\tif (action.fallback && action.service) {\n\t\t\t\t\tconst svc = action.service;\n\n\t\t\t\t\tconst fallback = isString(action.fallback) ? svc[action.fallback] : action.fallback;\n\t\t\t\t\tif (!isFunction(fallback)) {\n\t\t\t\t\t\t/* istanbul ignore next */\n\t\t\t\t\t\tthrow new MoleculerError(`The 'fallback' of '${action.name}' action is not a Function or valid method name: ${action.fallback}`);\n\t\t\t\t\t}\n\n\t\t\t\t\tsvc.logger.warn(`The '${ctx.action.name}' request is failed. Return fallback response.`, { requestID: ctx.requestID, err: err.message });\n\t\t\t\t\tbroker.metrics.increment(METRIC.MOLECULER_REQUEST_FALLBACK_TOTAL, { service: svc.fullName, action: action.name });\n\t\t\t\t\tctx.fallbackResult = true;\n\n\t\t\t\t\treturn fallback.call(svc, ctx, err);\n\t\t\t\t}\n\n\t\t\t\treturn Promise.reject(err);\n\t\t\t});\n\t\t}.bind(this);\n\t}\n\n\treturn {\n\t\tname: \"Fallback\",\n\n\t\tcreated(broker) {\n\t\t\tif (broker.isMetricsEnabled()) {\n\t\t\t\tbroker.metrics.register({ name: METRIC.MOLECULER_REQUEST_FALLBACK_TOTAL, type: METRIC.TYPE_COUNTER, labelNames: [\"service\", \"action\"], description: \"Number of fallbacked requests\", rate: true });\n\t\t\t}\n\t\t},\n\n\t\tlocalAction: wrapFallbackMiddleware,\n\t\tremoteAction: wrapFallbackMiddleware,\n\n\t\t/*call(next) {\n\t\t\treturn (actionName, params, opts) => {\n\t\t\t\treturn next(actionName, params, opts).catch(err => {\n\t\t\t\t\tif (opts.fallbackResponse) {\n\t\t\t\t\t\treturn handleContextFallback(null, err);\n\t\t\t\t\t}\n\t\t\t\t\tthrow err;\n\t\t\t\t});\n\t\t\t};\n\t\t},*/\n\t};\n};\n"],"names":["require$$0","require$$1","require$$2"],"mappings":"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"}
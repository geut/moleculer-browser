{"version":3,"file":"fallback.js","sources":["../../../../../src/moleculer/src/middlewares/fallback.js"],"sourcesContent":["/*\n * moleculer\n * Copyright (c) 2018 MoleculerJS (https://github.com/moleculerjs/moleculer)\n * MIT Licensed\n */\n\n\"use strict\";\n\nconst { MoleculerError } = require(\"../errors\");\nconst { METRIC }\t= require(\"../metrics\");\nconst { isFunction, isString } = require(\"../utils\");\n\nmodule.exports = function FallbackMiddleware(broker) {\n\n\tfunction handleContextFallback(ctx, err) {\n\t\tbroker.logger.warn(`The '${ctx.action.name}' request is failed. Return fallback response.`, { requestID: ctx.requestID, err: err.message });\n\t\tbroker.metrics.increment(METRIC.MOLECULER_REQUEST_FALLBACK_TOTAL, { action: ctx.action.name });\n\t\tctx.fallbackResult = true;\n\n\t\tif (isFunction(ctx.options.fallbackResponse))\n\t\t\treturn ctx.options.fallbackResponse(ctx, err);\n\t\telse\n\t\t\treturn Promise.resolve(ctx.options.fallbackResponse);\n\t}\n\n\tfunction wrapFallbackMiddleware(handler, action) {\n\t\treturn function fallbackMiddleware(ctx) {\n\t\t\t// Call the handler\n\t\t\treturn handler(ctx).catch(err => {\n\n\t\t\t\t// Handle fallback response from calling options\n\t\t\t\tif (ctx.options.fallbackResponse) {\n\t\t\t\t\treturn handleContextFallback(ctx, err);\n\t\t\t\t}\n\n\t\t\t\t// Handle fallback from Action Definition (only locally)\n\t\t\t\tif (action.fallback && action.service) {\n\t\t\t\t\tconst svc = action.service;\n\n\t\t\t\t\tconst fallback = isString(action.fallback) ? svc[action.fallback] : action.fallback;\n\t\t\t\t\tif (!isFunction(fallback)) {\n\t\t\t\t\t\t/* istanbul ignore next */\n\t\t\t\t\t\tthrow new MoleculerError(`The 'fallback' of '${action.name}' action is not a Function or valid method name: ${action.fallback}`);\n\t\t\t\t\t}\n\n\t\t\t\t\tsvc.logger.warn(`The '${ctx.action.name}' request is failed. Return fallback response.`, { requestID: ctx.requestID, err: err.message });\n\t\t\t\t\tbroker.metrics.increment(METRIC.MOLECULER_REQUEST_FALLBACK_TOTAL, { service: svc.fullName, action: action.name });\n\t\t\t\t\tctx.fallbackResult = true;\n\n\t\t\t\t\treturn fallback.call(svc, ctx, err);\n\t\t\t\t}\n\n\t\t\t\treturn Promise.reject(err);\n\t\t\t});\n\t\t}.bind(this);\n\t}\n\n\treturn {\n\t\tname: \"Fallback\",\n\n\t\tcreated(broker) {\n\t\t\tif (broker.isMetricsEnabled()) {\n\t\t\t\tbroker.metrics.register({ name: METRIC.MOLECULER_REQUEST_FALLBACK_TOTAL, type: METRIC.TYPE_COUNTER, labelNames: [\"service\", \"action\"], description: \"Number of fallbacked requests\", rate: true });\n\t\t\t}\n\t\t},\n\n\t\tlocalAction: wrapFallbackMiddleware,\n\t\tremoteAction: wrapFallbackMiddleware,\n\n\t\t/*call(next) {\n\t\t\treturn (actionName, params, opts) => {\n\t\t\t\treturn next(actionName, params, opts).catch(err => {\n\t\t\t\t\tif (opts.fallbackResponse) {\n\t\t\t\t\t\treturn handleContextFallback(null, err);\n\t\t\t\t\t}\n\t\t\t\t\tthrow err;\n\t\t\t\t});\n\t\t\t};\n\t\t},*/\n\t};\n};\n"],"names":["MoleculerError","require$$0","METRIC","require$$1","isFunction","isString","require$$2","broker","wrapFallbackMiddleware","handler","action","ctx","catch","err","options","fallbackResponse","logger","warn","name","requestID","message","metrics","increment","MOLECULER_REQUEST_FALLBACK_TOTAL","fallbackResult","Promise","resolve","handleContextFallback","fallback","service","svc","fullName","call","reject","bind","this","[object Object]","isMetricsEnabled","register","type","TYPE_COUNTER","labelNames","description","rate","localAction","remoteAction"],"mappings":"0FAQA,MAAMA,eAAEA,GAAmBC,GACrBC,OAAEA,GAAWC,GACbC,WAAEA,EAAUC,SAAEA,GAAaC,iBAEhB,SAA4BC,GAa5C,SAASC,EAAuBC,EAASC,GACxC,OAAO,SAA4BC,GAElC,OAAOF,EAAQE,GAAKC,OAAMC,IAGzB,GAAIF,EAAIG,QAAQC,iBACf,OAlBJ,SAA+BJ,EAAKE,GAKnC,OAJAN,EAAOS,OAAOC,KAAK,QAAQN,EAAID,OAAOQ,qDAAsD,CAAEC,UAAWR,EAAIQ,UAAWN,IAAKA,EAAIO,UACjIb,EAAOc,QAAQC,UAAUpB,EAAOqB,iCAAkC,CAAEb,OAAQC,EAAID,OAAOQ,OACvFP,EAAIa,gBAAiB,EAEjBpB,EAAWO,EAAIG,QAAQC,kBACnBJ,EAAIG,QAAQC,iBAAiBJ,EAAKE,GAElCY,QAAQC,QAAQf,EAAIG,QAAQC,kBAU1BY,CAAsBhB,EAAKE,GAInC,GAAIH,EAAOkB,UAAYlB,EAAOmB,QAAS,CACtC,MAAMC,EAAMpB,EAAOmB,QAEbD,EAAWvB,EAASK,EAAOkB,UAAYE,EAAIpB,EAAOkB,UAAYlB,EAAOkB,SAC3E,IAAKxB,EAAWwB,GAEf,MAAM,IAAI5B,EAAe,sBAAsBU,EAAOQ,wDAAwDR,EAAOkB,YAOtH,OAJAE,EAAId,OAAOC,KAAK,QAAQN,EAAID,OAAOQ,qDAAsD,CAAEC,UAAWR,EAAIQ,UAAWN,IAAKA,EAAIO,UAC9Hb,EAAOc,QAAQC,UAAUpB,EAAOqB,iCAAkC,CAAEM,QAASC,EAAIC,SAAUrB,OAAQA,EAAOQ,OAC1GP,EAAIa,gBAAiB,EAEdI,EAASI,KAAKF,EAAKnB,EAAKE,GAGhC,OAAOY,QAAQQ,OAAOpB,OAEtBqB,KAAKC,MAGR,MAAO,CACNjB,KAAM,WAENkB,QAAQ7B,GACHA,EAAO8B,oBACV9B,EAAOc,QAAQiB,SAAS,CAAEpB,KAAMhB,EAAOqB,iCAAkCgB,KAAMrC,EAAOsC,aAAcC,WAAY,CAAC,UAAW,UAAWC,YAAa,gCAAiCC,MAAM,KAI7LC,YAAapC,EACbqC,aAAcrC"}
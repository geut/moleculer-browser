{"version":3,"file":"retry.js","sources":["../../../../../src/moleculer/src/middlewares/retry.js"],"sourcesContent":["/*\n * moleculer\n * Copyright (c) 2018 MoleculerJS (https://github.com/moleculerjs/moleculer)\n * MIT Licensed\n */\n\n\"use strict\";\n\nconst { METRIC }\t= require(\"../metrics\");\n\nmodule.exports = function RetryMiddleware(broker) {\n\n\tfunction wrapRetryMiddleware(handler, action) {\n\t\tconst actionName = action.name;\n\t\tconst service = action.service ? action.service.fullName : null;\n\t\t// Merge action option and broker options\n\t\tconst opts = Object.assign({}, this.options.retryPolicy, action.retryPolicy || {});\n\t\tif (opts.enabled) {\n\t\t\treturn function retryMiddleware(ctx) {\n\t\t\t\tconst attempts = typeof ctx.options.retries === \"number\" ? ctx.options.retries : opts.retries;\n\t\t\t\tif (ctx._retryAttempts == null)\n\t\t\t\t\tctx._retryAttempts = 0;\n\n\t\t\t\t// Call the handler\n\t\t\t\treturn handler(ctx).catch(err => {\n\n\t\t\t\t\t// Skip retry if it is a remote call. The retry logic will run on the caller node\n\t\t\t\t\t// because the Retry middleware wrap the `remoteAction` hook, as well.\n\t\t\t\t\tif (ctx.nodeID != broker.nodeID && ctx.endpoint.local)\n\t\t\t\t\t\treturn Promise.reject(err);\n\n\t\t\t\t\t// Check the error's `retryable` property.\n\t\t\t\t\tif (opts.check(err)) {\n\t\t\t\t\t\tbroker.metrics.increment(METRIC.MOLECULER_REQUEST_RETRY_ATTEMPTS_TOTAL, { service, action: action.name });\n\n\t\t\t\t\t\tif (ctx._retryAttempts < attempts) {\n\t\t\t\t\t\t\t// Retry call\n\t\t\t\t\t\t\tctx._retryAttempts++;\n\n\t\t\t\t\t\t\t// Correct tracing\n\t\t\t\t\t\t\tif (ctx.span) {\n\t\t\t\t\t\t\t\tctx.span.setError(err);\n\t\t\t\t\t\t\t\tctx.span.addTags({ retryAttempts: ctx._retryAttempts });\n\t\t\t\t\t\t\t\tctx.finishSpan(ctx.span);\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t// Calculate next delay\n\t\t\t\t\t\t\tconst delay = Math.min(opts.delay * Math.pow(opts.factor, ctx._retryAttempts - 1), opts.maxDelay);\n\n\t\t\t\t\t\t\tbroker.logger.warn(`Retry to call '${actionName}' action after ${delay} ms...`, { requestID: ctx.requestID, attempts: ctx._retryAttempts });\n\n\t\t\t\t\t\t\t// Wait & recall\n\t\t\t\t\t\t\treturn broker.Promise.delay(delay)\n\t\t\t\t\t\t\t\t.then(() => {\n\t\t\t\t\t\t\t\t\tconst newCtx = ctx.copy();\n\t\t\t\t\t\t\t\t\tnewCtx._retryAttempts = ctx._retryAttempts;\n\n\t\t\t\t\t\t\t\t\tif (action.visibility == \"private\")\n\t\t\t\t\t\t\t\t\t\treturn ctx.service.actions[action.rawName](ctx.params, { ctx: newCtx });\n\n\t\t\t\t\t\t\t\t\treturn broker.call(actionName, ctx.params, { ctx: newCtx });\n\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\t// Throw error\n\t\t\t\t\treturn Promise.reject(err);\n\t\t\t\t});\n\t\t\t}.bind(this);\n\t\t}\n\n\t\treturn handler;\n\t}\n\n\treturn {\n\t\tname: \"Retry\",\n\n\t\tcreated() {\n\t\t\tif (broker.isMetricsEnabled()) {\n\t\t\t\tbroker.metrics.register({ name: METRIC.MOLECULER_REQUEST_RETRY_ATTEMPTS_TOTAL, type: METRIC.TYPE_COUNTER, labelNames: [\"service\", \"action\"], description: \"Number of retries\", rate: true });\n\t\t\t}\n\t\t},\n\n\t\tlocalAction: wrapRetryMiddleware,\n\t\tremoteAction: wrapRetryMiddleware\n\t};\n};\n"],"names":["METRIC","require$$0","broker","wrapRetryMiddleware","handler","action","actionName","name","service","fullName","opts","Object","assign","this","options","retryPolicy","enabled","ctx","attempts","retries","_retryAttempts","catch","err","nodeID","endpoint","local","Promise","reject","check","metrics","increment","MOLECULER_REQUEST_RETRY_ATTEMPTS_TOTAL","span","setError","addTags","retryAttempts","finishSpan","delay","Math","min","pow","factor","maxDelay","logger","warn","requestID","then","newCtx","copy","visibility","actions","rawName","params","call","bind","[object Object]","isMetricsEnabled","register","type","TYPE_COUNTER","labelNames","description","rate","localAction","remoteAction"],"mappings":"mCAQA,MAAMA,OAAEA,GAAWC,iBAEF,SAAyBC,GAEzC,SAASC,EAAoBC,EAASC,GACrC,MAAMC,EAAaD,EAAOE,KACpBC,EAAUH,EAAOG,QAAUH,EAAOG,QAAQC,SAAW,KAErDC,EAAOC,OAAOC,OAAO,GAAIC,KAAKC,QAAQC,YAAaV,EAAOU,aAAe,IAC/E,OAAIL,EAAKM,QACD,SAAyBC,GAC/B,MAAMC,EAA0C,iBAAxBD,EAAIH,QAAQK,QAAuBF,EAAIH,QAAQK,QAAUT,EAAKS,QAKtF,OAJ0B,MAAtBF,EAAIG,iBACPH,EAAIG,eAAiB,GAGfhB,EAAQa,GAAKI,OAAMC,IAIzB,GAAIL,EAAIM,QAAUrB,EAAOqB,QAAUN,EAAIO,SAASC,MAC/C,OAAOC,QAAQC,OAAOL,GAGvB,GAAIZ,EAAKkB,MAAMN,KACdpB,EAAO2B,QAAQC,UAAU9B,EAAO+B,uCAAwC,CAAEvB,QAAAA,EAASH,OAAQA,EAAOE,OAE9FU,EAAIG,eAAiBF,GAAU,CAElCD,EAAIG,iBAGAH,EAAIe,OACPf,EAAIe,KAAKC,SAASX,GAClBL,EAAIe,KAAKE,QAAQ,CAAEC,cAAelB,EAAIG,iBACtCH,EAAImB,WAAWnB,EAAIe,OAIpB,MAAMK,EAAQC,KAAKC,IAAI7B,EAAK2B,MAAQC,KAAKE,IAAI9B,EAAK+B,OAAQxB,EAAIG,eAAiB,GAAIV,EAAKgC,UAKxF,OAHAxC,EAAOyC,OAAOC,KAAK,kBAAkBtC,mBAA4B+B,UAAe,CAAEQ,UAAW5B,EAAI4B,UAAW3B,SAAUD,EAAIG,iBAGnHlB,EAAOwB,QAAQW,MAAMA,GAC1BS,MAAK,KACL,MAAMC,EAAS9B,EAAI+B,OAGnB,OAFAD,EAAO3B,eAAiBH,EAAIG,eAEH,WAArBf,EAAO4C,WACHhC,EAAIT,QAAQ0C,QAAQ7C,EAAO8C,SAASlC,EAAImC,OAAQ,CAAEnC,IAAK8B,IAExD7C,EAAOmD,KAAK/C,EAAYW,EAAImC,OAAQ,CAAEnC,IAAK8B,OAMtD,OAAOrB,QAAQC,OAAOL,OAEtBgC,KAAKzC,MAGDT,EAGR,MAAO,CACNG,KAAM,QAENgD,UACKrD,EAAOsD,oBACVtD,EAAO2B,QAAQ4B,SAAS,CAAElD,KAAMP,EAAO+B,uCAAwC2B,KAAM1D,EAAO2D,aAAcC,WAAY,CAAC,UAAW,UAAWC,YAAa,oBAAqBC,MAAM,KAIvLC,YAAa5D,EACb6D,aAAc7D"}
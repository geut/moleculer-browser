{"version":3,"file":"cpu-usage.js","sources":["../../../../src/moleculer/src/cpu-usage.js"],"sourcesContent":["/*\n * moleculer\n * Copyright (c) 2018 MoleculerJS (https://github.com/moleculerjs/moleculer)\n * MIT Licensed\n */\n\n\"use strict\";\n\n/**\n * CPU usage measure.\n *\n * Based on: https://github.com/icebob/cpu\n */\nconst os = require(\"os\");\n\n/* istanbul ignore next */\nmodule.exports = function getCpuUsage(sampleTime = 100) {\n\treturn new Promise((resolve, reject) => {\n\t\ttry {\n\t\t\tconst first = os.cpus().map(cpu => cpu.times);\n\t\t\tsetTimeout(() => {\n\t\t\t\ttry {\n\t\t\t\t\tconst second = os.cpus().map(cpu => cpu.times);\n\t\t\t\t\tsetTimeout(() => {\n\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\tconst third = os.cpus().map(cpu => cpu.times);\n\n\t\t\t\t\t\t\tconst usages = [];\n\t\t\t\t\t\t\tfor (let i = 0; i < first.length; i++) {\n\t\t\t\t\t\t\t\tconst first_idle = first[i].idle;\n\t\t\t\t\t\t\t\tconst first_total = first[i].idle + first[i].user + first[i].nice + first[i].sys + first[i].irq;\n\t\t\t\t\t\t\t\tconst second_idle = second[i].idle;\n\t\t\t\t\t\t\t\tconst second_total = second[i].idle + second[i].user + second[i].nice + second[i].sys + second[i].irq;\n\t\t\t\t\t\t\t\tconst third_idle = third[i].idle;\n\t\t\t\t\t\t\t\tconst third_total = third[i].idle + third[i].user + third[i].nice + third[i].sys + third[i].irq;\n\t\t\t\t\t\t\t\tconst first_usage = 1 - (second_idle - first_idle) / (second_total - first_total);\n\t\t\t\t\t\t\t\tconst second_usage = 1 - (third_idle - second_idle) / (third_total - second_total);\n\t\t\t\t\t\t\t\tconst per_usage = (first_usage + second_usage) / 2 * 100;\n\t\t\t\t\t\t\t\tusages.push(per_usage);\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\tresolve({\n\t\t\t\t\t\t\t\tavg: usages.reduce((a, b) => a + b, 0) / usages.length,\n\t\t\t\t\t\t\t\tusages\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t} catch (err) {\n\t\t\t\t\t\t\treject(err);\n\t\t\t\t\t\t}\n\t\t\t\t\t}, sampleTime);\n\t\t\t\t} catch (err) {\n\t\t\t\t\treject(err);\n\t\t\t\t}\n\t\t\t}, sampleTime);\n\t\t} catch (err) {\n\t\t\treject(err);\n\t\t}\n\t});\n};\n"],"names":[],"mappings":"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"}